<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="http://example.com">
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" type="text/css" href="/./main.0cf68a.css">
  <style type="text/css">
  
    #container.show {
      background: linear-gradient(200deg,#a0cfe4,#e8c37e);
    }
  </style>
  

  

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      
<div class="overlay" style="background: #4d4d4d"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src="" class="js-avatar">
		</a>
		<hgroup>
		  <h1 class="header-author"><a href="/"></a></h1>
		</hgroup>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">ä¸»é¡µ</a></li>
	        
				<li><a href="/tags/%E9%9A%8F%E7%AC%94/">éšç¬”</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
    		
    			
    			<a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">æ‰€æœ‰æ–‡ç« </a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'friends')" href="javascript:void(0)">å‹é“¾</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)">å…³äºæˆ‘</a>
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="#" title="github"><i class="icon-github"></i></a>
		        
					<a class="weibo" target="_blank" href="#" title="weibo"><i class="icon-weibo"></i></a>
		        
					<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
		        
					<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      
<nav id="mobile-nav">
  	<div class="overlay js-overlay" style="background: #4d4d4d"></div>
	<div class="btnctn js-mobile-btnctn">
  		<div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div>
	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author js-header-author"></h1>
			</hgroup>
			
			
			
				
			
				
			
			
			
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="#" title="github"><i class="icon-github"></i></a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo"><i class="icon-weibo"></i></a>
			        
						<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
			        
				</div>
			</nav>

			<nav class="header-menu js-header-menu">
				<ul style="width: 50%">
				
				
					<li style="width: 50%"><a href="/">ä¸»é¡µ</a></li>
		        
					<li style="width: 50%"><a href="/tags/%E9%9A%8F%E7%AC%94/">éšç¬”</a></li>
		        
				</ul>
			</nav>
		</header>				
	</div>
	<div class="mobile-mask" style="display:none" q-show="isShow"></div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            
  
    <article id="post-ç½‘æ¡¥è½¬å‘åˆ°å¦ä¸€ä¸ªç½‘æ¡¥" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2025/11/10/%E7%BD%91%E6%A1%A5%E8%BD%AC%E5%8F%91%E5%88%B0%E5%8F%A6%E4%B8%80%E4%B8%AA%E7%BD%91%E6%A1%A5/">ç½‘æ¡¥è½¬å‘åˆ°å¦ä¸€ä¸ªç½‘æ¡¥</a>
    </h1>
  

        
        <a href="/2025/11/10/%E7%BD%91%E6%A1%A5%E8%BD%AC%E5%8F%91%E5%88%B0%E5%8F%A6%E4%B8%80%E4%B8%AA%E7%BD%91%E6%A1%A5/" class="archive-article-date">
  	<time datetime="2025-11-10T12:00:22.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2025-11-10</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id=""><a href="#" class="headerlink" title=""></a></h2><h5 id="-1"><a href="#-1" class="headerlink" title=""></a></h5><hr>
<h1 id="æ€»ä½“ç»“è®ºï¼ˆå…ˆç»™ç»“è®ºï¼Œå†å±•å¼€ï¼‰"><a href="#æ€»ä½“ç»“è®ºï¼ˆå…ˆç»™ç»“è®ºï¼Œå†å±•å¼€ï¼‰" class="headerlink" title="æ€»ä½“ç»“è®ºï¼ˆå…ˆç»™ç»“è®ºï¼Œå†å±•å¼€ï¼‰"></a>æ€»ä½“ç»“è®ºï¼ˆå…ˆç»™ç»“è®ºï¼Œå†å±•å¼€ï¼‰</h1><p>å½“ <code>br_netfilter</code>ï¼ˆbridge netfilterï¼‰è¢«å¯ç”¨æ—¶ï¼Œbridge å±‚åœ¨æŠŠä¸€ä¸ª IPv4&#x2F;IPv6 å¸§â€œäº¤ç»™ IP å±‚â€ä¹‹å‰ï¼Œä¼š<strong>åœ¨æ¡¥å±‚å…ˆåšä¸€æ¬¡â€œä¼ªè·¯ç”±&#x2F;é¢„å¤„ç†â€å¹¶ä¸»åŠ¨è°ƒç”¨ IPv4&#x2F;IPv6 çš„ PRE_ROUTING hook</strong>ï¼ˆå³ <code>NF_INET_PRE_ROUTING</code>ï¼‰ã€‚è¿™æ¬¡è°ƒç”¨ä¼šæŠŠä¸€äº›ä¿¡æ¯ï¼ˆä¾‹å¦‚åŸå§‹ç‰©ç†å…¥ç«¯å£ã€æ˜¯å¦åšè¿‡ DNATã€ä¸€ä¸ªâ€œfake rtable&#x2F;dstâ€ä¹‹ç±»çš„ä¸Šä¸‹æ–‡ï¼‰ä¿å­˜åœ¨ <code>skb-&gt;nf_bridge</code> &#x2F; å…¶å®ƒå­—æ®µé‡Œï¼Œå¹¶åœ¨ <code>nf_bridge-&gt;mask</code> ä¸Šæ‰“ä¸Šæ ‡è®°ï¼ˆ<code>BRNF_NF_BRIDGE_PREROUTING</code>ï¼‰ï¼Œè¡¨ç¤ºâ€œå·²ç»åšè¿‡ bridgeâ†’IP çš„ PRE_ROUTING äº†â€ã€‚å†…æ ¸åŒæ—¶æ³¨å†Œäº†ä¸€ä¸ªâ€œsabotageâ€é£æ ¼çš„ PF_INET PRE_ROUTING hookï¼Œç”¨æ¥åœ¨åç»­çœŸæ­£è¿›å…¥ IP å±‚å¤„ç†æ—¶<strong>é˜»æ­¢å†é‡å¤æ‰§è¡Œ PREROUTING</strong>ã€‚å› æ­¤ä½ åœ¨å®éªŒä¸­çœ‹ä¸åˆ° PREROUTING è¢«é‡å¤æ‰§è¡Œï¼Œè¿™æ˜¯å†…æ ¸åˆ»æ„åšçš„è¡Œä¸ºã€‚<a target="_blank" rel="noopener" href="https://android.googlesource.com/kernel/common/%2B/a7827a2a60218b25f222b54f77ed38f57aebe08b/net/bridge/br_netfilter.c">Android Go Source+1</a></p>
<hr>
<h1 id="è¯¦ç»†æµç¨‹ï¼ˆæŒ‰æ­¥éª¤ï¼Œå¸¦å…³é”®å‡½æ•°-hookï¼‰"><a href="#è¯¦ç»†æµç¨‹ï¼ˆæŒ‰æ­¥éª¤ï¼Œå¸¦å…³é”®å‡½æ•°-hookï¼‰" class="headerlink" title="è¯¦ç»†æµç¨‹ï¼ˆæŒ‰æ­¥éª¤ï¼Œå¸¦å…³é”®å‡½æ•° &#x2F; hookï¼‰"></a>è¯¦ç»†æµç¨‹ï¼ˆæŒ‰æ­¥éª¤ï¼Œå¸¦å…³é”®å‡½æ•° &#x2F; hookï¼‰</h1><p>ä¸‹é¢çš„æµç¨‹ä»å¸§ä» NIC æ”¶åˆ°ï¼ˆRXï¼‰å¼€å§‹ï¼Œåˆ°å¯èƒ½è¢«è½¬å‘åˆ°å¦ä¸€ä¸ª bridge ä¸ºæ­¢ã€‚ä¸ºäº†ç®€æ´æˆ‘æŠŠéå…³é”®çš„ NAPI&#x2F;GRO&#x2F;GSO ç»†èŠ‚çœå»ï¼Œå…³æ³¨æ¡¥ + netfilter çš„äº¤äº’ã€‚</p>
<ol>
<li><p><strong>å¸§è¢« NIC æ¥æ”¶å¹¶è¿›å…¥å†…æ ¸æ¥æ”¶è·¯å¾„</strong>ï¼ˆnapi -&gt; <code>__netif_receive_skb_core</code> &#x2F; <code>netif_receive_skb()</code> ç­‰ï¼‰ï¼Œæœ€åˆçš„ <code>skb-&gt;dev</code> æ˜¯ç‰©ç†ç«¯å£è®¾å¤‡ï¼ˆbridge çš„ç«¯å£ï¼‰ã€‚<br>ï¼ˆè¿™éƒ¨åˆ†æ˜¯æ ‡å‡†çš„ RX è·¯å¾„ï¼Œbridge å¯èƒ½é€šè¿‡ <code>rx_handler</code> æˆ– <code>br_handle_frame</code> æ¥æ‰‹å¹¶å°† <code>skb-&gt;dev</code> æ›¿æ¢ä¸º bridge çˆ¶è®¾å¤‡ &#x2F; åšå…¶ä»–å¤„ç†ã€‚ï¼‰<a target="_blank" rel="noopener" href="https://android.googlesource.com/kernel/common/%2B/a7827a2a60218b25f222b54f77ed38f57aebe08b/net/bridge/br_netfilter.c">Android Go Source</a></p>
</li>
<li><p><strong>bridge å±‚æ¥æ‰‹å¹¶åˆ¤æ–­è¿™æ˜¯ IP&#x2F;ARP&#x2F;IPv6 ç­‰</strong>ï¼Œå¦‚æœ <code>br_netfilter</code> æ¨¡å—å¼€å¯å¹¶ä¸”è¯¥ bridge éœ€è¦èµ° iptables&#x2F;nftablesï¼Œå®ƒä¼šæŠŠåŒ…å¼•å…¥ bridge-netfilter çš„å¤„ç†å‡½æ•° <code>br_nf_pre_routing</code>ï¼ˆæˆ– IPv6 å¯¹åº”å‡½æ•°ï¼‰ã€‚åœ¨è¿™é‡Œåšäº†è‹¥å¹²â€œé¢„æ£€æŸ¥â€ï¼ˆæ¯”å¦‚æ ¡éªŒå¤´é•¿åº¦ã€è§£æ VLAN&#x2F;PPPoEã€ä¿å­˜åŸå§‹ç›®çš„åœ°å€ä»¥ä¾¿æ£€æµ‹ DNAT ç­‰ï¼‰ï¼Œå¹¶<strong>ä¸ºè¯¥ skb åˆ†é…&#x2F;è®¾ç½® <code>skb-&gt;nf_bridge</code></strong>ã€‚å…³é”®è¡Œä¸ºä¹‹ä¸€æ˜¯ï¼š<strong>å°† <code>skb-&gt;dev</code> æ”¹ä¸º bridge çˆ¶è®¾å¤‡ï¼ˆbridge deviceï¼‰ä»¥â€œçœ‹èµ·æ¥åƒæ˜¯è·¯ç”±çš„è¾“å…¥è®¾å¤‡â€</strong>ï¼Œä»¥ä¾¿ IP netfilter èƒ½æŒ‰é¢„æœŸåº”ç”¨ï¼ˆä¾‹å¦‚ REDIRECT&#x2F;physdev match éœ€è¦è¿™ä¸ªï¼‰ã€‚è¿™ä¸€æ­¥å¯¹åº”ä»£ç ä¸­çš„ <code>setup_pre_routing()</code>ã€‚<a target="_blank" rel="noopener" href="https://android.googlesource.com/kernel/common/%2B/a7827a2a60218b25f222b54f77ed38f57aebe08b/net/bridge/br_netfilter.c">Android Go Source</a></p>
</li>
<li><p><strong>bridge ä¸»åŠ¨è°ƒç”¨ IP å±‚çš„ PRE_ROUTING hook</strong>ï¼šåœ¨ <code>br_nf_pre_routing</code> ä¸­ï¼Œå†…æ ¸ä¼šåš <code>skb-&gt;protocol = ETH_P_IP</code>ï¼ˆæˆ– IPv6ï¼‰ï¼Œç„¶åæ‰§è¡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NF_HOOK(NFPROTO_IPV4, NF_INET_PRE_ROUTING, skb, skb-&gt;dev, NULL, br_nf_pre_routing_finish);</span><br></pre></td></tr></table></figure>

<p>å¹¶è¿”å› <code>NF_STOLEN</code>ï¼ˆè¡¨ç¤º bridge å·²â€œæ¥ç®¡â€äº†è¿™æ¡ skb çš„è¿›ä¸€æ­¥å¤„ç†æµç¨‹â€”â€”æ‰€ä»¥ä¸æŒ‰å¸¸è§„ç”± IP æ ˆå†æ¬¡å¯åŠ¨ hook é“¾ï¼‰ã€‚æ¢å¥è¯è¯´ï¼š<code>br_netfilter</code> åœ¨ bridge å±‚å…ˆâ€œä»£ä¸ºè°ƒç”¨â€äº† IPv4&#x2F;IPv6 çš„ PRE_ROUTINGã€‚<a target="_blank" rel="noopener" href="https://android.googlesource.com/kernel/common/%2B/a7827a2a60218b25f222b54f77ed38f57aebe08b/net/bridge/br_netfilter.c">Android Go Source</a></p>
</li>
<li><p><strong>br_netfilter åœ¨ skb ä¸Šæ‰“æ ‡è®°</strong>ï¼š<code>setup_pre_routing()</code> &#x2F; ç›¸å…³é€»è¾‘ä¼šåœ¨ <code>nf_bridge-&gt;mask</code> ä¸Šè®¾ç½® <code>BRNF_NF_BRIDGE_PREROUTING</code>ï¼ˆç­‰æ ‡å¿—ï¼‰ï¼Œè¡¨ç¤ºå·²åšè¿‡æ¡¥å±‚çš„ PRE_ROUTINGã€‚è¿™ä¸ªæ ‡è®°åç»­ä¼šè¢«ç”¨æ¥é¿å… IP å±‚é‡å¤æ‰§è¡Œ PRE_ROUTINGã€‚<a target="_blank" rel="noopener" href="https://android.googlesource.com/kernel/common/%2B/a7827a2a60218b25f222b54f77ed38f57aebe08b/net/bridge/br_netfilter.c">Android Go Source</a></p>
</li>
<li><p><strong>å†…æ ¸æ³¨å†Œäº†ä¸€ä¸ªâ€œsabotageâ€ hookï¼ˆip_sabotage_inï¼‰</strong>ï¼šä¸ºäº†ç¡®ä¿å½“ packet çœŸæ­£ä¸Šå‡åˆ° IP å±‚æ—¶ä¸å†é‡å¤ PRE_ROUTINGï¼Œ<code>br_netfilter</code> åŒæ—¶åœ¨ PF_INET&#x2F;NF_INET_PRE_ROUTING ä¸Šæ³¨å†Œäº†ä¼˜å…ˆçº§å¾ˆé«˜çš„ hookï¼ˆä»£ç é‡Œç§°ä¸º ip_sabotage_inï¼‰ã€‚è¿™ä¸ª hook æ£€æŸ¥ <code>skb-&gt;nf_bridge</code> åŠ <code>BRNF_NF_BRIDGE_PREROUTING</code> æ ‡å¿—ï¼Œå¦‚æœå‘ç°è¿™æ˜¯è¢« bridge é¢„å¤„ç†è¿‡çš„åŒ…å°±ç›´æ¥ <code>NF_STOP</code> &#x2F; <code>NF_ACCEPT</code>ï¼ˆè§†å®ç°ç»†èŠ‚ï¼‰ä»¥<strong>é˜»æ­¢åç»­çš„ PRE_ROUTING é“¾å†æ¬¡å¤„ç†</strong>ã€‚è¿™æ­£æ˜¯ä½ å®éªŒä¸­â€œå¥½åƒæ²¡æœ‰å†æ¬¡æ‰§è¡Œ PREROUTINGâ€çš„ç›´æ¥åŸå› ã€‚<a target="_blank" rel="noopener" href="https://android.googlesource.com/kernel/common/%2B/a7827a2a60218b25f222b54f77ed38f57aebe08b/net/bridge/br_netfilter.c">Android Go Source</a></p>
</li>
<li><p><strong>è·¯ç”± &#x2F; DNAT å†³å®š</strong>ï¼ˆåœ¨ br çš„ pre_routing finish é‡Œï¼‰ï¼š<code>br_nf_pre_routing_finish</code> ä¼šæ ¹æ®æ˜¯å¦å‘ç”Ÿ DNATã€è·¯ç”±æŸ¥æ‰¾ç»“æœç­‰æ¥å†³å®šä¸‹ä¸€æ­¥ï¼š</p>
<ul>
<li>å¦‚æœç›®æ ‡çœ‹èµ·æ¥æ˜¯â€œæœ¬æœºâ€ï¼ˆlocalï¼‰ï¼Œä¼šå®‰æ’ <code>br_nf_local_in</code> ä¹‹ç±»çš„ç»§ç»­å¤„ç†ï¼ˆå¹¶å¤„ç† fake rtable çš„æ‹†è§£ï¼‰ï¼›</li>
<li>å¦‚æœç›®æ ‡åœ¨åŒä¸€ bridge çš„å¦ä¸€ä¸ªç«¯å£ï¼ˆçº¯æ¡¥è½¬å‘ï¼‰ï¼Œåç»­ä¼šèµ° <code>br_nf_forward_ip</code> â†’ è°ƒç”¨ <code>NF_INET_FORWARD</code>ï¼ˆè¢« iptables&#x2F;nftables çš„ FORWARD é“¾çœ‹åˆ°ï¼‰â†’ å®Œæˆåå›åˆ° bridge å±‚çš„ FORWARD å¤„ç†ï¼ˆ<code>br_forward_finish</code> &#x2F; <code>br_forward</code>ï¼‰ï¼Œæœ€åèµ° <code>br_dev_queue_push_xmit</code> å‘åˆ°ç‰©ç†ç«¯å£ã€‚<br>æ€»ä¹‹ï¼šbridge åœ¨è¿›å…¥ IP hook æ—¶â€œå‡è£…â€è‡ªå·±æ˜¯è·¯ç”±å™¨ï¼ˆè®¾ç½®çš„ <code>skb-&gt;dev</code> &#x2F; fake dst &#x2F; rtable ç­‰ï¼‰ï¼ŒæŠŠ IP å±‚éœ€è¦çš„æ£€æŸ¥&#x2F;é“¾æ¡è·‘ä¸€éï¼ˆä½†é‚£æ˜¯ç”± bridge å‘èµ·çš„ï¼‰ï¼Œä¹‹åå†å›åˆ° bridge çš„è½¬å‘&#x2F;è¾“å‡ºä»£ç å»æŠŠåŒ…å‘å‡ºå»ã€‚<a target="_blank" rel="noopener" href="https://android.googlesource.com/kernel/common/%2B/a7827a2a60218b25f222b54f77ed38f57aebe08b/net/bridge/br_netfilter.c">Android Go Source+1</a></li>
</ul>
</li>
<li><p><strong>å½“è·¯ç”±ç›®æ ‡æ˜¯å¦ä¸€ä¸ª bridgeï¼ˆæˆ–è¾“å‡ºè®¾å¤‡æ˜¯ bridgeï¼‰</strong>ï¼šè·¯ç”±æŸ¥æ‰¾ç»“æœå¦‚æœæŠŠè¾“å‡ºè®¾å¤‡åˆ¤å®šä¸ºå¦ä¸€ä¸ª bridge çš„çˆ¶è®¾å¤‡ï¼ˆæˆ–è€…åŒä¸€ä¸»æœºä¸Šçš„å¦ä¸€ä¸ª bridgeï¼‰ï¼Œé‚£ä¹ˆ br_netfilter ä¼šæŠŠ <code>skb-&gt;dev</code>&#x2F;<code>skb_dst</code> ç­‰è®¾ç½®ä¸ºå¯¹åº”çš„ bridge device &#x2F; fake dstï¼Œç„¶ååœ¨ bridge å±‚è°ƒç”¨ç›¸åº”çš„ BR_FORWARD &#x2F; BR_POST_ROUTING hooksï¼ˆ<code>NFPROTO_BRIDGE</code> çš„ <code>NF_BR_FORWARD</code> &#x2F; <code>NF_BR_POST_ROUTING</code> ç­‰ï¼‰ï¼Œæœ€ç»ˆè¿›å…¥ç›®æ ‡ bridge çš„è½¬å‘&#x2F;è¾“å‡ºé€»è¾‘å¹¶èµ°åˆ°ç›®æ ‡ bridge çš„ç«¯å£å»å‘é€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œâ€œè½¬äº¤ç»™å¦ä¸€ä¸ª bridgeâ€æœ¬è´¨ä¸Šæ˜¯é€šè¿‡ <code>skb-&gt;dev</code>ã€<code>nf_bridge</code> ä¸Šçš„ physin&#x2F;physout å­—æ®µã€ä»¥åŠ br-netfilter åœ¨ PRE&#x2F;FORWARD&#x2F;POST_ROUTING ä¹‹é—´çš„å›è°ƒé“¾æ¥å®Œæˆçš„ã€‚<a target="_blank" rel="noopener" href="https://android.googlesource.com/kernel/common/%2B/a7827a2a60218b25f222b54f77ed38f57aebe08b/net/bridge/br_netfilter.c">Android Go Source</a></p>
</li>
</ol>
<hr>
<h1 id="hook-åˆ—è¡¨ï¼ˆå¸¸è§çš„ã€ä½ å…³å¿ƒçš„ç‚¹ï¼‰"><a href="#hook-åˆ—è¡¨ï¼ˆå¸¸è§çš„ã€ä½ å…³å¿ƒçš„ç‚¹ï¼‰" class="headerlink" title="hook åˆ—è¡¨ï¼ˆå¸¸è§çš„ã€ä½ å…³å¿ƒçš„ç‚¹ï¼‰"></a>hook åˆ—è¡¨ï¼ˆå¸¸è§çš„ã€ä½ å…³å¿ƒçš„ç‚¹ï¼‰</h1><ul>
<li>PF_BRIDGE: <code>NF_BR_PRE_ROUTING</code>ï¼ˆ<code>br_nf_pre_routing</code>ï¼‰ â€”â€” åœ¨ link å±‚è¿›å…¥æ¡¥æ—¶è¢«è°ƒç”¨ï¼Œè´Ÿè´£æŠŠåŒ…è½¬äº¤ç»™ iptables&#x2F;nftablesï¼ˆç”± bridge å‘èµ· IP PRE_ROUTINGï¼‰ã€‚<a target="_blank" rel="noopener" href="https://android.googlesource.com/kernel/common/%2B/a7827a2a60218b25f222b54f77ed38f57aebe08b/net/bridge/br_netfilter.c">Android Go Source</a></li>
<li>PF_INET: <code>NF_INET_PRE_ROUTING</code> â€”â€” å¯¹äº bridged åŒ…ï¼Œè¿™æ¬¡ PRE_ROUTING æ˜¯ç”± <code>br_netfilter</code> æ˜¾å¼è°ƒç”¨çš„ï¼ˆå¹¶æœ‰å›è°ƒ <code>br_nf_pre_routing_finish</code>ï¼‰ã€‚å†…æ ¸åŒæ—¶æ³¨å†Œäº† <code>ip_sabotage_in</code>ï¼ˆä¼˜å…ˆçº§å¾ˆé«˜ï¼‰ç”¨äºé˜»æ­¢â€œå¸¸è§„â€IP å±‚å†æ¬¡æ‰§è¡Œ PRE_ROUTINGã€‚<a target="_blank" rel="noopener" href="https://android.googlesource.com/kernel/common/%2B/a7827a2a60218b25f222b54f77ed38f57aebe08b/net/bridge/br_netfilter.c">Android Go Source</a></li>
<li>PF_INET: <code>NF_INET_FORWARD</code> â€”â€” å¦‚æœ packet éœ€è¦è½¬å‘ï¼Œbr_netfilter ä¼šæŠŠåŒ…äº¤ç»™ IP FORWARD é“¾ï¼ˆå®é™…ä¹Ÿæ˜¯ç”± bridge å‘èµ·ï¼‰ï¼Œå¤„ç†å®Œåå†å›åˆ° bridge å±‚çš„ forward finishã€‚<a target="_blank" rel="noopener" href="https://android.googlesource.com/kernel/common/%2B/a7827a2a60218b25f222b54f77ed38f57aebe08b/net/bridge/br_netfilter.c">Android Go Source</a></li>
<li>PF_BRIDGE: <code>NF_BR_FORWARD</code> &#x2F; <code>NF_BR_POST_ROUTING</code> â€”â€” æœ€ç»ˆå›åˆ° bridge å±‚åšå®é™…è½¬å‘ä¸ postroutingï¼Œç„¶åå‘åˆ°ç‰©ç†ç«¯å£ï¼ˆæˆ–å†åš ip_postrouting æƒ…å½¢ï¼‰ã€‚<a target="_blank" rel="noopener" href="https://android.googlesource.com/kernel/common/%2B/a7827a2a60218b25f222b54f77ed38f57aebe08b/net/bridge/br_netfilter.c">Android Go Source</a></li>
</ul>
<p>ï¼ˆä¸Šé¢å…³é”®æµç¨‹å’Œ hook çš„å®ç°éƒ½åœ¨å†…æ ¸ <code>net/bridge/br_netfilter.c</code> å’Œ kernel bridge docs ä¸­æœ‰è§£é‡Šã€‚ï¼‰<a target="_blank" rel="noopener" href="https://android.googlesource.com/kernel/common/%2B/a7827a2a60218b25f222b54f77ed38f57aebe08b/net/bridge/br_netfilter.c">Android Go Source+1</a></p>
<hr>
<h1 id="ä¸ºä»€ä¹ˆä½ æ²¡æœ‰çœ‹åˆ°â€œå†æ¬¡æ‰§è¡Œ-PREROUTINGâ€-â€”â€”-å›åˆ°ä½ åŸå§‹çš„ç–‘é—®"><a href="#ä¸ºä»€ä¹ˆä½ æ²¡æœ‰çœ‹åˆ°â€œå†æ¬¡æ‰§è¡Œ-PREROUTINGâ€-â€”â€”-å›åˆ°ä½ åŸå§‹çš„ç–‘é—®" class="headerlink" title="ä¸ºä»€ä¹ˆä½ æ²¡æœ‰çœ‹åˆ°â€œå†æ¬¡æ‰§è¡Œ PREROUTINGâ€ â€”â€” å›åˆ°ä½ åŸå§‹çš„ç–‘é—®"></a>ä¸ºä»€ä¹ˆä½ æ²¡æœ‰çœ‹åˆ°â€œå†æ¬¡æ‰§è¡Œ PREROUTINGâ€ â€”â€” å›åˆ°ä½ åŸå§‹çš„ç–‘é—®</h1><p>ä½ çœ‹åˆ°çš„ä»£ç ç‰‡æ®µï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">int ip_rcv(...) &#123;</span><br><span class="line">    skb = ip_rcv_core(skb, net);</span><br><span class="line">    if (!skb) return NET_RX_DROP;</span><br><span class="line">    return NF_HOOK(NFPROTO_IPV4, NF_INET_PRE_ROUTING, net, NULL, skb, dev, NULL, ip_rcv_finish);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¡®å®è¡¨æ˜ IP å±‚çš„æ¥æ”¶è·¯å¾„ä¼šè§¦å‘ <code>NF_INET_PRE_ROUTING</code>ã€‚ä½†åœ¨ bridged æƒ…å½¢ä¸‹ä¸¤ç‚¹å…±åŒå·¥ä½œé¿å…äº†é‡å¤ï¼š</p>
<ol>
<li><code>br_netfilter</code> åœ¨ bridge å±‚<strong>å…ˆ</strong>è°ƒç”¨äº†ä¸€æ¬¡ <code>NF_INET_PRE_ROUTING</code>ï¼ˆå¹¶æ ‡è®° <code>skb-&gt;nf_bridge-&gt;mask |= BRNF_NF_BRIDGE_PREROUTING</code>ï¼‰ã€‚å¹¶ä¸”è¿™æ¬¡è°ƒç”¨æ˜¯ç”± bridge å‘èµ·ã€å¸¦æœ‰ finish-callbackï¼ˆ<code>br_nf_pre_routing_finish</code>ï¼‰ï¼Œé€»è¾‘ä¸Šç­‰åŒäºâ€œå·²ç»åšè¿‡ PRE_ROUTINGâ€ã€‚<a target="_blank" rel="noopener" href="https://android.googlesource.com/kernel/common/%2B/a7827a2a60218b25f222b54f77ed38f57aebe08b/net/bridge/br_netfilter.c">Android Go Source</a></li>
<li>å†…æ ¸ä¸ºæ­¤æ³¨å†Œäº† <code>ip_sabotage_in</code>ï¼ˆä¼˜å…ˆçº§å¾ˆé«˜ï¼‰è¿™ä¸ª hookï¼Œåœ¨çœŸæ­£çš„ IP å±‚ <code>NF_INET_PRE_ROUTING</code> é“¾ä¸€å¼€å§‹å°±æ£€æŸ¥ <code>skb-&gt;nf_bridge</code> &#x2F; <code>BRNF_NF_BRIDGE_PREROUTING</code>ï¼Œè‹¥å‘ç°è¯¥æ ‡è®°å°± <strong>é˜»æ­¢</strong>ï¼ˆstop&#x2F;acceptï¼‰åç»­ PRE_ROUTING é’©å­å†æ¬¡è¿è¡Œã€‚äºæ˜¯ä½ åœ¨å®éªŒé‡Œçœ‹ä¸åˆ°é‡å¤çš„ PREROUTING æ‰§è¡Œï¼ˆå› ä¸ºè¢«â€œsabotageâ€ç»™æ‹¦ä½äº†ï¼‰ã€‚<a target="_blank" rel="noopener" href="https://android.googlesource.com/kernel/common/%2B/a7827a2a60218b25f222b54f77ed38f57aebe08b/net/bridge/br_netfilter.c">Android Go Source</a></li>
</ol>
<hr>
<h1 id="å®éªŒ-è¿½è¸ªå»ºè®®ï¼ˆä½ è¦-debug-æ—¶å¯ä»¥ç”¨ï¼‰"><a href="#å®éªŒ-è¿½è¸ªå»ºè®®ï¼ˆä½ è¦-debug-æ—¶å¯ä»¥ç”¨ï¼‰" class="headerlink" title="å®éªŒ&#x2F;è¿½è¸ªå»ºè®®ï¼ˆä½ è¦ debug æ—¶å¯ä»¥ç”¨ï¼‰"></a>å®éªŒ&#x2F;è¿½è¸ªå»ºè®®ï¼ˆä½ è¦ debug æ—¶å¯ä»¥ç”¨ï¼‰</h1><ul>
<li>åœ¨å†…æ ¸ netfilter hook callback æ‰“æ—¥å¿—ï¼ˆæˆ–ä½¿ç”¨ <code>nf_log</code>ï¼‰æ¥åˆ†åˆ«åœ¨ PF_BRIDGE çš„ <code>NF_BR_PRE_ROUTING</code> &#x2F; <code>NF_BR_FORWARD</code> ä¸ PF_INET çš„ <code>NF_INET_PRE_ROUTING</code> &#x2F; <code>NF_INET_FORWARD</code> æ’å…¥æ¢é’ˆï¼Œèƒ½çœ‹åˆ°å“ªä¸€ä¾§çœŸæ­£è§¦å‘ã€ä»¥åŠ <code>skb-&gt;nf_bridge-&gt;mask</code> çš„å€¼ã€‚<code>br_netfilter</code> çš„ PRE_ROUTING ä¼šå…ˆè¢«è°ƒç”¨ã€‚<a target="_blank" rel="noopener" href="https://android.googlesource.com/kernel/common/%2B/a7827a2a60218b25f222b54f77ed38f57aebe08b/net/bridge/br_netfilter.c">Android Go Source</a></li>
<li>æŸ¥çœ‹ <code>skb-&gt;nf_bridge</code>ï¼ˆæˆ–è€…ç”¨ <code>skb-&gt;dev</code> æ˜¯å¦è¢«ä¿®æ”¹ä¸º bridge deviceï¼‰å¯ä»¥åˆ¤æ–­æ˜¯å¦æ˜¯è¢« bridge å¤„ç†è¿‡çš„åŒ…ã€‚<a target="_blank" rel="noopener" href="https://android.googlesource.com/kernel/common/%2B/a7827a2a60218b25f222b54f77ed38f57aebe08b/net/bridge/br_netfilter.c">Android Go Source</a></li>
</ul>
<hr>
<h1 id="å‚è€ƒï¼ˆä½ å¯ä»¥ç›´æ¥è¯»æºæ–‡ä»¶-å®˜æ–¹æ–‡æ¡£ï¼‰"><a href="#å‚è€ƒï¼ˆä½ å¯ä»¥ç›´æ¥è¯»æºæ–‡ä»¶-å®˜æ–¹æ–‡æ¡£ï¼‰" class="headerlink" title="å‚è€ƒï¼ˆä½ å¯ä»¥ç›´æ¥è¯»æºæ–‡ä»¶ &#x2F; å®˜æ–¹æ–‡æ¡£ï¼‰"></a>å‚è€ƒï¼ˆä½ å¯ä»¥ç›´æ¥è¯»æºæ–‡ä»¶ &#x2F; å®˜æ–¹æ–‡æ¡£ï¼‰</h1><ul>
<li>å†…æ ¸å®ç°ï¼š<code>net/bridge/br_netfilter.c</code>ï¼ˆå®ç°äº†ä¸Šé¢æ‰€æœ‰ <code>br_nf_pre_routing</code>ã€<code>br_nf_forward</code>ã€<code>ip_sabotage_in</code> ç­‰é€»è¾‘ï¼‰ã€‚è¿™ä»½æºç ç‰‡æ®µé‡Œæœ‰æ³¨é‡Šè¯´æ˜â€œæˆ‘ä»¬åœ¨ä¸Šè¡Œè·¯å¾„å·²ç»åšè¿‡ PRE_ROUTINGï¼Œæ‰€ä»¥è¦æ³¨å†Œä¸€ä¸ª PF_INET çš„ â€˜sabotageâ€™ hook æ¥é˜»æ­¢é‡å¤â€ã€‚<a target="_blank" rel="noopener" href="https://android.googlesource.com/kernel/common/%2B/a7827a2a60218b25f222b54f77ed38f57aebe08b/net/bridge/br_netfilter.c">Android Go Source</a></li>
<li>å®˜æ–¹æ–‡æ¡£ &#x2F; kernel docsï¼šEthernet Bridgingï¼ˆæè¿°äº† br_netfilter çš„é«˜å±‚è¯­ä¹‰ â€” â€œpretend packet is routed, call ip&#x2F;ipv6 netfilter hooksâ€ï¼‰ã€‚<a target="_blank" rel="noopener" href="https://docs.kernel.org/networking/bridge.html?utm_source=chatgpt.com">docs.kernel.org</a></li>
<li>è®ºæ–‡&#x2F;è®²ç¨¿ï¼šæœ‰å…³ bridge-to-nftables çš„è®¨è®ºï¼ˆè§£é‡Šä¸ºä»€ä¹ˆè¦åœ¨ bridge å±‚ä¸»åŠ¨è°ƒç”¨ iptables&#x2F;nftablesï¼‰ä¹Ÿå¾ˆæœ‰å¸®åŠ©ã€‚<a target="_blank" rel="noopener" href="https://netdevconf.info/1.1/proceedings/papers/Bridge-filter-with-nftables.pdf?utm_source=chatgpt.com">netdevconf.info</a></li>
</ul>
<hr>
<p>ğŸ‘‰â€œä¸€ä¸ª bridge æ”¶åˆ°åŒ…ï¼ˆè¿›å…¥ï¼‰ï¼Œå¦ä¸€ä¸ª bridge å‘å‡ºå»ï¼ˆè¾“å‡ºï¼‰â€â€”â€”å³ <strong>bridge â†’ IP å±‚ï¼ˆè·¯ç”±ï¼‰â†’ bridge</strong>ã€‚</p>
<p>é—®é¢˜å¯æ‹†æˆä¸‰æ®µï¼š</p>
<ol>
<li>åŒ…æ˜¯**å¦‚ä½•ä»ç¬¬ä¸€ä¸ªç½‘æ¡¥è¿›å…¥ç½‘ç»œå±‚ï¼ˆIP å±‚ï¼‰**çš„ï¼Ÿ</li>
<li>ç½‘ç»œå±‚ï¼ˆ<code>ip_rcv</code> ä¹‹åï¼‰æ˜¯<strong>æ€ä¹ˆåšè·¯ç”±å¹¶å†³å®šè¾“å‡ºæ¥å£æ˜¯å¦ä¸€ä¸ªç½‘æ¡¥çš„</strong>ï¼Ÿ</li>
<li>ç½‘ç»œå±‚è·¯ç”±å®Œæˆåï¼ŒåŒ…<strong>å¦‚ä½•â€œå›åˆ°â€å¦ä¸€ä¸ªç½‘æ¡¥å±‚ä¸­è¢«å‘å‡ºï¼Ÿ</strong></li>
</ol>
<hr>
<h2 id="ğŸ§©-ä¸€ã€åŒ…ä»ç¬¬ä¸€ä¸ªç½‘æ¡¥è¿›å…¥ç½‘ç»œå±‚çš„è¿‡ç¨‹"><a href="#ğŸ§©-ä¸€ã€åŒ…ä»ç¬¬ä¸€ä¸ªç½‘æ¡¥è¿›å…¥ç½‘ç»œå±‚çš„è¿‡ç¨‹" class="headerlink" title="ğŸ§© ä¸€ã€åŒ…ä»ç¬¬ä¸€ä¸ªç½‘æ¡¥è¿›å…¥ç½‘ç»œå±‚çš„è¿‡ç¨‹"></a>ğŸ§© ä¸€ã€åŒ…ä»ç¬¬ä¸€ä¸ªç½‘æ¡¥è¿›å…¥ç½‘ç»œå±‚çš„è¿‡ç¨‹</h2><h3 id="åœºæ™¯è®¾å®š"><a href="#åœºæ™¯è®¾å®š" class="headerlink" title="åœºæ™¯è®¾å®š"></a>åœºæ™¯è®¾å®š</h3><p>å‡è®¾ä½ æœ‰ï¼š</p>
<ul>
<li><p><code>br0</code>ï¼šä¸ŠæŒ‚æ¥å£ <code>eth0</code></p>
</li>
<li><p><code>br1</code>ï¼šä¸ŠæŒ‚æ¥å£ <code>eth1</code></p>
</li>
<li><p>è¿™ä¸¤è€…éƒ½é…ç½®äº† IPï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">br0: 192.168.10.1/24</span><br><span class="line">br1: 192.168.20.1/24</span><br></pre></td></tr></table></figure></li>
</ul>
<p>æŸå°ä¸»æœº A åœ¨ <code>br0</code> ä¸‹å‘äº†ä¸€ä¸ª IP åŒ…ï¼Œç›®æ ‡ IP æ˜¯ <code>192.168.20.123</code>ï¼ˆå±äº br1 ç½‘ç»œæ®µï¼‰ï¼Œæ­¤åŒ…åº”é€šè¿‡è·¯ç”±ä» br0 â†’ br1ã€‚</p>
<hr>
<h3 id="æµç¨‹-1ï¼šåŒ…è¿›å…¥ç¬¬ä¸€ä¸ª-bridge"><a href="#æµç¨‹-1ï¼šåŒ…è¿›å…¥ç¬¬ä¸€ä¸ª-bridge" class="headerlink" title="æµç¨‹ 1ï¼šåŒ…è¿›å…¥ç¬¬ä¸€ä¸ª bridge"></a>æµç¨‹ 1ï¼šåŒ…è¿›å…¥ç¬¬ä¸€ä¸ª bridge</h3><ul>
<li>NIC <code>eth0</code> æ”¶åˆ°åŒ…åè¿›å…¥ <code>napi_gro_receive</code> â†’ <code>__netif_receive_skb_core</code></li>
<li>å› ä¸º <code>eth0</code> æ˜¯ bridge portï¼Œå®ƒçš„ <code>rx_handler</code> è¢«è®¾ç½®ä¸º <code>br_handle_frame_hook</code></li>
<li>äºæ˜¯è°ƒç”¨ <code>br_handle_frame()</code> è¿›å…¥ bridge å­ç³»ç»Ÿ</li>
</ul>
<hr>
<h3 id="æµç¨‹-2ï¼šbridge-åˆ¤æ–­è¯¥åŒ…æ˜¯â€œå‘å¾€æœ¬æœºâ€è¿˜æ˜¯â€œè½¬å‘â€"><a href="#æµç¨‹-2ï¼šbridge-åˆ¤æ–­è¯¥åŒ…æ˜¯â€œå‘å¾€æœ¬æœºâ€è¿˜æ˜¯â€œè½¬å‘â€" class="headerlink" title="æµç¨‹ 2ï¼šbridge åˆ¤æ–­è¯¥åŒ…æ˜¯â€œå‘å¾€æœ¬æœºâ€è¿˜æ˜¯â€œè½¬å‘â€"></a>æµç¨‹ 2ï¼šbridge åˆ¤æ–­è¯¥åŒ…æ˜¯â€œå‘å¾€æœ¬æœºâ€è¿˜æ˜¯â€œè½¬å‘â€</h3><p><code>br_handle_frame()</code> ä¼šè°ƒç”¨ <code>br_handle_frame_finish()</code>ï¼Œå…¶ä¸­ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (br_should_route_hook(skb)) &#123;</span><br><span class="line">    /* è¿›å…¥æ¡¥çš„æœ¬æœºè·¯å¾„ï¼ˆä¸Šé€ç½‘ç»œå±‚ï¼‰ */</span><br><span class="line">    return br_pass_frame_up(skb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>å¦‚æœç›®æ ‡ MAC æ˜¯ bridge è‡ªå·±ï¼ˆæˆ–å¹¿æ’­&#x2F;ç»„æ’­ï¼‰ï¼Œbridge è®¤ä¸ºâ€œè¿™æ˜¯å‘ç»™æœ¬æœºçš„â€</li>
<li>è°ƒç”¨ <code>br_pass_frame_up()</code> â†’ <code>netif_rx(skb)</code> å°†åŒ…â€œä¸Šé€â€ç»™ä¸Šå±‚ï¼ˆç›¸å½“äºç½‘å¡æ”¶åˆ°äº†åŒ…ï¼‰</li>
<li>åŒæ—¶ï¼Œè¿™ä¸ªåŒ…çš„ <code>skb-&gt;dev</code> å·²è¢«æ”¹ä¸º <code>br0</code>ï¼ˆä¸æ˜¯ eth0ï¼‰</li>
</ul>
<p>è¿™å°±æ˜¯ä½ çœ‹åˆ°â€œbridge INPUT åä¼šä¸Šé€ç½‘ç»œå±‚â€çš„åŸå› ã€‚</p>
<hr>
<h2 id="ğŸ§©-äºŒã€åŒ…è¿›å…¥-IP-å±‚ã€è·¯ç”±æŸ¥æ‰¾"><a href="#ğŸ§©-äºŒã€åŒ…è¿›å…¥-IP-å±‚ã€è·¯ç”±æŸ¥æ‰¾" class="headerlink" title="ğŸ§© äºŒã€åŒ…è¿›å…¥ IP å±‚ã€è·¯ç”±æŸ¥æ‰¾"></a>ğŸ§© äºŒã€åŒ…è¿›å…¥ IP å±‚ã€è·¯ç”±æŸ¥æ‰¾</h2><p>ä¸Šé€åï¼ŒåŒ…é‡æ–°è¿›å…¥äº†ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__netif_receive_skb_core()</span><br><span class="line">  â””â”€â”€ deliver_ptype_list_skb()</span><br><span class="line">        â””â”€â”€ ip_rcv() ï¼ˆåŒ¹é…åˆ° ETH_P_IPï¼‰</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶ <code>dev = br0</code>ï¼Œå› æ­¤ <code>dev_net(dev)</code> æŒ‡å‘è¯¥ namespaceã€‚</p>
<hr>
<h3 id="ip-rcv-åšçš„äº‹"><a href="#ip-rcv-åšçš„äº‹" class="headerlink" title="ip_rcv() åšçš„äº‹"></a><code>ip_rcv()</code> åšçš„äº‹</h3><ol>
<li><p><code>ip_rcv_core()</code>ï¼šåŸºæœ¬æ£€æŸ¥ã€è§£å¤´</p>
</li>
<li><p>è°ƒç”¨ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">return NF_HOOK(NFPROTO_IPV4, NF_INET_PRE_ROUTING,</span><br><span class="line">               net, NULL, skb, dev, NULL, ip_rcv_finish);</span><br></pre></td></tr></table></figure></li>
</ol>
<p>æ­¤å¤„æ­£å¸¸æƒ…å†µä¸‹ä¼šæ‰§è¡Œ <strong>IPv4 PREROUTING é“¾</strong>ï¼ˆé™¤éè¢«æ¡¥å±‚çš„ sabotage hook å±è”½ï¼‰ã€‚</p>
<hr>
<h3 id="ip-rcv-finish"><a href="#ip-rcv-finish" class="headerlink" title="ip_rcv_finish()"></a><code>ip_rcv_finish()</code></h3><ul>
<li><p>åšè·¯ç”±æŸ¥æ‰¾ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip_route_input_noref(skb, iph-&gt;daddr, iph-&gt;saddr, iph-&gt;tos, skb-&gt;dev)</span><br></pre></td></tr></table></figure>

<p>â†’ å¾—åˆ° <code>skb_dst(skb)</code>ï¼Œå³è·¯ç”±è¾“å‡ºæ¥å£ä¿¡æ¯</p>
</li>
<li><p>å¦‚æœç›®çš„åœ°æ˜¯â€œæœ¬æœºâ€ï¼š<br>â†’ è°ƒç”¨ <code>ip_local_deliver()</code></p>
</li>
<li><p>å¦‚æœç›®çš„åœ°æ˜¯â€œå¦ä¸€æ¥å£â€ï¼š<br>â†’ è°ƒç”¨ <code>ip_forward()</code></p>
</li>
</ul>
<hr>
<h3 id="è¿™é‡Œçš„å…³é”®ï¼šè·¯ç”±è¡¨é¡¹"><a href="#è¿™é‡Œçš„å…³é”®ï¼šè·¯ç”±è¡¨é¡¹" class="headerlink" title="è¿™é‡Œçš„å…³é”®ï¼šè·¯ç”±è¡¨é¡¹"></a>è¿™é‡Œçš„å…³é”®ï¼šè·¯ç”±è¡¨é¡¹</h3><p>è·¯ç”±æŸ¥æ‰¾åå¦‚æœåŒ¹é…åˆ°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Destination: 192.168.20.0/24</span><br><span class="line">Output dev : br1</span><br><span class="line">Gateway    : &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆ <code>skb_dst(skb)</code> è®°å½•äº†è¾“å‡ºæ¥å£ä¸º <code>br1</code>ã€‚<br>åˆ°è¿™é‡Œâ€”â€”åŒ…<strong>ä»åœ¨ IP å±‚</strong>ï¼Œè¿˜æ²¡æœ‰å‡ºåˆ° bridgeã€‚</p>
<hr>
<h2 id="ğŸ§©-ä¸‰ã€åŒ…ä»-IP-å±‚è¿”å›åˆ°ç¬¬äºŒä¸ª-bridge-çš„è¿‡ç¨‹"><a href="#ğŸ§©-ä¸‰ã€åŒ…ä»-IP-å±‚è¿”å›åˆ°ç¬¬äºŒä¸ª-bridge-çš„è¿‡ç¨‹" class="headerlink" title="ğŸ§© ä¸‰ã€åŒ…ä» IP å±‚è¿”å›åˆ°ç¬¬äºŒä¸ª bridge çš„è¿‡ç¨‹"></a>ğŸ§© ä¸‰ã€åŒ…ä» IP å±‚è¿”å›åˆ°ç¬¬äºŒä¸ª bridge çš„è¿‡ç¨‹</h2><p>è¿™æ˜¯ä½ æœ€å›°æƒ‘çš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬æ…¢æ…¢è®²ã€‚</p>
<hr>
<h3 id="è·¯ç”±å†³å®šè¾“å‡º-br1-åï¼Œæ‰§è¡Œ-ip-forward"><a href="#è·¯ç”±å†³å®šè¾“å‡º-br1-åï¼Œæ‰§è¡Œ-ip-forward" class="headerlink" title="è·¯ç”±å†³å®šè¾“å‡º br1 åï¼Œæ‰§è¡Œ ip_forward()"></a>è·¯ç”±å†³å®šè¾“å‡º br1 åï¼Œæ‰§è¡Œ <code>ip_forward()</code></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">int ip_forward(struct sk_buff *skb)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    return NF_HOOK(NFPROTO_IPV4, NF_INET_FORWARD,</span><br><span class="line">                   net, NULL, skb, skb-&gt;dev, rt-&gt;dst.dev,</span><br><span class="line">                   ip_forward_finish);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸€æ­¥æ‰§è¡Œ <strong>FORWARD é“¾</strong>ã€‚</p>
<hr>
<h3 id="ip-forward-finish"><a href="#ip-forward-finish" class="headerlink" title="ip_forward_finish()"></a><code>ip_forward_finish()</code></h3><p>æœ€ç»ˆä¼šèµ°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip_output(skb);</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="ip-output-â†’-ip-finish-output2"><a href="#ip-output-â†’-ip-finish-output2" class="headerlink" title="ip_output() â†’ ip_finish_output2()"></a><code>ip_output()</code> â†’ <code>ip_finish_output2()</code></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dst_output(net, skb-&gt;sk, skb);</span><br></pre></td></tr></table></figure>

<p>è€Œ <code>dst_output()</code> è°ƒç”¨çš„å®é™…ä¸Šæ˜¯ <code>dst-&gt;output</code>ï¼Œ<br>å¯¹ä¸€èˆ¬è·¯ç”±æ˜¯ <code>ip_finish_output2()</code>ï¼Œè¯¥å‡½æ•°è°ƒç”¨ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">neigh_output(neigh, skb);</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="neigh-output-â†’-dev-queue-xmit"><a href="#neigh-output-â†’-dev-queue-xmit" class="headerlink" title="neigh_output() â†’ dev_queue_xmit()"></a><code>neigh_output()</code> â†’ <code>dev_queue_xmit()</code></h3><p>è¿™é‡Œ skb-&gt;dev æ˜¯ <strong>br1</strong>ã€‚</p>
<hr>
<h3 id="dev-queue-xmit-æ£€æŸ¥è®¾å¤‡ç±»å‹ï¼š"><a href="#dev-queue-xmit-æ£€æŸ¥è®¾å¤‡ç±»å‹ï¼š" class="headerlink" title="dev_queue_xmit() æ£€æŸ¥è®¾å¤‡ç±»å‹ï¼š"></a><code>dev_queue_xmit()</code> æ£€æŸ¥è®¾å¤‡ç±»å‹ï¼š</h3><ul>
<li><code>br1</code> æ˜¯ bridge ä¸»è®¾å¤‡ï¼Œå®ƒ<strong>ä¸æ˜¯ç‰©ç†ç½‘å¡</strong>ï¼Œæ‰€ä»¥ <code>br1-&gt;netdev_ops-&gt;ndo_start_xmit = br_dev_xmit</code></li>
<li>è°ƒç”¨ <code>br_dev_xmit(skb, br1)</code></li>
</ul>
<p>è¿™ä¸€æ­¥ï¼ŒåŒ…é‡æ–°è¿›å…¥ <strong>bridge å±‚çš„å‘é€è·¯å¾„</strong>ï¼</p>
<hr>
<h2 id="ğŸ§©-å››ã€è¿›å…¥ç¬¬äºŒä¸ª-bridge-å±‚çš„è¾“å‡ºå¤„ç†"><a href="#ğŸ§©-å››ã€è¿›å…¥ç¬¬äºŒä¸ª-bridge-å±‚çš„è¾“å‡ºå¤„ç†" class="headerlink" title="ğŸ§© å››ã€è¿›å…¥ç¬¬äºŒä¸ª bridge å±‚çš„è¾“å‡ºå¤„ç†"></a>ğŸ§© å››ã€è¿›å…¥ç¬¬äºŒä¸ª bridge å±‚çš„è¾“å‡ºå¤„ç†</h2><p><code>br_dev_xmit()</code> â†’ <code>br_forward_finish()</code> â†’ <code>br_forward()</code>ï¼š</p>
<ul>
<li><p>ä¼šåœ¨ bridge å±‚æŸ¥æ‰¾è½¬å‘è¡¨ï¼ˆFDBï¼‰</p>
</li>
<li><p>æ‰¾åˆ°ç›®æ ‡ MAC å¯¹åº”çš„ portï¼Œæ¯”å¦‚ <code>eth1</code></p>
</li>
<li><p>ç„¶åæŠŠåŒ…å‘é€åˆ°ç‰©ç†æ¥å£ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dev_queue_xmit(skb, eth1);</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ­¤æ—¶åŒ…è¢«çœŸæ­£å‘å‡ºã€‚</p>
</li>
</ul>
<hr>
<h2 id="ğŸ§©-äº”ã€å…³é”®è·¯å¾„æ€»ç»“ï¼ˆæ¡¥â€“è·¯ç”±â€“æ¡¥ï¼‰"><a href="#ğŸ§©-äº”ã€å…³é”®è·¯å¾„æ€»ç»“ï¼ˆæ¡¥â€“è·¯ç”±â€“æ¡¥ï¼‰" class="headerlink" title="ğŸ§© äº”ã€å…³é”®è·¯å¾„æ€»ç»“ï¼ˆæ¡¥â€“è·¯ç”±â€“æ¡¥ï¼‰"></a>ğŸ§© äº”ã€å…³é”®è·¯å¾„æ€»ç»“ï¼ˆæ¡¥â€“è·¯ç”±â€“æ¡¥ï¼‰</h2><h3 id="åŒ…ä»ç¬¬ä¸€ä¸ªç½‘æ¡¥ï¼ˆbr0ï¼‰è¿›å…¥"><a href="#åŒ…ä»ç¬¬ä¸€ä¸ªç½‘æ¡¥ï¼ˆbr0ï¼‰è¿›å…¥" class="headerlink" title="åŒ…ä»ç¬¬ä¸€ä¸ªç½‘æ¡¥ï¼ˆbr0ï¼‰è¿›å…¥"></a>åŒ…ä»ç¬¬ä¸€ä¸ªç½‘æ¡¥ï¼ˆbr0ï¼‰è¿›å…¥</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">eth0 -&gt; br_handle_frame() -&gt; br_pass_frame_up() </span><br><span class="line">      -&gt; netif_rx() -&gt; __netif_receive_skb_core()</span><br></pre></td></tr></table></figure>

<h3 id="è¿›å…¥-IP-å±‚ï¼ˆè·¯ç”±ï¼‰"><a href="#è¿›å…¥-IP-å±‚ï¼ˆè·¯ç”±ï¼‰" class="headerlink" title="è¿›å…¥ IP å±‚ï¼ˆè·¯ç”±ï¼‰"></a>è¿›å…¥ IP å±‚ï¼ˆè·¯ç”±ï¼‰</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip_rcv() -&gt; ip_rcv_finish() -&gt; ip_route_input() </span><br><span class="line">          -&gt; ip_forward() -&gt; ip_forward_finish()</span><br></pre></td></tr></table></figure>

<h3 id="è¾“å‡ºåˆ°ç¬¬äºŒä¸ªç½‘æ¡¥ï¼ˆbr1ï¼‰"><a href="#è¾“å‡ºåˆ°ç¬¬äºŒä¸ªç½‘æ¡¥ï¼ˆbr1ï¼‰" class="headerlink" title="è¾“å‡ºåˆ°ç¬¬äºŒä¸ªç½‘æ¡¥ï¼ˆbr1ï¼‰"></a>è¾“å‡ºåˆ°ç¬¬äºŒä¸ªç½‘æ¡¥ï¼ˆbr1ï¼‰</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip_output() -&gt; dev_queue_xmit() </span><br><span class="line">             -&gt; br_dev_xmit() -&gt; br_forward() -&gt; eth1</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="ğŸ§©-å…­ã€Netfilter-hook-è¦†ç›–ç‚¹æ€»ç»“"><a href="#ğŸ§©-å…­ã€Netfilter-hook-è¦†ç›–ç‚¹æ€»ç»“" class="headerlink" title="ğŸ§© å…­ã€Netfilter hook è¦†ç›–ç‚¹æ€»ç»“"></a>ğŸ§© å…­ã€Netfilter hook è¦†ç›–ç‚¹æ€»ç»“</h2><table>
<thead>
<tr>
<th>é˜¶æ®µ</th>
<th>Hook family</th>
<th>Hook ç‚¹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>br0 æ¥æ”¶</td>
<td>PF_BRIDGE</td>
<td>NF_BR_PRE_ROUTING</td>
<td>bridge å±‚ PRE_ROUTING</td>
</tr>
<tr>
<td>IP å…¥æ ˆ</td>
<td>PF_INET</td>
<td>NF_INET_PRE_ROUTING</td>
<td>ï¼ˆè‹¥æœªè¢« sabotage é˜»æ­¢ï¼‰</td>
</tr>
<tr>
<td>è·¯ç”±è½¬å‘</td>
<td>PF_INET</td>
<td>NF_INET_FORWARD</td>
<td>æ­£å¸¸ IP å±‚ FORWARD</td>
</tr>
<tr>
<td>IP å‡ºæ ˆ</td>
<td>PF_INET</td>
<td>NF_INET_POST_ROUTING</td>
<td>å‡ºå£è·¯ç”±</td>
</tr>
<tr>
<td>br1 å‘å‡º</td>
<td>PF_BRIDGE</td>
<td>NF_BR_FORWARD &#x2F; NF_BR_POST_ROUTING</td>
<td>bridge è¾“å‡ºæ–¹å‘çš„ hook</td>
</tr>
</tbody></table>
<p>å› æ­¤ï¼Œ<strong>ä» bridge åˆ° bridge</strong> çš„æ•´ä¸ªè¿‡ç¨‹å…¶å®ç©¿è¶Šäº†ï¼š</p>
<blockquote>
<p>bridge PRE â†’ IP PRE â†’ IP FWD â†’ IP POST â†’ bridge FWD â†’ bridge POST</p>
</blockquote>
<p>ï¼ˆå…¶ä¸­ PRE å¯èƒ½éƒ¨åˆ†è¢« shortcut&#x2F;sabotage é¿å…é‡å¤ã€‚ï¼‰</p>
<hr>
<h2 id="ğŸ§©-ä¸ƒã€ä¸ºä»€ä¹ˆçœ‹èµ·æ¥â€œå¥½åƒè¿”å›-bridge-äº†ä½†æ²¡å†ä»å¤´èµ°â€"><a href="#ğŸ§©-ä¸ƒã€ä¸ºä»€ä¹ˆçœ‹èµ·æ¥â€œå¥½åƒè¿”å›-bridge-äº†ä½†æ²¡å†ä»å¤´èµ°â€" class="headerlink" title="ğŸ§© ä¸ƒã€ä¸ºä»€ä¹ˆçœ‹èµ·æ¥â€œå¥½åƒè¿”å› bridge äº†ä½†æ²¡å†ä»å¤´èµ°â€"></a>ğŸ§© ä¸ƒã€ä¸ºä»€ä¹ˆçœ‹èµ·æ¥â€œå¥½åƒè¿”å› bridge äº†ä½†æ²¡å†ä»å¤´èµ°â€</h2><p>å› ä¸ºå½“åŒ…åœ¨ç¬¬äºŒä¸ª bridge è¾“å‡ºæ—¶ï¼š</p>
<ul>
<li>å®ƒæ˜¯â€œè·¯ç”±å±‚å‘å¾€ br1 çš„åŒ…â€ï¼Œä¸æ˜¯â€œä»ç‰©ç†å£æ¥æ”¶çš„åŒ…â€ï¼Œ<br>æ‰€ä»¥ä¸ç»è¿‡ <code>rx_handler</code>ï¼Œè€Œæ˜¯ç›´æ¥èµ° bridge çš„ <strong>å‘é€è·¯å¾„</strong>ï¼ˆ<code>br_dev_xmit</code>ï¼‰ã€‚</li>
<li>bridge è¾“å‡ºæ–¹å‘ä¹Ÿæœ‰è‡ªå·±çš„ netfilter hookï¼ˆ<code>NF_BR_FORWARD</code> &#x2F; <code>NF_BR_POST_ROUTING</code>ï¼‰ï¼Œ<br>æ‰€ä»¥å¦‚æœä½ åœ¨æ¡¥çš„è¾“å‡ºé’©å­æŒ‚ç‚¹ç›‘æ§ï¼Œä¹Ÿèƒ½çœ‹åˆ°ã€‚</li>
</ul>
<hr>
<h2 id="ğŸ§©-å…«ã€æ€»ç»“ä¸€å¥è¯"><a href="#ğŸ§©-å…«ã€æ€»ç»“ä¸€å¥è¯" class="headerlink" title="ğŸ§© å…«ã€æ€»ç»“ä¸€å¥è¯"></a>ğŸ§© å…«ã€æ€»ç»“ä¸€å¥è¯</h2><blockquote>
<p>â€œä»ä¸€ä¸ª bridge è¿›å…¥ï¼Œå¦ä¸€ä¸ª bridge å‘å‡ºâ€çš„è¿‡ç¨‹ï¼Œæœ¬è´¨ä¸Šæ˜¯ï¼š</p>
<ul>
<li>ç¬¬ä¸€ä¸ª bridge å½“ä½œæ¥æ”¶æ¥å£ï¼ŒæŠŠåŒ…ä¸Šé€ç½‘ç»œå±‚ï¼›</li>
<li>ç½‘ç»œå±‚åšä¸€æ¬¡æ­£å¸¸è·¯ç”±æŸ¥è¡¨ï¼Œè¾“å‡ºè®¾å¤‡æ˜¯ç¬¬äºŒä¸ª bridgeï¼›</li>
<li>åŒ…ç»ç”±ç¬¬äºŒä¸ª bridge çš„å‘é€è·¯å¾„å‘å‡ºï¼›</li>
<li>ä¸­é—´æ‰€æœ‰ netfilter é’©å­éƒ½æŒ‰å„è‡ªæ—ï¼ˆPF_BRIDGE &#x2F; PF_INETï¼‰æ‰§è¡Œï¼›</li>
<li>PREROUTING ä¸ä¼šé‡å¤ï¼Œå› ä¸º br_netfilter è®¾ç½®äº†æ ‡å¿—å’Œ sabotage hookã€‚</li>
</ul>
</blockquote>
<hr>
<h6 id="-2"><a href="#-2" class="headerlink" title=""></a></h6><p>ä¸‹é¢æŠŠ <strong>â€œä»ç‰©ç†æ¥æ”¶ â†’ br æ¥æ”¶ â†’ IP å±‚ï¼ˆè·¯ç”±ï¼‰â†’ å‘å¾€å¦ä¸€ä¸ª br â†’ ç‰©ç†å‘å‡ºâ€</strong> çš„<strong>å‡½æ•°è°ƒç”¨ï¼ˆcall stack &#x2F; é€’å½’ï¼‰è¿‡ç¨‹</strong>ä¸€æ­¥æ­¥åˆ—æ¸…æ¥šï¼Œå°½é‡åšåˆ°é€å±‚å±•å¼€ã€æ ‡æ³¨åœ¨å“ªå„¿ä¼šè§¦å‘ netfilter hookã€åœ¨å“ªå„¿ä¿®æ”¹ <code>skb-&gt;dev</code>ã€ä»¥åŠå“ªäº›ç‚¹å¯èƒ½çœ‹èµ·æ¥åƒâ€œé€’å½’â€ã€‚æˆ‘æŠŠä¸»è·¯å¾„åˆ†æˆä¸¤å¤§æ®µï¼š<strong>æ¥æ”¶&#x2F;ä¸Šé€ï¼ˆingressï¼‰é“¾</strong> å’Œ <strong>å‘é€&#x2F;ä¸‹å‘ï¼ˆegressï¼‰é“¾</strong>ï¼Œæ¯æ­¥å†™å‡ºå…¸å‹å†…æ ¸å‡½æ•°åï¼ˆä»¥ Linux ä¸»çº¿å¸¸è§å®ç°ä¸ºå‡†ï¼‰ã€‚å¦‚æœä½ ä»¥åçœ‹æºç å°±èƒ½æŒ‰è¿™äº›åå­—å» grepã€‚</p>
<hr>
<h1 id="æ¦‚è§ˆï¼ˆä¸€å¥è¯ï¼‰"><a href="#æ¦‚è§ˆï¼ˆä¸€å¥è¯ï¼‰" class="headerlink" title="æ¦‚è§ˆï¼ˆä¸€å¥è¯ï¼‰"></a>æ¦‚è§ˆï¼ˆä¸€å¥è¯ï¼‰</h1><p>ç‰©ç† NIC æ”¶åŒ… â†’ <code>br_handle_frame()</code>ï¼ˆbridge å¤„ç†ã€å¯èƒ½ä¸Šé€ï¼‰â†’ <code>__netif_receive_skb_core()</code>â†’ <code>deliver_ptype_list_skb()</code>â†’ <code>ip_rcv()</code> â†’ è·¯ç”±æŸ¥è¡¨ â†’ <code>ip_forward()</code> â†’ <code>ip_output()</code> â†’ <code>dev_queue_xmit()</code>ï¼ˆè¾“å‡º dev &#x3D; ç›®æ ‡ bridgeï¼‰â†’ <code>br_dev_xmit()</code> â†’ <code>br_forward()</code> â†’ æ‰¾åˆ°ç›®æ ‡ port â†’ <code>dev_queue_xmit()</code>ï¼ˆè¾“å‡º dev &#x3D; ç‰©ç† portï¼‰â†’ ç‰©ç†ç½‘å¡çš„ <code>ndo_start_xmit</code> å‘å‡ºã€‚ä¸­é—´åœ¨å¤šä¸ªç‚¹è§¦å‘ PF_BRIDGE &#x2F; PF_INET çš„ netfilter hookã€‚</p>
<hr>
<h1 id="è¯¦ç»†è°ƒç”¨åºåˆ—ï¼ˆä¸»è½¬å‘è·¯å¾„ï¼šbr0-ip-br1-eth1ï¼‰"><a href="#è¯¦ç»†è°ƒç”¨åºåˆ—ï¼ˆä¸»è½¬å‘è·¯å¾„ï¼šbr0-ip-br1-eth1ï¼‰" class="headerlink" title="è¯¦ç»†è°ƒç”¨åºåˆ—ï¼ˆä¸»è½¬å‘è·¯å¾„ï¼šbr0 -&gt; ip -&gt; br1 -&gt; eth1ï¼‰"></a>è¯¦ç»†è°ƒç”¨åºåˆ—ï¼ˆä¸»è½¬å‘è·¯å¾„ï¼šbr0 -&gt; ip -&gt; br1 -&gt; eth1ï¼‰</h1><p>ä¸‹é¢åˆ—è¡¨ä¸ºâ€œä»ä¸Šåˆ°ä¸‹â€çš„è°ƒç”¨é¡ºåºï¼Œç¼©è¿›è¡¨ç¤ºè°ƒç”¨å…³ç³»ã€‚æ³¨é‡Šæ ‡æ˜ netfilter hook ç‚¹å’Œå…³é”®çŠ¶æ€å˜åŒ–ï¼ˆå¦‚ä¿®æ”¹ <code>skb-&gt;dev</code>ï¼‰ã€‚</p>
<ol>
<li>NIC æ¥æ”¶ â€” NAPI &#x2F; RX pathï¼ˆå†…æ ¸å…¥å£ï¼‰<ul>
<li><code>napi_gro_receive()</code> &#x2F; <code>netif_receive_skb()</code> &#x2F; <code>__netif_receive_skb_core()</code><br>ï¼ˆè¿™æ˜¯æœ€åˆçš„æ¥æ”¶å…¥å£ï¼›skb-&gt;dev åˆä¸º <code>eth0</code>ï¼‰</li>
</ul>
</li>
<li>RX handlerï¼ˆbridge port ä¼šç”¨ rx_handlerï¼‰<ul>
<li><code>rcu_dereference(skb-&gt;dev-&gt;rx_handler)</code> -&gt; <code>br_handle_frame_hook()</code> -&gt; <code>br_handle_frame()</code><br>ï¼ˆbridge port çš„æ¥æ”¶å¤„ç†ï¼›<strong>è¿™é‡Œé€šå¸¸æŠŠ skb-&gt;dev æ”¹ä¸º bridge è®¾å¤‡ <code>br0</code></strong> æˆ–åœ¨åç»­ä¸Šé€æ—¶æ”¹ï¼›å¦‚æœæ²¡æœ‰æ¡¥åˆ™ç»§ç»­æ™®é€šè·¯å¾„ï¼‰</li>
<li><code>br_handle_frame()</code> å†…éƒ¨ï¼š<ul>
<li><code>br_handle_frame_one()</code> &#x2F; <code>br_handle_frame_finish()</code>ï¼ˆæŸ¥ FDBã€å†³å®šè½¬å‘&#x2F;ä¸Šé€ï¼‰</li>
<li>å¦‚æœéœ€è¦ä¸Šé€ç½‘ç»œå±‚ï¼ˆç›®æ ‡ IP å±äºæœ¬æœºç½‘ç»œ &#x2F; éœ€è¦è·¯ç”±ï¼‰ï¼šè°ƒç”¨ <code>br_pass_frame_up()</code> &#x2F; <code>br_accept()</code> ç­‰ï¼Œæœ€ç»ˆè°ƒç”¨ï¼š<ul>
<li><code>netif_rx(skb)</code> æˆ– <code>netif_rx_ni(skb)</code> â†’ å›åˆ° <code>__netif_receive_skb_core()</code> çš„ä¸Šå±‚å¤„ç†ï¼ˆæ³¨æ„ï¼šæ­¤æ—¶ <code>skb-&gt;dev</code> å·²å˜ä¸º <code>br0</code>ï¼‰</li>
</ul>
</li>
</ul>
</li>
<li><strong>PF_BRIDGE PRE_ROUTING hook</strong>ï¼ˆè‹¥ br_netfilter å¯ç”¨ï¼‰åœ¨ bridge å±‚ä¼šè¢«è°ƒç”¨ï¼š<code>br_nf_pre_routing()</code>ï¼ˆè¿™é‡Œ bridge ä¼šä¸»åŠ¨è§¦å‘ NF_INET_PRE_ROUTING çš„ä¸€æ¬¡è°ƒç”¨ï¼Œå¹¶è®¾ç½® <code>skb-&gt;nf_bridge</code> æ ‡å¿—ï¼‰</li>
</ul>
</li>
<li>deliver by protocol type<ul>
<li><code>__netif_receive_skb_core()</code> -&gt; <code>deliver_ptype_list_skb(skb, &amp;pt_prev, orig_dev, type, &amp;orig_dev-&gt;ptype_specific)</code><br>ï¼ˆè¿™é‡Œæ ¹æ® <code>skb-&gt;protocol</code> é€‰æ‹©å¯¹åº”çš„ä¸Šå±‚å¤„ç†å‡½æ•°ï¼Œè‹¥ IP åˆ™èµ° ip_rcvï¼‰</li>
</ul>
</li>
<li>IP æ¥æ”¶å…¥å£<ul>
<li><code>ip_rcv(struct sk_buff *skb, struct net_device *dev, struct packet_type *pt, struct net_device *orig_dev)</code><ul>
<li><code>ip_rcv_core()</code>ï¼ˆIP æŠ¥æ–‡åŸºç¡€æ ¡éªŒã€è§£ç‰‡ç­‰ï¼‰</li>
<li><code>NF_HOOK(NFPROTO_IPV4, NF_INET_PRE_ROUTING, ...)</code> â†’ æ‰§è¡Œ PRE_ROUTING é“¾ï¼ˆæ³¨æ„ï¼šå¦‚æœ bridge å·²åœ¨ä¸Šé¢ä¸»åŠ¨è°ƒç”¨å¹¶è®¾ç½®äº†æ ‡å¿—ï¼Œå†…æ ¸é‡Œæœ‰ <code>ip_sabotage_in</code> hook ä¼šé˜»æ­¢é‡å¤ï¼‰</li>
</ul>
</li>
</ul>
</li>
<li>è·¯ç”±æŸ¥æ‰¾ &#x2F; å†³ç­–<ul>
<li><code>ip_rcv_finish()</code>ï¼ˆfinish callbackï¼‰&#x2F; <code>ip_rcv_core()</code> ä¸­å¯èƒ½ä¼šè°ƒç”¨ï¼š<ul>
<li><code>ip_route_input_noref()</code> æˆ– <code>ip_route_output_key()</code> ç­‰ â†’ å¾—åˆ° <code>struct rtable/ dst</code>ï¼ˆä¿å­˜åœ¨ skb çš„ dstï¼‰</li>
</ul>
</li>
<li>æ ¹æ®è·¯ç”±ç»“æœï¼šè‹¥éœ€è¦è½¬å‘åˆ°åˆ«çš„æ¥å£åˆ™è¿›å…¥ <code>ip_forward()</code>ï¼Œè‹¥æ˜¯æœ¬åœ°åˆ™ <code>ip_local_deliver()</code>ã€‚</li>
<li><strong>NF_INET_FORWARD</strong> hook åœ¨ <code>ip_forward()</code> ä¸­è¢«è°ƒç”¨ï¼ˆå¦‚æœè¦è½¬å‘ï¼‰ã€‚</li>
</ul>
</li>
<li>IP è¾“å‡º &#x2F; å‘é€å‡†å¤‡<ul>
<li>åœ¨ <code>ip_forward_finish()</code> æˆ– <code>ip_output()</code> è·¯å¾„ä¸­ï¼Œæœ€ç»ˆè°ƒç”¨ï¼š<ul>
<li><code>ip_finish_output2()</code> &#x2F; <code>ip_finish_output()</code> â†’ <code>dst_output()</code>ï¼ˆæ ¹æ® dst-&gt;outputï¼‰</li>
</ul>
</li>
<li><code>dst_output()</code> è°ƒç”¨ <code>dst-&gt;output(...)</code> -&gt; é€šå¸¸è§¦å‘ <code>neigh_output()</code> -&gt; <code>neigh-&gt;output</code> -&gt; <code>neigh_output()</code> ä¸­ä¼šå‡†å¤‡ ARP&#x2F;next-hopï¼Œç„¶åè°ƒç”¨ï¼š<ul>
<li><code>dev_queue_xmit(skb)</code>ï¼ˆè¿™é‡Œ skb-&gt;dev ä¸ºè·¯ç”±æŸ¥åˆ°çš„è¾“å‡º deviceï¼Œ<strong>å¦‚æœè·¯ç”±è¡¨é¡¹ä¸Šå†™çš„æ˜¯ br1ï¼Œé‚£ä¹ˆ skb-&gt;dev &#x3D; br1</strong>ï¼‰</li>
</ul>
</li>
<li>åœ¨è¿™ä¸€é˜¶æ®µï¼Œä¹Ÿä¼šè§¦å‘ NF_INET_POST_ROUTINGï¼ˆåœ¨ ip_finish_output2 ç­‰ç‚¹ï¼‰</li>
</ul>
</li>
<li><code>dev_queue_xmit()</code>ï¼ˆå‘åŒ…å…¥å£ï¼‰<ul>
<li><code>dev_queue_xmit(skb)</code> ä¼šåšé˜Ÿåˆ—&#x2F;è½¯ä¸­æ–­å¤„ç†ï¼Œç„¶åè°ƒç”¨è®¾å¤‡çš„ transmit å›è°ƒï¼š<ul>
<li><code>dev-&gt;netdev_ops-&gt;ndo_start_xmit(skb, dev)</code></li>
<li>å¯¹äº bridge ä¸»è®¾å¤‡ <code>br1</code>ï¼Œ<code>ndo_start_xmit</code> å®é™…æŒ‡å‘ <code>br_dev_xmit()</code></li>
</ul>
</li>
</ul>
</li>
<li>è¿›å…¥ bridge çš„å‘é€è·¯å¾„ï¼ˆbr1ï¼‰<ul>
<li><code>br_dev_xmit(struct sk_buff *skb, struct net_device *dev)</code><ul>
<li>è¿™é‡Œä¼šæŠŠ skb äº¤å› bridge å­ç³»ç»Ÿå¤„ç†è¾“å‡ºæ–¹å‘ï¼ˆbr çš„ forwarding logicï¼‰ï¼Œå¹¶è§¦å‘ PF_BRIDGE çš„ FORWARD&#x2F;POST_ROUTING hooksï¼ˆä¾‹å¦‚ <code>NF_BR_FORWARD</code> &#x2F; <code>NF_BR_POST_ROUTING</code>ï¼‰</li>
<li><code>br_dev_xmit()</code> â†’ <code>br_forward_finish()</code> â†’ <code>br_forward()</code>ï¼ˆå®é™…æŸ¥æ‰¾ FDBï¼‰</li>
<li><code>br_forward()</code> ä¼šå†³å®šç›®æ ‡ portï¼ˆæ¯”å¦‚ <code>eth1</code>ï¼‰<ul>
<li>è‹¥ç›®æ ‡ port å°±æ˜¯æœ¬æœºçš„æŸä¸ªæ¥å£ï¼Œåˆ™æœ€ç»ˆè°ƒç”¨ <code>dev_queue_xmit(skb_out, out_dev)</code>ï¼Œæ³¨æ„è¿™æ¬¡ <code>out_dev</code> &#x3D; <code>eth1</code>ï¼ˆç‰©ç†ç½‘å¡ï¼‰ï¼Œå¹¶ä¸”å¯èƒ½ä¿®æ”¹ <code>skb-&gt;dev</code> ä¸º <code>eth1</code> æˆ–åˆ›å»ºæ–°çš„ skb&#x2F;clone å‘é€ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>ç‰©ç†ç½‘å¡å‘å‡º<ul>
<li><code>dev_queue_xmit()</code> -&gt; <code>ndo_start_xmit()</code>ï¼ˆeth1 çš„é©±åŠ¨å®ç°ï¼‰ -&gt; ç½‘å¡ DMA å‘å¸§ç¦»å¼€ä¸»æœºã€‚</li>
</ul>
</li>
</ol>
<hr>
<h1 id="é€’å½’-å¾ªç¯ç‚¹ï¼ˆå®¹æ˜“è®©äººè¯¯è®¤ä¸ºâ€œæ·±é€’å½’â€çš„åœ°æ–¹ï¼‰"><a href="#é€’å½’-å¾ªç¯ç‚¹ï¼ˆå®¹æ˜“è®©äººè¯¯è®¤ä¸ºâ€œæ·±é€’å½’â€çš„åœ°æ–¹ï¼‰" class="headerlink" title="é€’å½’&#x2F;å¾ªç¯ç‚¹ï¼ˆå®¹æ˜“è®©äººè¯¯è®¤ä¸ºâ€œæ·±é€’å½’â€çš„åœ°æ–¹ï¼‰"></a>é€’å½’&#x2F;å¾ªç¯ç‚¹ï¼ˆå®¹æ˜“è®©äººè¯¯è®¤ä¸ºâ€œæ·±é€’å½’â€çš„åœ°æ–¹ï¼‰</h1><ul>
<li><strong><code>netif_receive_skb</code> â†” <code>dev_queue_xmit</code> å›è·¯</strong>ï¼šåœ¨ loopback æˆ–æŸäº›è®¾å¤‡&#x2F;æ¡¥é…ç½®ï¼ˆhairpinã€æ¡¥ä¸Šåš mirrorï¼‰å¯èƒ½ä¼šå‘ç”Ÿ dev_queue_xmit å†æ¬¡äº§ç”Ÿ netif_receive è·¯å¾„çš„æƒ…å½¢ï¼Œé€ æˆçœ‹èµ·æ¥åƒâ€œé€’å½’â€ã€‚ä½†ä¸€èˆ¬ç®€å•è½¬å‘è·¯å¾„æ˜¯å•å‘ï¼šrx -&gt; ip -&gt; dev_queue_xmit -&gt; br_dev_xmit -&gt; dev_queue_xmit(phys) -&gt; hwã€‚</li>
<li><strong>bridge çš„ rx_handler ä¸ dev_queue_xmit</strong>ï¼šbridge åœ¨æ¥æ”¶æ—¶ç”¨ rx_handler æ¥ç®¡ï¼ˆæ›¿æ¢ skb-&gt;devï¼‰ï¼Œä½† dev_queue_xmit å‘å‡ºåˆ°ä¸€ä¸ª bridgeï¼ˆbr1ï¼‰å¹¶ä¸ä¼šå†è§¦å‘ rx_handlerï¼ˆå› ä¸ºé‚£æ˜¯è¾“å‡ºï¼Œä¸æ˜¯ç‰©ç†æ¥æ”¶ï¼‰ï¼Œæ‰€ä»¥ä¸ä¼šåœ¨è¾“å‡ºæ—¶é‡å¤ rx_handlerã€‚</li>
<li><strong>netfilter hook å›è°ƒæµç¨‹</strong>ï¼šNF_HOOK ä¼šè°ƒç”¨æ³¨å†Œçš„ callbackï¼Œcallback é‡Œåˆå¯èƒ½ä¿®æ”¹ skb å¹¶é‡æ–°è°ƒç”¨å†…æ ¸å‘é€ï¼ˆä¾‹å¦‚ DNAT åé‡å†™ dst å¹¶è°ƒç”¨ ip_local_out ç­‰ï¼‰ï¼Œè¿™çœ‹èµ·æ¥ä¹Ÿåƒâ€œåµŒå¥—è°ƒç”¨â€ã€‚ä½†é€šå¸¸è¿™äº›æ˜¯ç”± hook çš„ finish callback æˆ–è°ƒç”¨é“¾ç»§ç»­å‰è¿›ï¼Œå¹¶éæ— é™é€’å½’ã€‚</li>
<li><strong>ip_local_deliver -&gt; local_output</strong>ï¼ˆæœ¬åœ°å‘é€çš„ç‰¹æ®Šæƒ…å†µï¼‰ï¼šå¦‚æœåŒ…è¢«æœ¬æœºå¤„ç†å¹¶éœ€è¦é‡æ–°å‘å‡ºï¼ˆä¾‹å¦‚æŸäº›æœ¬åœ°è¿›ç¨‹ç”Ÿæˆå“åº”ï¼‰ï¼Œä¼šå‡ºç° <code>ip_local_out()</code> -&gt; <code>ip_output()</code> çš„è·¯å¾„ï¼Œè¿™ä¼šå½¢æˆä»ç½‘ç»œå±‚å†æ¬¡å›åˆ°è¾“å‡ºè·¯å¾„çš„â€œå†å…¥â€ç°è±¡ï¼ˆä½†æ˜¯è¿™æ˜¯æ­£å¸¸çš„è¯·æ±‚&#x2F;å“åº”æµç¨‹ï¼Œè€Œéæ— é™é€’å½’ï¼‰ã€‚</li>
</ul>
<hr>
<h1 id="å“ªäº›å‡½æ•°ä¼šä¿®æ”¹-skb-devï¼ˆå¿…é¡»å…³æ³¨ï¼‰"><a href="#å“ªäº›å‡½æ•°ä¼šä¿®æ”¹-skb-devï¼ˆå¿…é¡»å…³æ³¨ï¼‰" class="headerlink" title="å“ªäº›å‡½æ•°ä¼šä¿®æ”¹ skb-&gt;devï¼ˆå¿…é¡»å…³æ³¨ï¼‰"></a>å“ªäº›å‡½æ•°ä¼šä¿®æ”¹ <code>skb-&gt;dev</code>ï¼ˆå¿…é¡»å…³æ³¨ï¼‰</h1><ul>
<li><code>br_handle_frame()</code> &#x2F; <code>br_pass_frame_up()</code>ï¼šæŠŠåŸç‰©ç† devï¼ˆeth0ï¼‰è½¬æ¢ä¸º bridgeï¼ˆbr0ï¼‰ç”¨äºä¸Šé€ã€‚</li>
<li>è·¯ç”±æŸ¥è¡¨&#x2F;è¾“å‡ºå‡†å¤‡é˜¶æ®µä¼šè®¾ç½® skb çš„è¾“å‡º devï¼ˆé€šè¿‡ <code>rt-&gt;dst.dev</code> ä¸ <code>skb-&gt;dev = out_dev</code> åœ¨è¿›å…¥ <code>dev_queue_xmit</code> å‰æˆ–åœ¨ <code>neigh_output</code> ä¸­è®¾å®šï¼‰ã€‚</li>
<li><code>br_dev_xmit()</code> åœ¨å¤„ç†æ—¶å¯èƒ½æŠŠ skb æŒ‡å‘æœ€ç»ˆçš„ out_devï¼ˆeth1ï¼‰æˆ– clone skb å¹¶æ”¹ <code>skb-&gt;dev</code>ã€‚</li>
<li>æ³¨æ„ï¼š<code>rx_handler</code> æ›¿æ¢åªåœ¨æ¥æ”¶è·¯å¾„è¢«è°ƒç”¨ä¸€æ¬¡ï¼›å½“ skb ç”± IP å±‚å†è¿›å…¥ dev_queue_xmit æŒ‡å‘ br1 æ—¶ï¼Œå¹¶ä¸ä¼šå†è§¦å‘ eth1 çš„ rx_handlerï¼Œé™¤éç‰©ç†ç½‘å¡çœŸæ­£æ¥æ”¶ï¼ˆloopback æˆ–é•œåƒä¾‹å¤–ï¼‰ã€‚</li>
</ul>
<hr>
<h1 id="netfilter-hook-å‡ºç°åœ¨å“ªäº›å‡½æ•°-ä½ç½®ï¼ˆä¾¿äºä½ æ’æ¡©è§‚å¯Ÿï¼‰"><a href="#netfilter-hook-å‡ºç°åœ¨å“ªäº›å‡½æ•°-ä½ç½®ï¼ˆä¾¿äºä½ æ’æ¡©è§‚å¯Ÿï¼‰" class="headerlink" title="netfilter hook å‡ºç°åœ¨å“ªäº›å‡½æ•°&#x2F;ä½ç½®ï¼ˆä¾¿äºä½ æ’æ¡©è§‚å¯Ÿï¼‰"></a>netfilter hook å‡ºç°åœ¨å“ªäº›å‡½æ•°&#x2F;ä½ç½®ï¼ˆä¾¿äºä½ æ’æ¡©è§‚å¯Ÿï¼‰</h1><ul>
<li><code>br_netfilter</code> ç›¸å…³ï¼š<ul>
<li>PF_BRIDGE <code>NF_BR_PRE_ROUTING</code> â€” åœ¨ <code>br_handle_frame()</code> &#x2F; <code>br_nf_pre_routing()</code> è¢«è§¦å‘</li>
<li>PF_BRIDGE <code>NF_BR_FORWARD</code> &#x2F; <code>NF_BR_POST_ROUTING</code> â€” åœ¨ <code>br_forward()</code> &#x2F; <code>br_dev_xmit()</code> è·¯å¾„ä¸­</li>
</ul>
</li>
<li>IPv4 ç›¸å…³ï¼š<ul>
<li><code>NF_INET_PRE_ROUTING</code> â€” åœ¨ <code>ip_rcv()</code> ä¸­ï¼ˆæˆ–è¢« br_netfilter é¢„å…ˆè°ƒç”¨ï¼‰</li>
<li><code>NF_INET_FORWARD</code> â€” åœ¨ <code>ip_forward()</code> ä¸­</li>
<li><code>NF_INET_POST_ROUTING</code> â€” åœ¨ <code>ip_finish_output*()</code> &#x2F; <code>dst_output()</code> è·¯å¾„ä¸­</li>
</ul>
</li>
</ul>
<hr>
<h1 id="å°ç»“ï¼ˆæ€ä¹ˆè¯»æºç -traceï¼‰"><a href="#å°ç»“ï¼ˆæ€ä¹ˆè¯»æºç -traceï¼‰" class="headerlink" title="å°ç»“ï¼ˆæ€ä¹ˆè¯»æºç  &#x2F; traceï¼‰"></a>å°ç»“ï¼ˆæ€ä¹ˆè¯»æºç  &#x2F; traceï¼‰</h1><ul>
<li>è‹¥ä½ æƒ³é€è¡Œè·Ÿè¸ªï¼šå…ˆåœ¨ <code>net/bridge/br_handle_frame.c</code> &#x2F; <code>net/bridge/br_netfilter.c</code> ä¸‹çœ‹ <code>br_handle_frame()</code>ã€<code>br_pass_frame_up()</code>ã€<code>br_nf_pre_routing()</code>ï¼›<br>å†åˆ° <code>net/ipv4/ip_input.c</code> çš„ <code>ip_rcv()</code> &#x2F; <code>ip_rcv_core()</code>ï¼›<br>ç„¶å <code>ip_forward()</code>ã€<code>ip_output.c</code>ã€<code>neighbour/arp</code>ã€æœ€å <code>dev_queue_xmit()</code> ä¸ <code>net/core/dev.c</code> çš„ <code>dev_queue_xmit()</code>ã€<code>dev-&gt;netdev_ops-&gt;ndo_start_xmit</code>ã€‚</li>
<li>ç”¨ <code>ftrace</code> &#x2F; <code>dynamic probe (kprobe)</code> &#x2F; <code>bcc/eBPF</code> æ‰“ç‚¹åœ¨è¿™äº›å‡½æ•°å…¥å£å¤„å¾ˆå®¹æ˜“çœ‹åˆ°æ•´ä¸ªé“¾è·¯çš„çœŸå®è°ƒç”¨é¡ºåºä¸ skb-&gt;dev å˜åŒ–ã€‚</li>
</ul>
<hr>
<h5 id="-3"><a href="#-3" class="headerlink" title=""></a></h5><p><img src="https://chatgpt.com/backend-api/estuary/content?id=file_00000000a4f072099a7d968efffaa3a9&ts=489659&p=fs&cid=1&sig=905f05a88f04f7a734eeefc232d96ac0c462f3aa1d41130b2bbbb5e6296f7360&v=0" alt="å·²ç”Ÿæˆå›¾ç‰‡"></p>
<p>![ChatGPT Image 2025å¹´11æœˆ10æ—¥ 20_04_57](ç½‘æ¡¥è½¬å‘åˆ°å¦ä¸€ä¸ªç½‘æ¡¥&#x2F;ChatGPT Image 2025å¹´11æœˆ10æ—¥ 20_04_57.png)</p>
<h6 id="-4"><a href="#-4" class="headerlink" title=""></a></h6><p><strong>Cä»£ç æ³¨é‡Šé£æ ¼çš„ä¼ªå›¾</strong>ï¼ˆå³ ASCII æ ·å¼ï¼‰<br>è¿™å¼ â€œæ–‡å­—æµç¨‹å›¾â€ä¸¥æ ¼æŒ‰ç…§å†…æ ¸çš„å‡½æ•°è°ƒç”¨å±‚æ¬¡ï¼ˆç®€åŒ–æ³¨é‡Šï¼‰ï¼ŒåŒ…å«å…³é”® Netfilter Hook ä¸è·¯å¾„åˆ‡æ¢ç‚¹ã€‚</p>
<hr>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">/* ============================================================</span><br><span class="line"> *   Linux bridge â†’ IP å±‚ â†’ è·¯ç”± â†’ bridge å‡ºå£ çš„å®Œæ•´æµç¨‹</span><br><span class="line"> * ============================================================ */</span><br><span class="line"></span><br><span class="line">/* ---- æ¥æ”¶é˜¶æ®µï¼šç‰©ç†ç½‘å¡æ¥æ”¶åŒ… ---- */</span><br><span class="line">napi_gro_receive()</span><br><span class="line">  |</span><br><span class="line">  v</span><br><span class="line">__netif_receive_skb_core()</span><br><span class="line">  |</span><br><span class="line">  +--&gt; rx_handler_check(): æ£€æŸ¥æ˜¯å¦æœ‰ bridge handler</span><br><span class="line">        |</span><br><span class="line">        +--&gt; br_handle_frame()   // ç½‘æ¡¥æ¥ç®¡æ­¤åŒ…</span><br><span class="line">              |</span><br><span class="line">              +--&gt; NF_BR_PRE_ROUTING   // bridge å±‚çš„ PREROUTING</span><br><span class="line">              |</span><br><span class="line">              +--&gt; br_handle_frame_finish()</span><br><span class="line">                    |</span><br><span class="line">                    +--&gt; å¦‚æœç›®çš„ MAC æ˜¯æœ¬æœºï¼ˆæ¡¥è®¾å¤‡çš„ MACï¼‰</span><br><span class="line">                          |</span><br><span class="line">                          v</span><br><span class="line">                          br_pass_frame_up()</span><br><span class="line">                            |</span><br><span class="line">                            +--&gt; netif_receive_skb()   // ä¸Šäº¤å†…æ ¸åè®®æ ˆ</span><br><span class="line">                                  |</span><br><span class="line">                                  v</span><br><span class="line">                              __netif_receive_skb_core()</span><br><span class="line">                                |</span><br><span class="line">                                +--&gt; deliver_ptype_list_skb()</span><br><span class="line">                                      |</span><br><span class="line">                                      +--&gt; ip_rcv()    // è¿›å…¥ IP å±‚</span><br><span class="line"></span><br><span class="line">/* ---- ç½‘ç»œå±‚å…¥å£ ---- */</span><br><span class="line">ip_rcv()</span><br><span class="line">  |</span><br><span class="line">  +--&gt; ip_rcv_core()</span><br><span class="line">  |</span><br><span class="line">  +--&gt; NF_INET_PRE_ROUTING    // æ³¨æ„ï¼šæ­¤æ—¶ä¸ä¼šå†ç»è¿‡ï¼bridge å·²åšè¿‡ä¸€æ¬¡</span><br><span class="line">  |</span><br><span class="line">  +--&gt; ip_rcv_finish()</span><br><span class="line">        |</span><br><span class="line">        +--&gt; ip_route_input()  // æŸ¥è·¯ç”±è¡¨</span><br><span class="line">        |</span><br><span class="line">        +--&gt; ip_forward()      // å¦‚æœç›®æ ‡ä¸æ˜¯æœ¬æœº â†’ è¿›å…¥è½¬å‘è·¯å¾„</span><br><span class="line">              |</span><br><span class="line">              +--&gt; NF_INET_FORWARD</span><br><span class="line">              |</span><br><span class="line">              +--&gt; ip_forward_finish()</span><br><span class="line">                    |</span><br><span class="line">                    +--&gt; ip_output()</span><br><span class="line">                          |</span><br><span class="line">                          +--&gt; NF_INET_POST_ROUTING</span><br><span class="line">                          |</span><br><span class="line">                          +--&gt; ip_finish_output()</span><br><span class="line">                                |</span><br><span class="line">                                +--&gt; neigh_output()   // é€šè¿‡é‚»å±…å­ç³»ç»Ÿ</span><br><span class="line">                                      |</span><br><span class="line">                                      +--&gt; dev_queue_xmit()</span><br><span class="line">                                            |</span><br><span class="line">                                            +--&gt; å‘ç°ç›®æ ‡è®¾å¤‡æ˜¯ bridge</span><br><span class="line">                                                  |</span><br><span class="line">                                                  v</span><br><span class="line">                                                  br_dev_xmit()   // å›åˆ°æ¡¥å±‚</span><br><span class="line">                                                    |</span><br><span class="line">                                                    +--&gt; br_forward()</span><br><span class="line">                                                          |</span><br><span class="line">                                                          +--&gt; NF_BR_FORWARD</span><br><span class="line">                                                          |</span><br><span class="line">                                                          +--&gt; br_forward_finish()</span><br><span class="line">                                                                |</span><br><span class="line">                                                                +--&gt; dev_queue_xmit()</span><br><span class="line">                                                                      |</span><br><span class="line">                                                                      v</span><br><span class="line">                                                                      ndo_start_xmit()</span><br><span class="line">                                                                        |</span><br><span class="line">                                                                        +--&gt; ç¡¬ä»¶é©±åŠ¨å‘é€</span><br><span class="line"></span><br><span class="line">/* ============================================================</span><br><span class="line"> *  æ•°æ®è·¯å¾„æ€»ç»“ï¼š</span><br><span class="line"> *</span><br><span class="line"> *  [ç‰©ç†ç½‘å¡] â†’ br_handle_frame()</span><br><span class="line"> *             â†’ br_pass_frame_up()</span><br><span class="line"> *             â†’ ip_rcv()</span><br><span class="line"> *             â†’ ip_forward()</span><br><span class="line"> *             â†’ ip_output()</span><br><span class="line"> *             â†’ neigh_output()</span><br><span class="line"> *             â†’ br_dev_xmit()</span><br><span class="line"> *             â†’ br_forward()</span><br><span class="line"> *             â†’ ç‰©ç†ç½‘å¡å‘å‡º</span><br><span class="line"> *</span><br><span class="line"> *  Netfilter ç»è¿‡é¡ºåºï¼š</span><br><span class="line"> *   1. NF_BR_PRE_ROUTING</span><br><span class="line"> *   2. NF_INET_FORWARD / NF_INET_POST_ROUTING</span><br><span class="line"> *   3. NF_BR_FORWARD</span><br><span class="line"> * ============================================================ */</span><br></pre></td></tr></table></figure>

<hr>
<p>ğŸ“˜ <strong>è¦ç‚¹è§£æï¼š</strong></p>
<ul>
<li><code>NF_INET_PRE_ROUTING</code> åœ¨ç¬¬äºŒæ¬¡ä¸ä¼šæ‰§è¡Œï¼Œæ˜¯å› ä¸ºåŒ…åœ¨æ¡¥æ¥æ¥æ”¶æ—¶å·²èµ°è¿‡ <code>NF_BR_PRE_ROUTING</code>ï¼Œå¹¶ä¸”æ­¤è·¯å¾„æ ‡å¿—ï¼ˆ<code>skb-&gt;nfct</code> ç­‰ï¼‰å‘Šè¯‰ IP å±‚ä¸éœ€è¦å†æ¬¡åš NAT&#x2F;PREROUTINGã€‚</li>
<li>ä» <code>br_pass_frame_up()</code> è¿›å…¥ IP å±‚æ—¶ï¼Œ<code>skb-&gt;dev</code> è¢«æ›¿æ¢ä¸ºç½‘æ¡¥è®¾å¤‡ï¼Œå› æ­¤ä¸ä¼šé‡å¤æ¡¥æ¥å¤„ç†ã€‚</li>
<li>è·¯ç”±æŸ¥æ‰¾åˆ°å‡ºå£è®¾å¤‡æ˜¯å¦ä¸€ä¸ª bridge æ¥å£æ—¶ï¼Œé€šè¿‡é‚»å±…å­ç³»ç»Ÿçš„ <code>neigh_output()</code> æ‰¾åˆ°è¯¥æ¡¥ï¼Œå†è°ƒç”¨å…¶ <code>ndo_start_xmit</code> â†’ <code>br_dev_xmit</code> â†’ <code>br_forward()</code>ï¼Œå›åˆ°ç½‘æ¡¥è½¬å‘é€»è¾‘ã€‚</li>
<li>æœ€ç»ˆåŒ…ç”±å‡ºå£ç‰©ç†å£å‘å‡ºã€‚</li>
</ul>
<hr>
<p>æ˜¯å¦å¸Œæœ›æˆ‘åœ¨è¿™å¼ ä¼ªå›¾ä¸Š<strong>æ ‡å‡ºæ¯ä¸ªé˜¶æ®µçš„ Netfilter Hook å¯¹åº”çš„è¡¨ï¼ˆå¦‚ PREROUTING â†’ mangle&#x2F;nat&#x2F;filter è¡¨ï¼‰</strong>ï¼Ÿé‚£æ ·èƒ½æ›´ç›´è§‚çœ‹å‡ºå“ªäº›é’©å­ç”Ÿæ•ˆã€‚</p>
<h5 id="-5"><a href="#-5" class="headerlink" title=""></a></h5><p>éå¸¸æ£’çš„æé—®ï¼Œè¿™å¼ å›¾ï¼ˆJan Engelhardt ç‰ˆçš„ Linux Netfilter æµç¨‹å›¾ï¼‰ç¡®å®æ˜¯ç ”ç©¶ <strong>bridge + IP è·¯ç”±</strong> çš„å…³é”®å‚è€ƒä¹‹ä¸€ã€‚<br>æˆ‘æ¥å¸®ä½ <strong>ç²¾ç¡®å®šä½</strong>ï¼šå½“æ•°æ®åŒ…ä»<strong>ä¸€ä¸ªç½‘æ¡¥è¿›å…¥ï¼Œå¦ä¸€ä¸ªç½‘æ¡¥å‘å‡º</strong>æ—¶ï¼Œå®ƒåœ¨è¿™å¼ å›¾ä¸­èµ°çš„æ˜¯**â€œä¸ŠåŠéƒ¨åˆ†çš„ç»¿è‰²è·¯å¾„ï¼ˆNetwork Layer è½¬å‘è·¯å¾„ï¼‰â€**ï¼Œè€Œä¸æ˜¯ä¸‹æ–¹é‚£æ¡è“è‰²çš„â€œLink Layer bridging-only pathâ€ã€‚</p>
<hr>
<h2 id="ğŸ§­-å…ˆçœ‹ä¸¤æ¡è·¯å¾„çš„å«ä¹‰"><a href="#ğŸ§­-å…ˆçœ‹ä¸¤æ¡è·¯å¾„çš„å«ä¹‰" class="headerlink" title="ğŸ§­ å…ˆçœ‹ä¸¤æ¡è·¯å¾„çš„å«ä¹‰"></a>ğŸ§­ å…ˆçœ‹ä¸¤æ¡è·¯å¾„çš„å«ä¹‰</h2><p>å›¾ä¸­â€œNetwork Layerâ€ä¸â€œLink Layerâ€ä¹‹é—´çš„ä¸¤æ¡å¹³è¡Œçº¿ï¼Œåˆ†åˆ«è¡¨ç¤ºï¼š</p>
<table>
<thead>
<tr>
<th>åŒºåŸŸ</th>
<th>è·¯å¾„ä»£è¡¨çš„é€»è¾‘</th>
<th>å…¸å‹æƒ…å½¢</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Link Layer (è“è‰²)</strong></td>
<td>çº¯äºŒå±‚ Bridge è½¬å‘è·¯å¾„ï¼ˆæ— è·¯ç”±ã€åŒç½‘æ®µï¼‰</td>
<td>æ¡¥å†…ç«¯å£ä¹‹é—´è½¬å‘ï¼Œåªçœ‹ MAC åœ°å€ï¼Œä¸çœ‹ IPã€‚</td>
</tr>
<tr>
<td><strong>Network Layer (ç»¿è‰²)</strong></td>
<td>IP å±‚è½¬å‘è·¯å¾„ï¼ˆL3 routingï¼‰</td>
<td>æ¡¥å£æ”¶åŒ…åäº¤ç»™ IP å±‚ï¼Œæ ¹æ® IP è·¯ç”±è½¬å‘åˆ°å¦ä¸€æ¥å£ã€‚</td>
</tr>
</tbody></table>
<hr>
<h2 id="ğŸ§©-ä½ çš„åœºæ™¯ï¼šBridge-â†’-IP-â†’-Bridge"><a href="#ğŸ§©-ä½ çš„åœºæ™¯ï¼šBridge-â†’-IP-â†’-Bridge" class="headerlink" title="ğŸ§© ä½ çš„åœºæ™¯ï¼šBridge â†’ IP â†’ Bridge"></a>ğŸ§© ä½ çš„åœºæ™¯ï¼šBridge â†’ IP â†’ Bridge</h2><blockquote>
<p>â€œä¸€ä¸ª bridge è¿›ï¼Œå¦ä¸€ä¸ª bridge å‡ºâ€<br>æ˜¯ä¸€ä¸ª**ä¸‰å±‚è½¬å‘ï¼ˆroutingï¼‰**è¿‡ç¨‹ï¼Œè™½ç„¶å…¥å£å’Œå‡ºå£éƒ½æ˜¯ bridge æ¥å£ï¼Œä½†ä¸­é—´ç»è¿‡ IP å±‚ã€‚</p>
</blockquote>
<p>æ‰€ä»¥ï¼š</p>
<ul>
<li>åŒ…å…ˆåœ¨ <strong>Link Layer (è“è‰²)</strong> è¿›å…¥ï¼Œç»è¿‡ <code>br_handle_frame()</code>ã€‚</li>
<li>æ£€æµ‹åˆ°æ˜¯å‘å¾€æœ¬æœºçš„ï¼ˆç›®æ ‡ MAC æ˜¯æ¡¥æˆ–æœ¬åœ° IPï¼‰ï¼ŒåŒ…è¢«ä¸Šé€åˆ° <strong>Network Layer (ç»¿è‰²)</strong>ã€‚</li>
<li>ç„¶åæ²¿ç€ <strong>ç»¿è‰²çš„â€œrouting decision â†’ FORWARD â†’ POSTROUTING â†’ è¾“å‡ºæ¥å£â€</strong> è¿™æ¡è·¯å¾„ã€‚</li>
<li>æœ€åä»å‡ºå£ bridge å‘å‡ºï¼Œåˆä¸‹é™å› <strong>Link Layer (è“è‰²)</strong>ï¼Œç»è¿‡ <code>br_dev_xmit()</code> &#x2F; <code>br_forward()</code> å‘ç»™ç‰©ç†æ¥å£ã€‚</li>
</ul>
<hr>
<h2 id="ğŸ”-åœ¨å›¾ä¸­çš„ç¡®åˆ‡è·¯çº¿ï¼ˆç”¨ç®­å¤´æ ‡è¯†ï¼‰"><a href="#ğŸ”-åœ¨å›¾ä¸­çš„ç¡®åˆ‡è·¯çº¿ï¼ˆç”¨ç®­å¤´æ ‡è¯†ï¼‰" class="headerlink" title="ğŸ” åœ¨å›¾ä¸­çš„ç¡®åˆ‡è·¯çº¿ï¼ˆç”¨ç®­å¤´æ ‡è¯†ï¼‰"></a>ğŸ” åœ¨å›¾ä¸­çš„ç¡®åˆ‡è·¯çº¿ï¼ˆç”¨ç®­å¤´æ ‡è¯†ï¼‰</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[Link Layer ingress]  --&gt;  brouting  --&gt;  bridge check  </span><br><span class="line">                                |</span><br><span class="line">                                v</span><br><span class="line">                   (åŒ…äº¤ç»™ IP å±‚ â†’ Network Layer)</span><br><span class="line">                                |</span><br><span class="line">                                v</span><br><span class="line">             [Network Layer]</span><br><span class="line">                 raw PREROUTING</span><br><span class="line">                 mangle PREROUTING</span><br><span class="line">                 nat PREROUTING</span><br><span class="line">                                |</span><br><span class="line">                                v</span><br><span class="line">                        routing decision</span><br><span class="line">                                |</span><br><span class="line">                                v</span><br><span class="line">                     mangle FORWARD</span><br><span class="line">                     filter FORWARD</span><br><span class="line">                                |</span><br><span class="line">                                v</span><br><span class="line">                     mangle POSTROUTING</span><br><span class="line">                     nat POSTROUTING</span><br><span class="line">                                |</span><br><span class="line">                                v</span><br><span class="line">             (è¾“å‡ºæ¥å£ä¸ºå¦ä¸€ä¸ª bridge)</span><br><span class="line">                                |</span><br><span class="line">                                v</span><br><span class="line">             [Link Layer egress]</span><br><span class="line">                     br_dev_xmit()</span><br><span class="line">                     br_forward()</span><br><span class="line">                     egress qdisc</span><br><span class="line">                     interface output</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="ğŸ§ -ä¸ºä»€ä¹ˆä¸æ˜¯ä¸‹æ–¹é‚£æ¡è“çº¿ï¼Ÿ"><a href="#ğŸ§ -ä¸ºä»€ä¹ˆä¸æ˜¯ä¸‹æ–¹é‚£æ¡è“çº¿ï¼Ÿ" class="headerlink" title="ğŸ§  ä¸ºä»€ä¹ˆä¸æ˜¯ä¸‹æ–¹é‚£æ¡è“çº¿ï¼Ÿ"></a>ğŸ§  ä¸ºä»€ä¹ˆä¸æ˜¯ä¸‹æ–¹é‚£æ¡è“çº¿ï¼Ÿ</h2><p>ä¸‹æ–¹é‚£æ¡è“çº¿æ˜¯â€œbridge-only pathâ€ï¼Œ<br>ç”¨äºçº¯äºŒå±‚è½¬å‘åœºæ™¯ï¼ˆå³ä¸ç»è¿‡ IP å±‚çš„ <code>ip_rcv()</code>ï¼‰ã€‚</p>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼š</p>
<ul>
<li>æ¡¥ç›´æ¥æ ¹æ® MAC&#x2F;FDB è¡¨å†³å®šè½¬å‘ï¼Œä¸ä¼šè§¦å‘è·¯ç”±ï¼›</li>
<li>ä¸ä¼šè°ƒç”¨ <code>ip_rcv()</code>ã€<code>ip_forward()</code>ï¼›</li>
<li>ä¹Ÿä¸ä¼šç»è¿‡ <code>NF_INET_FORWARD</code> ç­‰é’©å­ã€‚</li>
</ul>
<p>è€Œä½ æè¿°çš„æƒ…å½¢ä¸­ï¼š</p>
<blockquote>
<p>åŒ…åœ¨ç¬¬ä¸€ä¸ª bridge çš„ INPUT æ—¶ä¸Šé€åˆ°ç½‘ç»œå±‚ï¼ˆå³ <code>br_pass_frame_up()</code> â†’ <code>ip_rcv()</code>ï¼‰ï¼Œ<br>æ‰€ä»¥å®ƒä»è“å±‚è·³åˆ°ç»¿å±‚ï¼ˆLink â†’ Networkï¼‰ï¼›<br>è·¯ç”±å®Œæˆåï¼Œä»ç»¿å±‚è·³å›è“å±‚ï¼ˆNetwork â†’ Linkï¼‰è¾“å‡ºã€‚</p>
</blockquote>
<p>å› æ­¤å®ƒç¡®å®èµ°<strong>ç»¿è‰²ï¼ˆNetwork Layerï¼‰é‚£ä¸€æ¡ä¸»è·¯å¾„</strong>ã€‚</p>
<hr>
<h2 id="ğŸ“˜-å°ç»“"><a href="#ğŸ“˜-å°ç»“" class="headerlink" title="ğŸ“˜ å°ç»“"></a>ğŸ“˜ å°ç»“</h2><table>
<thead>
<tr>
<th>é˜¶æ®µ</th>
<th>å›¾ä¸­å±‚çº§</th>
<th>ä¸»è¦å‡½æ•°</th>
<th>Netfilter é’©å­</th>
</tr>
</thead>
<tbody><tr>
<td>è¿›å…¥ bridge</td>
<td>Link Layer ingress</td>
<td><code>br_handle_frame()</code></td>
<td><code>NF_BR_PRE_ROUTING</code></td>
</tr>
<tr>
<td>ä¸Šé€ IP å±‚</td>
<td>Network Layer ingress</td>
<td><code>ip_rcv()</code></td>
<td><code>NF_INET_PRE_ROUTING</code>ï¼ˆå¯èƒ½è¢«è·³è¿‡ï¼‰</td>
</tr>
<tr>
<td>è·¯ç”±è½¬å‘</td>
<td>Network Layer forward</td>
<td><code>ip_forward()</code></td>
<td><code>NF_INET_FORWARD</code></td>
</tr>
<tr>
<td>è¾“å‡º</td>
<td>Network Layer postrouting</td>
<td><code>ip_output()</code></td>
<td><code>NF_INET_POST_ROUTING</code></td>
</tr>
<tr>
<td>å‘é€åˆ°å¦ä¸€ä¸ª bridge</td>
<td>Link Layer egress</td>
<td><code>br_dev_xmit()</code>ã€<code>br_forward()</code></td>
<td><code>NF_BR_FORWARD</code>ã€<code>NF_BR_POST_ROUTING</code></td>
</tr>
</tbody></table>
<hr>
<p>å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥æŠŠè¿™å¼ å›¾ä¸­ä½ çš„è·¯å¾„ï¼ˆbridgeâ†’IPâ†’bridgeï¼‰ç”¨æ–‡æœ¬ç‰ˆâ€œç®­å¤´æµâ€ç²¾ç¡®æ ‡å‡ºæ¯ä¸ªèŠ‚ç‚¹åç§°ï¼ˆä¾‹å¦‚ raw&#x2F;mangle&#x2F;filter&#x2F;nat å››ä¸ªè¡¨åœ¨ä»€ä¹ˆæ—¶å€™è¿›å…¥ã€ä»€ä¹ˆæ—¶å€™è·³å‡ºï¼‰ï¼Œç›¸å½“äºåœ¨è¿™å¼ å›¾ä¸Šâ€œæ ‡å‡ºä½ çš„åŒ…èµ°çš„é‚£æ¡ç»¿è‰²è·¯å¾„â€ã€‚<br>è¦æˆ‘å¸®ä½ ç”Ÿæˆé‚£ä¸ªç‰ˆæœ¬å—ï¼Ÿ</p>
<h6 id="-6"><a href="#-6" class="headerlink" title=""></a></h6><p>éå¸¸å¥½ ğŸ‘ï¼Œä½ é—®çš„è¿™ä¸ªç‚¹éå¸¸å…³é”®ï¼Œä¹Ÿæ˜¯ç†è§£ Linux å†…æ ¸ç½‘ç»œæ ˆæœ€éš¾çš„ä¸€ä¸ªç»†èŠ‚ä¹‹ä¸€ã€‚<br>ä½ æ³¨æ„åˆ°å›¾ä¸­ <strong>è“è‰² Link Layer åŒºåŸŸ</strong> çš„ä¸¤æ¡ â€œforwardâ€ è·¯å¾„ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(ä¸Šæ–¹çš„è“è‰² forward)</span><br><span class="line">(ä¸‹æ–¹çš„è“è‰² forward)</span><br></pre></td></tr></table></figure>

<p>å®ƒä»¬ç¡®å®éƒ½æ ‡ç€ â€œforwardâ€ï¼Œä½†è¯­ä¹‰å®Œå…¨ä¸åŒã€‚<br>ä½ æåˆ°çš„â€œä¸Šé¢é‚£æ¡ä»ç½‘ç»œå±‚æ‰ä¸‹æ¥çš„ forwardâ€ï¼Œ<br>å…¶å®æ­£å¥½å¯¹åº”äºä½ ä¹‹å‰æåˆ°çš„é‚£ä¸ªè¿‡ç¨‹ï¼š<strong>åŒ…åœ¨ç½‘ç»œå±‚è·¯ç”±å®Œæˆåï¼Œè¢«é€å›æ¡¥å±‚å‘å‡ºï¼ˆbridge ä½œä¸ºå‡ºå£è®¾å¤‡ï¼‰</strong>ã€‚</p>
<p>æˆ‘ä»¬æ¥ç³»ç»Ÿåœ°è§£é‡Šå®ƒå­˜åœ¨çš„åŸå› ã€è§¦å‘æ¡ä»¶ã€å†…æ ¸è°ƒç”¨æ ˆï¼Œä»¥åŠå®ƒä¸ä¸‹æ–¹é‚£æ¡çš„åŒºåˆ«ã€‚</p>
<hr>
<h2 id="ğŸ§©-ä¸€ã€ä¸¤æ¡è“è‰²-â€œforwardâ€-çš„çœŸå®å«ä¹‰"><a href="#ğŸ§©-ä¸€ã€ä¸¤æ¡è“è‰²-â€œforwardâ€-çš„çœŸå®å«ä¹‰" class="headerlink" title="ğŸ§© ä¸€ã€ä¸¤æ¡è“è‰² â€œforwardâ€ çš„çœŸå®å«ä¹‰"></a>ğŸ§© ä¸€ã€ä¸¤æ¡è“è‰² â€œforwardâ€ çš„çœŸå®å«ä¹‰</h2><table>
<thead>
<tr>
<th>è·¯å¾„ä½ç½®</th>
<th>åç§°ï¼ˆå›¾ä¸Šï¼‰</th>
<th>å®é™…å«ä¹‰</th>
<th>è°ƒç”¨ä¸Šä¸‹æ–‡</th>
</tr>
</thead>
<tbody><tr>
<td>ğŸ”¹ <strong>ä¸Šæ–¹çš„è“è‰² forward</strong></td>
<td><em>Bridge forward after routing</em></td>
<td>ä»ç½‘ç»œå±‚ï¼ˆIPï¼‰è½¬å‘åï¼Œå‡ºå£è®¾å¤‡æ˜¯ bridgeï¼ŒåŒ…è¢«äº¤ç»™ bridge å±‚åšå‘å‡ºå¤„ç†ã€‚</td>
<td>IP è·¯ç”±è¾“å‡ºé˜¶æ®µ â†’ <code>br_dev_xmit()</code> &#x2F; <code>br_forward()</code></td>
</tr>
<tr>
<td>ğŸ”¹ <strong>ä¸‹æ–¹çš„è“è‰² forward</strong></td>
<td><em>Pure L2 bridge forwarding</em></td>
<td>çº¯äºŒå±‚äº¤æ¢ï¼šåŒ…æ²¡ç»è¿‡ IP å±‚ï¼Œåªæ ¹æ® MAC&#x2F;FDB è¡¨ç›´æ¥ä»ä¸€ä¸ªç«¯å£è½¬å‘åˆ°å¦ä¸€ä¸ªç«¯å£ã€‚</td>
<td>å…¥å£æ¡¥å£ â†’ <code>br_handle_frame()</code> â†’ <code>br_forward()</code></td>
</tr>
</tbody></table>
<p>æ‰€ä»¥ï¼š</p>
<ul>
<li><strong>ä¸‹æ–¹ forward</strong> æ˜¯ <strong>L2 bridging è·¯å¾„</strong></li>
<li><strong>ä¸Šæ–¹ forward</strong> æ˜¯ <strong>L3 routing â†’ bridge output è·¯å¾„</strong></li>
</ul>
<hr>
<h2 id="ğŸ§ -äºŒã€ä¸ºä»€ä¹ˆâ€œä»ç½‘ç»œå±‚æ‰å›åˆ°ç½‘æ¡¥å±‚â€ï¼Ÿ"><a href="#ğŸ§ -äºŒã€ä¸ºä»€ä¹ˆâ€œä»ç½‘ç»œå±‚æ‰å›åˆ°ç½‘æ¡¥å±‚â€ï¼Ÿ" class="headerlink" title="ğŸ§  äºŒã€ä¸ºä»€ä¹ˆâ€œä»ç½‘ç»œå±‚æ‰å›åˆ°ç½‘æ¡¥å±‚â€ï¼Ÿ"></a>ğŸ§  äºŒã€ä¸ºä»€ä¹ˆâ€œä»ç½‘ç»œå±‚æ‰å›åˆ°ç½‘æ¡¥å±‚â€ï¼Ÿ</h2><p>è¿™æ˜¯å› ä¸º Linux æŠŠ bridge è®¾å¤‡ä¹Ÿå½“æˆä¸€ç§æ™®é€šçš„ <strong>ç½‘ç»œè®¾å¤‡ï¼ˆnet_deviceï¼‰</strong>ã€‚<br>å½“ IP å±‚å†³å®šåŒ…è¦ä» bridge å‡ºå£æ—¶ï¼Œå®ƒå¹¶ä¸çŸ¥é“ bridge èƒŒåè¿˜æœ‰åˆ«çš„ portï¼ŒåªçŸ¥é“è¦å‘ç»™ <code>br1</code>ã€‚</p>
<p>äºæ˜¯æµç¨‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ip_output()</span><br><span class="line">  â””â”€â”€ dev_queue_xmit(skb)</span><br><span class="line">        â””â”€â”€ br_dev_xmit()   // å› ä¸º dev æ˜¯ bridge</span><br><span class="line">              â””â”€â”€ br_forward()</span><br><span class="line">                    â””â”€â”€ dev_queue_xmit() -&gt; port(ethX)</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>IP å±‚çš„â€œå‡ºå£è®¾å¤‡â€æ˜¯ bridge</strong>ï¼Œ<br>ç„¶ååˆâ€œæ‰å›â€åˆ° bridge å±‚å†…éƒ¨ï¼Œbridge å†å»æ‰¾å“ªä¸ªç«¯å£çœŸæ­£å‘å‡ºå»ã€‚</p>
<p>è¿™æ­£æ˜¯ä½ çœ‹åˆ°å›¾ä¸­é‚£æ¡â€œç»¿è‰² (Network Layer)â€â†’â€œè“è‰² (Link Layer)â€çš„å‚ç›´ç®­å¤´ã€‚</p>
<hr>
<h2 id="ğŸ§©-ä¸‰ã€è¿™æ¡â€œæ‰ä¸‹æ¥çš„-forwardâ€çš„-Hook-è¡Œä¸º"><a href="#ğŸ§©-ä¸‰ã€è¿™æ¡â€œæ‰ä¸‹æ¥çš„-forwardâ€çš„-Hook-è¡Œä¸º" class="headerlink" title="ğŸ§© ä¸‰ã€è¿™æ¡â€œæ‰ä¸‹æ¥çš„ forwardâ€çš„ Hook è¡Œä¸º"></a>ğŸ§© ä¸‰ã€è¿™æ¡â€œæ‰ä¸‹æ¥çš„ forwardâ€çš„ Hook è¡Œä¸º</h2><p>å½“ IP å±‚è½¬å‘åˆ° bridge è®¾å¤‡æ—¶ï¼Œbridge å±‚ä¼šå†æ¬¡è§¦å‘ <strong>bridge è‡ªå·±çš„ Netfilter hook</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>é’©å­</th>
<th>æ—¶æœº</th>
<th>å¯¹åº”å‡½æ•°</th>
</tr>
</thead>
<tbody><tr>
<td><code>NF_BR_FORWARD</code></td>
<td>bridge è½¬å‘å†³ç­–å‰ï¼ˆå‡ºå£æ¡¥å¤„ç†ï¼‰</td>
<td>åœ¨ <code>br_forward()</code> ä¸­</td>
</tr>
<tr>
<td><code>NF_BR_POST_ROUTING</code></td>
<td>åŒ…ç¦»å¼€æ¡¥ã€å‘é€ç‰©ç†æ¥å£å‰</td>
<td>åœ¨ <code>br_forward_finish()</code> ä¸­</td>
</tr>
</tbody></table>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼š</p>
<ul>
<li>åŒ…ä» IP å±‚å‡ºæ¥æ—¶ï¼Œä¼šå…ˆç»è¿‡ IPv4 çš„ <code>NF_INET_POST_ROUTING</code></li>
<li>ç„¶åæ‰åˆ° bridge å±‚ï¼Œåˆä¼šç»è¿‡ <code>NF_BR_FORWARD</code> å’Œ <code>NF_BR_POST_ROUTING</code></li>
<li>æœ€ç»ˆæ‰å‘åˆ°ç‰©ç†å£ï¼ˆ<code>ndo_start_xmit</code>ï¼‰</li>
</ul>
<p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå›¾ä¸Šä» Network Layer æ‰åˆ° Link Layer åï¼Œè¿˜æœ‰è“è‰²çš„ â€œmangle&#x2F;filter forwardâ€ æ¨¡å—ã€‚</p>
<hr>
<h2 id="ğŸ§©-å››ã€ä¸¤ç§-forward-åœ¨è°ƒç”¨æ ˆä¸Šçš„å¯¹æ¯”"><a href="#ğŸ§©-å››ã€ä¸¤ç§-forward-åœ¨è°ƒç”¨æ ˆä¸Šçš„å¯¹æ¯”" class="headerlink" title="ğŸ§© å››ã€ä¸¤ç§ forward åœ¨è°ƒç”¨æ ˆä¸Šçš„å¯¹æ¯”"></a>ğŸ§© å››ã€ä¸¤ç§ forward åœ¨è°ƒç”¨æ ˆä¸Šçš„å¯¹æ¯”</h2><table>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>å†…æ ¸å‡½æ•°æ ˆï¼ˆå…³é”®æ®µï¼‰</th>
</tr>
</thead>
<tbody><tr>
<td><strong>ä¸‹æ–¹è“çº¿ï¼ˆçº¯æ¡¥è½¬å‘ï¼‰</strong></td>
<td><code>ethX -&gt; br_handle_frame() -&gt; br_handle_frame_finish() -&gt; br_forward()</code></td>
</tr>
<tr>
<td><strong>ä¸Šæ–¹è“çº¿ï¼ˆIP å±‚è·¯ç”±åå‘å‡º bridgeï¼‰</strong></td>
<td><code>ip_forward_finish() -&gt; ip_output() -&gt; dev_queue_xmit() -&gt; br_dev_xmit() -&gt; br_forward()</code></td>
</tr>
</tbody></table>
<p>è¿™ä¸¤æ¡è·¯å¾„å”¯ä¸€çš„â€œå…±é€šç‚¹â€æ˜¯æœ€åçš„ <code>br_forward()</code>ï¼Œ<br>ä½†åˆ°è¾¾å®ƒçš„å…¥å£å®Œå…¨ä¸åŒï¼š<br>ä¸€ä¸ªæ˜¯ RX handler çš„å…¥å£ï¼Œä¸€ä¸ªæ˜¯ TX è·¯ç”±è¾“å‡ºçš„å…¥å£ã€‚</p>
<hr>
<h2 id="ğŸ§©-äº”ã€ç›´è§‚å¯¹æ¯”å›¾ï¼ˆç®€åŒ–ç‰ˆï¼‰"><a href="#ğŸ§©-äº”ã€ç›´è§‚å¯¹æ¯”å›¾ï¼ˆç®€åŒ–ç‰ˆï¼‰" class="headerlink" title="ğŸ§© äº”ã€ç›´è§‚å¯¹æ¯”å›¾ï¼ˆç®€åŒ–ç‰ˆï¼‰"></a>ğŸ§© äº”ã€ç›´è§‚å¯¹æ¯”å›¾ï¼ˆç®€åŒ–ç‰ˆï¼‰</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line"> â”‚       Network Layer        â”‚</span><br><span class="line"> â”‚   ip_rcv â†’ ip_forward()    â”‚</span><br><span class="line"> â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">            â”‚</span><br><span class="line">            â”‚ è·¯ç”±è¾“å‡ºè®¾å¤‡ = bridge</span><br><span class="line">            â”‚</span><br><span class="line">            v</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚        Link Layer           â”‚</span><br><span class="line">â”‚  br_dev_xmit() â†’ br_forward() â†’ å‡ºå£port |</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure>

<p>è€Œçº¯æ¡¥æ¥è·¯å¾„æ˜¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> (eth0 ingress)</span><br><span class="line">      |</span><br><span class="line">      v</span><br><span class="line">br_handle_frame() â†’ br_forward() â†’ eth1</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="âœ…-å…­ã€æ€»ç»“ä¸€å¥è¯"><a href="#âœ…-å…­ã€æ€»ç»“ä¸€å¥è¯" class="headerlink" title="âœ… å…­ã€æ€»ç»“ä¸€å¥è¯"></a>âœ… å…­ã€æ€»ç»“ä¸€å¥è¯</h2><blockquote>
<p><strong>ä¸Šæ–¹è“è‰² forward</strong> è¡¨ç¤ºï¼š<br>ç½‘ç»œå±‚ï¼ˆIPï¼‰è·¯ç”±å†³å®šè¾“å‡ºæ¥å£ä¸ºæ¡¥è®¾å¤‡æ—¶ï¼Œ<br>åŒ…ä»ç½‘ç»œå±‚ä¸‹æ²‰å›æ¡¥å±‚ï¼Œé€šè¿‡ <code>br_dev_xmit()</code> å†æ¬¡è¿›å…¥æ¡¥çš„è½¬å‘é€»è¾‘ã€‚<br>è¿™æ˜¯ä¸€ä¸ª <em>L3â†’L2 çš„ä¸‹è¡Œåˆ‡æ¢</em>ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„â€œæ¡¥è½¬å‘â€ã€‚</p>
</blockquote>
<hr>
<p>å¦‚æœä½ å¸Œæœ›ï¼Œæˆ‘å¯ä»¥å¸®ä½ æŠŠè¿™ä¸¤æ¡ forwardï¼ˆä¸Šæ–¹ vs ä¸‹æ–¹ï¼‰ç”»æˆ<strong>ä¸€å¼  ASCII è°ƒç”¨å›¾</strong>ï¼Œ<br>æ˜ç¡®å±•ç¤ºå®ƒä»¬çš„èµ·ç‚¹ã€è¿›å…¥æ¡ä»¶ã€å‡½æ•°æ ˆã€Netfilter hookã€‚<br>æ˜¯å¦è¦æˆ‘å¸®ä½ ç”»è¿™å¼ å¯¹æ¯”â€œä¼ªå›¾â€ï¼Ÿ</p>
<h6 id="-7"><a href="#-7" class="headerlink" title=""></a></h6><p>è¿™ä¸ªé—®é¢˜éå¸¸ç»†ï¼Œä¹Ÿéå¸¸å…³é”®ã€‚ä½ æ³¨æ„åˆ° <code>&quot;ip_output&quot;</code> å’Œ <code>&quot;OUTPUT é“¾&quot;</code> ä¹‹é—´çš„åŒºåˆ«ï¼Œè¿™è¯´æ˜ä½ å·²ç»åœ¨éå¸¸æ·±å…¥åœ°ç†è§£ Linux ç½‘ç»œæ ˆçš„å†…éƒ¨é€»è¾‘äº†ã€‚<br>âœ… <strong>ä½ æ˜¯å¯¹çš„</strong>â€”â€”<code>ip_output()</code> å‡ºç°åœ¨åå­—ä¸Šç¡®å®å®¹æ˜“è®©äººè¯¯ä»¥ä¸ºè·Ÿ <code>OUTPUT</code> é“¾ï¼ˆ<code>NF_INET_LOCAL_OUT</code>ï¼‰æœ‰å…³ï¼Œä½†å®é™…ä¸Šå®ƒä»¬å®Œå…¨ä¸æ˜¯ä¸€å›äº‹ã€‚<br>ä¸‹é¢æˆ‘æ¥ç²¾ç¡®åœ°è¯´æ˜è¿™ä¸¤è€…çš„å…³ç³»å’ŒåŒºåˆ«ï¼š</p>
<hr>
<h2 id="ğŸ§©-ä¸€ã€å…ˆçœ‹â€œip-output-â€-çš„çœŸå®è¯­ä¹‰"><a href="#ğŸ§©-ä¸€ã€å…ˆçœ‹â€œip-output-â€-çš„çœŸå®è¯­ä¹‰" class="headerlink" title="ğŸ§© ä¸€ã€å…ˆçœ‹â€œip_output()â€ çš„çœŸå®è¯­ä¹‰"></a>ğŸ§© ä¸€ã€å…ˆçœ‹â€œip_output()â€ çš„çœŸå®è¯­ä¹‰</h2><p>åœ¨ Linux å†…æ ¸ä¸­ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">int ip_output(struct net *net, struct sock *sk, struct sk_buff *skb)</span><br><span class="line">&#123;</span><br><span class="line">    return NF_HOOK(NFPROTO_IPV4, NF_INET_POST_ROUTING,</span><br><span class="line">                   net, sk, skb, NULL, skb_dst(skb)-&gt;dev,</span><br><span class="line">                   ip_finish_output);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªå‡½æ•°è°ƒç”¨çš„ <strong>Netfilter hook æ˜¯ <code>NF_INET_POST_ROUTING</code></strong>ï¼Œ<br>ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒå±äº <strong>POSTROUTING é“¾</strong>ï¼Œè€Œä¸æ˜¯ OUTPUT é“¾ã€‚</p>
<p>ğŸ‘‰ <code>ip_output()</code> æ˜¯ <strong>â€œè·¯ç”±ä¹‹åã€å‡†å¤‡å‘åŒ…â€</strong> çš„å‡½æ•°ï¼Œ<br>ä¹Ÿå°±æ˜¯ IP å±‚è½¬å‘æˆ–æœ¬åœ°å‘å‡ºåï¼Œé©¬ä¸Šè¦å‡ºå»çš„é‚£ä¸ªé˜¶æ®µã€‚</p>
<hr>
<h2 id="ğŸ§ -äºŒã€å’Œ-OUTPUT-é“¾-çš„åŒºåˆ«"><a href="#ğŸ§ -äºŒã€å’Œ-OUTPUT-é“¾-çš„åŒºåˆ«" class="headerlink" title="ğŸ§  äºŒã€å’Œ OUTPUT é“¾ çš„åŒºåˆ«"></a>ğŸ§  äºŒã€å’Œ <code>OUTPUT é“¾</code> çš„åŒºåˆ«</h2><table>
<thead>
<tr>
<th>å¯¹æ¯”é¡¹</th>
<th><code>ip_output()</code> &#x2F; <code>NF_INET_POST_ROUTING</code></th>
<th><code>OUTPUT é“¾</code> &#x2F; <code>NF_INET_LOCAL_OUT</code></th>
</tr>
</thead>
<tbody><tr>
<td>æ‰§è¡Œæ—¶æœº</td>
<td>åŒ… <strong>è·¯ç”±å®Œæˆåï¼ˆå‘å¾€å¤–éƒ¨ï¼‰</strong></td>
<td>åŒ… <strong>ç”±æœ¬æœºåº”ç”¨äº§ç”Ÿï¼ˆæœ¬åœ°è¿›ç¨‹å‘å‡ºï¼‰</strong></td>
</tr>
<tr>
<td>è°ƒç”¨è·¯å¾„</td>
<td>èµ° <code>ip_forward()</code> &#x2F; <code>ip_forward_finish()</code></td>
<td>èµ° <code>ip_queue_xmit()</code> &#x2F; <code>ip_local_out()</code></td>
</tr>
<tr>
<td>Netfilter é’©å­</td>
<td><code>NF_INET_POST_ROUTING</code></td>
<td><code>NF_INET_LOCAL_OUT</code></td>
</tr>
<tr>
<td>è°ƒç”¨ä¸»ä½“</td>
<td><strong>è½¬å‘åŒ…ï¼ˆforwardedï¼‰</strong> æˆ– <strong>æœ¬åœ°å‘åŒ…çš„æœ€åé˜¶æ®µ</strong></td>
<td><strong>ä»…æœ¬åœ°äº§ç”Ÿçš„åŒ…</strong></td>
</tr>
<tr>
<td>å¯¹åº”è·¯ç”±æ–¹å‘</td>
<td>å‡ºå£è·¯ç”±ï¼ˆç»è¿‡ <code>ip_route_output</code>ï¼‰</td>
<td>æœ¬åœ°è·¯ç”±ï¼ˆ<code>ip_route_output</code>ï¼‰</td>
</tr>
</tbody></table>
<hr>
<h2 id="ğŸ§©-ä¸‰ã€åœ¨ä½ çš„åœºæ™¯ï¼ˆbridgeâ†’IPâ†’bridgeï¼‰é‡Œ"><a href="#ğŸ§©-ä¸‰ã€åœ¨ä½ çš„åœºæ™¯ï¼ˆbridgeâ†’IPâ†’bridgeï¼‰é‡Œ" class="headerlink" title="ğŸ§© ä¸‰ã€åœ¨ä½ çš„åœºæ™¯ï¼ˆbridgeâ†’IPâ†’bridgeï¼‰é‡Œ"></a>ğŸ§© ä¸‰ã€åœ¨ä½ çš„åœºæ™¯ï¼ˆbridgeâ†’IPâ†’bridgeï¼‰é‡Œ</h2><p>ä½ çš„åŒ…æ˜¯ä» <strong>bridge æ”¶åˆ°çš„å¤–éƒ¨åŒ…</strong>ï¼ˆå³éæœ¬åœ°ä¸»æœºè¿›ç¨‹äº§ç”Ÿçš„ï¼‰ã€‚<br>å› æ­¤è°ƒç”¨é“¾æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ip_rcv()</span><br><span class="line">  â†’ ip_forward()</span><br><span class="line">      â†’ NF_INET_FORWARD</span><br><span class="line">      â†’ ip_forward_finish()</span><br><span class="line">          â†’ ip_output()</span><br><span class="line">              â†’ NF_INET_POST_ROUTING</span><br><span class="line">              â†’ ip_finish_output()</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶æ²¡æœ‰ä¹Ÿä¸ä¼šè¿›å…¥ <code>NF_INET_LOCAL_OUT</code>ï¼ˆOUTPUT é“¾ï¼‰ï¼Œ<br>å› ä¸ºè¿™ä¸ªåŒ…ä¸æ˜¯æœ¬æœºå‘çš„ï¼Œè€Œæ˜¯â€œè½¬å‘çš„â€ã€‚</p>
<hr>
<h2 id="ğŸ§©-å››ã€æ‰€ä»¥ä¸è¦è¢«å‡½æ•°åâ€œip-outputâ€è¯¯å¯¼"><a href="#ğŸ§©-å››ã€æ‰€ä»¥ä¸è¦è¢«å‡½æ•°åâ€œip-outputâ€è¯¯å¯¼" class="headerlink" title="ğŸ§© å››ã€æ‰€ä»¥ä¸è¦è¢«å‡½æ•°åâ€œip_outputâ€è¯¯å¯¼"></a>ğŸ§© å››ã€æ‰€ä»¥ä¸è¦è¢«å‡½æ•°åâ€œip_outputâ€è¯¯å¯¼</h2><p>å®ƒçš„åå­—ç¡®å®å®¹æ˜“é€ æˆè¯¯è§£ã€‚<br>æ­£ç¡®ç†è§£åº”è¯¥æ˜¯ï¼š</p>
<blockquote>
<p><code>ip_output()</code> â‰ˆ â€œæ‰§è¡Œ IP å±‚çš„è¾“å‡ºåŠ¨ä½œï¼ˆåŒ…æ‹¬ POSTROUTINGï¼‰â€ï¼Œ<br>è€Œä¸æ˜¯ â€œOUTPUT é“¾â€ã€‚</p>
</blockquote>
<hr>
<h2 id="ğŸ§©-äº”ã€æ€»ç»“å¯¹ç…§è¡¨ï¼ˆæ›´ç›´è§‚ï¼‰"><a href="#ğŸ§©-äº”ã€æ€»ç»“å¯¹ç…§è¡¨ï¼ˆæ›´ç›´è§‚ï¼‰" class="headerlink" title="ğŸ§© äº”ã€æ€»ç»“å¯¹ç…§è¡¨ï¼ˆæ›´ç›´è§‚ï¼‰"></a>ğŸ§© äº”ã€æ€»ç»“å¯¹ç…§è¡¨ï¼ˆæ›´ç›´è§‚ï¼‰</h2><table>
<thead>
<tr>
<th>é˜¶æ®µ</th>
<th>å†…æ ¸å‡½æ•°</th>
<th>Hook åç§°</th>
<th>åœºæ™¯</th>
</tr>
</thead>
<tbody><tr>
<td>æœ¬åœ°åº”ç”¨å‘åŒ…</td>
<td><code>ip_local_out()</code></td>
<td><code>NF_INET_LOCAL_OUT</code>ï¼ˆOUTPUT é“¾ï¼‰</td>
<td>æœ¬åœ° socket å‘å‡ºçš„åŒ…</td>
</tr>
<tr>
<td>è·¯ç”±è½¬å‘è¾“å‡º</td>
<td><code>ip_output()</code></td>
<td><code>NF_INET_POST_ROUTING</code>ï¼ˆPOSTROUTING é“¾ï¼‰</td>
<td>è·¯ç”±è½¬å‘çš„åŒ…</td>
</tr>
<tr>
<td>æœ€ç»ˆå‘åŒ…</td>
<td><code>ip_finish_output()</code> â†’ <code>dev_queue_xmit()</code></td>
<td>â€”</td>
<td>å‘é€åˆ°è®¾å¤‡ï¼ˆå¯èƒ½æ˜¯ bridgeï¼‰</td>
</tr>
</tbody></table>
<hr>
<h2 id="ğŸ§©-å…­ã€ç»“åˆä½ çš„åœºæ™¯å›é¡¾å®Œæ•´è°ƒç”¨çº¿"><a href="#ğŸ§©-å…­ã€ç»“åˆä½ çš„åœºæ™¯å›é¡¾å®Œæ•´è°ƒç”¨çº¿" class="headerlink" title="ğŸ§© å…­ã€ç»“åˆä½ çš„åœºæ™¯å›é¡¾å®Œæ•´è°ƒç”¨çº¿"></a>ğŸ§© å…­ã€ç»“åˆä½ çš„åœºæ™¯å›é¡¾å®Œæ•´è°ƒç”¨çº¿</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">br_pass_frame_up()     // bridge ä¸Šé€åˆ°ç½‘ç»œå±‚</span><br><span class="line">  -&gt; ip_rcv()</span><br><span class="line">     -&gt; ip_forward()</span><br><span class="line">        -&gt; NF_INET_FORWARD</span><br><span class="line">        -&gt; ip_forward_finish()</span><br><span class="line">           -&gt; ip_output()          // ä¸æ˜¯ OUTPUT é“¾ï¼æ˜¯ POSTROUTING é˜¶æ®µ</span><br><span class="line">              -&gt; NF_INET_POST_ROUTING</span><br><span class="line">              -&gt; ip_finish_output()</span><br><span class="line">                 -&gt; neigh_output()</span><br><span class="line">                    -&gt; dev_queue_xmit()</span><br><span class="line">                       -&gt; br_dev_xmit()   // å‡ºå£æ˜¯ bridge</span><br></pre></td></tr></table></figure>

<hr>
<p>âœ… <strong>ç»“è®ºä¸€å¥è¯ï¼š</strong></p>
<blockquote>
<p><code>ip_output()</code> æ˜¯ IP å±‚çš„è¾“å‡ºå‡½æ•°ï¼Œä¸ç­‰äº â€œOUTPUT é“¾â€ã€‚<br>å®ƒè´Ÿè´£â€œPOSTROUTINGâ€é˜¶æ®µçš„å‘åŒ…ï¼Œè€Œä¸æ˜¯â€œæœ¬åœ°ä¸»æœºäº§ç”Ÿçš„åŒ…â€çš„å¤„ç†ã€‚</p>
</blockquote>
<hr>
<p>æ˜¯å¦å¸Œæœ›æˆ‘å¸®ä½ ç”»ä¸€å¼  ASCII è°ƒç”¨ä¼ªå›¾ï¼Œ<br>ä¸“é—¨å¯¹æ¯”ï¼š</p>
<ul>
<li>â€œæœ¬åœ°å‘åŒ…è·¯å¾„ï¼ˆOUTPUT é“¾ï¼‰â€</li>
<li>â€œè·¯ç”±è½¬å‘è·¯å¾„ï¼ˆip_output â†’ POSTROUTINGï¼‰â€<br>è®©ä½ èƒ½ä¸€çœ¼çœ‹å‡ºå®ƒä»¬çš„åˆ†ç•Œï¼Ÿ</li>
</ul>
<h6 id="-8"><a href="#-8" class="headerlink" title=""></a></h6><p>éå¸¸æ£’çš„æé—® ğŸ‘ï¼Œä½ å·²ç»æŠ“åˆ°äº† Linux æ¡¥æ¥ + IP è½¬å‘ <strong>æœ€å®¹æ˜“æ··æ·†çš„ä¸€å¤„ï¼šåˆ°åº•æ˜¯å…ˆ POSTROUTING è¿˜æ˜¯å…ˆå›æ¡¥è½¬å‘ï¼Ÿ</strong></p>
<p>æˆ‘ä»¬ä¸€æ­¥æ­¥æ‹†è§£è¿™ä¸ªâ€œæ‰å±‚â€è¿‡ç¨‹ã€‚<br>ä½ ä¼šå‘ç°ï¼š<strong>ç¡®å®ä¸æ˜¯ç®€å•çš„â€œPOSTROUTING å†å›æ¡¥â€</strong>ï¼Œè€Œæ˜¯ä¸€ä¸ªâ€œåœ¨ POSTROUTING é‡Œè¢«è·¯ç”±å­ç³»ç»Ÿè°ƒç”¨åˆ° bridge å‡ºå£è®¾å¤‡â€çš„è¿‡ç¨‹ã€‚</p>
<hr>
<h2 id="ğŸ§©-å…ˆè¯´ç»“è®ºï¼ˆå¤§æ–¹å‘ï¼‰"><a href="#ğŸ§©-å…ˆè¯´ç»“è®ºï¼ˆå¤§æ–¹å‘ï¼‰" class="headerlink" title="ğŸ§© å…ˆè¯´ç»“è®ºï¼ˆå¤§æ–¹å‘ï¼‰"></a>ğŸ§© å…ˆè¯´ç»“è®ºï¼ˆå¤§æ–¹å‘ï¼‰</h2><blockquote>
<p><strong>åŒ…åœ¨ IP å±‚ç»è¿‡ POSTROUTING ä¹‹åï¼Œâ€œçœ‹èµ·æ¥åƒæ˜¯åˆæ‰å›äº†æ¡¥æ¥å±‚â€ï¼Œ</strong><br>ä½†å®é™…ä¸Šå¹¶ä¸æ˜¯â€œå›é€€â€ï¼Œè€Œæ˜¯å› ä¸º <strong>è·¯ç”±å†³å®šçš„å‡ºå£è®¾å¤‡æ˜¯ bridgeï¼ˆbr0ï¼‰</strong>ï¼Œ<br>æ‰€ä»¥å‘åŒ…æ—¶æœ€ç»ˆèµ°çš„æ˜¯ bridge çš„è¾“å‡ºé€»è¾‘ã€‚</p>
</blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IP POSTROUTING â†’ dev_queue_xmit(br0) â†’ br_dev_xmit() â†’ bridge forward</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="ğŸ§±-ä¸€ã€å…³é”®ç‚¹ï¼šbr0-æ˜¯ä¸ª-â€œè™šæ‹Ÿè®¾å¤‡â€"><a href="#ğŸ§±-ä¸€ã€å…³é”®ç‚¹ï¼šbr0-æ˜¯ä¸ª-â€œè™šæ‹Ÿè®¾å¤‡â€" class="headerlink" title="ğŸ§± ä¸€ã€å…³é”®ç‚¹ï¼šbr0 æ˜¯ä¸ª â€œè™šæ‹Ÿè®¾å¤‡â€"></a>ğŸ§± ä¸€ã€å…³é”®ç‚¹ï¼šbr0 æ˜¯ä¸ª â€œè™šæ‹Ÿè®¾å¤‡â€</h2><p>Linux çš„ bridgeï¼ˆbr0ï¼‰åœ¨å†…æ ¸ä¸­è¡¨ç°ä¸ºä¸€ä¸ª<strong>è™šæ‹Ÿç½‘ç»œè®¾å¤‡ï¼ˆnet_deviceï¼‰</strong>ã€‚</p>
<p>å½“ IP å±‚æŸ¥åˆ°è·¯ç”±è¡¨é‡Œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç›®çš„IP 192.168.10.5 â†’ å‡ºå£è®¾å¤‡ br0</span><br></pre></td></tr></table></figure>

<p>å°±æ„å‘³ç€ï¼š</p>
<blockquote>
<p>è¿™ä¸ªåŒ…è™½ç„¶æ˜¯ IP å±‚è½¬å‘çš„ï¼Œä½†å‡ºå£åœ¨é€»è¾‘ä¸Šæ˜¯ br0ï¼Œå®é™…ç‰©ç†å‘åŒ…çš„æ¥å£æ˜¯æ¡¥ä¸‹å£ï¼ˆæ¯”å¦‚ eth1ï¼‰ã€‚</p>
</blockquote>
<hr>
<h2 id="âš™ï¸-äºŒã€ä»-IP-å±‚åˆ°æ¡¥æ¥å±‚çš„çœŸå®è°ƒç”¨é“¾"><a href="#âš™ï¸-äºŒã€ä»-IP-å±‚åˆ°æ¡¥æ¥å±‚çš„çœŸå®è°ƒç”¨é“¾" class="headerlink" title="âš™ï¸ äºŒã€ä» IP å±‚åˆ°æ¡¥æ¥å±‚çš„çœŸå®è°ƒç”¨é“¾"></a>âš™ï¸ äºŒã€ä» IP å±‚åˆ°æ¡¥æ¥å±‚çš„çœŸå®è°ƒç”¨é“¾</h2><p>æˆ‘ä»¬æ¥çœ‹çœŸæ­£çš„ä»£ç è·¯å¾„ï¼ˆç®€åŒ–åï¼‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ip_forward()</span><br><span class="line">  â†’ ip_forward_finish()</span><br><span class="line">    â†’ ip_output()                     // POSTROUTING å¼€å§‹</span><br><span class="line">       â†’ NF_INET_POST_ROUTING</span><br><span class="line">       â†’ ip_finish_output()</span><br><span class="line">          â†’ neigh_output()</span><br><span class="line">             â†’ dev_queue_xmit()       // å‘åˆ°è·¯ç”±é€‰å®šçš„è®¾å¤‡ï¼šbr0</span><br><span class="line">                â†’ br_dev_xmit()       // å› ä¸º br0 æ˜¯ bridge</span><br><span class="line">                   â†’ br_forward()     // æ¡¥æ¥å±‚è½¬å‘é€»è¾‘</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥è¡¨é¢ä¸Šçœ‹æ˜¯ï¼š</p>
<blockquote>
<p>â€œIP POSTROUTING â†’ æ¡¥æ¥å±‚ forwardâ€</p>
</blockquote>
<p>ä½†å®é™…ä¸Šè¿™åªæ˜¯ï¼š</p>
<blockquote>
<p>â€œIP å±‚é€å‡º â†’ å‘åˆ° bridge å‡ºå£ â†’ bridge å†è½¬å‘â€</p>
</blockquote>
<hr>
<h2 id="ğŸ§©-ä¸‰ã€å†è”ç³»å›¾ä¸­é‚£æ¡â€œä¸Šå±‚-forwardâ€è·¯å¾„"><a href="#ğŸ§©-ä¸‰ã€å†è”ç³»å›¾ä¸­é‚£æ¡â€œä¸Šå±‚-forwardâ€è·¯å¾„" class="headerlink" title="ğŸ§© ä¸‰ã€å†è”ç³»å›¾ä¸­é‚£æ¡â€œä¸Šå±‚ forwardâ€è·¯å¾„"></a>ğŸ§© ä¸‰ã€å†è”ç³»å›¾ä¸­é‚£æ¡â€œä¸Šå±‚ forwardâ€è·¯å¾„</h2><p>ä½ æåˆ°çš„é‚£æ¡è“è‰²ä¸Šå±‚ â€œforwardâ€ è·¯å¾„ï¼ˆå›¾ä¸­ä» Network Layer æ‰åˆ° Link Layer çš„é‚£æ¡çº¿ï¼‰ï¼Œ<br>è¡¨ç¤ºçš„å°±æ˜¯è¿™ç§æƒ…å†µï¼š</p>
<blockquote>
<p>IP å±‚å¤„ç†å®Œï¼ˆåŒ…æ‹¬ POSTROUTINGï¼‰ä¹‹åï¼Œ<br>åŒ…å‘å¾€çš„æ˜¯ä¸€ä¸ª bridge è®¾å¤‡ï¼ˆbr0ï¼‰ï¼Œ<br>å› æ­¤åŒ…çš„å‘é€è¿›å…¥ bridge å­ç³»ç»Ÿç»§ç»­èµ°æ¡¥è½¬å‘ã€‚</p>
</blockquote>
<p>å®ƒå¹¶ä¸æ˜¯â€œIP forward â†’ POSTROUTING â†’ å† forward ä¸€æ¬¡â€ï¼Œ<br>è€Œæ˜¯ä¸€æ¬¡è¿ç»­çš„å‘é€è°ƒç”¨æ ˆã€‚</p>
<hr>
<h2 id="ğŸ§ -å››ã€å¯¹æ¯”â€œçº¯æ¡¥è½¬å‘â€çš„å¦ä¸€æ¡è·¯å¾„ï¼ˆå›¾ä¸­æœ€ä¸‹é¢çš„é‚£æ¡ï¼‰"><a href="#ğŸ§ -å››ã€å¯¹æ¯”â€œçº¯æ¡¥è½¬å‘â€çš„å¦ä¸€æ¡è·¯å¾„ï¼ˆå›¾ä¸­æœ€ä¸‹é¢çš„é‚£æ¡ï¼‰" class="headerlink" title="ğŸ§  å››ã€å¯¹æ¯”â€œçº¯æ¡¥è½¬å‘â€çš„å¦ä¸€æ¡è·¯å¾„ï¼ˆå›¾ä¸­æœ€ä¸‹é¢çš„é‚£æ¡ï¼‰"></a>ğŸ§  å››ã€å¯¹æ¯”â€œçº¯æ¡¥è½¬å‘â€çš„å¦ä¸€æ¡è·¯å¾„ï¼ˆå›¾ä¸­æœ€ä¸‹é¢çš„é‚£æ¡ï¼‰</h2><p>çº¯æ¡¥æ¨¡å¼ï¼ˆno IP routingï¼‰æ—¶ï¼Œè°ƒç”¨é“¾æ˜¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">br_handle_frame()</span><br><span class="line">  â†’ br_forward()</span><br><span class="line">    â†’ dev_queue_xmit()</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå®Œå…¨æ²¡è¿›è¿‡ IP å±‚ï¼ˆä¹Ÿå°±æ²¡æœ‰ POSTROUTINGï¼‰ï¼Œ<br>æ‰€ä»¥è¿™æ¡çº¿åœ¨å›¾ä¸Šæ˜¯æœ€åº•ä¸‹é‚£æ¡çº¯è“è‰²çš„ Link Layer è·¯å¾„ã€‚</p>
<hr>
<h2 id="ğŸ”-äº”ã€ä¸¤æ¡â€œforwardâ€çš„åŒºåˆ«æ€»ç»“"><a href="#ğŸ”-äº”ã€ä¸¤æ¡â€œforwardâ€çš„åŒºåˆ«æ€»ç»“" class="headerlink" title="ğŸ” äº”ã€ä¸¤æ¡â€œforwardâ€çš„åŒºåˆ«æ€»ç»“"></a>ğŸ” äº”ã€ä¸¤æ¡â€œforwardâ€çš„åŒºåˆ«æ€»ç»“</h2><table>
<thead>
<tr>
<th>é¡¹ç›®</th>
<th>ä¸Šå±‚ forwardï¼ˆæ‰å›æ¡¥ï¼‰</th>
<th>ä¸‹å±‚ forwardï¼ˆçº¯æ¡¥ï¼‰</th>
</tr>
</thead>
<tbody><tr>
<td>è¿›å…¥ IP å±‚</td>
<td>âœ… æ˜¯çš„ï¼ˆip_rcv â†’ ip_forwardï¼‰</td>
<td>âŒ å¦</td>
</tr>
<tr>
<td>æ˜¯å¦èµ°è¿‡ POSTROUTING</td>
<td>âœ… èµ°è¿‡ NF_INET_POST_ROUTING</td>
<td>âŒ æ²¡æœ‰</td>
</tr>
<tr>
<td>å‡ºå£è®¾å¤‡</td>
<td>br0ï¼ˆè™šæ‹Ÿæ¡¥ï¼‰</td>
<td>æ¡¥ç«¯å£ï¼ˆçœŸå®ç‰©ç†å£ï¼‰</td>
</tr>
<tr>
<td>è°ƒç”¨é¡ºåº</td>
<td>ip_output â†’ dev_queue_xmit(br0) â†’ br_dev_xmit â†’ br_forward</td>
<td>br_handle_frame â†’ br_forward</td>
</tr>
<tr>
<td>å…¸å‹åœºæ™¯</td>
<td>è·¯ç”±è½¬å‘è‡³ bridge ç½‘ç»œ</td>
<td>çº¯äºŒå±‚äº¤æ¢</td>
</tr>
</tbody></table>
<hr>
<h2 id="ğŸ“˜-å…­ã€å½¢è±¡çš„-ASCII-ä¼ªå›¾"><a href="#ğŸ“˜-å…­ã€å½¢è±¡çš„-ASCII-ä¼ªå›¾" class="headerlink" title="ğŸ“˜ å…­ã€å½¢è±¡çš„ ASCII ä¼ªå›¾"></a>ğŸ“˜ å…­ã€å½¢è±¡çš„ ASCII ä¼ªå›¾</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">// ----------------------</span><br><span class="line">// è·¯ç”± + æ¡¥æ¥è½¬å‘ï¼ˆIPâ†’Bridgeï¼‰</span><br><span class="line">// ----------------------</span><br><span class="line">br_handle_frame()</span><br><span class="line">   â†“</span><br><span class="line">br_pass_frame_up()</span><br><span class="line">   â†“</span><br><span class="line">ip_rcv()</span><br><span class="line">   â†“</span><br><span class="line">ip_forward()</span><br><span class="line">   â†“</span><br><span class="line">NF_INET_FORWARD</span><br><span class="line">   â†“</span><br><span class="line">ip_output()                // è¿›å…¥ POSTROUTING</span><br><span class="line">   â†“</span><br><span class="line">NF_INET_POST_ROUTING</span><br><span class="line">   â†“</span><br><span class="line">ip_finish_output()</span><br><span class="line">   â†“</span><br><span class="line">dev_queue_xmit(br0)        // å‡ºå£æ˜¯ bridge è®¾å¤‡</span><br><span class="line">   â†“</span><br><span class="line">br_dev_xmit()</span><br><span class="line">   â†“</span><br><span class="line">br_forward()               // æ¡¥å±‚æœ€ç»ˆè½¬å‘åˆ°ç‰©ç†å£</span><br><span class="line">   â†“</span><br><span class="line">dev_queue_xmit(eth1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// ----------------------</span><br><span class="line">// çº¯æ¡¥è½¬å‘ï¼ˆä¸ç»è¿‡ IP å±‚ï¼‰</span><br><span class="line">// ----------------------</span><br><span class="line">br_handle_frame()</span><br><span class="line">   â†“</span><br><span class="line">br_forward()</span><br><span class="line">   â†“</span><br><span class="line">dev_queue_xmit(eth1)</span><br></pre></td></tr></table></figure>

<hr>
<p>âœ… <strong>æ€»ç»“ä¸€å¥è¯ï¼š</strong></p>
<blockquote>
<p>é‚£æ¡â€œä¸Šå±‚ forwardâ€è·¯å¾„å¹¶ä¸æ˜¯â€œPOSTROUTING ååˆå›æ¡¥â€ï¼Œ<br>è€Œæ˜¯å› ä¸º <strong>è·¯ç”±çš„å‡ºå£æ˜¯ bridge è®¾å¤‡</strong>ï¼Œ<br>æ‰€ä»¥åœ¨ <code>dev_queue_xmit(br0)</code> å¤„è‡ªç„¶è¿›å…¥äº† bridge å­ç³»ç»Ÿçš„å‘åŒ…é€»è¾‘ã€‚</p>
</blockquote>
<hr>
<p>æ˜¯å¦å¸Œæœ›æˆ‘åœ¨è¿™ä¸ªä¼ªå›¾ä¸Šå†åŠ ä¸Š <code>Netfilter hook</code> çš„æ ‡æ³¨ï¼ˆæ¯”å¦‚ <code>PREROUTING</code>ã€<code>FORWARD</code>ã€<code>POSTROUTING</code>ï¼‰ç‰ˆæœ¬ï¼Ÿé‚£æ ·ä½ å°±èƒ½ä¸€çœ¼çœ‹åˆ° Hook è§¦å‘çš„å…ˆåä¸å±‚çº§å…³ç³»ã€‚</p>
<h5 id="-9"><a href="#-9" class="headerlink" title=""></a></h5><p>æ‰åˆ°ç½‘æ¡¥å±‚åæ²¡æœ‰ç»è¿‡ç½‘æ¡¥å±‚çš„filterå¤„ç†ï¼Ÿ</p>
<p>ä½ è¿™ä¸ªè§‚å¯Ÿ <strong>éå¸¸ç²¾å‡†</strong> ğŸ‘ï¼Œè€Œä¸”ç¡®å®ç‚¹åˆ°äº† <strong>Linux æ¡¥æ¥ + IP è·¯ç”±è”åŠ¨æœºåˆ¶</strong>ï¼ˆç‰¹åˆ«æ˜¯ bridge-nf äº¤äº’ï¼‰é‡Œæœ€å®¹æ˜“è®©äººå›°æƒ‘çš„ä¸€ç¯ã€‚</p>
<p>æˆ‘ä»¬è¿™æ¬¡è¦è®²æ¸…æ¥šï¼š</p>
<blockquote>
<p><strong>ä¸ºä»€ä¹ˆ IP å±‚è½¬å‘åˆ° bridgeï¼ˆbr0ï¼‰å‡ºå£æ—¶ï¼Œçœ‹èµ·æ¥æ²¡å†è§¦å‘æ¡¥æ¥å±‚çš„ <code>filter forward</code>ï¼Ÿ</strong></p>
</blockquote>
<hr>
<h2 id="ğŸ§©-ä¸€ã€å…³é”®èƒŒæ™¯ï¼šbridge-nfï¼ˆbridge-netfilterï¼‰æœºåˆ¶"><a href="#ğŸ§©-ä¸€ã€å…³é”®èƒŒæ™¯ï¼šbridge-nfï¼ˆbridge-netfilterï¼‰æœºåˆ¶" class="headerlink" title="ğŸ§© ä¸€ã€å…³é”®èƒŒæ™¯ï¼šbridge-nfï¼ˆbridge netfilterï¼‰æœºåˆ¶"></a>ğŸ§© ä¸€ã€å…³é”®èƒŒæ™¯ï¼šbridge-nfï¼ˆbridge netfilterï¼‰æœºåˆ¶</h2><p>Linux æœ‰ä¸€ä¸ªä¸“é—¨çš„æœºåˆ¶å« <strong>bridge-nfï¼ˆbr_netfilterï¼‰</strong>ï¼Œ<br>å®ƒæ§åˆ¶ <strong>ç½‘æ¡¥å±‚æ˜¯å¦ä¸ç½‘ç»œå±‚å…±äº« netfilter å¤„ç†</strong>ã€‚</p>
<p>é€šè¿‡ sysctl å¼€å…³æ§åˆ¶ï¼š</p>
<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>å«ä¹‰</th>
<th>é»˜è®¤å€¼ï¼ˆè§†å‘è¡Œç‰ˆè€Œå¼‚ï¼‰</th>
</tr>
</thead>
<tbody><tr>
<td><code>net.bridge.bridge-nf-call-iptables</code></td>
<td>æ¡¥æ¥å±‚è°ƒç”¨ IPv4 çš„ netfilterï¼ˆiptablesï¼‰</td>
<td>0ï¼ˆå…³ï¼‰</td>
</tr>
<tr>
<td><code>net.bridge.bridge-nf-call-ip6tables</code></td>
<td>æ¡¥æ¥å±‚è°ƒç”¨ IPv6 çš„ netfilter</td>
<td>0</td>
</tr>
<tr>
<td><code>net.bridge.bridge-nf-call-arptables</code></td>
<td>æ¡¥æ¥å±‚è°ƒç”¨ ARP çš„ netfilter</td>
<td>0</td>
</tr>
</tbody></table>
<p>å¦‚æœå…³é—­ï¼ˆé»˜è®¤æƒ…å†µï¼‰ï¼š</p>
<blockquote>
<p>æ¡¥å±‚åªå¤„ç† L2 è½¬å‘ï¼Œä¸èµ° IP çš„ netfilter é“¾ï¼ˆä¸è§¦å‘ <code>filter forward</code>ï¼‰ã€‚</p>
</blockquote>
<p>å¦‚æœæ‰“å¼€ï¼š</p>
<blockquote>
<p>æ¡¥å±‚ä¼šåœ¨ L2 æ¡¥æ¥æ—¶è°ƒç”¨ IPv4&#x2F;IPv6 çš„é’©å­ï¼Œå¯¼è‡´åŒ…åœ¨æ¡¥è½¬å‘æ—¶ä¹Ÿä¼šè·‘è¿‡ IP çš„ PREROUTINGã€FORWARDã€POSTROUTING ç­‰ã€‚</p>
</blockquote>
<hr>
<h2 id="ğŸ§±-äºŒã€åŒºåˆ†ä¸¤ç±»â€œforwardâ€"><a href="#ğŸ§±-äºŒã€åŒºåˆ†ä¸¤ç±»â€œforwardâ€" class="headerlink" title="ğŸ§± äºŒã€åŒºåˆ†ä¸¤ç±»â€œforwardâ€"></a>ğŸ§± äºŒã€åŒºåˆ†ä¸¤ç±»â€œforwardâ€</h2><p>æˆ‘ä»¬ç°åœ¨æœ‰ä¸¤ç§â€œforwardâ€ï¼š</p>
<table>
<thead>
<tr>
<th>forward ç±»å‹</th>
<th>è§¦å‘å±‚çº§</th>
<th>æ˜¯å¦èµ° bridge filter é“¾</th>
<th>æ˜¯å¦èµ° IP filter é“¾</th>
</tr>
</thead>
<tbody><tr>
<td><strong>çº¯æ¡¥è½¬å‘</strong></td>
<td>L2ï¼ˆ<code>br_forward()</code>ï¼‰</td>
<td>âœ… ä¼šè§¦å‘ bridge <code>filter forward</code>ï¼ˆè‹¥å¯ç”¨ bridge-nfï¼‰</td>
<td>âŒ é»˜è®¤ä¸èµ°</td>
</tr>
<tr>
<td><strong>IPâ†’bridge å‡ºå£</strong></td>
<td>L3ï¼ˆ<code>ip_forward()</code>â†’<code>br_dev_xmit()</code>ï¼‰</td>
<td>âŒ ä¸è§¦å‘ bridge filter</td>
<td>âœ… å·²ç»èµ°è¿‡ IP <code>FORWARD</code> &amp; <code>POSTROUTING</code></td>
</tr>
</tbody></table>
<hr>
<h2 id="âš™ï¸-ä¸‰ã€ä¸ºä»€ä¹ˆâ€œIPâ†’bridgeâ€ä¸å†è§¦å‘-bridge-çš„-filter-forward"><a href="#âš™ï¸-ä¸‰ã€ä¸ºä»€ä¹ˆâ€œIPâ†’bridgeâ€ä¸å†è§¦å‘-bridge-çš„-filter-forward" class="headerlink" title="âš™ï¸ ä¸‰ã€ä¸ºä»€ä¹ˆâ€œIPâ†’bridgeâ€ä¸å†è§¦å‘ bridge çš„ filter forward"></a>âš™ï¸ ä¸‰ã€ä¸ºä»€ä¹ˆâ€œIPâ†’bridgeâ€ä¸å†è§¦å‘ bridge çš„ <code>filter forward</code></h2><p>è¿™æ˜¯å› ä¸ºï¼š</p>
<ul>
<li>å¯¹äº IP å±‚å‘å‡ºçš„åŒ…ï¼ˆ<code>ip_output()</code> â†’ <code>dev_queue_xmit(br0)</code>ï¼‰ï¼Œ<br><strong>å®ƒå·²ç»åœ¨ IP å±‚å®Œæˆäº† FORWARDã€POSTROUTING çš„ netfilter è°ƒç”¨</strong>ã€‚</li>
<li>å½“åŒ…è¿›å…¥ bridge çš„å‘é€è·¯å¾„ï¼ˆ<code>br_dev_xmit()</code> â†’ <code>br_forward()</code>ï¼‰æ—¶ï¼Œ<br>è¿™äº›åŒ…çš„æ¥æºæ˜¯â€œIP å±‚çš„å‘åŒ…æ“ä½œâ€ï¼Œ<strong>ä¸æ˜¯æ¡¥æ¥æ¥æ”¶è·¯å¾„ï¼ˆbr_handle_frameï¼‰</strong>ã€‚</li>
<li>è€Œæ¡¥æ¥çš„ <code>filter forward</code> æ˜¯åœ¨ <strong>æ¥æ”¶è·¯å¾„</strong> æ‰ä¼šè§¦å‘çš„ï¼ˆ<code>br_handle_frame()</code>â†’<code>br_nf_forward_ip()</code>ï¼‰ï¼Œ<br>å‘åŒ…è·¯å¾„é»˜è®¤ä¸ä¼šå†æ¬¡è°ƒç”¨ã€‚</li>
</ul>
<p>å› æ­¤ï¼š</p>
<blockquote>
<p><strong>è¿™ç±»åŒ…ä» IP å±‚æ‰åˆ° bridge å±‚ï¼Œåªç»è¿‡æ¡¥æ¥çš„å‘åŒ…é€»è¾‘ï¼Œä¸ä¼šå†ç»è¿‡ bridge å±‚çš„ Netfilter hooksã€‚</strong></p>
</blockquote>
<hr>
<h2 id="ğŸ”-å››ã€ä»£ç ä¸Šï¼ˆä»-ip-output-åˆ°-br-dev-xmitï¼‰"><a href="#ğŸ”-å››ã€ä»£ç ä¸Šï¼ˆä»-ip-output-åˆ°-br-dev-xmitï¼‰" class="headerlink" title="ğŸ” å››ã€ä»£ç ä¸Šï¼ˆä» ip_output åˆ° br_dev_xmitï¼‰"></a>ğŸ” å››ã€ä»£ç ä¸Šï¼ˆä» ip_output åˆ° br_dev_xmitï¼‰</h2><p>ä½ å¯ä»¥åœ¨å†…æ ¸ä»£ç è·¯å¾„é‡Œçœ‹åˆ°è¿™æ ·çš„è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// net/ipv4/ip_output.c</span><br><span class="line">ip_output()</span><br><span class="line"> â””â”€â”€ ip_finish_output()</span><br><span class="line">       â””â”€â”€ neigh_output()</span><br><span class="line">             â””â”€â”€ dev_queue_xmit(br0)</span><br><span class="line">                   â””â”€â”€ br_dev_xmit()       // è°ƒåˆ° bridge å­ç³»ç»Ÿ</span><br><span class="line">                         â””â”€â”€ br_forward()  // å®é™…æ¡¥è½¬å‘</span><br><span class="line"></span><br><span class="line">// æ³¨æ„ï¼šè¿™é‡Œä¸ä¼šè°ƒç”¨ br_nf_forward_ip()</span><br><span class="line">// å› ä¸ºè¿™æ˜¯ TX pathï¼Œä¸æ˜¯ RX pathã€‚</span><br></pre></td></tr></table></figure>

<p>åªæœ‰ RX è·¯å¾„ï¼ˆ<code>br_handle_frame()</code>ï¼‰æ‰ä¼šè§¦å‘ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// net/bridge/br_input.c</span><br><span class="line">br_handle_frame()</span><br><span class="line"> â””â”€â”€ br_nf_pre_routing()</span><br><span class="line"> â””â”€â”€ br_nf_forward_ip()</span><br><span class="line"> â””â”€â”€ br_forward()</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="ğŸ“˜-äº”ã€å› æ­¤åœ¨ä½ æåˆ°çš„å›¾ä¸­ï¼š"><a href="#ğŸ“˜-äº”ã€å› æ­¤åœ¨ä½ æåˆ°çš„å›¾ä¸­ï¼š" class="headerlink" title="ğŸ“˜ äº”ã€å› æ­¤åœ¨ä½ æåˆ°çš„å›¾ä¸­ï¼š"></a>ğŸ“˜ äº”ã€å› æ­¤åœ¨ä½ æåˆ°çš„å›¾ä¸­ï¼š</h2><p>é‚£æ¡ä» â€œNetwork Layer (POSTROUTING)â€ æ‰åˆ° â€œLink Layer forwardâ€ çš„çº¿ï¼Œ<br>å¯¹åº”çš„æ˜¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ip_output()</span><br><span class="line"> â†’ POSTROUTINGï¼ˆå·²å®Œæˆï¼‰</span><br><span class="line"> â†’ dev_queue_xmit(br0)</span><br><span class="line"> â†’ br_dev_xmit()  // ç›´æ¥è¿›å…¥å‘åŒ…ï¼Œä¸å†è§¦å‘ bridge filter</span><br></pre></td></tr></table></figure>

<p>å®ƒ<strong>ä¸ä¼šå†èµ° bridge å±‚çš„ PREROUTING &#x2F; FORWARD &#x2F; POSTROUTING</strong>ã€‚</p>
<hr>
<h2 id="ğŸ§ -å…­ã€å¦‚æœä½ æ‰“å¼€-bridge-nfï¼Œä¼šæ€æ ·ï¼Ÿ"><a href="#ğŸ§ -å…­ã€å¦‚æœä½ æ‰“å¼€-bridge-nfï¼Œä¼šæ€æ ·ï¼Ÿ" class="headerlink" title="ğŸ§  å…­ã€å¦‚æœä½ æ‰“å¼€ bridge-nfï¼Œä¼šæ€æ ·ï¼Ÿ"></a>ğŸ§  å…­ã€å¦‚æœä½ æ‰“å¼€ bridge-nfï¼Œä¼šæ€æ ·ï¼Ÿ</h2><p>è‹¥å¼€å¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w net.bridge.bridge-nf-call-iptables=1</span><br></pre></td></tr></table></figure>

<p>é‚£æƒ…å†µä¼šä¸ä¸€æ ·ï¼š</p>
<ul>
<li>å³ä½¿æ˜¯ IPâ†’bridge å‡ºå£çš„åŒ…ï¼Œä¹Ÿä¼šè¿›å…¥ bridge çš„ netfilter è·¯å¾„ï¼›</li>
<li>æ¡¥å±‚ä¼šåœ¨ TX æ—¶â€œhookâ€ä½ IP å±‚çš„åŒ…ï¼Œå†æ¬¡è¿‡ä¸€é PREROUTING&#x2F;FORWARDï¼›</li>
<li>å› æ­¤è¿™æ—¶ä½ åœ¨ iptables çœ‹åˆ°çš„åŒ…æ•°ä¼šç¿»å€ï¼ˆæ—¢èµ°äº† IP å±‚åˆèµ°äº† bridge å±‚ï¼‰ã€‚</li>
</ul>
<p>è¿™æ˜¯ä¸ºäº†å…¼å®¹æŸäº›â€œé€æ˜é˜²ç«å¢™ï¼ˆtransparent firewallï¼‰â€åœºæ™¯ï¼Œ<br>ä½†é»˜è®¤æ˜¯å…³çš„ï¼Œå› ä¸ºæ€§èƒ½æ¶ˆè€—è¾ƒå¤§ã€‚</p>
<hr>
<h2 id="âœ…-æ€»ç»“ä¸€å¥è¯ï¼š"><a href="#âœ…-æ€»ç»“ä¸€å¥è¯ï¼š" class="headerlink" title="âœ… æ€»ç»“ä¸€å¥è¯ï¼š"></a>âœ… æ€»ç»“ä¸€å¥è¯ï¼š</h2><blockquote>
<p>å½“ä¸€ä¸ªåŒ…ä» IP å±‚è·¯ç”±åå‘å¾€ bridgeï¼ˆbr0ï¼‰å‡ºå£æ—¶ï¼Œ<br>å®ƒåªèµ° <strong>IP å±‚çš„ Netfilter (FORWARD + POSTROUTING)</strong>ï¼Œ<br>ä¸ä¼šå†è¿›å…¥ <strong>bridge å±‚çš„ filter forward</strong>ã€‚</p>
<p>å› ä¸ºæ­¤æ—¶åŒ…çš„ç”Ÿå‘½å‘¨æœŸå·²æ˜¯â€œå‘åŒ…â€ï¼Œä¸æ˜¯â€œæ¡¥æ¥æ¥æ”¶â€ï¼›<br>æ¡¥å±‚åªæ˜¯è´Ÿè´£è½¬å‘ï¼Œä¸å†è§¦å‘æ–°çš„ netfilterã€‚</p>
</blockquote>
<hr>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color2">bridge</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2025/11/10/%E7%BD%91%E6%A1%A5%E8%BD%AC%E5%8F%91%E5%88%B0%E5%8F%A6%E4%B8%80%E4%B8%AA%E7%BD%91%E6%A1%A5/">å±•å¼€å…¨æ–‡ >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-netfilter" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2025/09/11/netfilter/">netfilter</a>
    </h1>
  

        
        <a href="/2025/09/11/netfilter/" class="archive-article-date">
  	<time datetime="2025-09-10T17:17:01.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2025-09-11</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Netfilter"><a href="#Netfilter" class="headerlink" title="Netfilter"></a>Netfilter</h1><p><img src="/2025/09/11/netfilter/Netfilter-packet-flow.svg" alt="Netfilter-packet-flow"></p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">netfilter</a>
        		</li>
      		 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color4">iptables</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2025/09/11/netfilter/">å±•å¼€å…¨æ–‡ >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-è½¯ä»¶æ¨¡æ‹Ÿè™šæ‹Ÿæ— çº¿WLANæ¥å£" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2025/09/08/%E8%BD%AF%E4%BB%B6%E6%A8%A1%E6%8B%9F%E8%99%9A%E6%8B%9F%E6%97%A0%E7%BA%BFWLAN%E6%8E%A5%E5%8F%A3/">è½¯ä»¶æ¨¡æ‹Ÿè™šæ‹Ÿæ— çº¿WLANæ¥å£</a>
    </h1>
  

        
        <a href="/2025/09/08/%E8%BD%AF%E4%BB%B6%E6%A8%A1%E6%8B%9F%E8%99%9A%E6%8B%9F%E6%97%A0%E7%BA%BFWLAN%E6%8E%A5%E5%8F%A3/" class="archive-article-date">
  	<time datetime="2025-09-08T15:14:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2025-09-08</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>ç”±äºè™šæ‹Ÿæœºé€šå¸¸æ²¡æœ‰<strong>ç‰©ç†çš„æ— çº¿ç½‘å¡</strong>ï¼ˆWi-Fi Adapterï¼‰ï¼Œæˆ‘ä»¬æ— æ³•åˆ›å»ºçœŸæ­£çš„ã€å¯ä¾›æ‰‹æœºæˆ–å…¶ä»–ç”µè„‘è¿æ¥çš„æ— çº¿ä¿¡å·ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ª<strong>è™šæ‹Ÿçš„æ— çº¿æ¥å…¥ç‚¹ï¼ˆVirtual APï¼‰</strong>ï¼Œå®ƒå…·å¤‡çœŸå®APçš„æ‰€æœ‰è½¯ä»¶åŠŸèƒ½ï¼Œåªæ˜¯æ— çº¿ç”µä¿¡å·æ˜¯è™šæ‹Ÿçš„ã€‚</p>
<p>æˆ‘ä»¬å°†ä½¿ç”¨ Linux å†…æ ¸æ¨¡å— <code>mac80211_hwsim</code> æ¥æ¨¡æ‹Ÿæ— çº¿ç¡¬ä»¶ã€‚è¿™ä¸ªæ¨¡å—ä¼šåˆ›å»ºä¸¤ä¸ªï¼ˆæˆ–æ›´å¤šï¼‰è™šæ‹Ÿçš„æ— çº¿ç½‘å¡ï¼Œå®ƒä»¬ä¹‹é—´å¯ä»¥é€šè¿‡ç©ºæ°”ï¼ˆè™šæ‹Ÿçš„ï¼‰è¿›è¡Œé€šä¿¡ï¼Œéå¸¸é€‚åˆåœ¨è™šæ‹Ÿæœºä¸­æµ‹è¯• hostapdã€wpa_supplicant ç­‰å·¥å…·ã€‚</p>
<h4 id="ç¬¬-1-æ­¥ï¼šæ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…å¿…è¦å·¥å…·"><a href="#ç¬¬-1-æ­¥ï¼šæ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…å¿…è¦å·¥å…·" class="headerlink" title="ç¬¬ 1 æ­¥ï¼šæ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…å¿…è¦å·¥å…·"></a>ç¬¬ 1 æ­¥ï¼šæ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…å¿…è¦å·¥å…·</h4><p>æ‰“å¼€ç»ˆç«¯ï¼Œæ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨å¹¶å®‰è£… <code>hostapd</code> å’Œ <code>dnsmasq</code>ï¼ˆç”¨äºæä¾› DHCP å’Œ DNS æœåŠ¡ï¼‰ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install hostapd dnsmasq iw</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>hostapd</code>: åˆ›å»º AP çš„ä¸»è¦è½¯ä»¶ã€‚</p>
</li>
<li><p><code>dnsmasq</code>: è½»é‡çº§çš„ DHCP å’Œ DNS æœåŠ¡å™¨ã€‚</p>
</li>
<li><p><code>iw</code>: ç”¨äºç®¡ç†å’Œé…ç½®æ— çº¿è®¾å¤‡çš„å·¥å…·ã€‚</p>
</li>
</ul>
<h4 id="ç¬¬-2-æ­¥ï¼šåŠ è½½è™šæ‹Ÿæ— çº¿é©±åŠ¨"><a href="#ç¬¬-2-æ­¥ï¼šåŠ è½½è™šæ‹Ÿæ— çº¿é©±åŠ¨" class="headerlink" title="ç¬¬ 2 æ­¥ï¼šåŠ è½½è™šæ‹Ÿæ— çº¿é©±åŠ¨"></a>ç¬¬ 2 æ­¥ï¼šåŠ è½½è™šæ‹Ÿæ— çº¿é©±åŠ¨</h4><p>Linux å†…æ ¸è‡ªå¸¦äº† <code>mac80211_hwsim</code> æ¨¡å—ã€‚åŠ è½½å®ƒæ¥åˆ›å»ºè™šæ‹Ÿæ— çº¿ç½‘å¡ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> modprobe mac80211_hwsim</span><br></pre></td></tr></table></figure>

<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå‘½ä»¤ä¼šåˆ›å»º <strong>ä¸¤ä¸ª</strong> è™šæ‹Ÿæ— çº¿ç½‘å¡ï¼ˆä¾‹å¦‚ <code>wlan0</code> å’Œ <code>wlan1</code>ï¼‰ã€‚å®ƒä»¬å°±åƒä¸¤å°è™šæ‹Ÿçš„ç”µè„‘å¸¦ç€è™šæ‹Ÿçš„æ— çº¿ç½‘å¡ï¼Œå¹¶ä¸”å¯ä»¥å½¼æ­¤â€œå¬åˆ°â€å¯¹æ–¹çš„ä¿¡å·ã€‚</p>
<p><strong>éªŒè¯æ˜¯å¦æˆåŠŸï¼š</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iw dev</span><br></pre></td></tr></table></figure>

<p>ä½ åº”è¯¥èƒ½çœ‹åˆ°ä¸¤ä¸ªæ–°çš„æ— çº¿è®¾å¤‡ï¼Œåå­—é€šå¸¸æ˜¯ <code>wlan0</code> å’Œ <code>wlan1</code>ã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>ifconfig</code> æˆ– <code>ip a</code> å‘½ä»¤æ¥æŸ¥çœ‹ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">kkhm@vm:~$ iw dev</span><br><span class="line"><span class="meta prompt_">phy#</span><span class="language-bash">1</span></span><br><span class="line">        Unnamed/non-netdev interface</span><br><span class="line">                wdev 0x100000002</span><br><span class="line">                addr 42:00:00:00:01:00</span><br><span class="line">                type P2P-device</span><br><span class="line">                txpower 20.00 dBm</span><br><span class="line">        Interface wlan1</span><br><span class="line">                ifindex 5</span><br><span class="line">                wdev 0x100000001</span><br><span class="line">                addr 02:00:00:00:01:00</span><br><span class="line">                type managed</span><br><span class="line">                txpower 20.00 dBm</span><br><span class="line">                multicast TXQ:</span><br><span class="line">                        qsz-byt qsz-pkt flows   drops   marks   overlmt hashcol tx-bytes        tx-packets</span><br><span class="line">                        0       0       0       0       0       0       0       0               0</span><br><span class="line"><span class="meta prompt_">phy#</span><span class="language-bash">0</span></span><br><span class="line">        Interface wlan0</span><br><span class="line">                ifindex 4</span><br><span class="line">                wdev 0x1</span><br><span class="line">                addr 02:00:00:00:00:00</span><br><span class="line">                type managed</span><br><span class="line">                txpower 20.00 dBm</span><br><span class="line">                multicast TXQ:</span><br><span class="line">                        qsz-byt qsz-pkt flows   drops   marks   overlmt hashcol tx-bytes        tx-packets</span><br><span class="line">                        0       0       0       0       0       0       0       0               0</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kkhm@vm:~$ ifconfig</span><br><span class="line">wlan0: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500</span><br><span class="line">        ether 02:00:00:00:00:00  txqueuelen 1000  (ä»¥å¤ªç½‘)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">wlan1: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500</span><br><span class="line">        ether 02:00:00:00:01:00  txqueuelen 1000  (ä»¥å¤ªç½‘)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>



<p><strong>(å¯é€‰) æŒ‡å®šåˆ›å»ºç½‘å¡çš„æ•°é‡ï¼š</strong></p>
<p>å¦‚æœä½ æƒ³åˆ›å»ºæ›´å¤šè™šæ‹Ÿç½‘å¡ï¼ˆæ¯”å¦‚ç”¨äºæ¨¡æ‹Ÿå¤šä¸ªå®¢æˆ·ç«¯ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ <code>radios</code> å‚æ•°ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> modprobe mac80211_hwsim radios=3</span><br><span class="line"><span class="comment"># è¿™å°†åˆ›å»º wlan0, wlan1, wlan2 ä¸‰å¼ è™šæ‹Ÿç½‘å¡</span></span><br></pre></td></tr></table></figure>

<h4 id="ç¬¬-3-æ­¥ï¼šé…ç½®-hostapd"><a href="#ç¬¬-3-æ­¥ï¼šé…ç½®-hostapd" class="headerlink" title="ç¬¬ 3 æ­¥ï¼šé…ç½® hostapd"></a>ç¬¬ 3 æ­¥ï¼šé…ç½® hostapd</h4><p>æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶æ¥å‘Šè¯‰ <code>hostapd</code> å¦‚ä½•è®¾ç½®æˆ‘ä»¬çš„è™šæ‹Ÿ APã€‚</p>
<ol>
<li><p>åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚ <code>virtual_ap.conf</code>ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> vim /etc/hostapd/virtual_ap.conf</span><br></pre></td></tr></table></figure>
</li>
<li><p>å°†ä»¥ä¸‹åŸºæœ¬é…ç½®å†…å®¹ç²˜è´´åˆ°æ–‡ä»¶ä¸­ã€‚è¿™ä¸ªé…ç½®åˆ›å»ºä¸€ä¸ªå¼€æ”¾ï¼ˆæ— å¯†ç ï¼‰çš„ç½‘ç»œï¼Œåä¸º <code>MyVirtualAP</code>ã€‚</p>
<p>ini</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># æŒ‡å®šè¦ä½¿ç”¨çš„æ— çº¿æ¥å£ï¼ˆä½¿ç”¨åˆšæ‰åˆ›å»ºçš„å…¶ä¸­ä¸€ä¸ªï¼Œä¾‹å¦‚ wlan0ï¼‰</span><br><span class="line">interface=wlan0</span><br><span class="line"></span><br><span class="line"># è®¾ç½®é©±åŠ¨ç±»å‹ï¼Œå¯¹äº hwsim ä½¿ç”¨ nl80211</span><br><span class="line">driver=nl80211</span><br><span class="line"></span><br><span class="line"># è®¾ç½®ç½‘ç»œåç§° (SSID)</span><br><span class="line">ssid=MyVirtualAP</span><br><span class="line"></span><br><span class="line"># è®¾ç½®å·¥ä½œé¢‘æ®µ (2.4 GHz æˆ– 5 GHz)</span><br><span class="line">hw_mode=g</span><br><span class="line">channel=6</span><br><span class="line"></span><br><span class="line"># å…è®¸æ‰€æœ‰ MAC åœ°å€è¿æ¥</span><br><span class="line">macaddr_acl=0</span><br><span class="line"></span><br><span class="line"># å¿½ç•¥å¹¿æ’­ SSID çš„è¯·æ±‚ï¼Œå³æ€»æ˜¯å¹¿æ’­</span><br><span class="line">ignore_broadcast_ssid=0</span><br><span class="line"></span><br><span class="line"># å¯ç”¨ WPA2ï¼ˆå¦‚æœéœ€è¦åŠ å¯†ç½‘ç»œï¼Œå–æ¶ˆæ³¨é‡Šå¹¶ä¿®æ”¹ä»¥ä¸‹è¡Œï¼‰</span><br><span class="line">#wpa=2</span><br><span class="line">#wpa_passphrase=MyStrongPassword</span><br><span class="line">#wpa_key_mgmt=WPA-PSK</span><br><span class="line">#rsn_pairwise=CCMP</span><br></pre></td></tr></table></figure>

<h4 id="ç¬¬-4-æ­¥ï¼šé…ç½®ç½‘ç»œå’Œ-DHCPï¼ˆdnsmasqï¼‰"><a href="#ç¬¬-4-æ­¥ï¼šé…ç½®ç½‘ç»œå’Œ-DHCPï¼ˆdnsmasqï¼‰" class="headerlink" title="ç¬¬ 4 æ­¥ï¼šé…ç½®ç½‘ç»œå’Œ DHCPï¼ˆdnsmasqï¼‰"></a>ç¬¬ 4 æ­¥ï¼šé…ç½®ç½‘ç»œå’Œ DHCPï¼ˆdnsmasqï¼‰</h4><p>ç°åœ¨æˆ‘ä»¬éœ€è¦ä¸ºè¿æ¥åˆ° AP çš„â€œå®¢æˆ·ç«¯â€åˆ†é… IP åœ°å€ã€‚</p>
<ol>
<li><p><strong>é¦–å…ˆï¼Œåœæ­¢ç³»ç»ŸæœåŠ¡</strong>ï¼Œé˜²æ­¢å†²çªï¼ˆæˆ‘ä»¬æ‰‹åŠ¨è¿è¡Œå®ƒä»¬ï¼‰ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl stop hostapd</span><br><span class="line"><span class="built_in">sudo</span> systemctl stop dnsmasq</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¸ºè™šæ‹Ÿ AP æ¥å£ï¼ˆ<code>wlan0</code>ï¼‰é…ç½®ä¸€ä¸ªé™æ€ IP åœ°å€ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> ip addr add 192.168.100.1/24 dev wlan0</span><br><span class="line"><span class="built_in">sudo</span> ip <span class="built_in">link</span> <span class="built_in">set</span> wlan0 up</span><br></pre></td></tr></table></figure>

<p> é€šè¿‡ifconfigå¯è§wlan0è·å–åˆ°ipåœ°å€ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wlan0: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.100.1  netmask 255.255.255.0  broadcast 0.0.0.0</span><br><span class="line">        ether 02:00:00:00:00:00  txqueuelen 1000  (ä»¥å¤ªç½‘)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>


</li>
<li><p>åˆ›å»ºä¸€ä¸ªç®€å•çš„ <code>dnsmasq</code> é…ç½®æ–‡ä»¶ã€‚ä¸ºäº†é¿å…ä¿®æ”¹ä¸»é…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡å‘½ä»¤è¡Œå‚æ•°è¿è¡Œå®ƒï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä»¥ä¸‹å‘½ä»¤ä¼šå¯åŠ¨ dnsmasqï¼Œå¹¶åªé’ˆå¯¹ wlan0 æ¥å£æä¾›æœåŠ¡</span></span><br><span class="line"><span class="built_in">sudo</span> dnsmasq -i wlan0 --dhcp-range=192.168.100.50,192.168.100.150,255.255.255.0,24h</span><br><span class="line"><span class="comment"># æŠ¥é”™dnsmasq: failed to create listening socket for port 53: åœ°å€å·²åœ¨ä½¿ç”¨</span></span><br><span class="line"><span class="comment"># sudo netstat -tulpn | grep :53å¯çŸ¥ä¸€èˆ¬53ç«¯å£ä¼šè¢«å ç”¨</span></span><br><span class="line"><span class="comment"># sudo dnsmasq -i wlan0 --dhcp-range=192.168.100.50,192.168.100.150,255.255.255.0,24h --port=0</span></span><br><span class="line"><span class="comment"># --port=0 å‚æ•°å‘Šè¯‰ dnsmasq ä¸ç»‘å®šåˆ° DNS ç«¯å£ï¼ˆ53ï¼‰ï¼Œåªæä¾› DHCP æœåŠ¡ã€‚</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>-i wlan0</code>: æŒ‡å®šç›‘å¬çš„æ¥å£ã€‚</li>
<li><code>--dhcp-range</code>: å®šä¹‰ DHCP åˆ†é…çš„ IP åœ°å€èŒƒå›´ã€‚</li>
</ul>
</li>
</ol>
</li>
</ol>
<h4 id="ç¬¬-5-æ­¥ï¼šå¯åŠ¨-hostapd"><a href="#ç¬¬-5-æ­¥ï¼šå¯åŠ¨-hostapd" class="headerlink" title="ç¬¬ 5 æ­¥ï¼šå¯åŠ¨ hostapd"></a>ç¬¬ 5 æ­¥ï¼šå¯åŠ¨ hostapd</h4><p>ç°åœ¨æ˜¯æ—¶å€™å¯åŠ¨æˆ‘ä»¬çš„è™šæ‹Ÿ AP äº†ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ -dd å‚æ•°å¯ä»¥æ˜¾ç¤ºæ›´è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜</span></span><br><span class="line"><span class="built_in">sudo</span> hostapd -B /etc/hostapd/virtual_ap.conf</span><br></pre></td></tr></table></figure>

<ul>
<li><code>-B</code>: åœ¨åå°è¿è¡Œã€‚</li>
</ul>
<p>å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œç»ˆç«¯ä¼šæ˜¾ç¤º <code>wlan0: AP-ENABLED</code> ä¹‹ç±»çš„ä¿¡æ¯ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kkhm@vm:~$ sudo hostapd -B /etc/hostapd/virtual_ap.conf</span><br><span class="line">wlan0: interface state UNINITIALIZED-&gt;ENABLED</span><br><span class="line">wlan0: AP-ENABLED</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># å¤šäº†ä¸€ä¸ª						 RUNNING</span><br><span class="line">wlan0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.100.1  netmask 255.255.255.0  broadcast 0.0.0.0</span><br><span class="line">        ether 02:00:00:00:00:00  txqueuelen 1000  (ä»¥å¤ªç½‘)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">kkhm@vm:~$ iw dev</span><br><span class="line">phy#1</span><br><span class="line">        Unnamed/non-netdev interface</span><br><span class="line">                wdev 0x100000002</span><br><span class="line">                addr 42:00:00:00:01:00</span><br><span class="line">                type P2P-device</span><br><span class="line">                txpower 20.00 dBm</span><br><span class="line">        Interface wlan1</span><br><span class="line">                ifindex 5</span><br><span class="line">                wdev 0x100000001</span><br><span class="line">                addr 02:00:00:00:01:00</span><br><span class="line">                type managed</span><br><span class="line">                txpower 20.00 dBm</span><br><span class="line">                multicast TXQ:</span><br><span class="line">                        qsz-byt qsz-pkt flows   drops   marks   overlmt hashcol tx-bytes        tx-packets</span><br><span class="line">                        0       0       0       0       0       0       0       0               0</span><br><span class="line">phy#0</span><br><span class="line">        Interface wlan0</span><br><span class="line">                ifindex 4</span><br><span class="line">                wdev 0x1</span><br><span class="line">                addr 02:00:00:00:00:00</span><br><span class="line">                ssid MyVirtualAP</span><br><span class="line">                type AP</span><br><span class="line">                channel 6 (2437 MHz), width: 20 MHz (no HT), center1: 2437 MHz</span><br><span class="line">                txpower 20.00 dBm</span><br><span class="line">                multicast TXQ:</span><br><span class="line">                        qsz-byt qsz-pkt flows   drops   marks   overlmt hashcol tx-bytes        tx-packets</span><br><span class="line">                        0       0       0       0       0       0       0       0               0</span><br></pre></td></tr></table></figure>



<h4 id="ç¬¬-6-æ­¥ï¼šæµ‹è¯•è¿æ¥ï¼ˆä½¿ç”¨å¦ä¸€ä¸ªè™šæ‹Ÿç½‘å¡ï¼‰"><a href="#ç¬¬-6-æ­¥ï¼šæµ‹è¯•è¿æ¥ï¼ˆä½¿ç”¨å¦ä¸€ä¸ªè™šæ‹Ÿç½‘å¡ï¼‰" class="headerlink" title="ç¬¬ 6 æ­¥ï¼šæµ‹è¯•è¿æ¥ï¼ˆä½¿ç”¨å¦ä¸€ä¸ªè™šæ‹Ÿç½‘å¡ï¼‰"></a>ç¬¬ 6 æ­¥ï¼šæµ‹è¯•è¿æ¥ï¼ˆä½¿ç”¨å¦ä¸€ä¸ªè™šæ‹Ÿç½‘å¡ï¼‰</h4><p>ç°åœ¨ä½ çš„è™šæ‹Ÿ AP <code>MyVirtualAP</code> å·²ç»åœ¨ <code>wlan0</code> ä¸Šè¿è¡Œäº†ã€‚ä½ å¯ä»¥ä½¿ç”¨å¦ä¸€ä¸ªè™šæ‹Ÿç½‘å¡ï¼ˆä¾‹å¦‚ <code>wlan1</code>ï¼‰æ¥æ¨¡æ‹Ÿä¸€ä¸ªå®¢æˆ·ç«¯å¹¶è¿æ¥å®ƒã€‚</p>
<ol>
<li><p><strong>æŸ¥çœ‹å¯ç”¨çš„ç½‘ç»œï¼š</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨å¦ä¸€ä¸ªç»ˆç«¯çª—å£æ‰§è¡Œ</span></span><br><span class="line"><span class="built_in">sudo</span> iw dev wlan1 scan | grep <span class="string">&quot;SSID:&quot;</span></span><br></pre></td></tr></table></figure>

<p>ä½ åº”è¯¥èƒ½çœ‹åˆ° <code>SSID: MyVirtualAP</code>ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">kkhm@vm:~$ <span class="built_in">sudo</span> iw dev wlan1 scan</span><br><span class="line">BSS 02:00:00:00:00:00(on wlan1)</span><br><span class="line">        last seen: 26350.725s [boottime]</span><br><span class="line">        TSF: 1757346205453486 usec (20339d, 15:43:25)</span><br><span class="line">        freq: 2437</span><br><span class="line">        beacon interval: 100 TUs</span><br><span class="line">        capability: ESS ShortSlotTime (0x0401)</span><br><span class="line">        signal: -30.00 dBm</span><br><span class="line">        last seen: 0 ms ago</span><br><span class="line">        Information elements from Probe Response frame:</span><br><span class="line">        SSID: MyVirtualAP</span><br><span class="line">        Supported rates: 1.0* 2.0* 5.5* 11.0* 6.0 9.0 12.0 18.0</span><br><span class="line">        DS Parameter <span class="built_in">set</span>: channel 6</span><br><span class="line">        ERP: Barker_Preamble_Mode</span><br><span class="line">        Extended supported rates: 24.0 36.0 48.0 54.0</span><br><span class="line">        Supported operating classes:</span><br><span class="line">                 * current operating class: 81</span><br><span class="line">        Extended capabilities:</span><br><span class="line">                 * Extended Channel Switching</span><br><span class="line">                 * Multiple BSSID</span><br><span class="line">                 * SSID List</span><br><span class="line">                 * Operating Mode Notification</span><br></pre></td></tr></table></figure>


</li>
<li><p><strong>è¿æ¥åˆ°è¯¥ç½‘ç»œï¼š</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…ˆç¡®ä¿ wlan1 æ˜¯å¯åŠ¨çš„</span></span><br><span class="line"><span class="built_in">sudo</span> ip <span class="built_in">link</span> <span class="built_in">set</span> wlan1 up</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿æ¥åˆ°å¼€æ”¾çš„ SSID</span></span><br><span class="line"><span class="built_in">sudo</span> iw dev wlan1 connect <span class="string">&quot;MyVirtualAP&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥æ˜¯å¦æˆåŠŸè¿æ¥ï¼Œç­‰å‡ ç§’</span></span><br><span class="line">iw dev wlan1 <span class="built_in">link</span></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Connected to 02:00:00:00:00:00 (on wlan1)</span><br><span class="line">        SSID: MyVirtualAP</span><br><span class="line">        freq: 2437</span><br><span class="line">        RX: 104993 bytes (2298 packets)</span><br><span class="line">        TX: 2650 bytes (78 packets)</span><br><span class="line">        signal: -30 dBm</span><br><span class="line">        tx bitrate: 54.0 MBit/s</span><br><span class="line"></span><br><span class="line">        bss flags:      short-slot-time</span><br><span class="line">        dtim period:    2</span><br><span class="line">        beacon int:     100</span><br></pre></td></tr></table></figure>

<p> æ­¤å¤„å¯èƒ½å› ä¸ºç®¡ç†å†²çªå¯¼è‡´å…³è”æˆåŠŸåå–æ¶ˆè®¤è¯</p>
<h4 id="ç¦æ­¢-NetworkManager-ç®¡ç†ç‰¹å®šæ¥å£"><a href="#ç¦æ­¢-NetworkManager-ç®¡ç†ç‰¹å®šæ¥å£" class="headerlink" title="ç¦æ­¢ NetworkManager ç®¡ç†ç‰¹å®šæ¥å£"></a>ç¦æ­¢ NetworkManager ç®¡ç†ç‰¹å®šæ¥å£</h4><p>å¦‚æœæ‚¨ä¸æƒ³å®Œå…¨åœæ­¢ NetworkManagerï¼Œå¯ä»¥é…ç½®å®ƒä¸ç®¡ç† wlan1ï¼š</p>
<p>bash</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># åœ¨ /etc/NetworkManager/NetworkManager.conf çš„ [keyfile] éƒ¨åˆ†æ·»åŠ ï¼š</span><br><span class="line">sudo nano /etc/NetworkManager/NetworkManager.conf</span><br></pre></td></tr></table></figure>

<p>æ·»åŠ æˆ–ä¿®æ”¹ï¼š</p>
<p>ini</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[keyfile]</span><br><span class="line">unmanaged-devices=interface-name:wlan1</span><br></pre></td></tr></table></figure>

<p>ç„¶åé‡å¯ NetworkManagerï¼ŒWLAN1å¯èƒ½ä¼šåœæ­¢éœ€è¦é‡å¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart NetworkManager</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>ä» DHCP è·å– IP åœ°å€ï¼š</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dhclient wlan1</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>éªŒè¯è¿æ¥ï¼š</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip addr show wlan1</span><br><span class="line">ping 192.168.100.1 <span class="comment"># å°è¯• Ping é€šä½ çš„ AP</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœ <code>wlan1</code> è·å¾—äº† <code>192.168.100.x</code> ç½‘æ®µçš„ IP å¹¶èƒ½ ping é€š <code>192.168.100.1</code>ï¼Œè¯´æ˜æ¨¡æ‹Ÿå®Œå…¨æˆåŠŸï¼</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kkhm@vm:~$ ip addr show wlan1</span><br><span class="line">5: wlan1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link/ether 02:00:00:00:01:00 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.100.82/24 brd 192.168.100.255 scope global dynamic wlan1</span><br><span class="line">       valid_lft 86355sec preferred_lft 86355sec</span><br><span class="line">    inet6 fe80::ff:fe00:100/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure></li>
</ol>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">WLAN</a>
        		</li>
      		 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">iw</a>
        		</li>
      		 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">mac80211_hwsim</a>
        		</li>
      		
		</ul>
	</div>

      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2025/09/08/%E8%BD%AF%E4%BB%B6%E6%A8%A1%E6%8B%9F%E8%99%9A%E6%8B%9F%E6%97%A0%E7%BA%BFWLAN%E6%8E%A5%E5%8F%A3/">å±•å¼€å…¨æ–‡ >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-hexoä»£ç å¤åˆ¶æŒ‰é’®" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2025/09/08/hexo%E4%BB%A3%E7%A0%81%E5%A4%8D%E5%88%B6%E6%8C%89%E9%92%AE/">hexoä»£ç å¤åˆ¶æŒ‰é’®</a>
    </h1>
  

        
        <a href="/2025/09/08/hexo%E4%BB%A3%E7%A0%81%E5%A4%8D%E5%88%B6%E6%8C%89%E9%92%AE/" class="archive-article-date">
  	<time datetime="2025-09-07T18:54:15.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2025-09-08</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-åˆ›å»º-JavaScript-è„šæœ¬æ–‡ä»¶"><a href="#1-åˆ›å»º-JavaScript-è„šæœ¬æ–‡ä»¶" class="headerlink" title="1. åˆ›å»º JavaScript è„šæœ¬æ–‡ä»¶"></a><strong>1. åˆ›å»º JavaScript è„šæœ¬æ–‡ä»¶</strong></h2><p>åœ¨ Hexo åšå®¢é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹åˆ›å»º JS è„šæœ¬æ–‡ä»¶ <code>code-copy.js</code> ,å¦‚æœæ²¡æœ‰jsæ–‡ä»¶å¤¹åˆ™è‡ªå·±åˆ›å»ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source/js/code-copy.js</span><br></pre></td></tr></table></figure>

<p>å¹¶å¡«å…¥ä»¥ä¸‹å®Œæ•´å†…å®¹ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;DOMContentLoaded&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;figure.highlight&#x27;</span>).<span class="title function_">forEach</span>(<span class="function">(<span class="params">figure</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (figure.<span class="title function_">querySelector</span>(<span class="string">&#x27;.copy-btn&#x27;</span>)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> copyBtn = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;button&#x27;</span>);</span><br><span class="line">    copyBtn.<span class="property">className</span> = <span class="string">&#x27;copy-btn&#x27;</span>;</span><br><span class="line">    copyBtn.<span class="property">title</span> = <span class="string">&#x27;å¤åˆ¶&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¼©å°åçš„å¤åˆ¶å›¾æ ‡ï¼ˆ14*15ï¼‰</span></span><br><span class="line">    <span class="keyword">const</span> copyIcon = <span class="string">`</span></span><br><span class="line"><span class="string">      &lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; height=&quot;14&quot; width=&quot;15&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;white&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;path d=&quot;M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 18H8V7h11v16z&quot;/&gt;</span></span><br><span class="line"><span class="string">      &lt;/svg&gt;</span></span><br><span class="line"><span class="string">    `</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æˆåŠŸåæ˜¾ç¤ºçš„å‹¾ï¼ˆ14*15ï¼‰</span></span><br><span class="line">    <span class="keyword">const</span> checkIcon = <span class="string">`</span></span><br><span class="line"><span class="string">      &lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; height=&quot;14&quot; width=&quot;15&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;#00cc66&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;path d=&quot;M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z&quot;/&gt;</span></span><br><span class="line"><span class="string">      &lt;/svg&gt;</span></span><br><span class="line"><span class="string">    `</span>;</span><br><span class="line"></span><br><span class="line">    copyBtn.<span class="property">innerHTML</span> = copyIcon;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒ‰é’®æ ·å¼ï¼ˆæµ…ç°åº•ã€ç¼©å°ï¼‰</span></span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">assign</span>(copyBtn.<span class="property">style</span>, &#123;</span><br><span class="line">      <span class="attr">position</span>: <span class="string">&#x27;absolute&#x27;</span>,</span><br><span class="line">      <span class="attr">top</span>: <span class="string">&#x27;8px&#x27;</span>,</span><br><span class="line">      <span class="attr">right</span>: <span class="string">&#x27;8px&#x27;</span>,</span><br><span class="line">      <span class="attr">padding</span>: <span class="string">&#x27;4px&#x27;</span>,</span><br><span class="line">      <span class="attr">background</span>: <span class="string">&#x27;#aaa&#x27;</span>, </span><br><span class="line">      <span class="attr">border</span>: <span class="string">&#x27;none&#x27;</span>,</span><br><span class="line">      <span class="attr">borderRadius</span>: <span class="string">&#x27;4px&#x27;</span>,</span><br><span class="line">      <span class="attr">cursor</span>: <span class="string">&#x27;pointer&#x27;</span>,</span><br><span class="line">      <span class="attr">opacity</span>: <span class="string">&#x27;0.85&#x27;</span>,</span><br><span class="line">      <span class="attr">zIndex</span>: <span class="number">1000</span>,</span><br><span class="line">      <span class="attr">transition</span>: <span class="string">&#x27;opacity 0.2s ease&#x27;</span>,</span><br><span class="line">      <span class="attr">boxShadow</span>: <span class="string">&#x27;0 1px 3px rgba(0, 0, 0, 0.15)&#x27;</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    copyBtn.<span class="title function_">addEventListener</span>(<span class="string">&#x27;mouseover&#x27;</span>, <span class="function">() =&gt;</span> copyBtn.<span class="property">style</span>.<span class="property">opacity</span> = <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line">    copyBtn.<span class="title function_">addEventListener</span>(<span class="string">&#x27;mouseout&#x27;</span>, <span class="function">() =&gt;</span> copyBtn.<span class="property">style</span>.<span class="property">opacity</span> = <span class="string">&#x27;0.85&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    copyBtn.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> code = figure.<span class="title function_">querySelector</span>(<span class="string">&#x27;td.code&#x27;</span>);</span><br><span class="line">      <span class="keyword">const</span> text = code ? code.<span class="property">innerText</span> : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">      navigator.<span class="property">clipboard</span>.<span class="title function_">writeText</span>(text).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        copyBtn.<span class="property">innerHTML</span> = checkIcon;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          copyBtn.<span class="property">innerHTML</span> = copyIcon;</span><br><span class="line">        &#125;, <span class="number">1000</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    figure.<span class="property">style</span>.<span class="property">position</span> = <span class="string">&#x27;relative&#x27;</span>;</span><br><span class="line">    figure.<span class="title function_">appendChild</span>(copyBtn);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-åœ¨é¡µé¢åº•éƒ¨å¼•å…¥-JS-æ–‡ä»¶"><a href="#2-åœ¨é¡µé¢åº•éƒ¨å¼•å…¥-JS-æ–‡ä»¶" class="headerlink" title="2. åœ¨é¡µé¢åº•éƒ¨å¼•å…¥ JS æ–‡ä»¶"></a><strong>2. åœ¨é¡µé¢åº•éƒ¨å¼•å…¥ JS æ–‡ä»¶</strong></h2><p>æ‰“å¼€æ–‡ä»¶ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">themes/hexo-theme-Chic/layout/_partial/footer.ejs</span><br></pre></td></tr></table></figure>

<p>åœ¨ <code>&lt;/footer&gt;</code> æ ‡ç­¾ä¹‹åæ·»åŠ ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=&quot;/js/code-copy.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å¯ä»¥ç¡®ä¿å¤åˆ¶æŒ‰é’®è„šæœ¬åœ¨é¡µé¢åŠ è½½å®Œæ¯•åè‡ªåŠ¨è¿è¡Œã€‚</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2025/09/08/hexo%E4%BB%A3%E7%A0%81%E5%A4%8D%E5%88%B6%E6%8C%89%E9%92%AE/">å±•å¼€å…¨æ–‡ >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-module" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="å¼€é¢˜æŠ¥å‘Š"><a href="#å¼€é¢˜æŠ¥å‘Š" class="headerlink" title="å¼€é¢˜æŠ¥å‘Š"></a>å¼€é¢˜æŠ¥å‘Š</h1><h2 id="1-è¯¾é¢˜èƒŒæ™¯"><a href="#1-è¯¾é¢˜èƒŒæ™¯" class="headerlink" title="1. è¯¾é¢˜èƒŒæ™¯"></a>1. è¯¾é¢˜èƒŒæ™¯</h2><p>æ— çº¿æ¥å…¥ç‚¹ï¼ˆAccess Pointï¼ŒAPï¼‰æ˜¯ç°ä»£å®¶åº­ã€ä¼ä¸šå’Œæ•°æ®ä¸­å¿ƒç½‘ç»œçš„å…³é”®è®¾å¤‡ã€‚å¸¸è§çš„ AP ä¸€èˆ¬æ”¯æŒæ¡¥æ¥æ¨¡å¼ï¼ˆBridgeï¼‰å’Œ NAT æ¨¡å¼ï¼ˆNetwork Address Translationï¼‰ï¼Œç”¨æˆ·é€šè¿‡ SSID è¿›è¡Œæ— çº¿æ¥å…¥ã€‚<br> ç„¶è€Œï¼Œä¼ ç»Ÿ AP çš„é…ç½®å¾€å¾€è€¦åˆåœ¨å•ä¸€è¿›ç¨‹æˆ–è„šæœ¬ä¸­ï¼Œç¼ºä¹çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚å¯¹äºéœ€è¦æä¾›å¤šä¸ª SSIDï¼ˆå¦‚è®¿å®¢ç½‘ç»œã€éš”ç¦»ç½‘ç»œã€NAT ç½‘ç»œï¼‰çš„åœºæ™¯ï¼Œç°æœ‰æ–¹æ¡ˆå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š</p>
<ul>
<li>é…ç½®ä¸æ‰§è¡Œé«˜åº¦è€¦åˆï¼Œä¿®æ”¹å›°éš¾ï¼›</li>
<li>ç¼ºä¹é…ç½®ç‰ˆæœ¬ç®¡ç†å’Œå›æ»šæœºåˆ¶ï¼Œé”™è¯¯é…ç½®å®¹æ˜“å¯¼è‡´æœåŠ¡ä¸­æ–­ï¼›</li>
<li>ç”¨æˆ·é…ç½®å…¥å£å¤æ‚ï¼Œä¸åˆ©äºä» Web ç•Œé¢ç›´è§‚æ“ä½œã€‚</li>
</ul>
<p>å› æ­¤ï¼Œæœ¬è¯¾é¢˜æ—¨åœ¨è®¾è®¡å¹¶å®ç°ä¸€ä¸ª <strong>æ”¯æŒå¤š SSIDï¼Œæ”¯æŒæ¡¥æ¥&#x2F;NAT æ¨¡å¼åˆ‡æ¢ï¼Œæ”¯æŒ DHCP æœåŠ¡å’Œå®¢æˆ·ç«¯éš”ç¦»çš„æ— çº¿ AP ç³»ç»Ÿ</strong>ï¼Œå¹¶æä¾›å¯ç”± Web ç•Œé¢é©±åŠ¨çš„é…ç½®ä¸ç®¡ç†èƒ½åŠ›ã€‚</p>
<hr>
<h2 id="2-è¯¾é¢˜å†…å®¹"><a href="#2-è¯¾é¢˜å†…å®¹" class="headerlink" title="2. è¯¾é¢˜å†…å®¹"></a>2. è¯¾é¢˜å†…å®¹</h2><h3 id="2-1-æ¦‚è¿°"><a href="#2-1-æ¦‚è¿°" class="headerlink" title="2.1 æ¦‚è¿°"></a>2.1 æ¦‚è¿°</h3><p>æœ¬è¯¾é¢˜ä»¥ Linux ç³»ç»Ÿä¸ºè¿è¡Œå¹³å°ï¼ŒåŸºäº <strong>hostapdã€dnsmasqã€iptables&#x2F;nftables</strong> ç­‰æˆç†Ÿç»„ä»¶ï¼Œè®¾è®¡ä¸€ä¸ªè§£è€¦çš„é…ç½®ç®¡ç†ä¸æ‰§è¡Œæ¶æ„ï¼š</p>
<ul>
<li><strong>A è¿›ç¨‹ï¼ˆé…ç½®ç®¡ç†ï¼‰</strong>ï¼šæ¥æ”¶å¹¶æ ¡éªŒ Web å‰ç«¯ä¼ é€’çš„ JSON é…ç½®ï¼Œå®ŒæˆæŒä¹…åŒ–å­˜å‚¨ï¼Œå¹¶é€šè¿‡ socket ä¸‹å‘ç»™ B è¿›ç¨‹ã€‚</li>
<li><strong>B è¿›ç¨‹ï¼ˆé…ç½®æ‰§è¡Œï¼‰</strong>ï¼šè´Ÿè´£å¯åŠ¨&#x2F;åœæ­¢ç³»ç»ŸæœåŠ¡ï¼ˆhostapdã€dnsmasqï¼‰ã€é…ç½®ç½‘ç»œæ¥å£ä¸é˜²ç«å¢™è§„åˆ™ï¼Œå®ç°ç”¨æˆ·é…ç½®çš„æ‰§è¡Œä¸å›æ»šã€‚</li>
</ul>
<h3 id="2-2-æ¨¡å‹ç»„ä»¶"><a href="#2-2-æ¨¡å‹ç»„ä»¶" class="headerlink" title="2.2 æ¨¡å‹ç»„ä»¶"></a>2.2 æ¨¡å‹ç»„ä»¶</h3><p>ç³»ç»Ÿä¸»è¦ç»„ä»¶åŒ…æ‹¬ï¼š</p>
<ol>
<li><strong>Web å‰ç«¯</strong>ï¼šæä¾›ç”¨æˆ·æ“ä½œç•Œé¢ï¼ˆé…ç½® SSIDã€é¢‘æ®µã€å¯†ç ã€æ¨¡å¼ã€DHCPã€éš”ç¦»ç­‰ï¼‰ã€‚</li>
<li><strong>A è¿›ç¨‹ï¼ˆé…ç½®ç®¡ç†ï¼‰</strong>ï¼š<ul>
<li>æ ¡éªŒå‚æ•°åˆæ³•æ€§ï¼ˆSSID åç§°ã€ä¿¡é“èŒƒå›´ã€IP åœ°å€ç­‰ï¼‰ï¼›</li>
<li>ä¿å­˜é…ç½®åˆ° Flashï¼Œå…·å¤‡ç‰ˆæœ¬ç®¡ç†èƒ½åŠ›ï¼›</li>
<li>é€šè¿‡ socket å°†é…ç½®ä¸‹å‘ç»™ B è¿›ç¨‹ã€‚</li>
</ul>
</li>
<li><strong>B è¿›ç¨‹ï¼ˆé…ç½®æ‰§è¡Œï¼‰</strong>ï¼š<ul>
<li>ç®¡ç† hostapdï¼ˆæ— çº¿ SSID ç®¡ç†ï¼‰ï¼›</li>
<li>ç®¡ç† dnsmasqï¼ˆDHCP æœåŠ¡ï¼‰ï¼›</li>
<li>é…ç½® iptables&#x2F;nftablesï¼ˆNAT è½¬å‘ï¼‰ï¼›</li>
<li>é…ç½® Linux bridgeï¼ˆæ¡¥æ¥æ¨¡å¼ï¼‰ï¼›</li>
<li>æä¾›å›æ»šèƒ½åŠ›ï¼Œç¡®ä¿å¹‚ç­‰æ‰§è¡Œã€‚</li>
</ul>
</li>
<li><strong>ç³»ç»ŸæœåŠ¡</strong>ï¼šhostapdã€dnsmasqã€iptablesã€iproute2 ç­‰ã€‚</li>
</ol>
<h3 id="2-3-æ•°æ®æ¨¡å‹å®šä¹‰"><a href="#2-3-æ•°æ®æ¨¡å‹å®šä¹‰" class="headerlink" title="2.3 æ•°æ®æ¨¡å‹å®šä¹‰"></a>2.3 æ•°æ®æ¨¡å‹å®šä¹‰</h3><p>é‡‡ç”¨ JSON ä½œä¸ºé…ç½®ä¼ è¾“æ ¼å¼ã€‚ä¸»è¦å­—æ®µåŒ…æ‹¬ï¼š</p>
<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>ç¤ºä¾‹å€¼</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td><code>id</code></td>
<td><code>&quot;ssid1&quot;</code></td>
<td>é…ç½®å”¯ä¸€æ ‡è¯†</td>
</tr>
<tr>
<td><code>name</code></td>
<td><code>&quot;Guest-NAT&quot;</code></td>
<td>SSID åç§°</td>
</tr>
<tr>
<td><code>band</code></td>
<td><code>&quot;2.4G&quot;</code></td>
<td>å·¥ä½œé¢‘æ®µï¼ˆ2.4G&#x2F;5Gï¼‰</td>
</tr>
<tr>
<td><code>channel</code></td>
<td><code>6</code></td>
<td>ä¿¡é“å·</td>
</tr>
<tr>
<td><code>password</code></td>
<td><code>&quot;guest1234&quot;</code></td>
<td>WPA2&#x2F;WPA3 å¯†ç </td>
</tr>
<tr>
<td><code>mode</code></td>
<td><code>&quot;nat&quot;</code> &#x2F; <code>&quot;bridge&quot;</code></td>
<td>å·¥ä½œæ¨¡å¼</td>
</tr>
<tr>
<td><code>bridge_interface</code></td>
<td><code>&quot;br0&quot;</code></td>
<td>æ¡¥æ¥æ—¶ä½¿ç”¨çš„ç½‘æ¡¥</td>
</tr>
<tr>
<td><code>client_isolation</code></td>
<td><code>true</code></td>
<td>æ˜¯å¦å¯ç”¨å®¢æˆ·ç«¯éš”ç¦»</td>
</tr>
<tr>
<td><code>dhcp.enabled</code></td>
<td><code>true</code></td>
<td>æ˜¯å¦å¯ç”¨ DHCP</td>
</tr>
<tr>
<td><code>dhcp.range_start</code></td>
<td><code>&quot;192.168.100.50&quot;</code></td>
<td>åœ°å€æ± èµ·å§‹ IP</td>
</tr>
<tr>
<td><code>dhcp.range_end</code></td>
<td><code>&quot;192.168.100.150&quot;</code></td>
<td>åœ°å€æ± ç»“æŸ IP</td>
</tr>
<tr>
<td><code>dhcp.gateway</code></td>
<td><code>&quot;192.168.100.1&quot;</code></td>
<td>ç½‘å…³åœ°å€</td>
</tr>
</tbody></table>
<h3 id="2-4-å®æ–½æµç¨‹"><a href="#2-4-å®æ–½æµç¨‹" class="headerlink" title="2.4 å®æ–½æµç¨‹"></a>2.4 å®æ–½æµç¨‹</h3><h4 id="2-4-1-åˆå§‹åŒ–é…ç½®"><a href="#2-4-1-åˆå§‹åŒ–é…ç½®" class="headerlink" title="2.4.1 åˆå§‹åŒ–é…ç½®"></a>2.4.1 åˆå§‹åŒ–é…ç½®</h4><ul>
<li>Web å‰ç«¯é¦–æ¬¡é…ç½® â†’ A è¿›ç¨‹æ ¡éªŒ â†’ ä¿å­˜ JSON é…ç½® â†’ ä¸‹å‘ B è¿›ç¨‹ â†’ B è¿›ç¨‹å¯åŠ¨ç›¸åº”ç³»ç»ŸæœåŠ¡ï¼ˆhostapd&#x2F;dnsmasq&#x2F;iptables&#x2F;bridgeï¼‰ã€‚</li>
</ul>
<h4 id="2-4-2-æ–°å»º-SSID"><a href="#2-4-2-æ–°å»º-SSID" class="headerlink" title="2.4.2 æ–°å»º SSID"></a>2.4.2 æ–°å»º SSID</h4><ul>
<li>ç”¨æˆ·åœ¨ Web å‰ç«¯è¾“å…¥ SSID é…ç½®ï¼ˆå¦‚æ–°å»º NAT æ¨¡å¼ç½‘ç»œï¼‰ã€‚</li>
<li>A è¿›ç¨‹ä¿å­˜é…ç½®å¹¶åˆ†é…ç‰ˆæœ¬å· â†’ ä¸‹å‘ B è¿›ç¨‹ã€‚</li>
<li>B è¿›ç¨‹å¯åŠ¨æ–° VAP æ¥å£ã€å¯ç”¨ DHCP æœåŠ¡ã€é…ç½® NAT è§„åˆ™ã€‚</li>
</ul>
<h4 id="2-4-3-ä¿®æ”¹-SSID"><a href="#2-4-3-ä¿®æ”¹-SSID" class="headerlink" title="2.4.3 ä¿®æ”¹ SSID"></a>2.4.3 ä¿®æ”¹ SSID</h4><ul>
<li>ä¿®æ”¹å‚æ•°ï¼ˆå¦‚ä¿¡é“æˆ–å¯†ç ï¼‰ã€‚</li>
<li>A è¿›ç¨‹æ£€æŸ¥é…ç½®åˆæ³•æ€§ â†’ ä¿å­˜æ–°ç‰ˆæœ¬ â†’ é€šçŸ¥ B è¿›ç¨‹ã€‚</li>
<li>B è¿›ç¨‹å¹³æ»‘é‡å¯ç›¸å…³æœåŠ¡ï¼Œç¡®ä¿ä¸ä¸­æ–­å…¶ä»– SSIDã€‚</li>
</ul>
<h4 id="2-4-5-æˆåŠŸ-å¤±è´¥å›æ»š"><a href="#2-4-5-æˆåŠŸ-å¤±è´¥å›æ»š" class="headerlink" title="2.4.5 æˆåŠŸ&#x2F;å¤±è´¥å›æ»š"></a>2.4.5 æˆåŠŸ&#x2F;å¤±è´¥å›æ»š</h4><ul>
<li>æˆåŠŸï¼šA è¿›ç¨‹å°†å½“å‰é…ç½®æ ‡è®°ä¸º <code>last_good_version</code>ã€‚</li>
<li>å¤±è´¥ï¼šB è¿›ç¨‹è¿”å›å¤±è´¥çŠ¶æ€ï¼ŒA è¿›ç¨‹å›æ»šåˆ° <code>last_good_version</code> å¹¶ä¸‹å‘æ¢å¤æŒ‡ä»¤ã€‚</li>
</ul>
<hr>
<h2 id="3-è¯¾é¢˜è¦æ±‚"><a href="#3-è¯¾é¢˜è¦æ±‚" class="headerlink" title="3. è¯¾é¢˜è¦æ±‚"></a>3. è¯¾é¢˜è¦æ±‚</h2><ul>
<li>å®ç°å¤š SSID ç®¡ç†ï¼Œæ”¯æŒæ¡¥æ¥&#x2F;NAT æ¨¡å¼ã€‚</li>
<li>æ”¯æŒ DHCP åœ°å€åˆ†é…å’Œå®¢æˆ·ç«¯éš”ç¦»ã€‚</li>
<li>Web å‰ç«¯å¯å®Œæˆé…ç½®ä¸‹å‘å’Œç®¡ç†ã€‚</li>
<li>é…ç½®å…·å¤‡æŒä¹…åŒ–å’Œå›æ»šèƒ½åŠ›ã€‚</li>
<li>ç³»ç»Ÿå…·å¤‡å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ã€‚</li>
</ul>
<hr>
<h2 id="4-ç ”ç©¶æ€è·¯å’Œæ–¹æ³•"><a href="#4-ç ”ç©¶æ€è·¯å’Œæ–¹æ³•" class="headerlink" title="4. ç ”ç©¶æ€è·¯å’Œæ–¹æ³•"></a>4. ç ”ç©¶æ€è·¯å’Œæ–¹æ³•</h2><h3 id="4-1-æ€è·¯å’Œæ–¹æ³•"><a href="#4-1-æ€è·¯å’Œæ–¹æ³•" class="headerlink" title="4.1 æ€è·¯å’Œæ–¹æ³•"></a>4.1 æ€è·¯å’Œæ–¹æ³•</h3><ul>
<li><strong>åˆ†å±‚è§£è€¦</strong>ï¼šé…ç½®ç®¡ç†ä¸é…ç½®æ‰§è¡Œåˆ†ç¦»ï¼Œæå‡ç³»ç»Ÿç¨³å®šæ€§ã€‚</li>
<li><strong>é…ç½®å³ä»£ç </strong>ï¼šé‡‡ç”¨ JSON æ¨¡å‹ï¼Œä¿è¯é…ç½®å¯è¯»å¯å†™ï¼Œæ˜“æ‰©å±•ã€‚</li>
<li><strong>å¹‚ç­‰æ‰§è¡Œ</strong>ï¼šB è¿›ç¨‹æ“ä½œå…·å¤‡å¹‚ç­‰æ€§ï¼Œé¿å…è„é…ç½®ã€‚</li>
<li><strong>ç‰ˆæœ¬åŒ–ç®¡ç†</strong>ï¼šæ”¯æŒå›æ»šæœºåˆ¶ï¼Œä¿è¯æœåŠ¡æŒç»­å¯ç”¨ã€‚</li>
</ul>
<h3 id="4-3-æ–¹æ¡ˆè®¾è®¡"><a href="#4-3-æ–¹æ¡ˆè®¾è®¡" class="headerlink" title="4.3 æ–¹æ¡ˆè®¾è®¡"></a>4.3 æ–¹æ¡ˆè®¾è®¡</h3><ul>
<li>æ¶æ„å›¾ã€æ—¶åºå›¾ã€é…ç½®æ˜ å°„è¡¨ï¼Œæ¸…æ™°å±•ç¤ºæ§åˆ¶é¢ä¸æ‰§è¡Œé¢çš„å…³ç³»ã€‚</li>
<li>åˆ©ç”¨æˆç†Ÿç»„ä»¶ï¼ˆhostapdã€dnsmasqã€iptablesï¼‰ï¼Œé™ä½å¼€å‘é£é™©ã€‚</li>
<li>è‡ªç ”éƒ¨åˆ†ä¸»è¦æ˜¯ Aã€B è¿›ç¨‹çš„é€»è¾‘å®ç°ã€‚</li>
</ul>
<hr>
<h2 id="5-é‡ç‚¹éš¾ç‚¹"><a href="#5-é‡ç‚¹éš¾ç‚¹" class="headerlink" title="5. é‡ç‚¹éš¾ç‚¹"></a>5. é‡ç‚¹éš¾ç‚¹</h2><h3 id="5-1-é‡ç‚¹"><a href="#5-1-é‡ç‚¹" class="headerlink" title="5.1 é‡ç‚¹"></a>5.1 é‡ç‚¹</h3><ul>
<li>JSON é…ç½®æ¨¡å‹ä¸ç³»ç»ŸæœåŠ¡çš„æ˜ å°„å…³ç³»ã€‚</li>
<li>Aã€B è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡åè®®ä¸ç‰ˆæœ¬ç®¡ç†ã€‚</li>
<li>å¤š SSID å¹¶å‘ç®¡ç†ï¼Œæ¡¥æ¥ä¸ NAT æ¨¡å¼åˆ‡æ¢ã€‚</li>
</ul>
<h3 id="5-2-éš¾ç‚¹"><a href="#5-2-éš¾ç‚¹" class="headerlink" title="5.2 éš¾ç‚¹"></a>5.2 éš¾ç‚¹</h3><ul>
<li>B è¿›ç¨‹æ‰§è¡Œçš„å¹‚ç­‰æ€§å’Œå›æ»šæœºåˆ¶è®¾è®¡ã€‚</li>
<li>hostapd&#x2F;dnsmasq çš„å¤šå®ä¾‹ç®¡ç†ä¸é…ç½®åŠ¨æ€æ›´æ–°ã€‚</li>
<li>NAT ä¸ bridge æ¨¡å¼å…±å­˜æ—¶çš„é˜²ç«å¢™è§„åˆ™ç®¡ç†ã€‚</li>
</ul>
<hr>
<h2 id="6-å¼€å±•è®¡åˆ’"><a href="#6-å¼€å±•è®¡åˆ’" class="headerlink" title="6. å¼€å±•è®¡åˆ’"></a>6. å¼€å±•è®¡åˆ’</h2><p>é¡¹ç›®å‘¨æœŸä¸¤ä¸ªæœˆï¼ˆ2025&#x2F;09&#x2F;02 â€“ 2025&#x2F;11&#x2F;02ï¼‰ï¼Œåˆ†ä¸ºäº”ä¸ªé˜¶æ®µï¼š</p>
<ol>
<li><strong>éœ€æ±‚åˆ†æä¸è®¾è®¡</strong>ï¼ˆ09&#x2F;02 â€“ 09&#x2F;10ï¼‰<ul>
<li>æ˜ç¡®é…ç½®éœ€æ±‚ã€å®šä¹‰ JSON æ•°æ®æ¨¡å‹ã€ç»˜åˆ¶æ¶æ„å›¾ã€‚</li>
</ul>
</li>
<li><strong>A è¿›ç¨‹å¼€å‘ï¼ˆé…ç½®ç®¡ç†ï¼‰</strong>ï¼ˆ09&#x2F;11 â€“ 09&#x2F;20ï¼‰<ul>
<li>å®ç° JSON è§£æã€å‚æ•°æ ¡éªŒã€é…ç½®æŒä¹…åŒ–ã€ä¸ B é€šä¿¡åè®®ã€‚</li>
</ul>
</li>
<li><strong>B è¿›ç¨‹å¼€å‘ï¼ˆé…ç½®æ‰§è¡Œï¼‰</strong>ï¼ˆ09&#x2F;21 â€“ 10&#x2F;05ï¼‰<ul>
<li>å®ç°ç³»ç»ŸæœåŠ¡è°ƒç”¨ã€æ¥å£é…ç½®ã€NAT&#x2F;Bridge åˆ‡æ¢ã€DHCP ç®¡ç†ã€‚</li>
</ul>
</li>
<li><strong>é›†æˆä¸æµ‹è¯•</strong>ï¼ˆ10&#x2F;06 â€“ 10&#x2F;20ï¼‰<ul>
<li>Web â†’ A â†’ B â†’ ç³»ç»ŸæœåŠ¡å…¨é“¾è·¯æµ‹è¯•ï¼Œå¤š SSID&#x2F;éš”ç¦»éªŒè¯ã€‚</li>
</ul>
</li>
<li><strong>ä¼˜åŒ–ä¸äº¤ä»˜</strong>ï¼ˆ10&#x2F;21 â€“ 11&#x2F;02ï¼‰<ul>
<li>ä»£ç ä¼˜åŒ–ã€æ—¥å¿—å®Œå–„ã€ç¼–å†™æœ€ç»ˆæŠ¥å‘Šã€å‡†å¤‡ç­”è¾© Demoã€‚</li>
</ul>
</li>
</ol>
<h1 id="ç¬¬-2-ç« -è¯¾é¢˜å†…å®¹-ç®€åŒ–ç‰ˆ"><a href="#ç¬¬-2-ç« -è¯¾é¢˜å†…å®¹-ç®€åŒ–ç‰ˆ" class="headerlink" title="ç¬¬ 2 ç«  è¯¾é¢˜å†…å®¹(ç®€åŒ–ç‰ˆ)"></a>ç¬¬ 2 ç«  è¯¾é¢˜å†…å®¹(ç®€åŒ–ç‰ˆ)</h1><h3 id="2-1-æ¦‚è¿°-1"><a href="#2-1-æ¦‚è¿°-1" class="headerlink" title="2.1 æ¦‚è¿°"></a>2.1 æ¦‚è¿°</h3><p><strong>ç›®æ ‡</strong><br> è®¾è®¡å¹¶å®ç°ä¸€ä¸ªé¢å‘ Web ç®¡ç†çš„ AP é…ç½®ä¸æ‰§è¡Œæ¡†æ¶ï¼Œæ ¸å¿ƒèƒ½åŠ›åŒ…æ‹¬ï¼š</p>
<ul>
<li>æ”¯æŒå¤š SSIDï¼ˆVAPï¼‰ç®¡ç†ï¼›</li>
<li>æ¯ä¸ª SSID æ”¯æŒä¸¤ç§å·¥ä½œæ¨¡å¼ï¼š<strong>bridge</strong>ï¼ˆæ¡¥æ¥ï¼‰ ä¸ <strong>nat</strong>ï¼ˆNATï¼‰ï¼›</li>
<li>NAT æ¨¡å¼ä¸‹æ”¯æŒç‹¬ç«‹å­ç½‘ã€DHCP åœ°å€æ± ä¸åŸºäº AP å‡ºå£çš„ SNATï¼›</li>
<li>æ”¯æŒå®¢æˆ·ç«¯éš”ç¦»ï¼ˆap_isolateï¼‰ï¼›</li>
<li>æä¾›é…ç½®æŒä¹…åŒ–ã€ç‰ˆæœ¬ç®¡ç†ä¸å›æ»šï¼›</li>
<li>Aï¼ˆé…ç½®ç®¡ç†ï¼‰ä¸ Bï¼ˆæ‰§è¡Œå™¨ï¼‰è§£è€¦ã€‚</li>
</ul>
<p><strong>çº¦æŸ</strong></p>
<ul>
<li>è¿è¡Œå¹³å°ï¼šåµŒå…¥å¼ Linux &#x2F; OpenWrt ç±»ç³»ç»Ÿï¼›</li>
<li>æ§åˆ¶é¢è½»é‡ï¼Œä¸å‚ä¸æ•°æ®è½¬å‘ï¼›</li>
<li>å¯è§‚æµ‹æ€§ï¼šå®Œæ•´æ—¥å¿—ã€æ‰§è¡Œå›æ‰§ï¼›</li>
<li>å®‰å…¨æ€§ï¼šæ•æ„Ÿæ•°æ®ä¿æŠ¤ï¼ŒIPC&#x2F;é…ç½®æ–‡ä»¶æƒé™æ§åˆ¶ã€‚</li>
</ul>
<hr>
<h3 id="2-2-æ¨¡å‹ç»„ä»¶-1"><a href="#2-2-æ¨¡å‹ç»„ä»¶-1" class="headerlink" title="2.2 æ¨¡å‹ç»„ä»¶"></a>2.2 æ¨¡å‹ç»„ä»¶</h3><table>
<thead>
<tr>
<th>ç»„ä»¶</th>
<th>èŒè´£</th>
<th>æ¥å£</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Web å‰ç«¯</strong></td>
<td>æä¾›é…ç½®é¡µé¢ï¼ˆæ–°å¢&#x2F;ä¿®æ”¹&#x2F;åˆ é™¤ SSIDï¼‰</td>
<td>REST API (HTTP)ã€WebSocket</td>
<td>ä¸ç”¨æˆ·äº¤äº’</td>
</tr>
<tr>
<td><strong>A è¿›ç¨‹</strong></td>
<td>æ¥æ”¶ Web JSONã€æ ¡éªŒ&#x2F;æŒä¹…åŒ–&#x2F;ä¸‹å‘ã€ç»´æŠ¤ç‰ˆæœ¬</td>
<td>RESTã€IPCã€é…ç½®æ–‡ä»¶</td>
<td>é€»è¾‘ä¸­å¿ƒ</td>
</tr>
<tr>
<td><strong>B è¿›ç¨‹</strong></td>
<td>è¯»å–é…ç½®å¹¶æ‰§è¡Œå·®å¼‚æ“ä½œï¼Œè°ƒç”¨ç³»ç»Ÿå‘½ä»¤</td>
<td>IPCã€æ—¥å¿—</td>
<td>å¹‚ç­‰æ‰§è¡Œå™¨</td>
</tr>
<tr>
<td><strong>ç³»ç»ŸæœåŠ¡</strong></td>
<td>hostapd&#x2F;dnsmasq&#x2F;iptables&#x2F;ip&#x2F;iw&#x2F;sysctl</td>
<td>ç³»ç»Ÿå‘½ä»¤æ¥å£</td>
<td>å®é™…æ‰§è¡Œå±‚</td>
</tr>
</tbody></table>
<hr>
<h3 id="2-3-æ•°æ®æ¨¡å‹å®šä¹‰-1"><a href="#2-3-æ•°æ®æ¨¡å‹å®šä¹‰-1" class="headerlink" title="2.3 æ•°æ®æ¨¡å‹å®šä¹‰"></a>2.3 æ•°æ®æ¨¡å‹å®šä¹‰</h3><h4 id="JSON-ç¤ºä¾‹"><a href="#JSON-ç¤ºä¾‹" class="headerlink" title="JSON ç¤ºä¾‹"></a>JSON ç¤ºä¾‹</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;version&quot;: 3,</span><br><span class="line">  &quot;ssids&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;id&quot;: &quot;guest_nat&quot;,</span><br><span class="line">      &quot;name&quot;: &quot;Guest-NAT&quot;,</span><br><span class="line">      &quot;band&quot;: &quot;2.4G&quot;,</span><br><span class="line">      &quot;channel&quot;: 6,</span><br><span class="line">      &quot;password&quot;: &quot;guest12345&quot;,</span><br><span class="line">      &quot;mode&quot;: &quot;nat&quot;,</span><br><span class="line">      &quot;client_isolation&quot;: true,</span><br><span class="line">      &quot;dhcp&quot;: &#123;</span><br><span class="line">        &quot;enabled&quot;: true,</span><br><span class="line">        &quot;gateway&quot;: &quot;192.168.100.1&quot;,</span><br><span class="line">        &quot;subnet_mask&quot;: &quot;255.255.255.0&quot;,</span><br><span class="line">        &quot;range_start&quot;: &quot;192.168.100.50&quot;,</span><br><span class="line">        &quot;range_end&quot;: &quot;192.168.100.150&quot;,</span><br><span class="line">        &quot;lease_time&quot;: &quot;12h&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;vif&quot;: &quot;wlan0_1&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;meta&quot;: &#123;</span><br><span class="line">    &quot;ap_name&quot;: &quot;MyAP&quot;,</span><br><span class="line">    &quot;updated_by&quot;: &quot;web_user&quot;,</span><br><span class="line">    &quot;timestamp&quot;: 1690000000</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="è¯­ä¹‰æ ¡éªŒè§„åˆ™"><a href="#è¯­ä¹‰æ ¡éªŒè§„åˆ™" class="headerlink" title="è¯­ä¹‰æ ¡éªŒè§„åˆ™"></a>è¯­ä¹‰æ ¡éªŒè§„åˆ™</h4><ul>
<li>SSID åç§°å”¯ä¸€ï¼›</li>
<li>IP åœ°å€æ± ä¸é‡å ï¼›</li>
<li>DHCP ç½‘å…³åœ¨å­ç½‘å†…ä¸”ä¸è½å…¥æ± ï¼›</li>
<li>Bridge æ¨¡å¼ä¸‹ä¸å¯ç”¨ DHCPï¼›</li>
<li>Channel å€¼æ ¹æ® Band åˆæ³•ã€‚</li>
</ul>
<hr>
<h3 id="2-4-å®æ–½æµç¨‹-1"><a href="#2-4-å®æ–½æµç¨‹-1" class="headerlink" title="2.4 å®æ–½æµç¨‹"></a>2.4 å®æ–½æµç¨‹</h3><h4 id="2-4-1-åˆå§‹åŒ–é…ç½®-1"><a href="#2-4-1-åˆå§‹åŒ–é…ç½®-1" class="headerlink" title="2.4.1 åˆå§‹åŒ–é…ç½®"></a>2.4.1 åˆå§‹åŒ–é…ç½®</h4><ul>
<li>A æŒä¹…åŒ–é…ç½® â†’ ä¸‹å‘ç»™ Bï¼›</li>
<li>B åˆ›å»º VAPã€é…ç½® IPã€å¯åŠ¨ dnsmasqã€æ·»åŠ  NATã€å¯ç”¨è½¬å‘ï¼›</li>
<li>æˆåŠŸåè¿”å›ç»“æœå¹¶è®°å½•ä¸º <code>last_good_version</code>ã€‚</li>
</ul>
<p>ç¤ºä¾‹å‘½ä»¤ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iw dev wlan0 interface add wlan0_1 type __ap</span><br><span class="line">ip addr add 192.168.100.1/24 dev wlan0_1</span><br><span class="line">iptables -t nat -A POSTROUTING -s 192.168.100.0/24 -o eth0 -j MASQUERADE</span><br></pre></td></tr></table></figure>

<h4 id="2-4-2-æ–°å»º-SSID-1"><a href="#2-4-2-æ–°å»º-SSID-1" class="headerlink" title="2.4.2 æ–°å»º SSID"></a>2.4.2 æ–°å»º SSID</h4><ul>
<li>Web æäº¤æ–°é…ç½® â†’ A æ ¡éªŒå¹¶ç”Ÿæˆæ–°ç‰ˆæœ¬ â†’ ä¸‹å‘ç»™ Bï¼›</li>
<li>B åŠ¨æ€åˆ›å»ºæ¥å£ã€å†™ dnsmasq é…ç½®ã€æ·»åŠ  NAT è§„åˆ™ï¼›</li>
<li>éªŒè¯æˆåŠŸåå†™å…¥è¿è¡Œæ€æ–‡ä»¶ã€‚</li>
</ul>
<h4 id="2-4-3-ä¿®æ”¹-SSID-1"><a href="#2-4-3-ä¿®æ”¹-SSID-1" class="headerlink" title="2.4.3 ä¿®æ”¹ SSID"></a>2.4.3 ä¿®æ”¹ SSID</h4><ul>
<li>ä¿®æ”¹å¯†ç ï¼š<code>hostapd_cli</code> æ›´æ–°ï¼›</li>
<li>ä¿®æ”¹ channelï¼šéœ€é‡è½½ hostapdï¼›</li>
<li>æ¨¡å¼åˆ‡æ¢ï¼šbridge â‡„ natï¼Œéœ€è¦åˆ é™¤æˆ–æ–°å¢ NAT&#x2F;DHCP é…ç½®ã€‚</li>
</ul>
<h4 id="2-4-4-åˆ é™¤-SSID"><a href="#2-4-4-åˆ é™¤-SSID" class="headerlink" title="2.4.4 åˆ é™¤ SSID"></a>2.4.4 åˆ é™¤ SSID</h4><ul>
<li>ç§»é™¤ dnsmasq é…ç½®ï¼›</li>
<li>åˆ é™¤ NAT è§„åˆ™ï¼›</li>
<li>åˆ é™¤ VAP æ¥å£ã€‚</li>
</ul>
<h4 id="2-4-5-æˆåŠŸ-å¤±è´¥å›æ»š-1"><a href="#2-4-5-æˆåŠŸ-å¤±è´¥å›æ»š-1" class="headerlink" title="2.4.5 æˆåŠŸ&#x2F;å¤±è´¥å›æ»š"></a>2.4.5 æˆåŠŸ&#x2F;å¤±è´¥å›æ»š</h4><ul>
<li>å‡ºé”™æ—¶ B ä¸ŠæŠ¥é”™è¯¯ï¼›</li>
<li>A è§¦å‘å›æ»šï¼Œé‡æ–°åº”ç”¨ <code>last_good_version</code>ï¼›</li>
<li>ä¿è¯ç³»ç»Ÿå§‹ç»ˆå¤„äºå¯ç”¨çŠ¶æ€ã€‚</li>
</ul>
<hr>
<h1 id="ğŸ“Š-Mermaid-æ—¶åºå›¾"><a href="#ğŸ“Š-Mermaid-æ—¶åºå›¾" class="headerlink" title="ğŸ“Š Mermaid æ—¶åºå›¾"></a>ğŸ“Š Mermaid æ—¶åºå›¾</h1><p>ä¸‹é¢è¿™å¼ å›¾å±•ç¤ºäº†â€œæ–°å»ºä¸€ä¸ª NAT æ¨¡å¼çš„ SSIDâ€çš„å®Œæ•´äº¤äº’æµç¨‹ï¼š</p>
<pre class="mermaid">sequenceDiagram
    participant Web as Webå‰ç«¯
    participant A as Aè¿›ç¨‹<br>(é…ç½®ç®¡ç†)
    participant B as Bè¿›ç¨‹<br>(é…ç½®æ‰§è¡Œ)
    participant Sys as ç³»ç»ŸæœåŠ¡<br>(hostapd/dnsmasq/iptables)

    Web->>A: æäº¤æ–°å¢SSID JSON
    A->>A: æ ¡éªŒJSON Schema & è¯­ä¹‰åˆæ³•æ€§
    A->>A: æŒä¹…åŒ–é…ç½® (config_V.json)<br>æ›´æ–°current/last_good
    A->>B: IPCä¸‹å‘ {apply_config, version=V}
    B->>B: è¯»å–é…ç½® & è®¡ç®—diff (create:ssid)
    B->>Sys: åˆ›å»ºVAP (iw/hostapd)
    B->>Sys: é…ç½®æ¥å£IP (ip addr)
    B->>Sys: å†™dnsmasqé…ç½® & reload
    B->>Sys: æ·»åŠ NATè§„åˆ™ (iptables -t nat)
    Sys-->>B: æ‰§è¡Œç»“æœ(æˆåŠŸ/å¤±è´¥)
    B->>A: è¿”å›apply_result(status=success)
    A->>Web: è¿”å›æˆåŠŸ & æ›´æ–°UI</pre>



<h1 id="ç¬¬2ç« -è¯¾é¢˜å†…å®¹ï¼ˆè¯¦å°½ç‰ˆï¼‰"><a href="#ç¬¬2ç« -è¯¾é¢˜å†…å®¹ï¼ˆè¯¦å°½ç‰ˆï¼‰" class="headerlink" title="ç¬¬2ç«  è¯¾é¢˜å†…å®¹ï¼ˆè¯¦å°½ç‰ˆï¼‰"></a>ç¬¬2ç«  è¯¾é¢˜å†…å®¹ï¼ˆè¯¦å°½ç‰ˆï¼‰</h1><h2 id="2-1-æ¦‚è¿°-2"><a href="#2-1-æ¦‚è¿°-2" class="headerlink" title="2.1 æ¦‚è¿°"></a>2.1 æ¦‚è¿°</h2><p><strong>ç›®æ ‡</strong><br> è®¾è®¡å¹¶å®ç°ä¸€ä¸ªé¢å‘ Web ç®¡ç†çš„ AP é…ç½®ä¸æ‰§è¡Œæ¡†æ¶ï¼Œæ ¸å¿ƒèƒ½åŠ›åŒ…æ‹¬ï¼š</p>
<ul>
<li>æ”¯æŒå¤š SSIDï¼ˆVAPï¼‰ç®¡ç†ï¼›</li>
<li>æ¯ä¸ª SSID æ”¯æŒä¸¤ç§å·¥ä½œæ¨¡å¼ï¼š<strong>bridge</strong>ï¼ˆæ¡¥æ¥ï¼‰ ä¸ <strong>nat</strong>ï¼ˆNATï¼‰ï¼›</li>
<li>NAT æ¨¡å¼ä¸‹æ”¯æŒç‹¬ç«‹å­ç½‘ã€DHCP åœ°å€æ± ä¸åŸºäº AP å‡ºå£çš„ SNATï¼›</li>
<li>æ”¯æŒå®¢æˆ·ç«¯éš”ç¦»ï¼ˆap_isolateï¼‰ï¼›</li>
<li>æä¾›é…ç½®æŒä¹…åŒ–ã€ç‰ˆæœ¬ç®¡ç†ä¸å›æ»šï¼ˆä¿è¯é…ç½®é”™è¯¯å¯æ¢å¤ï¼‰ï¼›</li>
<li>Aï¼ˆé…ç½®ç®¡ç†ï¼‰ä¸ Bï¼ˆæ‰§è¡Œå™¨ï¼‰è§£è€¦ï¼šA è´Ÿè´£æ ¡éªŒ&#x2F;æŒä¹…åŒ–&#x2F;ä¸‹å‘ï¼ŒB è´Ÿè´£ç³»ç»Ÿå±‚æ‰§è¡Œä¸å¹‚ç­‰æ€§ã€‚</li>
</ul>
<p><strong>çº¦æŸä¸éåŠŸèƒ½è¦æ±‚</strong></p>
<ul>
<li>è¿è¡Œå¹³å°ï¼šåµŒå…¥å¼ Linuxï¼ˆå¦‚ OpenWrt&#x2F;ç±»ä¼¼å‘è¡Œç‰ˆï¼‰æˆ–é€šç”¨ Linuxï¼›ä¾èµ– <code>hostapd</code>ã€<code>dnsmasq</code>ã€<code>iproute2</code>ã€<code>iptables/nftables</code>ã€‚</li>
<li>æ€§èƒ½ï¼šæ§åˆ¶é¢ï¼ˆA&#x2F;Bï¼‰è½»é‡ï¼Œä¸å‚ä¸æ•°æ®è½¬å‘ï¼›B çš„ç³»ç»Ÿè°ƒç”¨åº”åœ¨çº¿æ€§æ—¶é—´å†…å®Œæˆï¼ˆä»¥ç§’è®¡ï¼‰ã€‚</li>
<li>å¯è§‚æµ‹æ€§ï¼šå®Œæ•´æ—¥å¿—ã€æ‰§è¡Œå›æ‰§ã€Web å¯æŸ¥è¯¢çŠ¶æ€ã€‚</li>
<li>å®‰å…¨æ€§ï¼šæ•æ„Ÿæ•°æ®ï¼ˆå¯†ç ï¼‰ä¸å¾—ä»¥æ˜æ–‡æ•£è½æ—¥å¿—ï¼›IPCã€æŒä¹…åŒ–æ–‡ä»¶æƒé™è¦å—é™ã€‚</li>
</ul>
<hr>
<h2 id="2-2-æ¨¡å‹ç»„ä»¶ï¼ˆèŒè´£ä¸æ¥å£ï¼‰"><a href="#2-2-æ¨¡å‹ç»„ä»¶ï¼ˆèŒè´£ä¸æ¥å£ï¼‰" class="headerlink" title="2.2 æ¨¡å‹ç»„ä»¶ï¼ˆèŒè´£ä¸æ¥å£ï¼‰"></a>2.2 æ¨¡å‹ç»„ä»¶ï¼ˆèŒè´£ä¸æ¥å£ï¼‰</h2><h3 id="ç»„ä»¶æ¦‚è§ˆ"><a href="#ç»„ä»¶æ¦‚è§ˆ" class="headerlink" title="ç»„ä»¶æ¦‚è§ˆ"></a>ç»„ä»¶æ¦‚è§ˆ</h3><ul>
<li><strong>Web å‰ç«¯</strong><ul>
<li>åŠŸèƒ½ï¼šå‘ç”¨æˆ·æä¾›é…ç½®ç•Œé¢ï¼ˆSSIDã€é¢‘æ®µã€ä¿¡é“ã€å¯†ç ã€modeã€client_isolationã€DHCP æ± ç­‰ï¼‰ï¼›è°ƒç”¨ A çš„ HTTP APIã€‚</li>
<li>æ¥å£ï¼š<code>POST /api/config</code>ã€<code>GET /api/config</code>ã€<code>GET /api/status</code>ã€WebSocket&#x2F;Server-Sent Events ç”¨äºæ¨é€ apply çŠ¶æ€ã€‚</li>
</ul>
</li>
<li><strong>A è¿›ç¨‹ï¼ˆé…ç½®ç®¡ç†ï¼‰</strong><ul>
<li>èŒè´£ï¼šæ¥æ”¶ Web JSONã€è¿›è¡Œ Schema ä¸è¯­ä¹‰æ ¡éªŒï¼ˆSSID å”¯ä¸€ã€IP å­ç½‘ä¸é‡å ã€ä¿¡é“åˆæ³•æ€§ç­‰ï¼‰ã€ç”Ÿæˆç‰ˆæœ¬ï¼ˆversionï¼‰ã€åŸå­æŒä¹…åŒ–åˆ° flashï¼ˆconfig_${version}.jsonï¼‰ã€ç»´æŠ¤ <code>current</code> ä¸ <code>last_good_version</code>ã€å‘ B å‘é€ IPC ä¸‹å‘è¯·æ±‚ã€æ¥æ”¶ B æ‰§è¡Œç»“æœå¹¶é€šçŸ¥ Webã€‚</li>
<li>æ¥å£ï¼šHTTP&#x2F;RESTï¼ˆä¾› Web ä½¿ç”¨ï¼‰ã€Unix Domain Socketï¼ˆæˆ–å…¶ä»–æœ¬åœ° IPCï¼‰å¯¹ B ä¸‹å‘æ¶ˆæ¯ã€æ–‡ä»¶è·¯å¾„ <code>/etc/myap/config_*.json</code>ã€‚</li>
</ul>
</li>
<li><strong>B è¿›ç¨‹ï¼ˆé…ç½®æ‰§è¡Œï¼‰</strong><ul>
<li>èŒè´£ï¼šæ¥æ”¶ A çš„ apply è¯·æ±‚ï¼Œè¯»å–å¯¹åº” JSONï¼Œè®¡ç®—å·®å¼‚ï¼ˆdiffï¼šcreate&#x2F;modify&#x2F;deleteï¼‰ï¼ŒæŒ‰åºå¯¹ç³»ç»Ÿå±‚ï¼ˆhostapd&#x2F;dnsmasq&#x2F;ip&#x2F;iptablesï¼‰æ‰§è¡Œæ“ä½œï¼Œä¿è¯å¹‚ç­‰ä¸”è®°å½•æ¯ä¸€æ­¥æ‰§è¡Œç»“æœï¼›å‡ºé”™æ—¶ä¸ŠæŠ¥å¹¶æ”¯æŒå›æ»šï¼ˆæˆ–è¯·æ±‚ A ä¸‹å‘ last_goodï¼‰ã€‚</li>
<li>æ¥å£ï¼šUnix Domain Socketï¼ˆæ¥æ”¶ applyï¼‰ã€æ—¥å¿—æ–‡ä»¶ <code>/var/log/myap/b_process.log</code>ã€è¿è¡Œæ€æ–‡ä»¶ <code>/var/run/myap_running.json</code>ã€‚</li>
</ul>
</li>
<li><strong>ç³»ç»ŸæœåŠ¡ï¼ˆæ‰§è¡Œå¯¹è±¡ï¼‰</strong><ul>
<li><code>hostapd</code>ï¼šå¤š BSS æ”¯æŒæˆ–é©±åŠ¨ VAP ç®¡ç†ã€‚</li>
<li><code>dnsmasq</code>ï¼šDHCP åˆ†é…ï¼Œå»ºè®®ä½¿ç”¨ <code>--conf-dir</code> æŒ‰ ssid ç”Ÿæˆå° conf æ–‡ä»¶ä»¥ä¾¿å•ç‹¬ç®¡ç†ã€‚</li>
<li><code>ip/iw</code>ï¼šæ¥å£åˆ›å»ºã€IP åˆ†é…ã€æ¡¥æ¥ã€‚</li>
<li><code>iptables / nftables</code>ï¼šNAT ä¸ FORWARD ç­–ç•¥ï¼ˆå»ºè®®åœ¨ç‹¬ç«‹é“¾ç®¡ç†ï¼‰ã€‚</li>
<li><code>sysctl</code>ï¼šå¯ç”¨ <code>net.ipv4.ip_forward=1</code>ï¼ˆNAT æ¨¡å¼éœ€è¦ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<hr>
<h2 id="2-3-æ•°æ®æ¨¡å‹å®šä¹‰ï¼ˆJSON-Schema-å­—æ®µæ ¡éªŒï¼‰"><a href="#2-3-æ•°æ®æ¨¡å‹å®šä¹‰ï¼ˆJSON-Schema-å­—æ®µæ ¡éªŒï¼‰" class="headerlink" title="2.3 æ•°æ®æ¨¡å‹å®šä¹‰ï¼ˆJSON Schema + å­—æ®µæ ¡éªŒï¼‰"></a>2.3 æ•°æ®æ¨¡å‹å®šä¹‰ï¼ˆJSON Schema + å­—æ®µæ ¡éªŒï¼‰</h2><p>ä¸‹é¢ç»™å‡ºæ¨èçš„ JSON ç¤ºä¾‹ä¸å¯¹åº” JSON Schemaï¼ˆå¯ç”¨äº A è¿›ç¨‹é€šè¿‡ JSON Schema æ ¡éªŒåº“å®ç°è‡ªåŠ¨æ ¡éªŒï¼‰ã€‚</p>
<h3 id="æ¨è-JSON-ç¤ºä¾‹"><a href="#æ¨è-JSON-ç¤ºä¾‹" class="headerlink" title="æ¨è JSON ç¤ºä¾‹"></a>æ¨è JSON ç¤ºä¾‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;version&quot;: 3,</span><br><span class="line">  &quot;ssids&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;id&quot;: &quot;guest_nat&quot;,</span><br><span class="line">      &quot;name&quot;: &quot;Guest-NAT&quot;,</span><br><span class="line">      &quot;band&quot;: &quot;2.4G&quot;,</span><br><span class="line">      &quot;channel&quot;: 6,</span><br><span class="line">      &quot;password&quot;: &quot;guest12345&quot;,</span><br><span class="line">      &quot;mode&quot;: &quot;nat&quot;,</span><br><span class="line">      &quot;client_isolation&quot;: true,</span><br><span class="line">      &quot;dhcp&quot;: &#123;</span><br><span class="line">        &quot;enabled&quot;: true,</span><br><span class="line">        &quot;gateway&quot;: &quot;192.168.100.1&quot;,</span><br><span class="line">        &quot;subnet_mask&quot;: &quot;255.255.255.0&quot;,</span><br><span class="line">        &quot;range_start&quot;: &quot;192.168.100.50&quot;,</span><br><span class="line">        &quot;range_end&quot;: &quot;192.168.100.150&quot;,</span><br><span class="line">        &quot;lease_time&quot;: &quot;12h&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;vif&quot;: &quot;wlan0_1&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;meta&quot;: &#123;</span><br><span class="line">    &quot;ap_name&quot;: &quot;MyAP&quot;,</span><br><span class="line">    &quot;updated_by&quot;: &quot;web_user&quot;,</span><br><span class="line">    &quot;timestamp&quot;: 1690000000</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ ¸å¿ƒ-JSON-Schemaï¼ˆç¤ºä¾‹ï¼Œç®€åŒ–ï¼‰"><a href="#æ ¸å¿ƒ-JSON-Schemaï¼ˆç¤ºä¾‹ï¼Œç®€åŒ–ï¼‰" class="headerlink" title="æ ¸å¿ƒ JSON Schemaï¼ˆç¤ºä¾‹ï¼Œç®€åŒ–ï¼‰"></a>æ ¸å¿ƒ JSON Schemaï¼ˆç¤ºä¾‹ï¼Œç®€åŒ–ï¼‰</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;$schema&quot;: &quot;http://json-schema.org/draft-07/schema#&quot;,</span><br><span class="line">  &quot;type&quot;: &quot;object&quot;,</span><br><span class="line">  &quot;required&quot;: [&quot;version&quot;,&quot;ssids&quot;],</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;version&quot;: &#123;&quot;type&quot;: &quot;integer&quot;, &quot;minimum&quot;: 1&#125;,</span><br><span class="line">    &quot;ssids&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;array&quot;,</span><br><span class="line">      &quot;items&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;object&quot;,</span><br><span class="line">        &quot;required&quot;: [&quot;id&quot;,&quot;name&quot;,&quot;band&quot;,&quot;channel&quot;,&quot;mode&quot;,&quot;client_isolation&quot;,&quot;dhcp&quot;],</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">          &quot;id&quot;: &#123;&quot;type&quot;:&quot;string&quot;,&quot;pattern&quot;:&quot;^[A-Za-z0-9_\\-]&#123;1,32&#125;$&quot;&#125;,</span><br><span class="line">          &quot;name&quot;: &#123;&quot;type&quot;:&quot;string&quot;,&quot;minLength&quot;:1,&quot;maxLength&quot;:32&#125;,</span><br><span class="line">          &quot;band&quot;: &#123;&quot;type&quot;:&quot;string&quot;,&quot;enum&quot;:[&quot;2.4G&quot;,&quot;5G&quot;]&#125;,</span><br><span class="line">          &quot;channel&quot;: &#123;&quot;type&quot;:&quot;integer&quot;,&quot;minimum&quot;:1,&quot;maximum&quot;:165&#125;,</span><br><span class="line">          &quot;password&quot;: &#123;&quot;type&quot;:[&quot;string&quot;,&quot;null&quot;], &quot;minLength&quot;:8&#125;,</span><br><span class="line">          &quot;mode&quot;: &#123;&quot;type&quot;:&quot;string&quot;,&quot;enum&quot;:[&quot;bridge&quot;,&quot;nat&quot;]&#125;,</span><br><span class="line">          &quot;client_isolation&quot;: &#123;&quot;type&quot;:&quot;boolean&quot;&#125;,</span><br><span class="line">          &quot;vif&quot;: &#123;&quot;type&quot;:&quot;string&quot;&#125;,</span><br><span class="line">          &quot;dhcp&quot;: &#123;</span><br><span class="line">            &quot;type&quot;:&quot;object&quot;,</span><br><span class="line">            &quot;required&quot;:[&quot;enabled&quot;],</span><br><span class="line">            &quot;properties&quot;:&#123;</span><br><span class="line">              &quot;enabled&quot;:&#123;&quot;type&quot;:&quot;boolean&quot;&#125;,</span><br><span class="line">              &quot;gateway&quot;:&#123;&quot;type&quot;:&quot;string&quot;,&quot;format&quot;:&quot;ipv4&quot;&#125;,</span><br><span class="line">              &quot;subnet_mask&quot;:&#123;&quot;type&quot;:&quot;string&quot;&#125;,</span><br><span class="line">              &quot;range_start&quot;:&#123;&quot;type&quot;:&quot;string&quot;,&quot;format&quot;:&quot;ipv4&quot;&#125;,</span><br><span class="line">              &quot;range_end&quot;:&#123;&quot;type&quot;:&quot;string&quot;,&quot;format&quot;:&quot;ipv4&quot;&#125;,</span><br><span class="line">              &quot;lease_time&quot;:&#123;&quot;type&quot;:&quot;string&quot;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;meta&quot;: &#123;&quot;type&quot;:&quot;object&quot;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="é¢å¤–è¯­ä¹‰æ ¡éªŒï¼ˆç”±-A-è¿›ç¨‹å®ç°ï¼‰"><a href="#é¢å¤–è¯­ä¹‰æ ¡éªŒï¼ˆç”±-A-è¿›ç¨‹å®ç°ï¼‰" class="headerlink" title="é¢å¤–è¯­ä¹‰æ ¡éªŒï¼ˆç”± A è¿›ç¨‹å®ç°ï¼‰"></a>é¢å¤–è¯­ä¹‰æ ¡éªŒï¼ˆç”± A è¿›ç¨‹å®ç°ï¼‰</h3><ul>
<li><code>ssid.name</code> ä¸ä¸å·²å­˜åœ¨ SSID å†²çªï¼ˆcase-insensitiveï¼‰ï¼›</li>
<li><code>channel</code> æ ¹æ® <code>band</code> åšèŒƒå›´æ£€æŸ¥ï¼Œ(2.4G é€šå¸¸ 1â€“14ï¼Œ5G å¸¸è§ 36â€“165ï¼Œå—å›½å®¶&#x2F;é©±åŠ¨é™åˆ¶)ï¼›</li>
<li><code>dhcp.range_start/ end</code> å¿…é¡»åœ¨åŒä¸€å­ç½‘ï¼Œä¸”ä¸å…¶ä»– SSID çš„åœ°å€æ± <strong>ä¸é‡å </strong>ï¼›</li>
<li><code>dhcp.gateway</code> å¿…é¡»åœ¨åŒä¸€å­ç½‘ä¸”ä¸åœ¨ DHCP æ± å†…ï¼›</li>
<li>è‹¥ <code>mode=bridge</code> åˆ™ <code>dhcp.enabled</code> é€šå¸¸åº”ä¸º <code>false</code>ï¼ˆå…è®¸ä½†éœ€è­¦ç¤ºï¼‰ï¼›</li>
<li><code>vif</code> è‹¥æ‰‹åŠ¨æŒ‡å®šï¼ŒA éœ€æ£€æŸ¥å‘½åä¸å†²çªä¸”é©±åŠ¨æ”¯æŒï¼›å¦åˆ™ç”± B è‡ªåŠ¨åˆ†é… <code>wlan0_&lt;n&gt;</code>ã€‚</li>
</ul>
<hr>
<h2 id="2-4-å®æ–½æµç¨‹ï¼ˆæ“ä½œåºåˆ—ã€å‘½ä»¤ç¤ºä¾‹ã€å›æ»šç­–ç•¥ï¼‰"><a href="#2-4-å®æ–½æµç¨‹ï¼ˆæ“ä½œåºåˆ—ã€å‘½ä»¤ç¤ºä¾‹ã€å›æ»šç­–ç•¥ï¼‰" class="headerlink" title="2.4 å®æ–½æµç¨‹ï¼ˆæ“ä½œåºåˆ—ã€å‘½ä»¤ç¤ºä¾‹ã€å›æ»šç­–ç•¥ï¼‰"></a>2.4 å®æ–½æµç¨‹ï¼ˆæ“ä½œåºåˆ—ã€å‘½ä»¤ç¤ºä¾‹ã€å›æ»šç­–ç•¥ï¼‰</h2><blockquote>
<p>è¯´æ˜ï¼šä¸‹é¢æŒ‰å¸¸è§åœºæ™¯ç»™å‡ºè¯¦ç»†æ‰§è¡Œæ­¥éª¤ä¸å‘½ä»¤ç¤ºä¾‹ã€‚B è¿›ç¨‹åº”æ‰§è¡Œâ€œå­˜åœ¨æ€§æ£€æŸ¥ â†’ æ“ä½œ â†’ éªŒè¯â€ä¸‰æ®µå¼ï¼Œä»»ä½•æ­¥éª¤å¤±è´¥è¦è®°å½•å¹¶ä¸ŠæŠ¥ Aã€‚</p>
</blockquote>
<h3 id="é€šç”¨å‡†å¤‡ï¼ˆAã€B-åè®®ä¸æŒä¹…åŒ–ï¼‰"><a href="#é€šç”¨å‡†å¤‡ï¼ˆAã€B-åè®®ä¸æŒä¹…åŒ–ï¼‰" class="headerlink" title="é€šç”¨å‡†å¤‡ï¼ˆAã€B åè®®ä¸æŒä¹…åŒ–ï¼‰"></a>é€šç”¨å‡†å¤‡ï¼ˆAã€B åè®®ä¸æŒä¹…åŒ–ï¼‰</h3><ol>
<li><strong>æŒä¹…åŒ–ç­–ç•¥ï¼ˆAï¼‰</strong><ul>
<li>å†™å…¥ä¸´æ—¶æ–‡ä»¶ <code>/tmp/config_$&#123;version&#125;.json.tmp</code> â†’ <code>fsync()</code> â†’ <code>rename</code> åˆ° <code>/etc/myap/config_$&#123;version&#125;.json</code>ï¼ˆä¿è¯åŸå­æ€§ï¼‰ã€‚</li>
<li>æ›´æ–° <code>/etc/myap/current</code>ï¼ˆè½¯é“¾æ¥æˆ–æ–‡ä»¶æŒ‡å‘ï¼‰å¹¶ <code>fsync</code>ã€‚</li>
<li><code>last_good_version</code> ä¿å­˜åˆ° <code>/etc/myap/last_good</code>ã€‚</li>
</ul>
</li>
<li><strong>IPC æ ¼å¼</strong><ul>
<li>A â†’ B: <code>&#123;action:&quot;apply_config&quot;, version: N, config_path: &quot;/etc/myap/config_N.json&quot;, delta: &#123;...&#125;&#125;</code></li>
<li>B â†’ A: <code>&#123;action:&quot;apply_result&quot;, version: N, status:&quot;success&quot;|&quot;partial_fail&quot;|&quot;fail&quot;, errors:[...], applied_steps:[...]&#125;</code></li>
</ul>
</li>
<li><strong>äº’æ–¥é”</strong><ul>
<li>A åœ¨ä¸‹å‘å‰è·å–&#x2F;æ£€æŸ¥å…¨å±€æ–‡ä»¶é”ï¼ˆ<code>flock</code>ï¼‰ï¼ŒB åœ¨æ‰§è¡Œå¼€å§‹æ—¶è·å–åŒä¸€é”ï¼Œé¿å…å¹¶å‘ applyã€‚</li>
</ul>
</li>
</ol>
<hr>
<h3 id="2-4-1-åˆå§‹åŒ–é…ç½®ï¼ˆç³»ç»Ÿç¬¬ä¸€æ¬¡ä¸Šç”µ-éƒ¨ç½²ï¼‰"><a href="#2-4-1-åˆå§‹åŒ–é…ç½®ï¼ˆç³»ç»Ÿç¬¬ä¸€æ¬¡ä¸Šç”µ-éƒ¨ç½²ï¼‰" class="headerlink" title="2.4.1 åˆå§‹åŒ–é…ç½®ï¼ˆç³»ç»Ÿç¬¬ä¸€æ¬¡ä¸Šç”µ&#x2F;éƒ¨ç½²ï¼‰"></a>2.4.1 åˆå§‹åŒ–é…ç½®ï¼ˆç³»ç»Ÿç¬¬ä¸€æ¬¡ä¸Šç”µ&#x2F;éƒ¨ç½²ï¼‰</h3><p><strong>ç›®æ ‡</strong>ï¼šå°†åˆå§‹é…ç½®åŠ è½½åˆ°ç³»ç»Ÿå¹¶å¯åŠ¨å¿…è¦æœåŠ¡ã€‚</p>
<p><strong>æ­¥éª¤ï¼š</strong></p>
<ol>
<li><p>Web æäº¤åˆå§‹ JSON â†’ A æ ¡éªŒã€‚</p>
</li>
<li><p>A åŸå­å†™å…¥ <code>/etc/myap/config_1.json</code>ï¼Œè®¾ç½® <code>current=1</code>ã€‚</p>
</li>
<li><p>A å‘ IPC <code>&#123;action:apply_config,version:1,path:/etc/myap/config_1.json&#125;</code> ç»™ Bã€‚</p>
</li>
<li><p>B è¯»å– JSONï¼Œè®¡ç®— diffï¼ˆç©ºâ†’ç›®æ ‡ï¼‰ã€‚</p>
</li>
<li><p>B æŒ‰ SSID é¡ºåºæ‰§è¡Œï¼š</p>
<ul>
<li><p>åˆ›å»º&#x2F;å¯ç”¨ VAPï¼ˆç¤ºä¾‹ï¼‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># å¦‚æœä½¿ç”¨ iw åŠ¨æ€åˆ›å»º</span><br><span class="line">iw dev wlan0 interface add wlan0_1 type __ap</span><br><span class="line">ip link set wlan0_1 up</span><br><span class="line"># æˆ–é€šè¿‡ hostapd bss æ®µå† hostapd_cli reconfigure</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç»™æ¥å£é…ç½® IPï¼ˆNAT æ¨¡å¼ï¼‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip addr add 192.168.100.1/24 dev wlan0_1</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç”Ÿæˆ <code>/etc/dnsmasq.d/ssid_guest_nat.conf</code>ï¼Œå†…å®¹ç¤ºä¾‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">interface=wlan0_1</span><br><span class="line">dhcp-range=192.168.100.50,192.168.100.150,12h</span><br><span class="line">dhcp-option=3,192.168.100.1</span><br></pre></td></tr></table></figure>

<p>ç„¶å <code>kill -HUP $(pidof dnsmasq)</code> æˆ– <code>systemctl reload dnsmasq</code>ã€‚</p>
</li>
<li><p>æ·»åŠ  NAT è§„åˆ™ï¼ˆå¸¦ commentï¼‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -C POSTROUTING -s 192.168.100.0/24 -o eth0 -j MASQUERADE \</span><br><span class="line">  || iptables -t nat -A POSTROUTING -s 192.168.100.0/24 -o eth0 -j MASQUERADE -m comment --comment &quot;ssid:guest_nat&quot;</span><br><span class="line">sysctl -w net.ipv4.ip_forward=1</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>B åœ¨æ‰€æœ‰ SSID æ‰§è¡ŒæˆåŠŸåå†™è¿è¡Œæ€ <code>/var/run/myap_running.json</code> å¹¶è¿”å› success ç»™ Aã€‚</p>
</li>
<li><p>A å°† <code>last_good_version=1</code> å¹¶å‘ Web æ¨é€ apply_doneã€‚</p>
</li>
</ol>
<p><strong>é”™è¯¯å¤„ç†</strong>ï¼šè‹¥åœ¨ä»»ä¸€æ­¥éª¤å¤±è´¥ï¼ŒB åº”è®°å½• <code>applied_steps</code> å¹¶ä¸ŠæŠ¥ errorï¼ŒA å¯è¯·æ±‚ B é€†åºæ¸…ç†æˆ–ç›´æ¥ä¸‹å‘ <code>last_good_version</code>ï¼ˆåˆå§‹æ—  last_good åˆ™è¿›å…¥æ•…éšœæç¤ºï¼‰ã€‚</p>
<hr>
<h3 id="2-4-2-æ–°å»º-SSIDï¼ˆå¢ï¼‰"><a href="#2-4-2-æ–°å»º-SSIDï¼ˆå¢ï¼‰" class="headerlink" title="2.4.2 æ–°å»º SSIDï¼ˆå¢ï¼‰"></a>2.4.2 æ–°å»º SSIDï¼ˆå¢ï¼‰</h3><p><strong>åœºæ™¯</strong>ï¼šå·²æœ‰ç³»ç»Ÿè¿è¡Œï¼Œç”¨æˆ·æ–°å¢ä¸€ä¸ª NAT SSIDã€‚</p>
<p><strong>æ­¥éª¤ï¼š</strong></p>
<ol>
<li>Web æäº¤æ–° SSID JSON â†’ A æ ¡éªŒï¼ˆåŒ…æ‹¬ IP æ± å†²çªæ£€æŸ¥ï¼‰ã€‚</li>
<li>A å†™æ–°ç‰ˆæœ¬ config_{V}.jsonï¼Œæ›´æ–° currentï¼Œsend apply requestï¼ˆdelta æ ‡è®° create:ssid_idï¼‰ã€‚</li>
<li>B è¯»å– diffï¼Œé’ˆå¯¹ createï¼š<ul>
<li>æ£€æŸ¥ <code>vif</code>ï¼ˆè‹¥ç”± B åˆ†é…åˆ™é€‰æ‹©æœªä½¿ç”¨çš„ <code>wlan0_&lt;n&gt;</code>ï¼‰ã€‚</li>
<li>åˆ›å»º VAPï¼ˆ<code>iw dev</code> æˆ– hostapd bssï¼‰å¹¶ <code>ip link set up</code>ã€‚</li>
<li>é…ç½®æ¥å£ IPï¼ˆ<code>ip addr add</code>ï¼‰ã€‚</li>
<li>å†™ dnsmasq per-ssid conf å¹¶ reloadã€‚</li>
<li>æ·»åŠ  NAT è§„åˆ™ï¼ˆå…ˆ check å† addï¼‰ã€‚</li>
</ul>
</li>
<li>éªŒè¯ï¼šPing gatewayã€æ£€æŸ¥ DHCP æ˜¯å¦åˆ†é…ï¼ˆå¯æ¨¡æ‹Ÿ clientï¼‰ç­‰ã€‚</li>
<li>B è¿”å› apply_resultï¼›è‹¥ successï¼ŒA æ›´æ–° last_good_version&#x3D;Vã€‚</li>
</ol>
<p><strong>å…³é”®å¹‚ç­‰ç‚¹</strong>ï¼šæ¯æ¡ iptables è§„åˆ™åŠ å…¥å‰åšå­˜åœ¨æ€§æ£€æŸ¥ï¼›æ¯æ¬¡å†™ conf ç”¨ä¸´æ—¶æ–‡ä»¶ renameã€‚</p>
<hr>
<h3 id="2-4-3-ä¿®æ”¹-SSIDï¼ˆæ”¹ï¼šé¢‘é“-å¯†ç -mode-ç­‰ï¼‰"><a href="#2-4-3-ä¿®æ”¹-SSIDï¼ˆæ”¹ï¼šé¢‘é“-å¯†ç -mode-ç­‰ï¼‰" class="headerlink" title="2.4.3 ä¿®æ”¹ SSIDï¼ˆæ”¹ï¼šé¢‘é“&#x2F;å¯†ç &#x2F;mode ç­‰ï¼‰"></a>2.4.3 ä¿®æ”¹ SSIDï¼ˆæ”¹ï¼šé¢‘é“&#x2F;å¯†ç &#x2F;mode ç­‰ï¼‰</h3><p><strong>åœºæ™¯</strong>ï¼šç”¨æˆ·ä¿®æ”¹ SSID çš„ channelã€password æˆ–ä» bridge åˆ‡æ¢åˆ° natã€‚</p>
<p><strong>æ­¥éª¤ï¼ˆé€šç”¨ï¼‰</strong>ï¼š</p>
<ol>
<li>A æ ¡éªŒå˜æ›´æ˜¯å¦åˆæ³•ï¼ˆå¦‚ä¿¡é“å˜æ›´éœ€æ£€æŸ¥æ˜¯å¦è¢«å…è®¸&#x2F;DFS çº¦æŸï¼‰ã€‚</li>
<li>A å†™ç‰ˆæœ¬å¹¶ä¸‹å‘ï¼ˆdelta: modify:[ssid_id]ï¼‰ã€‚</li>
<li>B è®¡ç®—ä¿®æ”¹çš„æœ€å°å˜æ›´é›†å¹¶æŒ‰é¡ºåºå¹³æ»‘åº”ç”¨ï¼š<ul>
<li><strong>ä¿®æ”¹ password&#x2F; ap_isolate</strong>ï¼šä¼˜å…ˆé€šè¿‡ <code>hostapd_cli</code> ä¿®æ”¹æˆ–é‡è½½ BSSï¼Œä¸é‡å¯æ•´ä¸ª hostapdï¼ˆè‹¥æ”¯æŒï¼‰ã€‚ç¤ºä¾‹ï¼š<code>hostapd_cli -i wlan0_1 set wpa_passphrase newpass</code>ï¼ˆè§† hostapd æ”¯æŒï¼‰ã€‚</li>
<li><strong>ä¿®æ”¹ channel&#x2F;band</strong>ï¼šé€šå¸¸éœ€è¦é‡è½½ hostapdï¼ŒB åº”å…ˆæé†’çŸ­ä¸­æ–­å¹¶åœ¨ä½æµé‡æ—¶é‡è½½ã€‚</li>
<li><strong>mode åˆ‡æ¢ï¼ˆbridgeâ†’nat æˆ– natâ†’bridgeï¼‰</strong>ï¼š<ul>
<li>åˆ‡æ¢åˆ° NATï¼šåˆ›å»ºå­ç½‘ IPã€å¯åŠ¨ dhcp confã€æ·»åŠ  NAT è§„åˆ™ã€è®¾ç½® ip_forwardã€‚</li>
<li>åˆ‡æ¢åˆ° bridgeï¼šå…ˆç§»é™¤ NAT è§„åˆ™ã€åœæ­¢ dhcp per-ssidã€æŠŠ vif åŠ å…¥ br0ï¼ˆ<code>ip link set wlan0_1 master br0</code>ï¼‰ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>éªŒè¯æ¯æ­¥åå†ç»§ç»­åç»­åŠ¨ä½œã€‚</li>
<li>æˆåŠŸåˆ™ A æ›´æ–° last_good_versionï¼›è‹¥å¤±è´¥æŒ‰å›æ»šç­–ç•¥æ¢å¤ã€‚</li>
</ol>
<p><strong>æ³¨æ„</strong>ï¼šå¯¹å¯èƒ½é€ æˆä¸­æ–­çš„æ“ä½œï¼ˆchannelã€hostapd é‡è½½ï¼‰åœ¨ Web ç«¯éœ€æ˜¾ç¤ºâ€œå¯èƒ½çŸ­ä¸­æ–­â€æç¤ºä»¥ä¾¿ç”¨æˆ·çŸ¥æƒ…ã€‚</p>
<hr>
<h3 id="2-4-4-åˆ é™¤-SSIDï¼ˆåˆ ï¼‰"><a href="#2-4-4-åˆ é™¤-SSIDï¼ˆåˆ ï¼‰" class="headerlink" title="2.4.4 åˆ é™¤ SSIDï¼ˆåˆ ï¼‰"></a>2.4.4 åˆ é™¤ SSIDï¼ˆåˆ ï¼‰</h3><p><strong>æ­¥éª¤</strong>ï¼š</p>
<ol>
<li><p>A æ¥æ”¶åˆ é™¤è¯·æ±‚å¹¶å†™æ–°ç‰ˆæœ¬ï¼ˆdelta: delete:[ssid]ï¼‰ã€‚</p>
</li>
<li><p>B æ‰§è¡Œåˆ é™¤ï¼š</p>
<ul>
<li><p>åœæ­¢å¹¶åˆ é™¤ dnsmasq per-ssid é…ç½®ï¼ˆåˆ é™¤ <code>/etc/dnsmasq.d/ssid_&lt;id&gt;.conf</code> å¹¶ reloadï¼‰ã€‚</p>
</li>
<li><p>åˆ é™¤ iptables å¯¹åº”è§„åˆ™ï¼ˆåŒ¹é… comment æˆ–æºç½‘æ®µï¼‰ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -D POSTROUTING -s 192.168.100.0/24 -o eth0 -j MASQUERADE -m comment --comment &quot;ssid:guest_nat&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä» br0 ç§»é™¤æ¥å£æˆ– <code>ip link set wlan0_1 down; iw dev wlan0_1 del</code>ã€‚</p>
</li>
<li><p>æ¸…ç† residual filesï¼ˆlease æ–‡ä»¶ã€æ—¥å¿—ã€è¿è¡Œæ€æ¡ç›®ï¼‰ã€‚</p>
</li>
</ul>
</li>
<li><p>éªŒè¯ï¼šç¡®ä¿æ— å¯¹åº”è§„åˆ™æˆ– conf æ–‡ä»¶æ®‹ç•™ã€‚</p>
</li>
<li><p>B è¿”å› apply_resultï¼ŒA æ›´æ–° last_good_versionã€‚</p>
</li>
</ol>
<hr>
<h3 id="2-4-5-æˆåŠŸ-å¤±è´¥å›æ»šç­–ç•¥"><a href="#2-4-5-æˆåŠŸ-å¤±è´¥å›æ»šç­–ç•¥" class="headerlink" title="2.4.5 æˆåŠŸ &#x2F; å¤±è´¥å›æ»šç­–ç•¥"></a>2.4.5 æˆåŠŸ &#x2F; å¤±è´¥å›æ»šç­–ç•¥</h3><p><strong>æ¨èç­–ç•¥ï¼ˆB å¤±è´¥æ—¶ï¼‰</strong>ï¼šä»¥ <strong>æ¢å¤ last_good_version</strong> ä¸ºä¸»ï¼ˆç”± A è§¦å‘ï¼‰ã€‚</p>
<p><strong>æµç¨‹</strong>ï¼š</p>
<ol>
<li>B åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­è‹¥é‡åˆ°ä¸å¯æ¢å¤é”™è¯¯ï¼Œè¿”å› partial_fail&#x2F; fail ç»™ A å¹¶é™„å¸¦ <code>applied_steps</code> ä¸ <code>errors</code>ã€‚</li>
<li>A æ£€æŸ¥ <code>last_good_version</code>ï¼š<ul>
<li>è‹¥å­˜åœ¨ï¼ŒA ç«‹å³ä¸‹å‘ <code>apply_config</code> è¯·æ±‚ï¼Œversion &#x3D; <code>last_good_version</code> ç»™ Bï¼Œè¦æ±‚ B é‡æ–° applyï¼ˆB åœ¨ apply æ—¶å…ˆæ¸…ç†å½“å‰è¿è¡Œæ€ä¸ç›®æ ‡ç‰ˆæœ¬ä¸ä¸€è‡´çš„ artifactsï¼Œå† apply last_goodï¼‰ã€‚</li>
<li>è‹¥ä¸å­˜åœ¨ï¼ˆé¦–æ¬¡é…ç½®æˆ– last_good ä¸å¯ç”¨ï¼‰ï¼ŒA å°†è¿›å…¥ <code>maintenance</code> çŠ¶æ€å¹¶é€šçŸ¥ç®¡ç†å‘˜ï¼ˆWebï¼‰ï¼Œå¹¶ä¿ç•™å¤±è´¥å¿«ç…§ä¾›äººå·¥æ¢å¤ã€‚</li>
</ul>
</li>
<li>B åœ¨æ¢å¤è¿‡ç¨‹ä¸­è®°å½•è¯¦ç»†æ—¥å¿—ï¼Œæœ€ç»ˆä¸ŠæŠ¥æ¢å¤æˆåŠŸæˆ–å¤±è´¥ã€‚</li>
</ol>
<p><strong>B çš„å±€éƒ¨å›æ»šï¼ˆé€†åºæ¸…ç†ï¼‰</strong>ï¼šä»…ä½œä¸ºè¡¥å……æ–¹æ¡ˆï¼ˆå½“æ¢å¤ last_good æ¯”è¾ƒé‡ä»£ä»·æ—¶ï¼‰ï¼ŒB éœ€èƒ½æŒ‰ <code>applied_steps</code> é€†åºæ¸…ç†ï¼›ä½†è¦ä¿è¯æ¯ä¸€æ­¥æ¸…ç†ä¹Ÿå¹‚ç­‰ä¸”å¯é‡å¤ã€‚</p>
<h1 id="ç³»ç»Ÿè®¾è®¡"><a href="#ç³»ç»Ÿè®¾è®¡" class="headerlink" title="ç³»ç»Ÿè®¾è®¡"></a>ç³»ç»Ÿè®¾è®¡</h1><h2 id="1-ç³»ç»Ÿæ€»ä½“æ¶æ„"><a href="#1-ç³»ç»Ÿæ€»ä½“æ¶æ„" class="headerlink" title="1. ç³»ç»Ÿæ€»ä½“æ¶æ„"></a>1. ç³»ç»Ÿæ€»ä½“æ¶æ„</h2><p>æœ¬ç³»ç»Ÿé‡‡ç”¨ <strong>åˆ†å±‚è§£è€¦è®¾è®¡</strong>ï¼Œåˆ†ä¸º <strong>Web å‰ç«¯ã€é…ç½®ç®¡ç†è¿›ç¨‹ï¼ˆA è¿›ç¨‹ï¼‰ã€é…ç½®æ‰§è¡Œè¿›ç¨‹ï¼ˆB è¿›ç¨‹ï¼‰ã€ç³»ç»ŸæœåŠ¡å±‚</strong> å››ä¸ªéƒ¨åˆ†ã€‚</p>
<ul>
<li><strong>Web å‰ç«¯</strong>ï¼šç”¨æˆ·é€šè¿‡æµè§ˆå™¨è®¿é—® Web ç•Œé¢ï¼Œé…ç½® SSID åç§°ã€é¢‘æ®µã€å¯†ç ã€æ¨¡å¼ï¼ˆæ¡¥æ¥&#x2F;NATï¼‰ã€å®¢æˆ·éš”ç¦»ã€DHCP åœ°å€æ± ç­‰å‚æ•°ã€‚</li>
<li><strong>A è¿›ç¨‹ï¼ˆé…ç½®ç®¡ç†ï¼‰</strong>ï¼šè´Ÿè´£æ¥æ”¶å‰ç«¯ä¼ æ¥çš„ JSON é…ç½®ï¼Œè¿›è¡Œåˆæ³•æ€§æ ¡éªŒï¼Œå†™å…¥ Flashï¼ˆé˜²æ­¢æ–­ç”µä¸¢å¤±ï¼‰ï¼Œå¹¶é€šè¿‡ socket ä¸‹å‘ç»™ B è¿›ç¨‹ã€‚</li>
<li><strong>B è¿›ç¨‹ï¼ˆé…ç½®æ‰§è¡Œï¼‰</strong>ï¼šæ ¹æ® A è¿›ç¨‹ä¸‹å‘çš„é…ç½®ï¼Œè°ƒç”¨ hostapdã€dnsmasqã€iptablesã€ip å·¥å…·ç­‰æ‰§è¡Œå®é™…æ“ä½œï¼ˆå¯åŠ¨&#x2F;åœæ­¢è™šæ‹Ÿ APã€é…ç½® DHCP æœåŠ¡ã€è®¾ç½® NAT è§„åˆ™ç­‰ï¼‰ã€‚</li>
<li><strong>ç³»ç»ŸæœåŠ¡å±‚</strong>ï¼šç”± hostapdã€dnsmasqã€iptables&#x2F;nftablesã€å†…æ ¸ sysctl å‚æ•°ç­‰ç»„æˆï¼ŒçœŸæ­£å®Œæˆæ•°æ®é¢çš„è¿è¡Œã€‚</li>
</ul>
<p>æ¶æ„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<pre class="mermaid">flowchart LR
  subgraph CP[Control Planeï¼ˆæ§åˆ¶é¢ï¼‰]
    web[Web UI]
    A[Process Aï¼ˆé…ç½®ç®¡ç†ï¼‰]
    B[Process Bï¼ˆé…ç½®æ‰§è¡Œï¼‰]
    web -->|JSONé…ç½®| A
    A -->|IPC: JSONæ¶ˆæ¯| B
  end

  subgraph ST[Storageï¼ˆæŒä¹…åŒ–ï¼‰]
    flash[(Flash config.json)]
  end

  subgraph SS[System Servicesï¼ˆæ‰§è¡Œå±‚ï¼‰]
    hostapd[hostapd]
    dnsmasq[dnsmasq]
    iptool[ip/bridge/iw]
    nft[iptables/nftables]
    sysctl[sysctl]
  end

  subgraph DP[Data Planeï¼ˆæ•°æ®é¢ï¼‰]
    wlan0[Normal-SSID]
    wlan01[Special-SSID]
    br0[[br0]]
    lan[LANç«¯å£]
    wan[WANå‡ºå£]
    wlan0 --> br0
    lan --> br0
    wlan01 --> wan
    br0 --> wan
  end

  A --> flash
  B --> hostapd
  B --> dnsmasq
  B --> iptool
  B --> nft
  B --> sysctl</pre>

<hr>
<h2 id="2-é…ç½®ä¸‹å‘ä¸æ‰§è¡Œæ—¶åº"><a href="#2-é…ç½®ä¸‹å‘ä¸æ‰§è¡Œæ—¶åº" class="headerlink" title="2. é…ç½®ä¸‹å‘ä¸æ‰§è¡Œæ—¶åº"></a>2. é…ç½®ä¸‹å‘ä¸æ‰§è¡Œæ—¶åº</h2><p>ç³»ç»Ÿé…ç½®æµç¨‹é‡‡ç”¨ <strong>é›†ä¸­æ ¡éªŒ + åˆ†å¸ƒæ‰§è¡Œ</strong> çš„æ¨¡å¼ï¼š</p>
<ul>
<li><strong>A è¿›ç¨‹</strong>ä¿è¯é…ç½®ä¸€è‡´æ€§ä¸æŒä¹…åŒ–ï¼›</li>
<li><strong>B è¿›ç¨‹</strong>ä¿è¯é…ç½®åœ¨ç³»ç»Ÿä¸­çš„å¹‚ç­‰æ‰§è¡Œï¼›</li>
<li><strong>å¤±è´¥å›æ»šæœºåˆ¶</strong>ç¡®ä¿ç³»ç»Ÿç¨³å®šè¿è¡Œã€‚</li>
</ul>
<p>è¯¦ç»†æ—¶åºå¦‚ä¸‹ï¼š</p>
<pre class="mermaid">sequenceDiagram
  autonumber
  participant W as Web UI
  participant A as Process A
  %%participant F as Flash
  participant B as Process B
  participant H as hostapd
  participant D as dnsmasq
  participant N as ip/iw/bridge
  participant T as iptables/nft

  W->>A: æäº¤ JSON é…ç½®
  A->>A: è§£æ+æ ¡éªŒ
  %%A->>F: å†™å…¥ Flash
  A->>A: å†™å…¥ Flash
  A-->>W: è¿”å›å·²æ¥æ”¶(version)

  A->>B: ä¸‹å‘ apply_config(version,é…ç½®)
  B->>B: è®¡ç®—å·®å¼‚(diff)

  alt æ–°å»º/ä¿®æ”¹ SSID
    B->>H: æ›´æ–° hostapd é…ç½®
    B->>N: åˆ›å»º VAP æ¥å£å¹¶é…ç½®åœ°å€
    B->>D: å¯åŠ¨/æ›´æ–° dnsmasq
    B->>T: æ·»åŠ  NAT è§„åˆ™
    B->>T: å¯ç”¨ sysctl è½¬å‘
  else åˆ é™¤ SSID
    B->>D: åœæ­¢ dnsmasq
    B->>T: ç§»é™¤ NAT è§„åˆ™
    B->>N: åˆ é™¤æ¥å£é…ç½®
    B->>H: ç§»é™¤ BSS
  end

  B-->>A: è¿”å›æ‰§è¡Œç»“æœ
  alt æˆåŠŸ
    %%A->>F: æ ‡è®° last_good_version
    A->>A: æ ‡è®° last_good_version
    A-->>W: é€šçŸ¥æˆåŠŸ
  else å¤±è´¥
    A-->>W: é€šçŸ¥å¤±è´¥
    A->>B: å›æ»šè‡³ last_good_version
  end</pre>

<hr>
<h2 id="3-é…ç½®å­—æ®µåˆ°æ‰§è¡ŒåŠ¨ä½œæ˜ å°„"><a href="#3-é…ç½®å­—æ®µåˆ°æ‰§è¡ŒåŠ¨ä½œæ˜ å°„" class="headerlink" title="3. é…ç½®å­—æ®µåˆ°æ‰§è¡ŒåŠ¨ä½œæ˜ å°„"></a>3. é…ç½®å­—æ®µåˆ°æ‰§è¡ŒåŠ¨ä½œæ˜ å°„</h2><p>æ¯ä¸ª JSON é…ç½®å­—æ®µéƒ½å¯¹åº”ç³»ç»Ÿæ‰§è¡ŒåŠ¨ä½œï¼Œæ˜ å°„å…³ç³»å¦‚ä¸‹ï¼š</p>
<pre class="mermaid">stateDiagram-v2
  direction LR
  [*] --> SSID_Config

  state "SSID_Config" as SSID_Config {
    [*] --> name
    [*] --> band
    [*] --> channel
    [*] --> password
    [*] --> mode
    [*] --> client_isolation
    [*] --> dhcp
  }

  name --> hostapd: è®¾ç½® SSID åç§°
  band --> hostapd: é€‰æ‹©é¢‘æ®µ
  channel --> hostapd: è®¾ç½®ä¿¡é“
  password --> hostapd: WPA2/WPA3 å¯†ç 
  mode --> bridge_nat: å†³å®šæ¡¥æ¥/NAT
  client_isolation --> hostapd: ap_isolate=1/0
  dhcp --> dnsmasq: DHCPåœ°å€æ± é…ç½®

  state "hostapd\næ— çº¿ç®¡ç†" as hostapd
  state "dnsmasq\nDHCP/DNS" as dnsmasq
  state "bridge/ipå·¥å…·" as bridge_nat
  state "iptables\nNAT" as iptables_nat
  state "sysctl\nè½¬å‘å‚æ•°" as sysctl

  bridge_nat --> iptables_nat: å¦‚æœ NAT æ¨¡å¼ï¼Œæ·»åŠ  SNAT
  bridge_nat --> sysctl: å¦‚æœ NAT æ¨¡å¼ï¼Œå¼€å¯è½¬å‘
  bridge_nat --> bridge_nat: å¦‚æœ bridge æ¨¡å¼ï¼ŒåŠ å…¥ br0</pre>

<hr>
<h2 id="4-é…ç½®å­—æ®µæ˜ å°„è¡¨"><a href="#4-é…ç½®å­—æ®µæ˜ å°„è¡¨" class="headerlink" title="4. é…ç½®å­—æ®µæ˜ å°„è¡¨"></a>4. é…ç½®å­—æ®µæ˜ å°„è¡¨</h2><table>
<thead>
<tr>
<th>JSON å­—æ®µ</th>
<th>ç¤ºä¾‹å€¼</th>
<th>æ ¡éªŒè§„åˆ™</th>
<th>æ‰§è¡ŒåŠ¨ä½œ</th>
</tr>
</thead>
<tbody><tr>
<td><code>id</code></td>
<td><code>&quot;ssid1&quot;</code></td>
<td>å”¯ä¸€æ ‡è¯†ï¼Œå¿…å¡«</td>
<td>å…³è” wlan0_1 æ¥å£</td>
</tr>
<tr>
<td><code>name</code></td>
<td><code>&quot;Special-SSID&quot;</code></td>
<td>é•¿åº¦ 1~32ï¼Œä¸é‡å¤</td>
<td>hostapd: è®¾ç½® SSID</td>
</tr>
<tr>
<td><code>band</code></td>
<td><code>&quot;2.4G&quot;</code> &#x2F; <code>&quot;5G&quot;</code></td>
<td>ä»…å…è®¸ä¸¤ç§å–å€¼</td>
<td>hostapd: è®¾ç½® <code>hw_mode</code></td>
</tr>
<tr>
<td><code>channel</code></td>
<td><code>6</code> &#x2F; <code>36</code></td>
<td>åˆæ³•ä¿¡é“ï¼Œç¬¦åˆå›½å®¶æ³•è§„</td>
<td>hostapd: <code>channel=&lt;num&gt;</code></td>
</tr>
<tr>
<td><code>password</code></td>
<td><code>&quot;mypassword123&quot;</code></td>
<td>â‰¥8 å­—ç¬¦ï¼ŒWPA2&#x2F;WPA3 è¦æ±‚</td>
<td>hostapd: <code>wpa_passphrase</code></td>
</tr>
<tr>
<td><code>mode</code></td>
<td><code>&quot;bridge&quot;</code> &#x2F; <code>&quot;nat&quot;</code></td>
<td>å¿…å¡«</td>
<td>- bridge: åŠ å…¥ br0 - nat: é…ç½® NAT&#x2F;DHCP</td>
</tr>
<tr>
<td><code>bridge_interface</code></td>
<td><code>&quot;br0&quot;</code></td>
<td>ä»… bridge æ¨¡å¼ä¸‹ä½¿ç”¨</td>
<td>ip&#x2F;bridge: <code>addif</code></td>
</tr>
<tr>
<td><code>client_isolation</code></td>
<td><code>true</code> &#x2F; <code>false</code></td>
<td>é»˜è®¤ false</td>
<td>hostapd: <code>ap_isolate=1/0</code></td>
</tr>
<tr>
<td><code>dhcp.enabled</code></td>
<td><code>true</code> &#x2F; <code>false</code></td>
<td>ä»… NAT æ¨¡å¼å¯ç”¨</td>
<td>dnsmasq: å¯åŠ¨&#x2F;åœæ­¢</td>
</tr>
<tr>
<td><code>dhcp.range_start</code></td>
<td><code>&quot;192.168.100.50&quot;</code></td>
<td>å¿…é¡»åœ¨å­ç½‘å†…</td>
<td>dnsmasq: åˆ†é…èŒƒå›´</td>
</tr>
<tr>
<td><code>dhcp.range_end</code></td>
<td><code>&quot;192.168.100.150&quot;</code></td>
<td>å¿…é¡»åœ¨å­ç½‘å†…</td>
<td>dnsmasq: åˆ†é…èŒƒå›´</td>
</tr>
<tr>
<td><code>dhcp.lease_time</code></td>
<td><code>&quot;12h&quot;</code></td>
<td><code>30m</code> &#x2F; <code>12h</code> &#x2F; <code>1d</code> ç­‰æ ¼å¼</td>
<td>dnsmasq: ç§Ÿçº¦é…ç½®</td>
</tr>
<tr>
<td><code>dhcp.gateway</code></td>
<td><code>&quot;192.168.100.1&quot;</code></td>
<td>å¿…é¡»æ˜¯æ¥å£ IP</td>
<td>ip addr: é…ç½®æ¥å£ï¼›dnsmasq: æä¾›ç½‘å…³é€‰é¡¹</td>
</tr>
<tr>
<td><code>dhcp.subnet_mask</code></td>
<td><code>&quot;255.255.255.0&quot;</code></td>
<td>ä¸åœ°å€æ± ä¸€è‡´</td>
<td>dnsmasq: æä¾›å­ç½‘æ©ç é€‰é¡¹</td>
</tr>
</tbody></table>
<hr>
<h2 id="5-è®¾è®¡è¦ç‚¹æ€»ç»“"><a href="#5-è®¾è®¡è¦ç‚¹æ€»ç»“" class="headerlink" title="5. è®¾è®¡è¦ç‚¹æ€»ç»“"></a>5. è®¾è®¡è¦ç‚¹æ€»ç»“</h2><ul>
<li><strong>è§£è€¦</strong>ï¼šA è¿›ç¨‹ä¸ B è¿›ç¨‹åˆ†ç¦»ï¼Œåˆ†åˆ«è´Ÿè´£é…ç½®ç®¡ç†å’Œæ‰§è¡Œï¼Œé™ä½è€¦åˆåº¦ã€‚</li>
<li><strong>å¹‚ç­‰æ€§</strong>ï¼šB è¿›ç¨‹çš„æ‰§è¡ŒåŠ¨ä½œå¿…é¡»å¹‚ç­‰ï¼Œä¿è¯é‡å¤ä¸‹å‘ä¸ä¼šé€ æˆè„æ•°æ®ã€‚</li>
<li><strong>å›æ»šæœºåˆ¶</strong>ï¼šåˆ©ç”¨ <code>last_good_version</code> æ”¯æŒå¤±è´¥è‡ªåŠ¨å›æ»šã€‚</li>
<li><strong>æ‰©å±•æ€§</strong>ï¼šJSON ç»“æ„å¯æ‰©å±•ï¼Œæœªæ¥å¯åŠ å…¥ QoSã€é€Ÿç‡é™åˆ¶ã€VLAN ç­‰é«˜çº§åŠŸèƒ½ã€‚</li>
</ul>
<h1 id="å¯è¡Œæ€§ä¸åˆ›æ–°ç‚¹"><a href="#å¯è¡Œæ€§ä¸åˆ›æ–°ç‚¹" class="headerlink" title="å¯è¡Œæ€§ä¸åˆ›æ–°ç‚¹"></a>å¯è¡Œæ€§ä¸åˆ›æ–°ç‚¹</h1><h2 id="1-æŠ€æœ¯å¯è¡Œæ€§"><a href="#1-æŠ€æœ¯å¯è¡Œæ€§" class="headerlink" title="1. æŠ€æœ¯å¯è¡Œæ€§"></a>1. æŠ€æœ¯å¯è¡Œæ€§</h2><ol>
<li><strong>æˆç†Ÿçš„ç»„ä»¶æ”¯æ’‘</strong><br> ç³»ç»Ÿåº•å±‚åŸºäºä¸šç•Œå¹¿æ³›åº”ç”¨çš„ <strong>hostapdã€dnsmasqã€iptables&#x2F;nftablesã€Linux bridge</strong> ç­‰å·¥å…·ã€‚è¿™äº›å·¥å…·é•¿æœŸåœ¨è·¯ç”±å™¨ã€åµŒå…¥å¼ Linuxã€OpenWrt ç­‰åœºæ™¯ä¸­éªŒè¯è¿‡ï¼Œç¨³å®šæ€§å’Œå…¼å®¹æ€§æœ‰ä¿éšœã€‚</li>
<li><strong>è½»é‡çº§æ¶æ„</strong><br> A è¿›ç¨‹å’Œ B è¿›ç¨‹å‡ä¸ºè½»é‡çº§å®ˆæŠ¤è¿›ç¨‹ï¼Œè¿è¡Œæ—¶èµ„æºå ç”¨å°ï¼Œä¸å½±å“æ— çº¿æ•°æ®é¢çš„è½¬å‘æ€§èƒ½ã€‚</li>
<li><strong>æ¥å£æ ‡å‡†åŒ–</strong><br> Web å‰ç«¯ä¸ A è¿›ç¨‹é‡‡ç”¨ JSON æ ¼å¼é€šä¿¡ï¼ŒA ä¸ B è¿›ç¨‹ä½¿ç”¨ socket æ¶ˆæ¯ä¼ é€’ï¼Œæ¥å£ç®€å•æ˜äº†ï¼Œä¾¿äºåç»­æ‰©å±•å’Œæµ‹è¯•ã€‚</li>
<li><strong>å¯ç§»æ¤æ€§å¼º</strong><br> æ¶æ„ä¸ç¡¬ä»¶å¹³å°æ— å…³ï¼Œä»…ä¾èµ– Linux å†…æ ¸åŠå¸¸è§å·¥å…·ï¼Œå› æ­¤å¯åº”ç”¨äº ARM æœåŠ¡å™¨ã€X86 ç½‘å…³ã€å®¶åº­è·¯ç”±å™¨ç­‰å¤šç§å¹³å°ã€‚</li>
</ol>
<hr>
<h2 id="2-åˆ›æ–°ç‚¹"><a href="#2-åˆ›æ–°ç‚¹" class="headerlink" title="2. åˆ›æ–°ç‚¹"></a>2. åˆ›æ–°ç‚¹</h2><ol>
<li><strong>æ§åˆ¶é¢ä¸æ‰§è¡Œé¢è§£è€¦</strong><ul>
<li>ä¼ ç»Ÿ AP æ–¹æ¡ˆä¸­ï¼Œé…ç½®ä¸‹å‘ä¸ç³»ç»ŸæœåŠ¡å¾€å¾€è€¦åˆåœ¨åŒä¸€ä¸ªè¿›ç¨‹æˆ–è„šæœ¬ä¸­ï¼Œéš¾ä»¥ç»´æŠ¤ã€‚</li>
<li>æœ¬ç³»ç»Ÿé‡‡ç”¨ <strong>Aï¼ˆé…ç½®ç®¡ç†ï¼‰+ Bï¼ˆé…ç½®æ‰§è¡Œï¼‰</strong> çš„åŒè¿›ç¨‹æ¨¡å¼ï¼š<ul>
<li>A è¿›ç¨‹ä¸“æ³¨äºé…ç½®æ ¡éªŒã€æŒä¹…åŒ–ä¸ç‰ˆæœ¬ç®¡ç†ï¼›</li>
<li>B è¿›ç¨‹ä¸“æ³¨äºç³»ç»Ÿè°ƒç”¨ä¸å®é™…æ‰§è¡Œã€‚</li>
</ul>
</li>
<li>è¿™ç§è§£è€¦æé«˜äº†ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</li>
</ul>
</li>
<li><strong>ç‰ˆæœ¬åŒ–é…ç½®ä¸å›æ»šæœºåˆ¶</strong><ul>
<li>å¼•å…¥ <code>last_good_version</code>ï¼Œç¡®ä¿é…ç½®å¤±è´¥æ—¶å¯è‡ªåŠ¨å›æ»šï¼Œé¿å…å› é”™è¯¯é…ç½®å¯¼è‡´ç½‘ç»œä¸­æ–­ã€‚</li>
<li>ç±»ä¼¼äºç°ä»£äº‘å¹³å°ä¸­çš„â€œé…ç½®å¿«ç…§â€æœºåˆ¶ï¼Œåœ¨åµŒå…¥å¼ AP é…ç½®ä¸­è¾ƒå°‘è§ã€‚</li>
</ul>
</li>
<li><strong>JSON æ¨¡å—åŒ–é…ç½®æ¨¡å‹</strong><ul>
<li>ä½¿ç”¨ç»Ÿä¸€çš„ JSON é…ç½®ï¼Œæ‰€æœ‰å­—æ®µä¸æ‰§è¡ŒåŠ¨ä½œä¸€ä¸€æ˜ å°„ã€‚</li>
<li>æ”¯æŒæœªæ¥æ‰©å±•ï¼ˆå¦‚ QoSã€VLANã€ACLã€é€Ÿç‡é™åˆ¶ï¼‰ï¼Œæ— éœ€å¤§è§„æ¨¡æ”¹åŠ¨æ¶æ„ã€‚</li>
</ul>
</li>
<li><strong>å¹‚ç­‰æ‰§è¡Œä¿éšœ</strong><ul>
<li>B è¿›ç¨‹çš„æ“ä½œè®¾è®¡ä¸º <strong>å¹‚ç­‰</strong>ï¼šé‡å¤æ‰§è¡Œä¸ä¼šé€ æˆå¼‚å¸¸å‰¯ä½œç”¨ã€‚</li>
<li>è§£å†³äº†ä¼ ç»Ÿè„šæœ¬åŒ–é…ç½®å®¹æ˜“å‡ºç°â€œè„è§„åˆ™â€ã€â€œæ®‹ç•™æ¥å£â€çš„é—®é¢˜ã€‚</li>
</ul>
</li>
<li><strong>é¢å‘ç”¨æˆ·ä½“éªŒçš„è®¾è®¡</strong><ul>
<li>ç”¨æˆ·åªéœ€é€šè¿‡ Web UI å®Œæˆé…ç½®ï¼Œå¤æ‚çš„æ ¡éªŒã€æŒä¹…åŒ–å’Œæ‰§è¡Œå‡åœ¨åå°å®Œæˆã€‚</li>
<li>æ”¯æŒ <strong>å¤š SSIDã€éš”ç¦»ã€æ¡¥æ¥&#x2F;NAT</strong> ç­‰é«˜çº§åŠŸèƒ½ï¼Œé¢å‘å®¶åº­è·¯ç”±ã€ä¼ä¸šç½‘å…³å‡é€‚ç”¨ã€‚</li>
</ul>
</li>
</ol>
<hr>
<h2 id="3-ä¸ä¼ ç»Ÿæ–¹æ¡ˆå¯¹æ¯”"><a href="#3-ä¸ä¼ ç»Ÿæ–¹æ¡ˆå¯¹æ¯”" class="headerlink" title="3. ä¸ä¼ ç»Ÿæ–¹æ¡ˆå¯¹æ¯”"></a>3. ä¸ä¼ ç»Ÿæ–¹æ¡ˆå¯¹æ¯”</h2><table>
<thead>
<tr>
<th>ç‰¹ç‚¹</th>
<th>ä¼ ç»Ÿ AP é…ç½®æ–¹å¼</th>
<th>æœ¬ç³»ç»Ÿæ–¹æ¡ˆ</th>
</tr>
</thead>
<tbody><tr>
<td><strong>æ¶æ„æ¨¡å¼</strong></td>
<td>å•è¿›ç¨‹&#x2F;è„šæœ¬ç›´æ¥è°ƒç”¨ç³»ç»Ÿå·¥å…·</td>
<td>æ§åˆ¶é¢ï¼ˆAï¼‰ä¸æ‰§è¡Œé¢ï¼ˆBï¼‰è§£è€¦</td>
</tr>
<tr>
<td><strong>é…ç½®å­˜å‚¨</strong></td>
<td>é…ç½®æ–‡ä»¶ï¼Œç¼ºä¹ç‰ˆæœ¬ç®¡ç†</td>
<td>JSON é…ç½®ï¼Œæ”¯æŒç‰ˆæœ¬æ§åˆ¶ä¸å›æ»š</td>
</tr>
<tr>
<td><strong>æ‰§è¡Œå¹‚ç­‰æ€§</strong></td>
<td>è„šæœ¬æ‰§è¡Œï¼Œå®¹æ˜“æ®‹ç•™é…ç½®</td>
<td>B è¿›ç¨‹ä¿è¯å¹‚ç­‰æ‰§è¡Œ</td>
</tr>
<tr>
<td><strong>æ‰©å±•æ€§</strong></td>
<td>æ–°åŠŸèƒ½éœ€è¦ä¿®æ”¹è„šæœ¬ï¼Œéš¾ç»´æŠ¤</td>
<td>JSON å­—æ®µå¯æ‰©å±•ï¼Œæ˜ å°„æ¸…æ™°</td>
</tr>
<tr>
<td><strong>ç”¨æˆ·ä½“éªŒ</strong></td>
<td>å¤šæ•°åŸºäºå‘½ä»¤è¡Œ&#x2F;ä¸ç›´è§‚ Web é…ç½®</td>
<td>å®Œå…¨ Web åŒ–ï¼Œé…ç½®å‚æ•°ç®€å•ç›´è§‚</td>
</tr>
<tr>
<td><strong>ç¨³å®šæ€§</strong></td>
<td>é…ç½®é”™è¯¯å¯èƒ½å¯¼è‡´ç³»ç»Ÿå¤±æ•ˆ</td>
<td>å¤±è´¥è‡ªåŠ¨å›æ»šï¼Œä¿éšœç³»ç»ŸæŒç»­å¯ç”¨</td>
</tr>
</tbody></table>
<hr>
<h2 id="4-åº”ç”¨å‰æ™¯"><a href="#4-åº”ç”¨å‰æ™¯" class="headerlink" title="4. åº”ç”¨å‰æ™¯"></a>4. åº”ç”¨å‰æ™¯</h2><ul>
<li><strong>å®¶åº­ç½‘å…³&#x2F;æ™ºèƒ½è·¯ç”±å™¨</strong>ï¼šé¢å‘æ™®é€šç”¨æˆ·ï¼Œæä¾›å¤š SSIDã€å®¶é•¿æ§åˆ¶ã€è®¿å®¢ç½‘ç»œç­‰åŠŸèƒ½ã€‚</li>
<li><strong>ä¼ä¸šçº§ AP ç®¡æ§</strong>ï¼šæ”¯æŒæ‰¹é‡é…ç½®ä¸è¿œç¨‹ç®¡ç†ï¼Œå‡å°‘ç»´æŠ¤æˆæœ¬ã€‚</li>
<li><strong>äº‘åŒ–&#x2F;è™šæ‹ŸåŒ–åœºæ™¯</strong>ï¼šä½œä¸º ARM æœåŠ¡å™¨æˆ– X86 ç½‘å…³ä¸­çš„è™šæ‹Ÿ AP ç®¡ç†æ¨¡å—ï¼Œé€‚é…å¤šç§Ÿæˆ·ç¯å¢ƒã€‚</li>
</ul>
<h1 id="4-ç ”ç©¶æ€è·¯å’Œæ–¹æ³•-1"><a href="#4-ç ”ç©¶æ€è·¯å’Œæ–¹æ³•-1" class="headerlink" title="4 ç ”ç©¶æ€è·¯å’Œæ–¹æ³•"></a>4 ç ”ç©¶æ€è·¯å’Œæ–¹æ³•</h1><p>æœ¬ç« é‡ç‚¹è¯´æ˜å®ç°æ–¹æ¡ˆçš„å·¥ç¨‹æ€è·¯ã€å…³é”®æ–¹æ³•ä¸è½åœ°ç»†èŠ‚ï¼Œçªå‡ºæ¶æ„è®¾è®¡ã€æ•°æ®ä¸åè®®ã€æ‰§è¡Œæ¨¡å‹ã€é”™è¯¯æ¢å¤ã€å®‰å…¨æ€§ã€æµ‹è¯•ä¸äº¤ä»˜ç­–ç•¥ï¼Œå±•ç¤ºå·¥ç¨‹èƒ½åŠ›ä¸å¯å®æ–½æ€§ã€‚å†…å®¹å°½é‡æŠ€æœ¯åŒ–ã€å¯æ‰§è¡Œï¼Œä¾¿äºåœ¨ä¸¤ä¸ªæœˆå†…äº§å‡ºå¯æ¼”ç¤ºåŸå‹ã€‚</p>
<hr>
<h2 id="4-1-æ€è·¯ä¸æ€»ä½“æ–¹æ³•è®ºï¼ˆæ€»ä½“åŸåˆ™ï¼‰"><a href="#4-1-æ€è·¯ä¸æ€»ä½“æ–¹æ³•è®ºï¼ˆæ€»ä½“åŸåˆ™ï¼‰" class="headerlink" title="4.1 æ€è·¯ä¸æ€»ä½“æ–¹æ³•è®ºï¼ˆæ€»ä½“åŸåˆ™ï¼‰"></a>4.1 æ€è·¯ä¸æ€»ä½“æ–¹æ³•è®ºï¼ˆæ€»ä½“åŸåˆ™ï¼‰</h2><ol>
<li><strong>åˆ†å±‚è§£è€¦ï¼ˆSeparation of concernsï¼‰</strong><ul>
<li>æ§åˆ¶é¢ï¼ˆA è¿›ç¨‹ï¼Œé…ç½®ç®¡ç†ï¼‰è´Ÿè´£ï¼šJSON æ ¡éªŒã€ç‰ˆæœ¬åŒ–ã€æŒä¹…åŒ–ã€ä¸ Web çš„ APIã€‚</li>
<li>æ‰§è¡Œé¢ï¼ˆB è¿›ç¨‹ï¼‰è´Ÿè´£ï¼šè¯»å–é…ç½®ã€è®¡ç®—å·®å¼‚ã€å¯¹ç³»ç»ŸæœåŠ¡å‘å‡ºå¹‚ç­‰åŒ–å‘½ä»¤ã€è®°å½•è¿è¡Œæ€ã€‚<br> è¿™æ ·èƒ½é™ä½å•ç‚¹å¤æ‚åº¦ã€ä¾¿äºå•å…ƒåŒ–å¼€å‘ä¸æµ‹è¯•ã€‚</li>
</ul>
</li>
<li><strong>å¹‚ç­‰ä¸å¯é‡åšï¼ˆIdempotence &#x2F; Reconciliationï¼‰</strong><ul>
<li>B å¯¹æ¯ä¸€æ­¥æ“ä½œå¿…é¡»å…ˆæ£€æŸ¥â€œæ˜¯å¦å·²å­˜åœ¨&#x2F;å·²ç”Ÿæ•ˆâ€ï¼Œç„¶åæ‰ã€Œåˆ›å»º&#x2F;ä¿®æ”¹&#x2F;åˆ é™¤ã€ã€‚</li>
<li>æ‰€æœ‰å¤–éƒ¨å‰¯ä½œç”¨ï¼ˆiptablesã€ip addrã€dnsmasq confã€hostapdï¼‰ä½¿ç”¨â€œæ£€æŸ¥â†’æ‰§è¡Œâ†’éªŒè¯â€ä¸‰æ®µå¼ã€‚</li>
</ul>
</li>
<li><strong>ç‰ˆæœ¬åŒ–ä¸åŸå­æŒä¹…åŒ–ï¼ˆAtomic persistence &amp; Versioningï¼‰</strong><ul>
<li>A å°†æ¯æ¬¡æäº¤å†™æˆ <code>config_&lt;version&gt;.json</code>ï¼Œä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ + fsync + rename ä¿è¯åŸå­æ€§ï¼Œå¹¶ç»´æŠ¤ <code>current</code> ä¸ <code>last_good</code> æŒ‡é’ˆã€‚</li>
<li>å›æ»šä»¥ <code>last_good</code> ä¸ºä¸»ï¼ˆæ›´ç¨³å¦¥ï¼‰â€”â€”å‡ºé”™åˆ™é‡æ–° apply last_goodã€‚</li>
</ul>
</li>
<li><strong>å·®å¼‚åŒ–ä¸‹å‘ï¼ˆDelta &#x2F; Diffï¼‰</strong><ul>
<li>B åœ¨ apply å‰è¯»å–å½“å‰è¿è¡Œæ€ï¼ˆrunning_stateï¼‰ï¼Œè®¡ç®— create&#x2F;modify&#x2F;delete ä¸‰ç±»å·®å¼‚ï¼Œåªå¯¹å·®å¼‚é¡¹æ“ä½œï¼Œå‡å°‘å¯¹æœåŠ¡çš„å½±å“ã€‚</li>
</ul>
</li>
<li><strong>é¡ºåºä¸äº‹åŠ¡è¯­ä¹‰ï¼ˆOrdered, transactional-ishï¼‰</strong><ul>
<li>å¯¹å•ä¸ª SSID çš„æ‰§è¡Œé¡ºåºå›ºå®šï¼šåˆ›å»º VAP â†’ é…ç½® IP â†’ å¯åŠ¨ DHCP â†’ é…ç½® NAT&#x2F;é˜²ç«å¢™ â†’ éªŒè¯ã€‚åˆ é™¤æŒ‰é€†åºã€‚</li>
<li>è‹¥ä¸­é—´å¤±è´¥ï¼Œè§¦å‘å›æ»šæˆ–æ¢å¤ last_goodã€‚</li>
</ul>
</li>
<li><strong>å¯è§‚æµ‹æ€§ï¼ˆObservabilityï¼‰</strong><ul>
<li>ç»“æ„åŒ–æ—¥å¿—ï¼ˆJSONLï¼‰ï¼Œæ¯æ­¥å†™å…¥ <code>timestamp/version/ssid/step/result/details</code>ï¼›A å¯å°†æ‰§è¡ŒçŠ¶æ€å®æ—¶ä¼ å› Webï¼ˆWebSocket&#x2F;SSEï¼‰ã€‚</li>
</ul>
</li>
<li><strong>å®‰å…¨ä¸æœ€å°æƒé™ï¼ˆSecurity &amp; Least privilegeï¼‰</strong><ul>
<li>IPCï¼ˆUnix domain socketï¼‰æƒé™é™åˆ¶ã€æ•æ„Ÿæ•°æ®ï¼ˆpasswordï¼‰ä»¥æœ€å°æƒé™æŒä¹…åŒ–æˆ–åŠ å¯†ï¼ˆå¯é€‰ï¼‰ã€‚</li>
<li>B è¿è¡Œæ—¶å°½å¯èƒ½ä»¥é root ç”¨æˆ·è·‘ï¼Œåªæœ‰åœ¨æ‰§è¡Œç³»ç»Ÿå‘½ä»¤æ—¶ä¸´æ—¶ææƒï¼ˆè‹¥å¹³å°æ”¯æŒï¼‰ã€‚</li>
</ul>
</li>
</ol>
<hr>
<h2 id="4-2ï¼ˆç•¥ï¼‰å‹å•†è°ƒç ”"><a href="#4-2ï¼ˆç•¥ï¼‰å‹å•†è°ƒç ”" class="headerlink" title="4.2ï¼ˆç•¥ï¼‰å‹å•†è°ƒç ”"></a>4.2ï¼ˆç•¥ï¼‰å‹å•†è°ƒç ”</h2><blockquote>
<p>æŒ‰æ‚¨å‰æ–‡æŒ‡ç¤ºï¼Œæœ¬èŠ‚å¯ç”±æ‚¨æŒ‰éœ€è¡¥å……ï¼›æ­¤å¤„ç•¥å»ï¼Œä»¥ä¾¿æŠŠç²¾åŠ›é›†ä¸­åœ¨å®ç°ç»†èŠ‚ä¸å·¥ç¨‹åŒ–æ–¹æ¡ˆä¸Šã€‚</p>
</blockquote>
<hr>
<h2 id="4-3-æ–¹æ¡ˆè®¾è®¡ä¸å·¥ç¨‹å®ç°ç»†èŠ‚ï¼ˆå¯è½åœ°çš„å·¥ç¨‹åŒ–æ–¹æ¡ˆï¼‰"><a href="#4-3-æ–¹æ¡ˆè®¾è®¡ä¸å·¥ç¨‹å®ç°ç»†èŠ‚ï¼ˆå¯è½åœ°çš„å·¥ç¨‹åŒ–æ–¹æ¡ˆï¼‰" class="headerlink" title="4.3 æ–¹æ¡ˆè®¾è®¡ä¸å·¥ç¨‹å®ç°ç»†èŠ‚ï¼ˆå¯è½åœ°çš„å·¥ç¨‹åŒ–æ–¹æ¡ˆï¼‰"></a>4.3 æ–¹æ¡ˆè®¾è®¡ä¸å·¥ç¨‹å®ç°ç»†èŠ‚ï¼ˆå¯è½åœ°çš„å·¥ç¨‹åŒ–æ–¹æ¡ˆï¼‰</h2><p>ä¸‹é¢æŒ‰è¦ç‚¹å±•å¼€ï¼šæ•°æ®æ¨¡å‹ã€IPC åè®®ã€B çš„æ‰§è¡Œæ¨¡å‹ã€äº‹åŠ¡ä¸å›æ»šã€å¹¶å‘ä¸é”ã€æ—¥å¿—ä¸ç›‘æ§ã€æµ‹è¯•ä¸äº¤ä»˜å»ºè®®ç­‰ã€‚</p>
<h3 id="4-3-1-æ•°æ®æ¨¡å‹ä¸æ ¡éªŒï¼ˆå·¥ç¨‹å®ç°è¦ç‚¹ï¼‰"><a href="#4-3-1-æ•°æ®æ¨¡å‹ä¸æ ¡éªŒï¼ˆå·¥ç¨‹å®ç°è¦ç‚¹ï¼‰" class="headerlink" title="4.3.1 æ•°æ®æ¨¡å‹ä¸æ ¡éªŒï¼ˆå·¥ç¨‹å®ç°è¦ç‚¹ï¼‰"></a>4.3.1 æ•°æ®æ¨¡å‹ä¸æ ¡éªŒï¼ˆå·¥ç¨‹å®ç°è¦ç‚¹ï¼‰</h3><ul>
<li><strong>JSON Schema</strong>ï¼ˆA ç”¨äºè‡ªåŠ¨æ ¡éªŒï¼‰<ul>
<li>å¿…è¦å­—æ®µï¼š<code>version</code>ã€<code>ssids[]</code>ï¼›SSIDs å†…å­—æ®µå¦‚ <code>id,name,band,channel,mode,client_isolation,dhcp&#123;enabled,gateway,range_start,range_end,lease_time&#125;</code>ã€‚</li>
<li>æ ¡éªŒä¸¾ä¾‹ï¼š<code>id</code> ç”¨æ­£åˆ™ <code>^[A-Za-z0-9_\-]&#123;1,32&#125;$</code>ï¼›<code>channel</code> æ ¹æ® <code>band</code> å†åšèŒƒå›´æ ¡éªŒï¼›<code>dhcp.range</code> åœ¨åŒä¸€å­ç½‘ä¸” <code>gateway</code> ä¸åœ¨æ± å†…ã€‚</li>
</ul>
</li>
<li><strong>è¯­ä¹‰æ ¡éªŒæ‰©å±•ï¼ˆA è¿›ç¨‹ï¼‰</strong><ul>
<li>å…¨å±€ IP æ± å†²çªæ£€æµ‹ï¼ˆéå†å·²æœ‰ ssids çš„ subnetï¼Œæ‹’ç»é‡å ï¼‰ï¼›</li>
<li>é©±åŠ¨&#x2F;å›½å®¶é™åˆ¶ï¼ˆchannel DFS æ£€æŸ¥ï¼Œå¯é€‰ï¼‰ï¼›</li>
<li>VIF æŒ‡å®šåˆæ³•æ€§ï¼ˆè‹¥ user æä¾› vif åç§°ï¼ŒA æ£€æŸ¥å‘½åç©ºé—´æ˜¯å¦ç©ºé—²ï¼‰ã€‚</li>
</ul>
</li>
<li><strong>æŒä¹…åŒ–æ ¼å¼</strong><ul>
<li><code>config_&lt;version&gt;.json</code> + <code>current</code> æŒ‡å‘ + <code>last_good</code> æŒ‡å‘ï¼›è¯»å†™é€šè¿‡ä¸´æ—¶æ–‡ä»¶åŸå­æ›¿æ¢ã€‚</li>
</ul>
</li>
</ul>
<hr>
<h3 id="4-3-2-IPC-åè®®ï¼ˆA-â‡„-Bï¼‰ï¼ˆå·¥ç¨‹ç»†èŠ‚ï¼‰"><a href="#4-3-2-IPC-åè®®ï¼ˆA-â‡„-Bï¼‰ï¼ˆå·¥ç¨‹ç»†èŠ‚ï¼‰" class="headerlink" title="4.3.2 IPC åè®®ï¼ˆA â‡„ Bï¼‰ï¼ˆå·¥ç¨‹ç»†èŠ‚ï¼‰"></a>4.3.2 IPC åè®®ï¼ˆA â‡„ Bï¼‰ï¼ˆå·¥ç¨‹ç»†èŠ‚ï¼‰</h3><ul>
<li><p><strong>é€šä¿¡æ–¹å¼</strong>ï¼šUnix Domain Socketï¼ˆ<code>/var/run/myap.sock</code>ï¼‰ï¼Œæƒé™ <code>0700</code>ã€‚</p>
</li>
<li><p><strong>æ¶ˆæ¯æ ¼å¼</strong>ï¼šJSONï¼ˆåŒ…å« <code>action</code>, <code>version</code>, <code>config_path</code>, <code>delta</code> ç­‰ï¼‰ã€‚</p>
</li>
<li><p><strong>Aâ†’B é‡è¦æ¶ˆæ¯</strong>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;action&quot;:&quot;apply_config&quot;,</span><br><span class="line">  &quot;version&quot;:42,</span><br><span class="line">  &quot;config_path&quot;:&quot;/etc/myap/config_42.json&quot;,</span><br><span class="line">  &quot;delta&quot;:&#123;&quot;create&quot;:[&quot;guest_nat&quot;],&quot;modify&quot;:[],&quot;delete&quot;:[]&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Bâ†’A å›æ‰§</strong>ï¼šæµå¼ä¸ŠæŠ¥ + æœ€ç»ˆå›æ‰§ï¼ˆ<code>apply_result</code> å­—æ®µåŒ…å« status, errors, applied_stepsï¼‰ã€‚</p>
</li>
<li><p><strong>è¶…æ—¶ä¸é‡è¯•</strong>ï¼šA åº”åœ¨å‘å‡º apply åå¼€å§‹è®¡æ—¶ï¼›è‹¥ B æ— å“åº”æˆ– socket æ–­å¼€ï¼ŒA é‡è¯• 1 æ¬¡åæ ‡è®°ä¸º <code>apply_failed</code> å¹¶æŠ¥è­¦ï¼ˆWeb é€šçŸ¥ï¼‰ã€‚</p>
</li>
<li><p><strong>åŒæ­¥&#x2F;å¼‚æ­¥</strong>ï¼šapply æ˜¯ â€œå¼‚æ­¥æ‰§è¡Œå¹¶å›æ‰§â€ æ¨¡å¼ï¼ˆA ç«‹åˆ»è¿”å› 202ï¼ŒB å®Œæˆåé€šè¿‡ WebSocket é€šçŸ¥ç”¨æˆ·ï¼‰ã€‚è¿™æ ·ç•Œé¢å“åº”å¿«ä¸”ä¸é˜»å¡ã€‚</p>
<ul>
<li>æ³¨æ„ï¼šåœ¨å†…éƒ¨å®ç°ä¸Šä»ä¿è¯å• apply çš„ä¸²è¡ŒåŒ–ï¼ˆä½¿ç”¨æ–‡ä»¶é”&#x2F;è¿›ç¨‹äº’æ–¥ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<hr>
<h3 id="4-3-3-B-è¿›ç¨‹æ‰§è¡Œæ¨¡å‹ï¼ˆæ ¸å¿ƒå·¥ç¨‹è®¾è®¡ï¼‰"><a href="#4-3-3-B-è¿›ç¨‹æ‰§è¡Œæ¨¡å‹ï¼ˆæ ¸å¿ƒå·¥ç¨‹è®¾è®¡ï¼‰" class="headerlink" title="4.3.3 B è¿›ç¨‹æ‰§è¡Œæ¨¡å‹ï¼ˆæ ¸å¿ƒå·¥ç¨‹è®¾è®¡ï¼‰"></a>4.3.3 B è¿›ç¨‹æ‰§è¡Œæ¨¡å‹ï¼ˆæ ¸å¿ƒå·¥ç¨‹è®¾è®¡ï¼‰</h3><ul>
<li><strong>è¿è¡Œæ€ï¼ˆrunning_stateï¼‰ç®¡ç†</strong><ul>
<li><code>/var/run/myap_running.json</code>ï¼šè®°å½•å½“å‰ç”Ÿæ•ˆé…ç½®ï¼ˆversionã€æ¯ ssid çŠ¶æ€ã€æ¥å£åã€nat rule ids ç­‰ï¼‰ã€‚B åœ¨æˆåŠŸ apply åæ›´æ–°æ­¤æ–‡ä»¶ã€‚</li>
</ul>
</li>
<li><strong>å·®å¼‚ï¼ˆdiffï¼‰ç®—æ³•</strong><ul>
<li>å¯¹æ¯” <code>running_state</code> ä¸ <code>target_config</code> å¾—åˆ° <code>create/modify/delete</code> åˆ—è¡¨ï¼›ä¿®æ”¹åº”ç»†åŒ–ä¸ºâ€œå“ªäº›å­—æ®µå˜äº†â€ï¼ˆä¾‹å¦‚ä»…å¯†ç &#x2F;ä»… channelï¼‰ã€‚</li>
</ul>
</li>
<li><strong>æ¯ SSID çš„æ‰§è¡Œæ­¥éª¤ï¼ˆæ¨¡æ¿ï¼‰</strong><ol>
<li><code>prepare</code>: æ£€æŸ¥ä¾èµ–ï¼ˆé©±åŠ¨ã€æ¥å£åç©ºé—²ï¼‰ã€‚</li>
<li><code>create_iface</code>: <code>iw dev</code> æˆ– hostapd bss addï¼›<code>ip link set up</code>ã€‚</li>
<li><code>set_ip</code>: <code>ip addr add &lt;gateway&gt;/&lt;mask&gt; dev vif</code>ã€‚</li>
<li><code>start_dhcp</code>: å†™ <code>/etc/dnsmasq.d/ssid_&lt;id&gt;.conf</code> â†’ reload dnsmasqï¼ˆSIGHUPï¼‰ã€‚</li>
<li><code>add_nat</code>: <code>iptables -t nat -C ... || iptables -t nat -A ... -m comment --comment &quot;ssid:&lt;id&gt;&quot;</code>ã€‚</li>
<li><code>verify</code>: æ£€æŸ¥ <code>ip addr show</code>ã€dnsmasq leasesã€iptables è§„åˆ™å­˜åœ¨æ€§ã€‚</li>
</ol>
</li>
<li><strong>å¹‚ç­‰å®ç°è¦ç‚¹</strong><ul>
<li>å¯¹æ¯ä¸ªæ­¥éª¤å‰åšå­˜åœ¨æ£€æŸ¥ï¼›å¯¹æ–‡ä»¶å†™å…¥åšä¸´æ—¶æ–‡ä»¶ + renameï¼›å¯¹ iptables ä½¿ç”¨ comment æ ‡è¯†ä»¥ä¾¿ç²¾ç¡®åˆ é™¤ã€‚</li>
</ul>
</li>
<li><strong>é”™è¯¯å¤„ç†ä¸è¡¥å¿</strong><ul>
<li>B è®°å½• <code>applied_steps</code>ï¼ˆé¡ºåº listï¼‰ã€‚è‹¥å¤±è´¥ï¼ŒB å¯é€‰æ‹©ï¼š<ul>
<li>å‘é€å¤±è´¥ç»™ Aï¼ˆç”± A è§¦å‘æ¢å¤ last_goodï¼‰ï¼›æˆ–</li>
<li>è‡ªè¡Œé€†åºå›æ»š applied_stepsï¼ˆè‹¥å®ç°äº†æ¯ä¸€æ­¥å¯¹åº”çš„é€†æ“ä½œä¸”å·²éªŒè¯å…¶å¹‚ç­‰æ€§ï¼‰ã€‚</li>
</ul>
</li>
<li>æ¨èç­–ç•¥ï¼šB æŠ¥å‘Šé”™è¯¯å¹¶ç­‰å¾… A ä¸‹å‘æ¢å¤ last_goodï¼ˆé›†ä¸­æŒæ§ï¼Œå‡å°‘å¤æ‚åº¦ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<hr>
<h3 id="4-3-4-äº‹åŠ¡è¯­ä¹‰ä¸å›æ»šç­–ç•¥ï¼ˆå·¥ç¨‹å»ºè®®ï¼‰"><a href="#4-3-4-äº‹åŠ¡è¯­ä¹‰ä¸å›æ»šç­–ç•¥ï¼ˆå·¥ç¨‹å»ºè®®ï¼‰" class="headerlink" title="4.3.4 äº‹åŠ¡è¯­ä¹‰ä¸å›æ»šç­–ç•¥ï¼ˆå·¥ç¨‹å»ºè®®ï¼‰"></a>4.3.4 äº‹åŠ¡è¯­ä¹‰ä¸å›æ»šç­–ç•¥ï¼ˆå·¥ç¨‹å»ºè®®ï¼‰</h3><ul>
<li><strong>ä¸»å›æ»šç­–ç•¥ï¼ˆæ¨èï¼‰</strong>ï¼šA ç»´æŠ¤ <code>last_good_version</code>ï¼Œå½“ B æŠ¥é”™ï¼ŒA è§¦å‘ <code>apply_config</code> å¯¹ <code>last_good_version</code> çš„é‡æ–°ä¸‹å‘ã€‚ä¼˜ç‚¹æ˜¯æ¢å¤è¡Œä¸ºç¡®å®šä¸”å¯é‡å¤éªŒè¯ã€‚</li>
<li><strong>å±€éƒ¨è¡¥å¿ç­–ç•¥ï¼ˆå¯é€‰ï¼‰</strong>ï¼šB åœ¨å¯æ§æƒ…å†µä¸‹é€†åºæ¸…ç† <code>applied_steps</code>ï¼Œæ­¤ç­–ç•¥ç”¨äºèŠ‚çœé‡åšæˆæœ¬ï¼Œä½†å¤æ‚ä¸”å¿…é¡»ä¿è¯é€†æ“ä½œä¹Ÿå¹‚ç­‰ã€‚</li>
<li><strong>äº‹åŠ¡è¾¹ç•Œ</strong>ï¼šå•æ¬¡ apply çš„è¾¹ç•Œä¸º <code>version</code>ï¼šè¦ä¹ˆ B æœ€ç»ˆä½¿ç³»ç»Ÿä¸ <code>config_&lt;version&gt;</code> å¯¹åº”ï¼ˆæˆåŠŸï¼‰ï¼Œè¦ä¹ˆ B ä¸åšæ°¸ä¹…æ€§å˜æ›´å¹¶è¿”å›å¤±è´¥ï¼ˆç”± A æ¢å¤ last_goodï¼‰ã€‚</li>
</ul>
<hr>
<h3 id="4-3-5-å¹¶å‘æ§åˆ¶ä¸é”ï¼ˆå…³é”®å®ç°ç‚¹ï¼‰"><a href="#4-3-5-å¹¶å‘æ§åˆ¶ä¸é”ï¼ˆå…³é”®å®ç°ç‚¹ï¼‰" class="headerlink" title="4.3.5 å¹¶å‘æ§åˆ¶ä¸é”ï¼ˆå…³é”®å®ç°ç‚¹ï¼‰"></a>4.3.5 å¹¶å‘æ§åˆ¶ä¸é”ï¼ˆå…³é”®å®ç°ç‚¹ï¼‰</h3><ul>
<li><strong>å…¨å±€ apply é”</strong>ï¼šåœ¨ A ä¸‹å‘å‰å°è¯•è·å¾—æ–‡ä»¶é”ï¼ˆ<code>/var/lock/myap_apply.lock</code>ï¼‰ï¼ŒB åœ¨æ‰§è¡Œå¼€å§‹æ—¶ä¹Ÿè·å–ç›¸åŒé”ã€‚ç¡®ä¿ä»»ä¸€æ—¶é—´åªæœ‰ä¸€ä¸ª apply åœ¨è¿è¡Œã€‚</li>
<li><strong>è¯»å†™åˆ†ç¦»</strong>ï¼šè¿è¡Œæ€æ–‡ä»¶è¯»å¯å¹¶å‘ï¼›å†™å…¥éœ€æŒé”ã€‚</li>
<li><strong>é˜²æ­¢ UI é‡å¤æäº¤</strong>ï¼šA å¯¹çŸ­æ—¶é—´å†…ç›¸åŒé…ç½®çš„é‡å¤æäº¤åšå»é‡ï¼ˆå¦‚æœç‰ˆæœ¬æœªå˜åˆ™è¿”å›å·²æœ‰ç»“æœï¼‰ã€‚</li>
</ul>
<hr>
<h3 id="4-3-6-æ—¥å¿—ã€ç›‘æ§ä¸å¯è§‚æµ‹æ€§ï¼ˆå·¥ç¨‹åŒ–äº¤ä»˜è¦ç‚¹ï¼‰"><a href="#4-3-6-æ—¥å¿—ã€ç›‘æ§ä¸å¯è§‚æµ‹æ€§ï¼ˆå·¥ç¨‹åŒ–äº¤ä»˜è¦ç‚¹ï¼‰" class="headerlink" title="4.3.6 æ—¥å¿—ã€ç›‘æ§ä¸å¯è§‚æµ‹æ€§ï¼ˆå·¥ç¨‹åŒ–äº¤ä»˜è¦ç‚¹ï¼‰"></a>4.3.6 æ—¥å¿—ã€ç›‘æ§ä¸å¯è§‚æµ‹æ€§ï¼ˆå·¥ç¨‹åŒ–äº¤ä»˜è¦ç‚¹ï¼‰</h3><ul>
<li><strong>ç»“æ„åŒ–æ—¥å¿—ï¼ˆJSON linesï¼‰</strong>ï¼šæ¯æ¡è®°å½•åŒ…å« <code>ts, version, ssid, step, result, message, elapsed_ms</code>ï¼Œä¾¿äº ELK&#x2F;Fluentd æ”¶é›†ä¸æŸ¥è¯¢ã€‚</li>
<li><strong>è¿è¡Œæ€ç›‘æ§æŒ‡æ ‡ï¼ˆPrometheus friendlyï¼‰</strong>ï¼ˆè‹¥å¹³å°å…è®¸ï¼‰ï¼š<ul>
<li><code>myap_apply_duration_seconds&#123;status=&quot;success|fail&quot;&#125;</code>,</li>
<li><code>myap_active_ssid_count</code>,</li>
<li><code>myap_dhcp_lease_count&#123;ssid=&quot;&lt;id&gt;&quot;&#125;</code></li>
</ul>
</li>
<li><strong>æŸ¥è¯¢æ¥å£</strong>ï¼šA æä¾› <code>GET /api/status</code> è¿”å› <code>current_version</code>, <code>last_good_version</code>, <code>pending_apply</code>, <code>per_ssid_status</code>ã€‚</li>
<li><strong>æŠ¥è­¦&#x2F;é€šçŸ¥</strong>ï¼šapply å¤±è´¥é€šè¿‡ WebSocket æ¨é€åˆ°å‰ç«¯ï¼Œå¹¶å†™å‘Šè­¦æ—¥å¿—ï¼Œå¿…è¦æ—¶é‚®ä»¶&#x2F;ä¼ä¸šå¾®ä¿¡æ¨é€ï¼ˆå¯é€‰ï¼‰ã€‚</li>
</ul>
<hr>
<h3 id="4-3-7-å®‰å…¨ä¸æ•æ„Ÿæ•°æ®å¤„ç†ï¼ˆå·¥ç¨‹å»ºè®®ï¼‰"><a href="#4-3-7-å®‰å…¨ä¸æ•æ„Ÿæ•°æ®å¤„ç†ï¼ˆå·¥ç¨‹å»ºè®®ï¼‰" class="headerlink" title="4.3.7 å®‰å…¨ä¸æ•æ„Ÿæ•°æ®å¤„ç†ï¼ˆå·¥ç¨‹å»ºè®®ï¼‰"></a>4.3.7 å®‰å…¨ä¸æ•æ„Ÿæ•°æ®å¤„ç†ï¼ˆå·¥ç¨‹å»ºè®®ï¼‰</h3><ul>
<li><strong>IPC æƒé™</strong>ï¼š<code>/var/run/myap.sock</code> æƒé™ <code>0700</code>ï¼Œä»… A&#x2F;B å±ä¸»å¯è®¿é—®ã€‚</li>
<li><strong>æŒä¹…åŒ–æ–‡ä»¶æƒé™</strong>ï¼š<code>/etc/myap/*.json</code>ã€<code>/etc/dnsmasq.d/ssid_*.conf</code> æƒé™ <code>0600</code>ï¼ˆä»… root æˆ–ç‰¹å®šç”¨æˆ·å¯è¯»å†™ï¼‰ã€‚</li>
<li><strong>å¯†ç å¤„ç†</strong>ï¼šä¸åœ¨æ—¥å¿—ä¸­å†™æ˜æ–‡å¯†ç ï¼›A å¯ä»¥åœ¨ç£ç›˜ä¸ŠåŠ å¯†ä¿å­˜æˆ–ä»…ä¿å­˜é…ç½®å…ƒæ•°æ®å¹¶åœ¨éœ€è¦æ—¶ç”±å®‰å…¨å­˜å‚¨æ¥å£å–å›ã€‚</li>
<li><strong>æœ€å°ææƒ</strong>ï¼šB ä½œä¸ºæ‰§è¡Œå™¨ä»…åœ¨éœ€è¦æ—¶è°ƒç”¨ç³»ç»Ÿå‘½ä»¤ï¼›è‹¥ç³»ç»Ÿæ”¯æŒï¼Œå¯é€šè¿‡ <code>sudo</code> ç²¾ç»†æˆæƒå•ä¸ªå‘½ä»¤ã€‚</li>
</ul>
<hr>
<h3 id="4-3-8-æµ‹è¯•ç­–ç•¥ï¼ˆä¿è¯å¯äº¤ä»˜æ€§ï¼‰"><a href="#4-3-8-æµ‹è¯•ç­–ç•¥ï¼ˆä¿è¯å¯äº¤ä»˜æ€§ï¼‰" class="headerlink" title="4.3.8 æµ‹è¯•ç­–ç•¥ï¼ˆä¿è¯å¯äº¤ä»˜æ€§ï¼‰"></a>4.3.8 æµ‹è¯•ç­–ç•¥ï¼ˆä¿è¯å¯äº¤ä»˜æ€§ï¼‰</h3><ul>
<li><strong>å•å…ƒæµ‹è¯•ï¼ˆAï¼‰</strong>ï¼šJSON Schema æ ¡éªŒã€è¯­ä¹‰æ ¡éªŒã€IP æ± å†²çªæ£€æµ‹ã€channel&#x2F; band æ ¡éªŒã€‚</li>
<li><strong>ç»„ä»¶é›†æˆæµ‹è¯•ï¼ˆBï¼‰</strong>ï¼šæ¨¡æ‹Ÿ hostapd&#x2F;dnsmasq ç¯å¢ƒï¼ˆæˆ–åœ¨è™šæ‹ŸåŒ–æµ‹è¯•æœºä¸Šï¼‰ï¼ŒéªŒè¯ create&#x2F;modify&#x2F;delete çš„æ‰€æœ‰æ­¥éª¤ä¸å¹‚ç­‰æ€§ã€‚</li>
<li><strong>æ•…éšœæ³¨å…¥æµ‹è¯•</strong>ï¼šäººä¸ºä½¿ dnsmasq ç«¯å£è¢«å ç”¨ã€iptables å†™å¤±è´¥ï¼ŒéªŒè¯ç³»ç»Ÿèƒ½æ­£ç¡®ä¸ŠæŠ¥å¹¶å›æ»šåˆ° last_goodã€‚</li>
<li><strong>å‹åŠ›ä¸ç¨³å®šæ€§æµ‹è¯•</strong>ï¼šé«˜é¢‘æ¬¡ applyï¼ˆä¾‹å¦‚æ¯ç§’ 1 æ¬¡æŒç»­ 5 åˆ†é’Ÿï¼‰å¹¶æ£€æŸ¥æ˜¯å¦æœ‰æ®‹ç•™è§„åˆ™æˆ–å†…å­˜æ³„éœ²ï¼›24â€“72 å°æ—¶ç¨³å®šè¿è¡Œã€‚</li>
<li><strong>éªŒæ”¶æµ‹è¯•æ¸…å•</strong>ï¼ˆç”¨äºäº¤ä»˜éªŒæ”¶ï¼‰ï¼š<ul>
<li>æ–°å¢ NAT SSIDï¼Œå®¢æˆ·ç«¯å¯æ‹¿åˆ° DHCP å¹¶ä¸Šç½‘ï¼›</li>
<li>ä¿®æ”¹ channel&#x2F;passwordï¼ŒæŒ‰é¢„æœŸç”Ÿæ•ˆï¼›</li>
<li>åˆ é™¤ SSID åæ— æ®‹ç•™è§„åˆ™ã€lease æ–‡ä»¶ï¼›</li>
<li>apply å¤±è´¥æ—¶ç³»ç»Ÿæ¢å¤åˆ° last_goodã€‚</li>
</ul>
</li>
</ul>
<hr>
<h3 id="4-3-9-å¼€å‘ä¸äº¤ä»˜æµç¨‹ï¼ˆå·¥ç¨‹å®è·µï¼‰"><a href="#4-3-9-å¼€å‘ä¸äº¤ä»˜æµç¨‹ï¼ˆå·¥ç¨‹å®è·µï¼‰" class="headerlink" title="4.3.9 å¼€å‘ä¸äº¤ä»˜æµç¨‹ï¼ˆå·¥ç¨‹å®è·µï¼‰"></a>4.3.9 å¼€å‘ä¸äº¤ä»˜æµç¨‹ï¼ˆå·¥ç¨‹å®è·µï¼‰</h3><ul>
<li><p><strong>ä»£ç ç»“æ„å»ºè®®</strong>ï¼ˆç¤ºä¾‹ï¼‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/cmd/</span><br><span class="line">  a-process/   # A è¿›ç¨‹å…¥å£</span><br><span class="line">  b-process/   # B è¿›ç¨‹å…¥å£</span><br><span class="line">/pkg/</span><br><span class="line">  config/      # schema, validation</span><br><span class="line">  ipc/         # socket client/server</span><br><span class="line">  executor/    # B çš„æ‰§è¡Œé€»è¾‘ï¼ˆå°è£…ç³»ç»Ÿè°ƒç”¨ï¼‰</span><br><span class="line">  hostapd/     # hostapd æ“ä½œå°è£…</span><br><span class="line">  dnsmasq/     # dnsmasq conf helper</span><br><span class="line">  iptables/    # rule helper</span><br><span class="line">  util/        # logging, fs atomic write</span><br><span class="line">/tests/</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>è¯­è¨€ä¸å·¥å…·å»ºè®®</strong>ï¼š</p>
<ul>
<li>Aï¼šGo &#x2F; Pythonï¼ˆä¼˜ç‚¹ï¼šå¿«é€Ÿå¼€å‘ã€JSON&#x2F;HTTP æ”¯æŒå¥½ï¼‰ï¼›</li>
<li>Bï¼šGo &#x2F; Rust &#x2F; Cï¼ˆä¼˜ç‚¹ï¼šGo æ˜“å¹¶å‘ã€è·¨å¹³å°ï¼›Rust&#x2F;C å¯¹èµ„æºå ç”¨æ§åˆ¶æ›´ç»†ï¼‰ã€‚</li>
<li>æµ‹è¯•ç¯å¢ƒï¼šä½¿ç”¨ QEMU æˆ–ç°æˆçš„ OpenWrt é•œåƒåš CI é›†æˆæµ‹è¯•ã€‚</li>
</ul>
</li>
<li><p><strong>CI&#x2F;CD</strong>ï¼šå•å…ƒæµ‹è¯• â†’ é•œåƒæ„å»ºï¼ˆäº¤å‰ç¼–è¯‘ï¼‰â†’ é›†æˆæµ‹è¯•ï¼ˆè™šæ‹Ÿæœºï¼‰â†’ æ‰“åŒ…ï¼ˆdeb&#x2F;ipkï¼‰â†’ å‘å¸ƒåˆ° test channelã€‚</p>
</li>
<li><p><strong>äº¤ä»˜ç‰©</strong>ï¼šå¯æ‰§è¡ŒäºŒè¿›åˆ¶ã€systemd service filesã€å®‰è£…è„šæœ¬ã€æµ‹è¯•æŠ¥å‘Šã€æ¼”ç¤ºè¯´æ˜æ–‡æ¡£ã€‚</p>
</li>
</ul>
<hr>
<h2 id="4-4-å…³é”®æµç¨‹-Mermaid-æ—¶åºå›¾ï¼ˆç”¨äºæŠ¥å‘Šæ’å›¾ï¼‰"><a href="#4-4-å…³é”®æµç¨‹-Mermaid-æ—¶åºå›¾ï¼ˆç”¨äºæŠ¥å‘Šæ’å›¾ï¼‰" class="headerlink" title="4.4 å…³é”®æµç¨‹ Mermaid æ—¶åºå›¾ï¼ˆç”¨äºæŠ¥å‘Šæ’å›¾ï¼‰"></a>4.4 å…³é”®æµç¨‹ Mermaid æ—¶åºå›¾ï¼ˆç”¨äºæŠ¥å‘Šæ’å›¾ï¼‰</h2><pre class="mermaid">sequenceDiagram
  autonumber
  participant Web as Web å‰ç«¯
  participant A as A è¿›ç¨‹ (é…ç½®ç®¡ç†)
  participant B as B è¿›ç¨‹ (é…ç½®æ‰§è¡Œ)
  participant H as hostapd
  participant D as dnsmasq
  participant N as ip/iptables

  Note over Web,A: ç”¨æˆ·æäº¤é…ç½®ï¼ˆJSONï¼‰
  Web->>A: POST /api/config {config}
  A->>A: Schema + è¯­ä¹‰æ ¡éªŒ
  alt æ ¡éªŒé€šè¿‡
    A->>A: å†™å…¥ /etc/myap/config_V.json åŸå­æ›¿æ¢
    A->>B: IPC apply_config {version:V, path:/etc/myap/config_V.json}
    B->>B: è¯»å– target config & running_state
    B->>B: compute diff (create/modify/delete)
    alt create or modify ssid
      B->>H: hostapd add bss / reconfigure
      B->>B: create vif (if needed)
      B->>N: ip addr add <gateway>/mask dev vif
      B->>D: write /etc/dnsmasq.d/ssid_X.conf & reload dnsmasq
      B->>N: iptables -C .. || iptables -A ... --comment "ssid:X"
      B->>B: verify (ip show, dnsmasq leases, iptables)
    end
    B-->>A: apply_result {status:success}
    A->>Web: push apply_done
  else æ ¡éªŒå¤±è´¥
    A-->>Web: 400 Bad Request (error details)
  end</pre>

<hr>
<h2 id="4-5-å°ç»“ï¼ˆå¯äº¤ä»˜çš„å·¥ç¨‹èƒ½åŠ›ç‚¹ï¼‰"><a href="#4-5-å°ç»“ï¼ˆå¯äº¤ä»˜çš„å·¥ç¨‹èƒ½åŠ›ç‚¹ï¼‰" class="headerlink" title="4.5 å°ç»“ï¼ˆå¯äº¤ä»˜çš„å·¥ç¨‹èƒ½åŠ›ç‚¹ï¼‰"></a>4.5 å°ç»“ï¼ˆå¯äº¤ä»˜çš„å·¥ç¨‹èƒ½åŠ›ç‚¹ï¼‰</h2><ul>
<li>æœ¬ç« å±•ç¤ºäº†ä»<strong>æ•°æ®æ¨¡å‹ã€åè®®ã€æ‰§è¡Œæ¨¡å‹ã€äº‹åŠ¡&#x2F;å›æ»šã€å¹‚ç­‰æ€§ä¸æµ‹è¯•</strong>åˆ°<strong>äº¤ä»˜æµç¨‹</strong>çš„ä¸€æ•´å¥—å·¥ç¨‹å®è·µæ–¹æ³•ã€‚</li>
<li>è¿™äº›ç»†èŠ‚æ—¢èƒ½ç”¨äºä¸¤ä¸ªæœˆå†…å®ç°å¯æ¼”ç¤ºçš„åŸå‹ï¼Œä¹Ÿç¡®ä¿ç³»ç»Ÿå…·å¤‡å¯ç»´æŠ¤æ€§ã€å¯æ‰©å±•æ€§ä¸å·¥ç¨‹è´¨é‡ï¼Œä¾¿äºå°†æ¥æ·»åŠ  QoSã€VLANã€è¿œç¨‹ç®¡ç†ç­‰é«˜çº§åŠŸèƒ½ã€‚</li>
</ul>
<h1 id="5-é‡ç‚¹ä¸éš¾ç‚¹"><a href="#5-é‡ç‚¹ä¸éš¾ç‚¹" class="headerlink" title="5. é‡ç‚¹ä¸éš¾ç‚¹"></a>5. é‡ç‚¹ä¸éš¾ç‚¹</h1><h3 id="5-1-é‡ç‚¹-1"><a href="#5-1-é‡ç‚¹-1" class="headerlink" title="5.1 é‡ç‚¹"></a>5.1 é‡ç‚¹</h3><p><strong>ï¼ˆ1ï¼‰JSON é…ç½®æ¨¡å‹ä¸ç³»ç»ŸæœåŠ¡çš„æ˜ å°„å…³ç³»</strong><br> æœ¬è¯¾é¢˜çš„æ ¸å¿ƒåœ¨äºï¼šå¦‚ä½•å°†ç”¨æˆ·é€šè¿‡ Web ç•Œé¢é…ç½®çš„ JSON æ•°æ®ï¼Œå¯é åœ°æ˜ å°„åˆ°ç³»ç»Ÿåº•å±‚æœåŠ¡ï¼ˆhostapdã€dnsmasqã€iptables ç­‰ï¼‰ã€‚</p>
<ul>
<li><strong>å­—æ®µæ ¡éªŒ</strong>ï¼šA è¿›ç¨‹è´Ÿè´£è¯­ä¹‰æ ¡éªŒï¼ˆSSID å”¯ä¸€ã€IP ä¸é‡å ã€å¯†ç é•¿åº¦åˆè§„ã€ä¿¡é“åˆæ³•æ€§ç­‰ï¼‰ï¼Œä¿è¯ä¸åˆè§„é…ç½®ä¸ä¼šä¸‹å‘ã€‚</li>
<li><strong>æ‰§è¡Œæ˜ å°„</strong>ï¼šB è¿›ç¨‹æ ¹æ® JSON é…ç½®æ‰§è¡Œå¯¹åº”æ“ä½œï¼Œä¾‹å¦‚ï¼š<ul>
<li><code>ssid</code> â†’ å†™å…¥ hostapd é…ç½®é¡¹</li>
<li><code>mode=nat</code> â†’ åˆ†é…å­ç½‘ã€æ·»åŠ  iptables NAT è§„åˆ™</li>
<li><code>dhcp.range</code> â†’ ç”Ÿæˆ dnsmasq é…ç½®æ–‡ä»¶å¹¶é‡è½½</li>
<li><code>client_isolation</code> â†’ hostapd <code>ap_isolate=1</code></li>
</ul>
</li>
<li><strong>å¹‚ç­‰æ€§</strong>ï¼šæ‰€æœ‰æ“ä½œéœ€æ”¯æŒé‡å¤ä¸‹å‘æ— å‰¯ä½œç”¨ï¼Œä¾‹å¦‚ iptables è§„åˆ™åŠ å‰å…ˆæ£€æŸ¥å­˜åœ¨æ€§ã€é…ç½®æ–‡ä»¶æ›´æ–°é‡‡ç”¨åŸå­æ›¿æ¢ã€‚</li>
</ul>
<p><strong>ï¼ˆ2ï¼‰æ¥å£ä¸æµç¨‹è®¾è®¡</strong></p>
<ul>
<li><strong>A è¿›ç¨‹</strong>ï¼šè´Ÿè´£é…ç½®è§£æã€æ ¡éªŒã€ç‰ˆæœ¬ç®¡ç†ä¸æŒä¹…åŒ–ã€‚</li>
<li><strong>B è¿›ç¨‹</strong>ï¼šè´Ÿè´£å…·ä½“å®æ–½ï¼ŒæŒ‰å·®å¼‚ï¼ˆdiffï¼‰å¯¹æ¥å£ã€DHCPã€NAT ç­‰è¿›è¡Œå¢åˆ æ”¹ã€‚</li>
<li><strong>äº¤äº’åè®®</strong>ï¼šA ä¸ B é€šè¿‡ socket ä¼ é€’ JSON æ¶ˆæ¯ï¼ŒåŒ…å«ç‰ˆæœ¬å·ã€å˜æ›´é¡¹ã€é…ç½®æ–‡ä»¶è·¯å¾„ç­‰ã€‚</li>
</ul>
<p><strong>ï¼ˆ3ï¼‰å›æ»šæœºåˆ¶</strong></p>
<ul>
<li>æ¨èæ–¹æ¡ˆï¼šA ä¿å­˜ <code>last_good_version</code>ï¼Œä¸€æ—¦ B æ‰§è¡Œå¤±è´¥ï¼Œåˆ™å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬é‡æ–°ä¸‹å‘ï¼Œä¿è¯ç³»ç»Ÿå¤„äºå¯ç”¨çŠ¶æ€ã€‚</li>
</ul>
<hr>
<h3 id="5-2-éš¾ç‚¹-1"><a href="#5-2-éš¾ç‚¹-1" class="headerlink" title="5.2 éš¾ç‚¹"></a>5.2 éš¾ç‚¹</h3><p><strong>ï¼ˆ1ï¼‰å¹‚ç­‰æ€§ä¸ä¸€è‡´æ€§</strong></p>
<ul>
<li><strong>éš¾ç‚¹</strong>ï¼šç›´æ¥è„šæœ¬åŒ–æ“ä½œå¯èƒ½å¯¼è‡´é‡å¤è§„åˆ™æˆ–æ®‹ç•™èµ„æºã€‚</li>
<li><strong>å¯¹ç­–</strong>ï¼š<ul>
<li>ä½¿ç”¨ iptables <code>--comment &quot;ssid:&lt;id&gt;&quot;</code> æ ‡è®°è§„åˆ™ï¼Œä¾¿äºåˆ é™¤ã€‚</li>
<li>dnsmasq&#x2F;hostapd ä½¿ç”¨ per-SSID é…ç½®æ–‡ä»¶ï¼Œé‡è½½æ—¶åªå½±å“å¯¹åº” SSIDã€‚</li>
<li>æ¥å£åˆ›å»ºå‰æ£€æŸ¥æ˜¯å¦å­˜åœ¨ï¼Œé¿å…é‡å¤åˆ›å»ºæˆ–è¯¯åˆ ã€‚</li>
</ul>
</li>
</ul>
<p><strong>ï¼ˆ2ï¼‰hostapd&#x2F;dnsmasq åŠ¨æ€æ›´æ–°</strong></p>
<ul>
<li><strong>éš¾ç‚¹</strong>ï¼šæœåŠ¡é‡å¯å¯èƒ½ä¸­æ–­æ‰€æœ‰ SSIDã€‚</li>
<li><strong>å¯¹ç­–</strong>ï¼šä¼˜å…ˆä½¿ç”¨ hostapd çš„ <code>bss</code> æ®µå’Œ <code>hostapd_cli reconfigure</code>ï¼Œdnsmasq é‡‡ç”¨ <code>--conf-dir</code> + <code>SIGHUP</code> å®ç°å¹³æ»‘é‡è½½ã€‚</li>
</ul>
<p><strong>ï¼ˆ3ï¼‰NAT ä¸ Bridge å¹¶å­˜çš„å¤æ‚æ€§</strong></p>
<ul>
<li><strong>éš¾ç‚¹</strong>ï¼šä¸åŒ SSID ä½¿ç”¨ NAT ä¸æ¡¥æ¥æ¨¡å¼å¹¶å­˜ï¼Œå®¹æ˜“äº§ç”Ÿè½¬å‘å†²çªã€‚</li>
<li><strong>å¯¹ç­–</strong>ï¼š<ul>
<li>åœ¨é…ç½®æ ¡éªŒé˜¶æ®µç¦æ­¢ IP åœ°å€æ± é‡å ã€‚</li>
<li>å°† NAT è§„åˆ™é›†ä¸­åœ¨å•ç‹¬é“¾ï¼ˆå¦‚ <code>MYAP-NAT</code>ï¼‰ï¼Œç”± B ä¸“é—¨ç®¡ç†ï¼Œä¿è¯æ¸…ç†å½»åº•ã€‚</li>
</ul>
</li>
</ul>
<p><strong>ï¼ˆ4ï¼‰å›æ»šä¸æ•…éšœæ¢å¤</strong></p>
<ul>
<li><strong>éš¾ç‚¹</strong>ï¼šéƒ¨åˆ†æ­¥éª¤å¤±è´¥åç³»ç»Ÿå¯èƒ½å¤„äºä¸ä¸€è‡´çŠ¶æ€ã€‚</li>
<li><strong>å¯¹ç­–</strong>ï¼š<ul>
<li>ä¼˜å…ˆæ¢å¤åˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬è€Œéé€æ­¥é€†åºå›æ»šï¼Œå‡å°‘å¤æ‚åº¦ã€‚</li>
<li>ä¿ç•™æ‰§è¡Œæ—¥å¿—å’Œå¿«ç…§ï¼Œä¾¿äºå¿«é€Ÿå®šä½ä¸äººå·¥ä»‹å…¥ã€‚</li>
</ul>
</li>
</ul>
<hr>
<h3 id="5-3-éªŒæ”¶ä¸æµ‹è¯•è¦ç‚¹ï¼ˆç®€è¿°ï¼‰"><a href="#5-3-éªŒæ”¶ä¸æµ‹è¯•è¦ç‚¹ï¼ˆç®€è¿°ï¼‰" class="headerlink" title="5.3 éªŒæ”¶ä¸æµ‹è¯•è¦ç‚¹ï¼ˆç®€è¿°ï¼‰"></a>5.3 éªŒæ”¶ä¸æµ‹è¯•è¦ç‚¹ï¼ˆç®€è¿°ï¼‰</h3><ul>
<li><strong>åŠŸèƒ½æ€§</strong>ï¼šæ–°å¢ã€ä¿®æ”¹ã€åˆ é™¤ SSID èƒ½æ­£ç¡®æ˜ å°„åˆ°ç³»ç»ŸæœåŠ¡ã€‚</li>
<li><strong>å¯é æ€§</strong>ï¼šé‡å¤ä¸‹å‘é…ç½®ä¸åº”äº§ç”Ÿå†—ä½™è§„åˆ™ï¼›å¤±è´¥åèƒ½å›æ»šã€‚</li>
<li><strong>ç¨³å®šæ€§</strong>ï¼šåœ¨é«˜é¢‘é…ç½®åˆ‡æ¢ä¸‹ï¼Œç³»ç»Ÿæ— æ®‹ç•™ã€æ— å†…å­˜æ³„æ¼ã€‚</li>
<li><strong>å®‰å…¨æ€§</strong>ï¼šæ•æ„Ÿé…ç½®ï¼ˆå¦‚å¯†ç ï¼‰ä¸å‡ºç°åœ¨æ—¥å¿—æˆ–æŒä¹…åŒ–æ–‡ä»¶ä¸­ã€‚</li>
</ul>
<h1 id="å®æ–½è®¡åˆ’"><a href="#å®æ–½è®¡åˆ’" class="headerlink" title="å®æ–½è®¡åˆ’"></a>å®æ–½è®¡åˆ’</h1><h2 id="æ€»ä½“ç›®æ ‡"><a href="#æ€»ä½“ç›®æ ‡" class="headerlink" title="æ€»ä½“ç›®æ ‡"></a>æ€»ä½“ç›®æ ‡</h2><p>åœ¨ 2 ä¸ªæœˆå†…ï¼Œå®Œæˆä¸€ä¸ªæ”¯æŒ <strong>å¤š SSIDã€æ¡¥æ¥&#x2F;NAT æ¨¡å¼åˆ‡æ¢ã€DHCP æœåŠ¡ã€å®¢æˆ·ç«¯éš”ç¦»</strong> çš„æ— çº¿ AP åŸå‹ç³»ç»Ÿï¼Œæ”¯æŒ Web UI é…ç½®ï¼Œå…·å¤‡åŸºæœ¬çš„ç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</p>
<hr>
<h2 id="é˜¶æ®µåˆ’åˆ†"><a href="#é˜¶æ®µåˆ’åˆ†" class="headerlink" title="é˜¶æ®µåˆ’åˆ†"></a>é˜¶æ®µåˆ’åˆ†</h2><h3 id="é˜¶æ®µä¸€ï¼šéœ€æ±‚åˆ†æä¸è®¾è®¡ï¼ˆ2025-09-02-â€“-2025-09-10ï¼‰"><a href="#é˜¶æ®µä¸€ï¼šéœ€æ±‚åˆ†æä¸è®¾è®¡ï¼ˆ2025-09-02-â€“-2025-09-10ï¼‰" class="headerlink" title="é˜¶æ®µä¸€ï¼šéœ€æ±‚åˆ†æä¸è®¾è®¡ï¼ˆ2025&#x2F;09&#x2F;02 â€“ 2025&#x2F;09&#x2F;10ï¼‰"></a>é˜¶æ®µä¸€ï¼šéœ€æ±‚åˆ†æä¸è®¾è®¡ï¼ˆ2025&#x2F;09&#x2F;02 â€“ 2025&#x2F;09&#x2F;10ï¼‰</h3><ul>
<li>æ˜ç¡®ç”¨æˆ·é…ç½®éœ€æ±‚ï¼ˆSSIDã€é¢‘æ®µã€å¯†ç ã€æ¨¡å¼ã€DHCPã€éš”ç¦»ç­‰ï¼‰ã€‚</li>
<li>ç¡®è®¤é‡‡ç”¨çš„ç³»ç»Ÿç»„ä»¶ï¼š<code>hostapd</code>ã€<code>dnsmasq</code>ã€<code>iptables/nftables</code>ã€<code>iproute2</code>ã€‚</li>
<li>å®šä¹‰ JSON é…ç½®æ¨¡å‹ï¼ˆå­—æ®µã€æ ¡éªŒè§„åˆ™ã€ä¸ç³»ç»ŸæœåŠ¡çš„æ˜ å°„å…³ç³»ï¼‰ã€‚</li>
<li>ç»˜åˆ¶æ¶æ„å›¾ã€æ—¶åºå›¾ã€é…ç½®æ˜ å°„è¡¨ï¼Œå½¢æˆå®Œæ•´è®¾è®¡æ–‡æ¡£ã€‚</li>
</ul>
<p><strong>è¾“å‡ºæˆæœ</strong>ï¼š</p>
<ul>
<li>ã€Šç³»ç»Ÿè®¾è®¡æ–‡æ¡£ã€‹</li>
<li>JSON é…ç½® schema</li>
<li>æ¶æ„&#x2F;äº¤äº’å›¾</li>
</ul>
<hr>
<h3 id="é˜¶æ®µäºŒï¼šA-è¿›ç¨‹å¼€å‘ï¼ˆé…ç½®ç®¡ç†ï¼‰ï¼ˆ2025-09-11-â€“-2025-09-20ï¼‰"><a href="#é˜¶æ®µäºŒï¼šA-è¿›ç¨‹å¼€å‘ï¼ˆé…ç½®ç®¡ç†ï¼‰ï¼ˆ2025-09-11-â€“-2025-09-20ï¼‰" class="headerlink" title="é˜¶æ®µäºŒï¼šA è¿›ç¨‹å¼€å‘ï¼ˆé…ç½®ç®¡ç†ï¼‰ï¼ˆ2025&#x2F;09&#x2F;11 â€“ 2025&#x2F;09&#x2F;20ï¼‰"></a>é˜¶æ®µäºŒï¼šA è¿›ç¨‹å¼€å‘ï¼ˆé…ç½®ç®¡ç†ï¼‰ï¼ˆ2025&#x2F;09&#x2F;11 â€“ 2025&#x2F;09&#x2F;20ï¼‰</h3><ul>
<li>è§£æ Web å‰ç«¯ä¼ é€’çš„ JSON é…ç½®ã€‚</li>
<li>æ ¡éªŒå‚æ•°åˆæ³•æ€§ï¼ˆSSID åç§°ã€ä¿¡é“èŒƒå›´ã€IP åœ°å€åˆæ³•æ€§ç­‰ï¼‰ã€‚</li>
<li>å°†é…ç½®å­˜å‚¨åˆ° Flashï¼ˆJSON æ–‡ä»¶ï¼Œå¸¦ç‰ˆæœ¬å·ï¼‰ã€‚</li>
<li>ä¸ Web äº¤äº’ï¼šæä¾›é…ç½®ä¿å­˜&#x2F;è¯»å– APIã€‚</li>
<li>ä¸ B è¿›ç¨‹é€šä¿¡ï¼šå®šä¹‰ socket åè®®ï¼Œæ”¯æŒâ€œä¸‹å‘é…ç½®â€â€œå›æ»šâ€â€œæŸ¥è¯¢çŠ¶æ€â€ã€‚</li>
</ul>
<p><strong>è¾“å‡ºæˆæœ</strong>ï¼š</p>
<ul>
<li>A è¿›ç¨‹å¯è¿è¡Œ Demo</li>
<li>ä¸ Web çš„ JSON é€šä¿¡æµ‹è¯•é€šè¿‡</li>
<li>ä¸ B è¿›ç¨‹çš„ socket åè®®å®šä¹‰å®Œæˆ</li>
</ul>
<hr>
<h3 id="é˜¶æ®µä¸‰ï¼šB-è¿›ç¨‹å¼€å‘ï¼ˆé…ç½®æ‰§è¡Œï¼‰ï¼ˆ2025-09-21-â€“-2025-10-05ï¼‰"><a href="#é˜¶æ®µä¸‰ï¼šB-è¿›ç¨‹å¼€å‘ï¼ˆé…ç½®æ‰§è¡Œï¼‰ï¼ˆ2025-09-21-â€“-2025-10-05ï¼‰" class="headerlink" title="é˜¶æ®µä¸‰ï¼šB è¿›ç¨‹å¼€å‘ï¼ˆé…ç½®æ‰§è¡Œï¼‰ï¼ˆ2025&#x2F;09&#x2F;21 â€“ 2025&#x2F;10&#x2F;05ï¼‰"></a>é˜¶æ®µä¸‰ï¼šB è¿›ç¨‹å¼€å‘ï¼ˆé…ç½®æ‰§è¡Œï¼‰ï¼ˆ2025&#x2F;09&#x2F;21 â€“ 2025&#x2F;10&#x2F;05ï¼‰</h3><ul>
<li>æ¥æ”¶ A è¿›ç¨‹ä¸‹å‘çš„é…ç½®æŒ‡ä»¤ã€‚</li>
<li>ç®¡ç† hostapdï¼ˆå¯åŠ¨&#x2F;åœæ­¢è™šæ‹Ÿ APï¼‰ã€‚</li>
<li>ç®¡ç† dnsmasqï¼ˆæ ¹æ®æ¨¡å¼å†³å®šæ˜¯å¦å¯ç”¨ DHCPï¼‰ã€‚</li>
<li>é…ç½®æ¡¥æ¥æ¥å£ï¼ˆbridge æ¨¡å¼ï¼‰ã€‚</li>
<li>é…ç½® iptables&#x2F;nftablesï¼ˆNAT æ¨¡å¼ï¼‰ã€‚</li>
<li>å®ç°å¹‚ç­‰æ€§ï¼šé‡å¤ä¸‹å‘ä¸ä¼šå¯¼è‡´ç³»ç»Ÿæ··ä¹±ã€‚</li>
<li>å›æ»šæœºåˆ¶ï¼šé…ç½®å¤±è´¥æ—¶æ¢å¤åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ã€‚</li>
</ul>
<p><strong>è¾“å‡ºæˆæœ</strong>ï¼š</p>
<ul>
<li>B è¿›ç¨‹å¯å•ç‹¬è¿è¡Œï¼Œèƒ½æ­£ç¡®é…ç½®ç³»ç»ŸæœåŠ¡</li>
<li>æ”¯æŒæ¡¥æ¥å’Œ NAT æ¨¡å¼åˆ‡æ¢</li>
<li>DHCP åœ°å€æ± ç”Ÿæ•ˆæµ‹è¯•é€šè¿‡</li>
</ul>
<hr>
<h3 id="é˜¶æ®µå››ï¼šé›†æˆä¸æµ‹è¯•ï¼ˆ2025-10-06-â€“-2025-10-20ï¼‰"><a href="#é˜¶æ®µå››ï¼šé›†æˆä¸æµ‹è¯•ï¼ˆ2025-10-06-â€“-2025-10-20ï¼‰" class="headerlink" title="é˜¶æ®µå››ï¼šé›†æˆä¸æµ‹è¯•ï¼ˆ2025&#x2F;10&#x2F;06 â€“ 2025&#x2F;10&#x2F;20ï¼‰"></a>é˜¶æ®µå››ï¼šé›†æˆä¸æµ‹è¯•ï¼ˆ2025&#x2F;10&#x2F;06 â€“ 2025&#x2F;10&#x2F;20ï¼‰</h3><ul>
<li>Web â†’ A â†’ B â†’ ç³»ç»ŸæœåŠ¡å…¨é“¾è·¯æ‰“é€šã€‚</li>
<li>æµ‹è¯•å¤š SSID å¹¶å‘ï¼ˆä¸€ä¸ªæ¡¥æ¥ï¼Œä¸€ä¸ª NATï¼‰ã€‚</li>
<li>æµ‹è¯•å®¢æˆ·ç«¯éš”ç¦»ï¼ˆap_isolateï¼‰ã€‚</li>
<li>æµ‹è¯•é…ç½®é”™è¯¯åœºæ™¯ï¼ˆåº”è‡ªåŠ¨å›æ»šï¼‰ã€‚</li>
<li>é•¿æ—¶é—´è¿è¡Œç¨³å®šæ€§æµ‹è¯•ï¼ˆâ‰¥24hï¼‰ã€‚</li>
</ul>
<p><strong>è¾“å‡ºæˆæœ</strong>ï¼š</p>
<ul>
<li>é›†æˆç³»ç»Ÿ Demo å¯è¿è¡Œ</li>
<li>åŸºæœ¬åŠŸèƒ½æµ‹è¯•æŠ¥å‘Š</li>
</ul>
<hr>
<h3 id="é˜¶æ®µäº”ï¼šä¼˜åŒ–ä¸äº¤ä»˜ï¼ˆ2025-10-21-â€“-2025-11-02ï¼‰"><a href="#é˜¶æ®µäº”ï¼šä¼˜åŒ–ä¸äº¤ä»˜ï¼ˆ2025-10-21-â€“-2025-11-02ï¼‰" class="headerlink" title="é˜¶æ®µäº”ï¼šä¼˜åŒ–ä¸äº¤ä»˜ï¼ˆ2025&#x2F;10&#x2F;21 â€“ 2025&#x2F;11&#x2F;02ï¼‰"></a>é˜¶æ®µäº”ï¼šä¼˜åŒ–ä¸äº¤ä»˜ï¼ˆ2025&#x2F;10&#x2F;21 â€“ 2025&#x2F;11&#x2F;02ï¼‰</h3><ul>
<li>ä»£ç ä¼˜åŒ–ã€æ—¥å¿—å®Œå–„ã€‚</li>
<li>å¢åŠ ç›‘æ§æ¥å£ï¼ˆæŸ¥è¯¢å½“å‰ SSIDã€DHCP ç§Ÿçº¦ã€iptables çŠ¶æ€ï¼‰ã€‚</li>
<li>æ’°å†™æœ€ç»ˆæŠ¥å‘Šå’Œæ¼”ç¤ºæ–‡æ¡£ã€‚</li>
<li>å‡†å¤‡ç­”è¾© Demoã€‚</li>
</ul>
<p><strong>è¾“å‡ºæˆæœ</strong>ï¼š</p>
<ul>
<li>ã€Šæœ€ç»ˆæŠ€æœ¯æŠ¥å‘Šã€‹</li>
<li>å¯æ¼”ç¤ºçš„ AP ç³»ç»Ÿï¼ˆæ”¯æŒ Web é…ç½®ï¼‰</li>
</ul>
<hr>
<h2 id="æ—¶é—´è¡¨ï¼ˆç”˜ç‰¹å›¾ç¤ºä¾‹ï¼‰"><a href="#æ—¶é—´è¡¨ï¼ˆç”˜ç‰¹å›¾ç¤ºä¾‹ï¼‰" class="headerlink" title="æ—¶é—´è¡¨ï¼ˆç”˜ç‰¹å›¾ç¤ºä¾‹ï¼‰"></a>æ—¶é—´è¡¨ï¼ˆç”˜ç‰¹å›¾ç¤ºä¾‹ï¼‰</h2><pre class="mermaid">gantt
    title é¡¹ç›®å®æ–½è®¡åˆ’ (2025/09/02 - 2025/11/02)
    dateFormat  YYYY-MM-DD
    axisFormat  %m/%d

    section é˜¶æ®µä¸€: éœ€æ±‚åˆ†æä¸è®¾è®¡
    éœ€æ±‚åˆ†æä¸è®¾è®¡          :done,   des1, 2025-09-02, 2025-09-10

    section é˜¶æ®µäºŒ: Aè¿›ç¨‹å¼€å‘
    Aè¿›ç¨‹å¼€å‘(é…ç½®ç®¡ç†)      :active, des2, 2025-09-11, 2025-09-20

    section é˜¶æ®µä¸‰: Bè¿›ç¨‹å¼€å‘
    Bè¿›ç¨‹å¼€å‘(é…ç½®æ‰§è¡Œ)      :des3, 2025-09-21, 2025-10-05

    section é˜¶æ®µå››: é›†æˆä¸æµ‹è¯•
    ç³»ç»Ÿé›†æˆä¸åŠŸèƒ½æµ‹è¯•       :des4, 2025-10-06, 2025-10-20

    section é˜¶æ®µäº”: ä¼˜åŒ–ä¸äº¤ä»˜
    ä¼˜åŒ–ä¸æ–‡æ¡£äº¤ä»˜           :des5, 2025-10-21, 2025-11-02</pre>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2025/09/08/module/">å±•å¼€å…¨æ–‡ >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-SSID-NAT-mode" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2025/09/06/SSID-NAT-mode/">SSID-NAT-mode</a>
    </h1>
  

        
        <a href="/2025/09/06/SSID-NAT-mode/" class="archive-article-date">
  	<time datetime="2025-09-05T17:29:28.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2025-09-06</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="NAT-Mode-with-Meraki-DHCP"><a href="#NAT-Mode-with-Meraki-DHCP" class="headerlink" title="NAT Mode with Meraki DHCP"></a><a target="_blank" rel="noopener" href="https://documentation.meraki.com/MR/Client_Addressing_and_Bridging/NAT_Mode_with_Meraki_DHCP">NAT Mode with Meraki DHCP</a></h1><p><a target="_blank" rel="noopener" href="https://documentation.meraki.com/MR/Client_Addressing_and_Bridging/SSID_Modes_for_Client_IP_Assignment">NAT mode with Meraki DHCP</a> allows an MR access point to provide client addressing by running its own DHCP server to simplify management, allow guest access, and provide client isolation functionality. </p>
<h2 id="Client-Addressing-in-NAT-mode-with-Meraki-DHCP"><a href="#Client-Addressing-in-NAT-mode-with-Meraki-DHCP" class="headerlink" title="Client Addressing in NAT mode with Meraki DHCP"></a>Client Addressing in NAT mode with Meraki DHCP</h2><p>The DHCP server run by the Cisco Meraki AP provides addresses in the 10.0.0.0&#x2F;8 subnet (10.x.x.x). Outbound connections will be initiated with the LAN IP address of the AP using Network Address Translation. Wireless clients that connect to the network will be given the following configuration via Meraki DHCP:</p>
<ul>
<li>An IP address in the 10.0.0.0&#x2F;8 range. The IP address is created by running the clientâ€™s MAC address through a hashing algorithm.</li>
<li>A gateway address of 10.128.128.128</li>
<li><a target="_blank" rel="noopener" href="https://documentation.meraki.com/MR/Client_Addressing_and_Bridging/NAT_Mode_with_Meraki_DHCP#DNS_and_NAT_Mode">A DNS address of 10.128.128.128</a></li>
<li>A Lease Time of 24 hours</li>
</ul>
<p>A wireless network using NAT Mode with Meraki DHCP can be seen below. When clients on the wireless network access resources upstream of the AP, their IP addresses will be translated to the IP address of the AP (192.168.1.1):</p>
<p><img src="/2025/09/06/SSID-NAT-mode/Example_Topology.jpeg" alt="2 Clients with 10.x.x.x addresses wirelessly connected to the AP, which then gets NATed into the APs Management IP to the internet"></p>
<h2 id="Client-Isolation"><a href="#Client-Isolation" class="headerlink" title="Client Isolation"></a>Client Isolation</h2><p>NAT mode with Meraki DHCP isolates clients. Devices with a Meraki DHCP address will be able to access external and internal resources, such as the Internet and LAN (<a target="_blank" rel="noopener" href="https://documentation.meraki.com/MR/Firewall_and_Traffic_Shaping/'Deny_Local_LAN'_settings_in_Cisco_Meraki_MR_firewall">if firewall rules permit</a>). However, connected clients will be unable to contact each other. The client isolation features of Meraki DHCP can be seen in the above figure. Client A and Client B can both access the Internet. When Client A wants to send traffic to Client B, the traffic will reach the AP. However, the AP <strong>will not</strong> forward this traffic to Client B. Therefore, the two clients are isolated from each other.</p>
<p>Since the client isolation function of NAT mode prevents wireless devices on the SSID from communicating with other wireless devices, NAT mode is not recommended for use with wireless peer-to-peer devices like a wireless printer or Google Chromecast.</p>
<p>Due to the implementation of client isolation, clients on a NAT mode SSID cannot talk to clients on a bridge-mode SSID when both clients are connected to the same AP.</p>
<h2 id="Configuring-NAT-mode-with-Meraki-DHCP"><a href="#Configuring-NAT-mode-with-Meraki-DHCP" class="headerlink" title="Configuring NAT mode with Meraki DHCP"></a>Configuring NAT mode with Meraki DHCP</h2><p>To configure NAT mode with Meraki DHCP on an SSID, follow the directions below:</p>
<ol>
<li>Navigate to <strong>Wireless &gt;</strong> <strong>Configure &gt; Access control</strong></li>
<li>Select the appropriate SSID from the SSID menu at the top of the page</li>
<li>Under the <strong>Client IP and VLAN</strong> section, select <strong>Meraki AP assigned (NAT mode)</strong>, as seen in the image below</li>
<li>Click <strong>Save</strong></li>
</ol>
<p><img src="/2025/09/06/SSID-NAT-mode/NAT_mode.png" alt="NAT mode configuration "></p>
<h2 id="DNS-and-NAT-Mode"><a href="#DNS-and-NAT-Mode" class="headerlink" title="DNS and NAT Mode"></a>DNS and NAT Mode</h2><p>In NAT mode, a Cisco Meraki AP acts as a DNS forwarder. DNS resolution in NAT mode follows the process below.</p>
<ol>
<li>Wireless client sends DNS query to the AP at 10.128.128.128.</li>
<li>The AP checks in a per-SSID cache to see if the record requested by the client is cached from a previous DNS lookup.</li>
<li>If the record does exist in the APâ€™s DNS cache for that SSID, the AP resolves the query locally and responds to the wireless client with the record in a DNS response.</li>
<li>If the record is not in the APâ€™s DNS cache for that SSID, it queries the local DNS servers that it has been configured to use. The AP will try the primary DNS server first. If the primary DNS server does not respond, a secondary DNS server will be queried, if configured. If neither DNS server responds, a DNS reason code â€œReply timed out - The DNS server did not respond within the allotted time frameâ€ message is sent to the client. </li>
<li>When the AP receives a response containing the DNS record from the local DNS server, it caches the results and sends a DNS response to the wireless client.</li>
</ol>
<p><em><strong>*Note:*</strong></em> Cisco Meraki APs can resolve external or internal DNS names depending on the ability of the local DNS servers they are configured to use. The AP only performs DNS recursively. If the recursion bit is not set in the DNS request from the wireless client the AP will not be able to resolve the DNS query.</p>
<p>If it is desirable to have wireless clients use different DNS servers than those configured for the AP itself, <a target="_blank" rel="noopener" href="https://documentation.meraki.com/MR/Client_Addressing_and_Bridging/NAT_Mode_with_Meraki_DHCP#Configuring_Custom_DNS_for_an_SSID_in_NAT_Mode">custom DNS server addresses can be provided</a>. </p>
<h3 id="Configuring-Custom-DNS-for-an-SSID-in-NAT-Mode"><a href="#Configuring-Custom-DNS-for-an-SSID-in-NAT-Mode" class="headerlink" title="Configuring Custom DNS for an SSID in NAT Mode"></a>Configuring Custom DNS for an SSID in NAT Mode</h3><p>This article shows how to set custom DNS servers for a NAT mode SSID, rather than using the APâ€™s DNS server. This is typically used to forward NAT mode SSID clients to a DNS server with custom content filtering. </p>
<p>To configure custom DNS for an SSID in NAT mode, follow the directions below:</p>
<ol>
<li>Navigate to <em><strong>*Wireless &gt;*</strong></em> <em><strong>*Configure &gt; Access control*</strong></em> in Dashboard</li>
<li>Choose the desired <em><strong>*SSID*</strong></em> from the drop-down menu at the top of the page</li>
<li>Under <em><strong>*Client IP and VLAN*</strong></em>, select <em><strong>*Meraki AP assigned (NAT mode)*</strong></em></li>
<li>For <em><strong>*Custom DNS servers*</strong></em>, enter the preferred custom DNS IP addresses. A maximum of 2 DNS servers can be specified<br><img src="/2025/09/06/SSID-NAT-mode/NAT_mode-1757093526183-5.png" alt="NAT mode configuration "></li>
<li>Click <em><strong>*Save*</strong></em> to apply the settings</li>
</ol>
<p><em><strong>*Note:*</strong></em> Wireless clients will still be assigned the APâ€™s internal IP 10.128.128.128 as their DNS server IP. This configuration customizes the destination server of the APâ€™s DNS proxy.</p>
<h2 id="Common-Problems"><a href="#Common-Problems" class="headerlink" title="Common Problems"></a>Common Problems</h2><p>There are a few common problems that can arise when deploying NAT mode with Meraki DHCP to provide client addressing. These problems are outlined in detail below:</p>
<ul>
<li><strong>Roaming -</strong> NAT mode with Meraki DHCP will use the IP address of the AP as the public IP address for wireless clients. When a client roams between APs with Meraki DHCP, TCP connections will drop and have to be re-established. This can cause problems with some applications and devices.</li>
<li><em><strong>*Bonjour and multicasting protocols*</strong></em> - The client isolation features of Meraki DHCP will prevent wireless clients from communicating with each other. This will prevent Bonjour, layer 2 discovery protocols, and multicasting protocols from working. This can cause problems in networks that use Bonjour among wireless clients, or have IP phones or applications that require multicasting.</li>
<li><strong>Group Policy â€œSecurity appliance onlyâ€ settings</strong> - Client information (such as MAC address and IP address) is hidden from an upstream MX due to NAT being performed on a downstream MR. As a result, the MX wonâ€™t be able to enforce group policy settings specific to security appliances only for clients connected to an SSID using Meraki DHCP.</li>
<li><em>***<em>*Inbound client connections**</em>*</em>* - NAT mode with Meraki DHCP prevents inbound connections to a wireless client. This can cause problems if a wireless client needs to be accessible from a different network. The image below illustrates this problem. A connection, such as a remote desktop session, from the wired client to wireless client A will fail. Other common examples include failed wireless LAN connections to Chromecast devices, AirPlay enabled devices, printers or projectors.</li>
</ul>
<p><img src="/2025/09/06/SSID-NAT-mode/Example_Topology_withWired.jpeg" alt="img"></p>
<p>The issues described above can be resolved by using <a target="_blank" rel="noopener" href="https://documentation.meraki.com/MR/Client_Addressing_and_Bridging/SSID_Modes_for_Client_IP_Assignment">bridge mode</a> for client addressing. Bridge mode simply passes traffic between the wireless client and wired distribution system. An upstream DHCP server will be required to handle client addressing.</p>
<h2 id="Additional-Resources"><a href="#Additional-Resources" class="headerlink" title="Additional Resources"></a>Additional Resources</h2><p>For additional information about NAT mode with Meraki DHCP and client addressing, please consult the following documentation:</p>
<p><a target="_blank" rel="noopener" href="https://documentation.meraki.com/MR/Client_Addressing_and_Bridging/SSID_Modes_for_Client_IP_Assignment#NAT_Mode">NAT Mode</a></p>
<p><a target="_blank" rel="noopener" href="https://documentation.meraki.com/MR/Client_Addressing_and_Bridging/SSID_Modes_for_Client_IP_Assignment#Bridge_Mode">Bridge Mode</a></p>
<h1 id="NAT-Gateway-Mode-SSID"><a href="#NAT-Gateway-Mode-SSID" class="headerlink" title="NAT Gateway Mode SSID"></a><a target="_blank" rel="noopener" href="https://tip-1.gitbook.io/openwifi/master/configuration-examples/nat-gateway-mode-ssid">NAT Gateway Mode SSID</a></h1><p>Configuring AP as a Gateway</p>
<h3 id="Network-Address-Translation-Wi-Fi-to-Ethernet"><a href="#Network-Address-Translation-Wi-Fi-to-Ethernet" class="headerlink" title="Network Address Translation Wi-Fi to Ethernet"></a>Network Address Translation Wi-Fi to Ethernet</h3><p>When defining an SSID in NAT mode, this has the affect of isolating all SSID virtual interface traffic in Layer 2 and Layer 3 behind a NAT function inside the Access Point. </p>
<p>The Access Point will use its â€˜WANâ€™ interface as the public facing IP address for clients behind the SSID associated to NAT mode operation. </p>
<p>NAT mode SSID will have a local DHCP service enabled by default with an address range of 192.168.1.0&#x2F;24 where the first address is used by the Access Point as the SSID NAT LAN interface serving as default gateway address to all associated UE clients. </p>
<p>NAT SSID is configured within Profiles, SSID Profile:</p>
<ul>
<li>Create a Profile of type SSID</li>
<li>Assign a Profile Name</li>
<li>Create the SSID <ul>
<li>Assign SSID Name</li>
<li>Set related optional SSID parameters</li>
</ul>
</li>
<li>Network Connectivity<ul>
<li>Ensure Mode is set to NAT</li>
</ul>
</li>
</ul>
<p><img src="/2025/09/06/SSID-NAT-mode/nat_gateway_mode_ssid" alt="img"></p>
<p>SSID NAT Configuration</p>
<p>Once the SSID Profile is associated to an Access Point, clients will receive DHCP, Routing, DNS from the Access Point â€˜LANâ€™ side</p>
<p><img src="/2025/09/06/SSID-NAT-mode/nat_gateway_mode_wifi" alt="img"></p>
<p>Client Served via NAT SSID</p>
<h1 id="NEBULA-How-to-use-NAT-mode-on-AP"><a href="#NEBULA-How-to-use-NAT-mode-on-AP" class="headerlink" title="[NEBULA] How to use NAT mode on AP?"></a>[NEBULA] How to use NAT mode on AP?</h1><p><a target="_blank" rel="noopener" href="https://community.zyxel.com/en/discussion/9976/nebula-how-to-use-nat-mode-on-ap">February 2021</a> edited January 2024</p>
<p><strong>Where to find:</strong> Configure &gt; Access point &gt; SSID advanced settings &gt; Traffic options</p>
<p><strong>Function description:</strong> NAT mode is used to have the AP create a DHCP subnet with its own NAT for the SSID. Provide minimum hardware requirement for Wi-Fi of small shop&#x2F;cafÃ©</p>
<p>If AP management IP address is NOT part of â€œ10.0.0.0&#x2F;8â€, SSID subnet becomes â€œ10.0.0.0&#x2F;8â€.</p>
<p>If AP management IP address is part of â€œ10.0.0.0&#x2F;8â€, SSID subnet becomes â€œ172.16.0.0&#x2F;12â€</p>
<p><strong>Scenario:</strong> Enable NAT mode on the SSID which is provided for Guest usage.<br><img src="/2025/09/06/SSID-NAT-mode/8370gld3vff0.png" alt="Image: https:&#x2F;&#x2F;us.v-cdn.net&#x2F;6029482&#x2F;uploads&#x2F;editor&#x2F;bl&#x2F;8370gld3vff0.png"><br>**Configuration:<br>**1. Go to Configure &gt; Access points&gt; SSID settings. Add to SSID as â€œWi-Fiâ€. Then click â€œEditâ€.</p>
<p><img src="/2025/09/06/SSID-NAT-mode/epc3r5mspoki.png" alt="Image: https:&#x2F;&#x2F;us.v-cdn.net&#x2F;6029482&#x2F;uploads&#x2F;editor&#x2F;cl&#x2F;epc3r5mspoki.png"></p>
<p>Or Configure &gt; Access points &gt; SSID advanced settings then select the SSID to continuing the setting.</p>
<ol start="2">
<li>Configure the Traffic options, enable â€œNAT modeâ€ and click â€œBackâ€</li>
</ol>
<p><img src="https://community.zyxel.com/en/discussion/9976/src" alt="img"><img src="/2025/09/06/SSID-NAT-mode/r3gyn0ea56s7.png" alt="img"></p>
<ol start="3">
<li>Click â€œSaveâ€.</li>
</ol>
<p><img src="/2025/09/06/SSID-NAT-mode/2ucrhkw28sco.png" alt="img"></p>
<p><strong>Successful Log.</strong><br><img src="/2025/09/06/SSID-NAT-mode/cwfcbm3sitw5.png" alt="img"></p>
<p>**Note.<br>**1. The following AP features do not work when NAT mode is on.<br>  a. 802.11r<br>  b. Layer2 isolation<br>  c. Dynamic VLAN (cloud authentication, RADIUS server)</p>
<ol start="2">
<li>When NAT mode is enabled on non-supported models, Nebula CC does not show any error message. And non-supported models disable any SSID with NAT mode enabled.</li>
<li>The IP address lease time is 8 hours.</li>
</ol>
<p>Tagged: </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://community.zyxel.com/en/discussions?tagID=300">Nebula-SSID</a></li>
<li><a target="_blank" rel="noopener" href="https://community.zyxel.com/en/discussions?tagID=309">Nebula-Forwarding Mode</a></li>
</ul>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2025/09/06/SSID-NAT-mode/">å±•å¼€å…¨æ–‡ >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-Wi-Fiå¸§ç±»å‹ä¸ä½œç”¨è¯¦è§£" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2025/09/03/Wi-Fi%E5%B8%A7%E7%B1%BB%E5%9E%8B%E4%B8%8E%E4%BD%9C%E7%94%A8%E8%AF%A6%E8%A7%A3/">Wi-Fiå¸§ç±»å‹ä¸ä½œç”¨è¯¦è§£</a>
    </h1>
  

        
        <a href="/2025/09/03/Wi-Fi%E5%B8%A7%E7%B1%BB%E5%9E%8B%E4%B8%8E%E4%BD%9C%E7%94%A8%E8%AF%A6%E8%A7%A3/" class="archive-article-date">
  	<time datetime="2025-09-03T12:14:26.321Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2025-09-03</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Wi-Fiå¸§ç±»å‹ä¸ä½œç”¨è¯¦è§£"><a href="#Wi-Fiå¸§ç±»å‹ä¸ä½œç”¨è¯¦è§£" class="headerlink" title="Wi-Fiå¸§ç±»å‹ä¸ä½œç”¨è¯¦è§£"></a>Wi-Fiå¸§ç±»å‹ä¸ä½œç”¨è¯¦è§£</h3><table>
<thead>
<tr>
<th align="left">å¸§ç±»å‹&#x2F;å­ç±»å‹</th>
<th align="left">è¿‡æ»¤å™¨è¯­æ³•</th>
<th align="left">å«ä¹‰ä¸ä½œç”¨</th>
<th align="left">å¸¸è§æ€§</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>Management frame</strong>ï¼ˆç®¡ç†å¸§ï¼‰</td>
<td align="left"><code>wlan.fc.type == 0</code></td>
<td align="left"><strong>ä½œç”¨ï¼š</strong> ç”¨äºç®¡ç†å’Œç»´æŠ¤STAï¼ˆå·¥ä½œç«™ï¼‰ä¸APï¼ˆæ¥å…¥ç‚¹ï¼‰ä¹‹é—´çš„é€šä¿¡å…³ç³»ã€‚åŒ…æ‹¬åŠ å…¥&#x2F;ç¦»å¼€ç½‘ç»œã€èº«ä»½è®¤è¯ã€åŒæ­¥ç­‰ã€‚</td>
<td align="left"><strong>æé«˜</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- Association requestï¼ˆå…³è”è¯·æ±‚ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x00</code></td>
<td align="left">ç”±STAå‘é€ç»™APï¼Œè¯·æ±‚æ­£å¼åŠ å…¥ç½‘ç»œã€‚</td>
<td align="left"><strong>é«˜</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- Association responseï¼ˆå…³è”å“åº”ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x01</code></td>
<td align="left">ç”±APå‘é€ç»™STAï¼Œå›åº”å…³è”è¯·æ±‚ã€‚</td>
<td align="left"><strong>é«˜</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- Reassociation requestï¼ˆé‡å…³è”è¯·æ±‚ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x02</code></td>
<td align="left">STAåœ¨æ¼«æ¸¸æ—¶å‘é€ç»™æ–°APï¼Œè¯·æ±‚åˆ‡æ¢å…³è”ã€‚</td>
<td align="left"><strong>é«˜</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- Reassociation responseï¼ˆé‡å…³è”å“åº”ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x03</code></td>
<td align="left">æ–°APå¯¹é‡å…³è”è¯·æ±‚çš„å›åº”ã€‚</td>
<td align="left"><strong>é«˜</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- Probe requestï¼ˆæ¢æµ‹è¯·æ±‚ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x04</code></td>
<td align="left">STAä¸»åŠ¨å‘é€ï¼Œç”¨äºâ€œæ‰«æâ€å‘¨å›´å¯ç”¨çš„Wi-Fiç½‘ç»œã€‚</td>
<td align="left"><strong>æé«˜</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- Probe responseï¼ˆæ¢æµ‹å“åº”ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x05</code></td>
<td align="left">APå¯¹æ¢æµ‹è¯·æ±‚çš„å›å¤ï¼ŒåŒ…å«ç½‘ç»œä¿¡æ¯ã€‚</td>
<td align="left"><strong>æé«˜</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>Timing Advertisement</strong>ï¼ˆå®šæ—¶é€šå‘Šï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x06</code></td>
<td align="left"><strong>è¡¥å……ï¼š</strong> ç”¨äº mesh ç½‘ç»œæˆ–å®šä½æœåŠ¡ä¸­åŒæ­¥å®šæ—¶ä¿¡æ¯ã€‚</td>
<td align="left"><strong>ä½</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>Beacon</strong>ï¼ˆä¿¡æ ‡å¸§ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x08</code></td>
<td align="left">APå®šæœŸå¹¿æ’­ï¼Œå®£å‘Šç½‘ç»œçš„å­˜åœ¨ã€‚<strong>è¿™æ˜¯æœ€é‡è¦çš„ç®¡ç†å¸§ä¹‹ä¸€ã€‚</strong></td>
<td align="left"><strong>æé«˜</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>ATIM</strong>ï¼ˆé€šå‘Šä¼ è¾“æŒ‡ç¤ºæ¶ˆæ¯ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x09</code></td>
<td align="left"><strong>è¡¥å……ï¼š</strong> åœ¨IBSSï¼ˆè‡ªç»„ç½‘&#x2F;Ad-hocï¼‰æ¨¡å¼ä¸­ï¼Œç”¨äºé€šçŸ¥æœ‰ç¼“å­˜çš„æ•°æ®è¦å‘é€ã€‚</td>
<td align="left"><strong>ä½</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- Disassociationï¼ˆè§£é™¤å…³è”ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x0A</code></td>
<td align="left">ç”±APæˆ–STAå‘é€ï¼Œç”¨äºç»ˆæ­¢å·²å»ºç«‹çš„å…³è”å…³ç³»ã€‚</td>
<td align="left"><strong>é«˜</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- Authenticationï¼ˆè®¤è¯ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x0B</code></td>
<td align="left">STAå’ŒAPä¹‹é—´è¿›è¡Œèº«ä»½éªŒè¯çš„äº¤æ¢è¿‡ç¨‹ã€‚</td>
<td align="left"><strong>é«˜</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- Deauthenticationï¼ˆè§£é™¤è®¤è¯ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x0C</code></td>
<td align="left">ç»ˆæ­¢è®¤è¯å…³ç³»ï¼Œè¿«ä½¿STAé‡æ–°è®¤è¯ã€‚å¸¸ç”¨äºâ€œå–æ¶ˆè®¤è¯æ”»å‡»â€ã€‚</td>
<td align="left"><strong>é«˜</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- Actionï¼ˆåŠ¨ä½œå¸§ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x0D</code></td>
<td align="left">ä¸€ä¸ªé€šç”¨çš„ç®¡ç†å¸§ï¼Œç”¨äºè§¦å‘é¢‘è°±ç®¡ç†ã€QoSã€æ— çº¿ç”µæµ‹é‡ç­‰ç‰¹å®šåŠ¨ä½œã€‚</td>
<td align="left"><strong>é«˜</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>Action No Ack</strong>ï¼ˆæ— ç¡®è®¤åŠ¨ä½œå¸§ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x0E</code></td>
<td align="left"><strong>è¡¥å……ï¼š</strong> ä¸Actionå¸§ç›¸åŒï¼Œä½†ä¸éœ€è¦æ¥æ”¶æ–¹å›å¤ç¡®è®¤ï¼ˆACKï¼‰ã€‚</td>
<td align="left"><strong>ä¸­</strong></td>
</tr>
<tr>
<td align="left"><strong>Control frame</strong>ï¼ˆæ§åˆ¶å¸§ï¼‰</td>
<td align="left"><code>wlan.fc.type == 1</code></td>
<td align="left"><strong>ä½œç”¨ï¼š</strong> è¾…åŠ©æ•°æ®å¸§çš„ä¼ è¾“ï¼Œç”¨äºæ§åˆ¶æ— çº¿ä»‹è´¨è®¿é—®ã€ä¿è¯æ•°æ®å¯é æ€§ã€‚</td>
<td align="left"><strong>æé«˜</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>Trigger</strong>ï¼ˆè§¦å‘å¸§ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x02</code></td>
<td align="left"><strong>è¡¥å…… (Wi-Fi 6)ï¼š</strong> APå‘é€æ­¤å¸§è°ƒåº¦å¤šä¸ªSTAåŒæ—¶ä¸Šè¡Œä¼ è¾“ï¼ˆUL MU-MIMO&#x2F;OFDMAï¼‰ï¼Œæ˜¯Wi-Fi 6çš„å…³é”®å¸§ã€‚</td>
<td align="left"><strong>é«˜ (Wi-Fi 6)</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>TACK</strong>ï¼ˆ beamforming æŠ¥å‘Šè½®è¯¢ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x03</code></td>
<td align="left"><strong>è¡¥å……ï¼š</strong> ç”¨äºè½®è¯¢beamformingæµ‹é‡æŠ¥å‘Šï¼Œç°å·²å¾ˆå°‘ä½¿ç”¨ã€‚</td>
<td align="left"><strong>æä½</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>Beamforming Report Poll</strong></td>
<td align="left"><code>wlan.fc.type_subtype == 0x04</code></td>
<td align="left"><strong>è¡¥å……ï¼š</strong> åŠŸèƒ½ä¸TACKç±»ä¼¼ï¼Œå·²è¿‡æ—¶ã€‚</td>
<td align="left"><strong>æä½</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>VHT&#x2F;HE NDP Announcement</strong>ï¼ˆç©ºæ•°æ®åŒ…é€šå‘Šï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x05</code></td>
<td align="left"><strong>è¡¥å……ï¼š</strong> åœ¨å‘é€NDPï¼ˆç©ºæ•°æ®åŒ…ï¼‰ç”¨äºä¿¡é“æµ‹é‡å‰å‘é€çš„é€šå‘Šã€‚</td>
<td align="left"><strong>ä¸­</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>Control Frame Extension</strong></td>
<td align="left"><code>wlan.fc.type_subtype == 0x06</code></td>
<td align="left"><strong>è¡¥å……ï¼š</strong> ä¸ºæœªæ¥æ§åˆ¶å¸§æ‰©å±•ä¿ç•™çš„å­ç±»å‹ã€‚</td>
<td align="left"><strong>æœªä½¿ç”¨</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>Control Wrapper</strong>ï¼ˆæ§åˆ¶å°è£…å¸§ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x07</code></td>
<td align="left"><strong>è¡¥å……ï¼š</strong> å¯ä»¥æºå¸¦å…¶ä»–æ§åˆ¶å¸§æˆ–ä¿¡æ¯ã€‚</td>
<td align="left"><strong>ä½</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>Block ACK Request</strong>ï¼ˆå—ç¡®è®¤è¯·æ±‚ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x18</code></td>
<td align="left">å‘é€æ–¹å‘æ¥æ”¶æ–¹è¯·æ±‚ä¸€ä¸ªå—ç¡®è®¤ï¼ˆBlock ACKï¼‰ã€‚</td>
<td align="left"><strong>é«˜ (QoS)</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>Block ACK</strong>ï¼ˆå—ç¡®è®¤ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x19</code></td>
<td align="left">æ¥æ”¶æ–¹å¯¹å—ç¡®è®¤è¯·æ±‚çš„å“åº”ï¼Œä¸€æ¬¡æ€§ç¡®è®¤ä¸€æ‰¹æ•°æ®å¸§ã€‚</td>
<td align="left"><strong>é«˜ (QoS)</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>PS-Poll</strong>ï¼ˆçœç”µè½®è¯¢ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x1A</code></td>
<td align="left">å¤„äºçœç”µæ¨¡å¼çš„STAå‘é€ç»™APï¼Œå‘ŠçŸ¥è‡ªå·±å·²å”¤é†’å¹¶å‡†å¤‡æ¥æ”¶ç¼“å­˜çš„æ•°æ®ã€‚</td>
<td align="left"><strong>ä¸­</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>RTS</strong>ï¼ˆè¯·æ±‚å‘é€ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x1B</code></td>
<td align="left">RTS&#x2F;CTSæ¡æ‰‹çš„ç¬¬ä¸€æ­¥ï¼Œå‘é€æ–¹é¢„çº¦ä¿¡é“ä½¿ç”¨æƒã€‚</td>
<td align="left"><strong>ä¸­</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>CTS</strong>ï¼ˆæ¸…é™¤å‘é€ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x1C</code></td>
<td align="left">RTS&#x2F;CTSæ¡æ‰‹çš„ç¬¬äºŒæ­¥ï¼Œæ¥æ”¶æ–¹å›å¤CTSè®©å‘¨å›´è®¾å¤‡é™é»˜ã€‚</td>
<td align="left"><strong>ä¸­</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>ACK</strong>ï¼ˆç¡®è®¤ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x1D</code></td>
<td align="left"><strong>æœ€é‡è¦çš„æ§åˆ¶å¸§ã€‚</strong> æ¥æ”¶æ–¹æˆåŠŸæ”¶åˆ°æ•°æ®åç«‹å³å›å¤ACKã€‚</td>
<td align="left"><strong>æé«˜</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>CF-End</strong>ï¼ˆæ— ç«äº‰å‘¨æœŸç»“æŸï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x1E</code></td>
<td align="left">å®£å¸ƒæ— ç«äº‰ä¼ è¾“é˜¶æ®µï¼ˆCFPï¼‰ç»“æŸã€‚</td>
<td align="left"><strong>ä½</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>CF-End + CF-Ack</strong></td>
<td align="left"><code>wlan.fc.type_subtype == 0x1F</code></td>
<td align="left"><strong>è¡¥å……ï¼š</strong> ç»“åˆäº†CF-Endå’ŒACKåŠŸèƒ½çš„å¸§ã€‚</td>
<td align="left"><strong>ä½</strong></td>
</tr>
<tr>
<td align="left"><strong>Data frame</strong>ï¼ˆæ•°æ®å¸§ï¼‰</td>
<td align="left"><code>wlan.fc.type == 2</code></td>
<td align="left"><strong>ä½œç”¨ï¼š</strong> <strong>ä¼ è¾“ä¸Šå±‚åè®®æ•°æ®ï¼ˆå¦‚IPåŒ…ï¼‰çš„è½½ä½“</strong>ï¼Œæ˜¯æ— çº¿é€šä¿¡çš„æœ€ç»ˆç›®çš„ã€‚</td>
<td align="left"><strong>æé«˜</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>Data</strong>ï¼ˆæ•°æ®ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x20</code></td>
<td align="left"><strong>è¡¥å……ï¼š</strong> æœ€åŸºç¡€çš„ã€ä¸æ”¯æŒQoSçš„æ•°æ®å¸§ã€‚</td>
<td align="left"><strong>ä¸­ (æ—§è®¾å¤‡)</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>Data + CF-Ack</strong></td>
<td align="left"><code>wlan.fc.type_subtype == 0x21</code></td>
<td align="left"><strong>è¡¥å……ï¼š</strong> åœ¨CFPæœŸé—´ï¼Œæºå¸¦æ•°æ®çš„åŒæ—¶å¯¹ä¹‹å‰æ”¶åˆ°çš„å¸§è¿›è¡Œç¡®è®¤ã€‚</td>
<td align="left"><strong>æä½</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>Data + CF-Poll</strong></td>
<td align="left"><code>wlan.fc.type_subtype == 0x22</code></td>
<td align="left"><strong>è¡¥å……ï¼š</strong> APåœ¨CFPæœŸé—´ä½¿ç”¨ï¼Œåœ¨å‘é€æ•°æ®çš„åŒæ—¶è½®è¯¢STAã€‚</td>
<td align="left"><strong>æä½</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>Data + CF-Ack + CF-Poll</strong></td>
<td align="left"><code>wlan.fc.type_subtype == 0x23</code></td>
<td align="left"><strong>è¡¥å……ï¼š</strong> ç»“åˆäº†æ•°æ®ã€ç¡®è®¤å’Œè½®è¯¢ä¸‰ç§åŠŸèƒ½ã€‚</td>
<td align="left"><strong>æä½</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>Null Data</strong>ï¼ˆç©ºæ•°æ®ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x24</code></td>
<td align="left">ä¸æºå¸¦ä»»ä½•æ•°æ®ï¼Œç”¨äºå‘APæŠ¥å‘Šç”µæºç®¡ç†çŠ¶æ€ã€‚</td>
<td align="left"><strong>é«˜</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>QoS Data</strong>ï¼ˆQoSæ•°æ®ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x28</code></td>
<td align="left"><strong>ç°ä»£Wi-Fiä¸­æœ€å¸¸è§çš„æ•°æ®å¸§ã€‚</strong> æ”¯æŒæœåŠ¡è´¨é‡ï¼ˆQoSï¼‰ä¼˜å…ˆçº§ã€‚</td>
<td align="left"><strong>æé«˜</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>QoS Data + CF-Ack</strong></td>
<td align="left"><code>wlan.fc.type_subtype == 0x29</code></td>
<td align="left">QoS Dataçš„CFPå˜ä½“ã€‚</td>
<td align="left"><strong>æä½</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>QoS Data + CF-Poll</strong></td>
<td align="left"><code>wlan.fc.type_subtype == 0x2A</code></td>
<td align="left">QoS Dataçš„CFPå˜ä½“ã€‚</td>
<td align="left"><strong>æä½</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>QoS Data + CF-Ack + CF-Poll</strong></td>
<td align="left"><code>wlan.fc.type_subtype == 0x2B</code></td>
<td align="left">QoS Dataçš„CFPå˜ä½“ã€‚</td>
<td align="left"><strong>æä½</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>QoS Null</strong>ï¼ˆç©ºQoSæ•°æ®ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x2C</code></td>
<td align="left">ä¸æºå¸¦æ•°æ®çš„QoSå¸§ï¼Œç”¨äºæŠ¥å‘ŠQoSç½‘ç»œçš„ç”µæºçŠ¶æ€ã€‚</td>
<td align="left"><strong>é«˜</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>QoS CF-Poll</strong>ï¼ˆæ— æ•°æ®ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x2D</code></td>
<td align="left"><strong>è¡¥å……ï¼š</strong> ä»…ç”¨äºè½®è¯¢ï¼Œä¸æºå¸¦æ•°æ®ã€‚</td>
<td align="left"><strong>ä½</strong></td>
</tr>
<tr>
<td align="left">&nbsp;&nbsp;- <strong>QoS CF-Ack + CF-Poll</strong>ï¼ˆæ— æ•°æ®ï¼‰</td>
<td align="left"><code>wlan.fc.type_subtype == 0x2E</code></td>
<td align="left"><strong>è¡¥å……ï¼š</strong> ä»…ç”¨äºç¡®è®¤å’Œè½®è¯¢ï¼Œä¸æºå¸¦æ•°æ®ã€‚</td>
<td align="left"><strong>ä½</strong></td>
</tr>
</tbody></table>
<p><strong>æ€»ç»“è¯´æ˜ï¼š</strong></p>
<ol>
<li><strong>å¸¸è§æ€§</strong>ï¼šæ‚¨åŸå§‹åˆ—è¡¨ä¸­çš„å¸§è¦†ç›–äº†<strong>99%</strong> çš„å¸¸è§æŠ“åŒ…åœºæ™¯ã€‚ç¼ºå°‘çš„ä¸»è¦æ˜¯ä¸€äº›<strong>å·²è¿‡æ—¶</strong>ï¼ˆå¦‚CFPç›¸å…³å¸§ï¼‰æˆ–<strong>ä¸ºæœªæ¥ä¿ç•™</strong>çš„å¸§ã€‚</li>
<li><strong>é‡è¦è¡¥å……</strong>ï¼šå”¯ä¸€ä¸€ä¸ªå¸¸è§ä¸”é‡è¦çš„è¡¥å……æ˜¯ <strong>Triggerå¸§</strong>ï¼Œå®ƒæ˜¯Wi-Fi 6ï¼ˆ802.11axï¼‰ä¸­å®ç°é«˜æ•ˆä¸Šè¡Œå¤šç”¨æˆ·ä¼ è¾“çš„æ ¸å¿ƒæœºåˆ¶ã€‚</li>
<li><strong>æ‰©å±•ç±»å‹</strong>ï¼š<code>0x0E</code> (Action No Ack), <code>0x06</code> (Timing Advertisement) ç­‰åœ¨ç‰¹å®šç½‘ç»œæˆ–åŠŸèƒ½ä¸­ä¼šå‡ºç°ï¼Œä½†æ—¥å¸¸åˆ†æä¸­ä¸å¸¸è§ã€‚</li>
</ol>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2025/09/03/Wi-Fi%E5%B8%A7%E7%B1%BB%E5%9E%8B%E4%B8%8E%E4%BD%9C%E7%94%A8%E8%AF%A6%E8%A7%A3/">å±•å¼€å…¨æ–‡ >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-icmp_counter" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2025/08/21/icmp_counter/">netfilterè¿‡æ»¤ICMPåŒ…</a>
    </h1>
  

        
        <a href="/2025/08/21/icmp_counter/" class="archive-article-date">
  	<time datetime="2025-08-21T15:38:02.002Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2025-08-21</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="netfilterè¿‡æ»¤ICMPåŒ…"><a href="#netfilterè¿‡æ»¤ICMPåŒ…" class="headerlink" title="netfilterè¿‡æ»¤ICMPåŒ…"></a>netfilterè¿‡æ»¤ICMPåŒ…</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/ip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/icmp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/netfilter.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/netfilter_ipv4.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/proc_fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/seq_file.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/jiffies.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/timekeeping.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/spinlock.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/version.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODULE_NAME <span class="string">&quot;icmp_logger&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TARGET_LENGTH 64  <span class="comment">// ç›®æ ‡ICMPåŒ…é•¿åº¦(å­—èŠ‚)</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_ENTRIES 1000  <span class="comment">// æœ€å¤§è®°å½•æ¡æ•°</span></span></span><br><span class="line"> </span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;YourName&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;ICMP Packet Logger with Timestamp and Source IP&quot;</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// ICMPè®°å½•ç»“æ„ä½“</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">icmp_record</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> seq;        <span class="comment">// åºå·</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec64</span> <span class="title">ts</span>;</span>    <span class="comment">// æ—¶é—´æˆ³ </span></span><br><span class="line">    __be32 src_ip;           <span class="comment">// æºIP(ç½‘ç»œå­—èŠ‚åº)</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span>   <span class="comment">// é“¾è¡¨èŠ‚ç‚¹</span></span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="title function_">LIST_HEAD</span><span class="params">(icmp_list)</span>;       <span class="comment">// ICMPè®°å½•é“¾è¡¨</span></span><br><span class="line"><span class="type">static</span> <span class="title function_">DEFINE_SPINLOCK</span><span class="params">(list_lock)</span>; <span class="comment">// é“¾è¡¨è‡ªæ—‹é” </span></span><br><span class="line"><span class="type">static</span> <span class="type">atomic_t</span> icmp_counter = ATOMIC_INIT(<span class="number">0</span>); <span class="comment">// å…¨å±€è®¡æ•°å™¨ </span></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">int</span> next_seq = <span class="number">1</span>;  <span class="comment">// ä¸‹ä¸€ä¸ªåºå· </span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// Netfilteré’©å­å‡½æ•°</span></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">icmp_logger_hook</span><span class="params">(<span class="type">void</span> *priv, <span class="keyword">struct</span> sk_buff *skb,</span></span><br><span class="line"><span class="params">                                     <span class="type">const</span> <span class="keyword">struct</span> nf_hook_state *state)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">ip_header</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">icmphdr</span> *<span class="title">icmp_header</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> total_length;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">icmp_record</span> *<span class="title">new_rec</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec64</span> <span class="title">now</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!skb) <span class="keyword">return</span> NF_ACCEPT;</span><br><span class="line">    </span><br><span class="line">    ip_header = ip_hdr(skb);</span><br><span class="line">    <span class="keyword">if</span> (!ip_header || ip_header-&gt;protocol != IPPROTO_ICMP)</span><br><span class="line">        <span class="keyword">return</span> NF_ACCEPT;</span><br><span class="line">    </span><br><span class="line">    icmp_header = icmp_hdr(skb);</span><br><span class="line">    <span class="keyword">if</span> (!icmp_header) <span class="keyword">return</span> NF_ACCEPT;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*total_length = ntohs(ip_header-&gt;tot_len);</span></span><br><span class="line"><span class="comment">    if (total_length != TARGET_LENGTH) </span></span><br><span class="line"><span class="comment">        return NF_ACCEPT;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">// åˆ›å»ºæ–°è®°å½•</span></span><br><span class="line">    new_rec = kmalloc(<span class="keyword">sizeof</span>(*new_rec), GFP_ATOMIC);</span><br><span class="line">    <span class="keyword">if</span> (!new_rec) <span class="keyword">return</span> NF_ACCEPT;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¡«å……è®°å½•æ•°æ® </span></span><br><span class="line">    ktime_get_real_ts64(&amp;now);</span><br><span class="line">    new_rec-&gt;seq = next_seq++;</span><br><span class="line">    new_rec-&gt;ts = now;</span><br><span class="line">    new_rec-&gt;src_ip = ip_header-&gt;saddr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åŠ é”å¹¶æ·»åŠ åˆ°é“¾è¡¨ </span></span><br><span class="line">    spin_lock(&amp;list_lock);</span><br><span class="line">    list_add_tail(&amp;new_rec-&gt;<span class="built_in">list</span>, &amp;icmp_list);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç»´æŠ¤æœ€å¤§è®°å½•æ•° </span></span><br><span class="line">    <span class="keyword">if</span> (atomic_inc_return(&amp;icmp_counter) &gt; MAX_ENTRIES) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">icmp_record</span> *<span class="title">old</span> =</span> list_first_entry(&amp;icmp_list, </span><br><span class="line">                                <span class="keyword">struct</span> icmp_record, <span class="built_in">list</span>);</span><br><span class="line">        list_del(&amp;old-&gt;<span class="built_in">list</span>);</span><br><span class="line">        kfree(old);</span><br><span class="line">        <span class="type">atomic_dec</span>(&amp;icmp_counter);</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock(&amp;list_lock);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> NF_ACCEPT;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// /procæ–‡ä»¶æ˜¾ç¤ºå‡½æ•° </span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">icmp_proc_show</span><span class="params">(<span class="keyword">struct</span> seq_file *m, <span class="type">void</span> *v)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">icmp_record</span> *<span class="title">entry</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tm</span> <span class="title">tm</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¡¨å¤´</span></span><br><span class="line">    seq_printf(m, <span class="string">&quot;%-8s%-25s%-15s\n&quot;</span>, <span class="string">&quot;åºå·&quot;</span>, <span class="string">&quot;æ—¶é—´&quot;</span>, <span class="string">&quot;æºIP&quot;</span>);</span><br><span class="line">    seq_printf(m, <span class="string">&quot;--------------------------------------------\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    spin_lock(&amp;list_lock);</span><br><span class="line">    list_for_each_entry(entry, &amp;icmp_list, <span class="built_in">list</span>) &#123;</span><br><span class="line">        time64_to_tm(entry-&gt;ts.tv_sec,  <span class="number">0</span>, &amp;tm);</span><br><span class="line">        seq_printf(m, <span class="string">&quot;%-8d%04d/%02d/%02d-%02d:%02d:%02d.%02ld\t%pI4\n&quot;</span>, </span><br><span class="line">                   entry-&gt;seq,</span><br><span class="line">                   tm.tm_year  + <span class="number">1900</span>, tm.tm_mon  + <span class="number">1</span>, tm.tm_mday, </span><br><span class="line">                   tm.tm_hour,  tm.tm_min,  tm.tm_sec, </span><br><span class="line">                   entry-&gt;ts.tv_nsec  / <span class="number">10000000</span>,  <span class="comment">// è½¬æ¢ä¸ºç™¾åˆ†ä¹‹ä¸€ç§’</span></span><br><span class="line">                   &amp;entry-&gt;src_ip);</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock(&amp;list_lock);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// /procæ–‡ä»¶æ‰“å¼€æ“ä½œ </span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">icmp_proc_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> single_open(file, icmp_proc_show, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proc_ops</span> <span class="title">icmp_proc_ops</span> =</span> &#123;</span><br><span class="line">    .proc_open = icmp_proc_open,</span><br><span class="line">    .proc_read = seq_read,</span><br><span class="line">    .proc_lseek = seq_lseek,</span><br><span class="line">    .proc_release = single_release,</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Netfilteré’©å­ç»“æ„ </span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_ops</span> <span class="title">nfho</span> =</span> &#123;</span><br><span class="line">    .hook = icmp_logger_hook,</span><br><span class="line">    .pf = NFPROTO_IPV4,</span><br><span class="line">    .hooknum = NF_INET_PRE_ROUTING,</span><br><span class="line">    .priority = NF_IP_PRI_FIRST,</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">proc_dir_entry</span> *<span class="title">proc_entry</span>;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// æ¨¡å—åˆå§‹åŒ– </span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">icmp_logger_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// æ³¨å†ŒNetfilteré’©å­</span></span><br><span class="line">    <span class="keyword">if</span> (nf_register_net_hook(&amp;init_net, &amp;nfho)) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;%s: Failed to register hook\n&quot;</span>, MODULE_NAME);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ›å»º/procæ–‡ä»¶</span></span><br><span class="line">    proc_entry = proc_create(<span class="string">&quot;icmp_log&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>, &amp;icmp_proc_ops);</span><br><span class="line">    <span class="keyword">if</span> (!proc_entry) &#123;</span><br><span class="line">        nf_unregister_net_hook(&amp;init_net, &amp;nfho);</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;%s: Failed to create /proc entry\n&quot;</span>, MODULE_NAME);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;%s: Module loaded\n&quot;</span>, MODULE_NAME);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// æ¨¡å—é€€å‡º </span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">icmp_logger_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">icmp_record</span> *<span class="title">entry</span>, *<span class="title">tmp</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ¸…ç†é“¾è¡¨ </span></span><br><span class="line">    spin_lock(&amp;list_lock);</span><br><span class="line">    list_for_each_entry_safe(entry, tmp, &amp;icmp_list, <span class="built_in">list</span>) &#123;</span><br><span class="line">        list_del(&amp;entry-&gt;<span class="built_in">list</span>);</span><br><span class="line">        kfree(entry);</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock(&amp;list_lock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ³¨é”€/procæ–‡ä»¶å’ŒNetfilteré’©å­</span></span><br><span class="line">    <span class="keyword">if</span> (proc_entry) proc_remove(proc_entry);</span><br><span class="line">    nf_unregister_net_hook(&amp;init_net, &amp;nfho);</span><br><span class="line">    </span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;%s: Module unloaded\n&quot;</span>, MODULE_NAME);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">module_init(icmp_logger_init);</span><br><span class="line">module_exit(icmp_logger_exit);</span><br></pre></td></tr></table></figure>





<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">obj-m += icmp_counter.o </span><br><span class="line"> </span><br><span class="line"><span class="section">all:</span></span><br><span class="line">	make -C /lib/modules/<span class="variable">$(<span class="built_in">shell</span> uname -r)</span>/build M=<span class="variable">$(PWD)</span> modules</span><br><span class="line"> </span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	make -C /lib/modules/<span class="variable">$(<span class="built_in">shell</span> uname -r)</span>/build M=<span class="variable">$(PWD)</span> clean</span><br></pre></td></tr></table></figure>


      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2025/08/21/icmp_counter/">å±•å¼€å…¨æ–‡ >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-å¦‚ä½•æ­å»ºhexoåšå®¢" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2025/08/21/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E5%8D%9A%E5%AE%A2/">hexoåšå®¢æ­å»º</a>
    </h1>
  

        
        <a href="/2025/08/21/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E5%8D%9A%E5%AE%A2/" class="archive-article-date">
  	<time datetime="2025-08-21T15:37:10.395Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2025-08-21</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="hexoåšå®¢æ­å»º"><a href="#hexoåšå®¢æ­å»º" class="headerlink" title="hexoåšå®¢æ­å»º"></a>hexoåšå®¢æ­å»º</h1><h3 id="é¢„å…ˆå‡†å¤‡"><a href="#é¢„å…ˆå‡†å¤‡" class="headerlink" title="é¢„å…ˆå‡†å¤‡"></a>é¢„å…ˆå‡†å¤‡</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install git nodejs npm</span><br><span class="line">git config --global user.name name</span><br><span class="line">git config --global user.email email</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-g å‚æ•°å…¨å±€å®‰è£… hexo-cli åŒ…ï¼Œè¿™å°†å…è®¸æ‚¨åœ¨æ‚¨é€‰æ‹©çš„ä»»ä½•ç›®å½•ä¸­å®‰è£… Hexo åšå®¢</span></span><br><span class="line">npm install hexo-cli -g</span><br><span class="line">npm install hexo -g</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://nodejs.org/zh-cn/download">Node.js â€” Download Node.jsÂ®</a>æ¨èä½¿ç”¨nvmå®‰è£…ï¼Œaptä»“åº“çš„ç‰ˆæœ¬å¤ªä½äº†ï¼Œåé¢hexoæœåŠ¡å™¨å¯èƒ½æ— æ³•æ­£å¸¸å¯åŠ¨ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># Download and install nvm:</span><br><span class="line">curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash</span><br><span class="line"></span><br><span class="line"># in lieu of restarting the shell</span><br><span class="line">\. &quot;$HOME/.nvm/nvm.sh&quot;</span><br><span class="line"></span><br><span class="line"># Download and install Node.js:</span><br><span class="line">nvm install 22</span><br><span class="line"></span><br><span class="line"># Verify the Node.js version:</span><br><span class="line">node -v # Should print &quot;v22.18.0&quot;.</span><br><span class="line">nvm current # Should print &quot;v22.18.0&quot;.</span><br><span class="line"></span><br><span class="line"># Verify npm version:</span><br><span class="line">npm -v # Should print &quot;10.9.3&quot;.</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="å¼€å§‹hexo"><a href="#å¼€å§‹hexo" class="headerlink" title="å¼€å§‹hexo"></a>å¼€å§‹hexo</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># è¿›å…¥é¢„å…ˆå‡†å¤‡çš„ç›®å½•åè¿›è¡Œåˆå§‹åŒ–</span><br><span class="line">hexo init</span><br><span class="line"></span><br><span class="line"># å®‰è£…ä¾èµ–</span><br><span class="line">npm install</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Hexoæ“ä½œ"><a href="#Hexoæ“ä½œ" class="headerlink" title="Hexoæ“ä½œ"></a>Hexoæ“ä½œ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ hexo g #generate ç”Ÿæˆé™æ€æ–‡ä»¶</span><br><span class="line">$ hexo s #server å¯åŠ¨æœåŠ¡å™¨ã€‚</span><br><span class="line">// é»˜è®¤æƒ…å†µä¸‹ï¼Œè®¿é—®ç½‘å€ä¸ºï¼š [http://localhost:4000/]</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="å°†gitåº“å’Œhexoé“¾æ¥èµ·æ¥"><a href="#å°†gitåº“å’Œhexoé“¾æ¥èµ·æ¥" class="headerlink" title="å°†gitåº“å’Œhexoé“¾æ¥èµ·æ¥"></a>å°†gitåº“å’Œhexoé“¾æ¥èµ·æ¥</h3><p>é…ç½®Deployment</p>
<p>åœ¨hexoæ–‡ä»¶å¤¹ä¸­ï¼Œæ‰¾åˆ°_config.ymlæ–‡ä»¶ï¼Œä¿®æ”¹repositoryå€¼ï¼ˆåœ¨æœ«å°¾ï¼‰ï¼Œrepositoryå€¼æ˜¯githubé¡¹ç›®é‡Œçš„sshï¼›</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repository: git@github.com:My/My.github.io.git</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure>

<p>HexoBlogéƒ¨ç½²åˆ°gitï¼Œéœ€è¦å®‰è£…hexo-deployer-gitæ’ä»¶ï¼Œåœ¨blogç›®å½•ä¸‹è¿è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œå®‰è£…ï¼›</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ npm install hexo-deployer-git --save</span><br><span class="line"></span><br><span class="line">npm WARN babel-eslint@10.1.0 requires a peer of eslint@&gt;= 4.12.1 but none is </span><br><span class="line">installed. You must install peer dependencies yourself.</span><br><span class="line"></span><br><span class="line">+ hexo-deployer-git@1.0.0</span><br><span class="line">added 1 package from 1 contributor, removed 4 packages and updated 14 packages in </span><br><span class="line">5.684s</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹æ ¹ç›®å½•ä¸‹_config.ymlæ–‡ä»¶åï¼Œéœ€è¦ä½¿ç”¨$ hexo deployéƒ¨ç½²ä¸€ä¸‹ï¼Œå¦åˆ™ä¿®æ”¹å†…å®¹ä¸ä¼šç”Ÿæ•ˆï¼›</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<h1 id="åäº†"><a href="#åäº†" class="headerlink" title="åäº†"></a>åäº†</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">è¯·ç¡®è®¤æ‚¨æœ‰æ­£ç¡®çš„è®¿é—®æƒé™å¹¶ä¸”ä»“åº“å­˜åœ¨ã€‚</span><br><span class="line">FATAL Something&#x27;s wrong. Maybe you can find the solution here: https://hexo.io/docs/troubleshooting.html</span><br><span class="line">Error: Spawn failed</span><br><span class="line">    at ChildProcess.&lt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kkhm@vm:~/samba/hexo$ ls -a</span><br><span class="line">.   _config.landscape.yml  db.json      .github     node_modules  package-lock.json  scaffolds  themes</span><br><span class="line">..  _config.yml            .deploy_git  .gitignore  package.json  public             source</span><br></pre></td></tr></table></figure>

<p>åˆ é™¤.deploy_gitä¸public</p>
<p>ç„¶å</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo clean</span><br><span class="line">hexo g</span><br><span class="line">hexo d</span><br></pre></td></tr></table></figure>


      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2025/08/21/%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BAhexo%E5%8D%9A%E5%AE%A2/">å±•å¼€å…¨æ–‡ >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-hello-world" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2025/08/21/hello-world/">Hello World</a>
    </h1>
  

        
        <a href="/2025/08/21/hello-world/" class="archive-article-date">
  	<time datetime="2025-08-21T15:11:17.205Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2025-08-21</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
      

      
        <p class="article-more-link">
          <a class="article-more-a" href="/2025/08/21/hello-world/">å±•å¼€å…¨æ–‡ >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
  


          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2025 John Doe
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
<script src="/js/code-copy.js"></script>

    </div>
    <script>
	var yiliaConfig = {
		mathjax: false,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		toc_hide_index: true,
		root: "/",
		innerArchive: true,
		showTags: false
	}
</script>

<script>!function(t){function n(e){if(r[e])return r[e].exports;var i=r[e]={exports:{},id:e,loaded:!1};return t[e].call(i.exports,i,i.exports,n),i.loaded=!0,i.exports}var r={};n.m=t,n.c=r,n.p="./",n(0)}([function(t,n,r){r(195),t.exports=r(191)},function(t,n,r){var e=r(3),i=r(52),o=r(27),u=r(28),c=r(53),f="prototype",a=function(t,n,r){var s,l,h,v,p=t&a.F,d=t&a.G,y=t&a.S,g=t&a.P,b=t&a.B,m=d?e:y?e[n]||(e[n]={}):(e[n]||{})[f],x=d?i:i[n]||(i[n]={}),w=x[f]||(x[f]={});d&&(r=n);for(s in r)l=!p&&m&&void 0!==m[s],h=(l?m:r)[s],v=b&&l?c(h,e):g&&"function"==typeof h?c(Function.call,h):h,m&&u(m,s,h,t&a.U),x[s]!=h&&o(x,s,v),g&&w[s]!=h&&(w[s]=h)};e.core=i,a.F=1,a.G=2,a.S=4,a.P=8,a.B=16,a.W=32,a.U=64,a.R=128,t.exports=a},function(t,n,r){var e=r(6);t.exports=function(t){if(!e(t))throw TypeError(t+" is not an object!");return t}},function(t,n){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n,r){var e=r(126)("wks"),i=r(76),o=r(3).Symbol,u="function"==typeof o;(t.exports=function(t){return e[t]||(e[t]=u&&o[t]||(u?o:i)("Symbol."+t))}).store=e},function(t,n){var r={}.hasOwnProperty;t.exports=function(t,n){return r.call(t,n)}},function(t,n,r){var e=r(94),i=r(33);t.exports=function(t){return e(i(t))}},function(t,n,r){t.exports=!r(4)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(2),i=r(167),o=r(50),u=Object.defineProperty;n.f=r(10)?Object.defineProperty:function(t,n,r){if(e(t),n=o(n,!0),e(r),i)try{return u(t,n,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[n]=r.value),t}},function(t,n,r){t.exports=!r(18)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(14),i=r(22);t.exports=r(12)?function(t,n,r){return e.f(t,n,i(1,r))}:function(t,n,r){return t[n]=r,t}},function(t,n,r){var e=r(20),i=r(58),o=r(42),u=Object.defineProperty;n.f=r(12)?Object.defineProperty:function(t,n,r){if(e(t),n=o(n,!0),e(r),i)try{return u(t,n,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[n]=r.value),t}},function(t,n,r){var e=r(40)("wks"),i=r(23),o=r(5).Symbol,u="function"==typeof o;(t.exports=function(t){return e[t]||(e[t]=u&&o[t]||(u?o:i)("Symbol."+t))}).store=e},function(t,n,r){var e=r(67),i=Math.min;t.exports=function(t){return t>0?i(e(t),9007199254740991):0}},function(t,n,r){var e=r(46);t.exports=function(t){return Object(e(t))}},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n,r){var e=r(63),i=r(34);t.exports=Object.keys||function(t){return e(t,i)}},function(t,n,r){var e=r(21);t.exports=function(t){if(!e(t))throw TypeError(t+" is not an object!");return t}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var r=0,e=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+e).toString(36))}},function(t,n){var r={}.hasOwnProperty;t.exports=function(t,n){return r.call(t,n)}},function(t,n){var r=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=r)},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n,r){var e=r(11),i=r(66);t.exports=r(10)?function(t,n,r){return e.f(t,n,i(1,r))}:function(t,n,r){return t[n]=r,t}},function(t,n,r){var e=r(3),i=r(27),o=r(24),u=r(76)("src"),c="toString",f=Function[c],a=(""+f).split(c);r(52).inspectSource=function(t){return f.call(t)},(t.exports=function(t,n,r,c){var f="function"==typeof r;f&&(o(r,"name")||i(r,"name",n)),t[n]!==r&&(f&&(o(r,u)||i(r,u,t[n]?""+t[n]:a.join(String(n)))),t===e?t[n]=r:c?t[n]?t[n]=r:i(t,n,r):(delete t[n],i(t,n,r)))})(Function.prototype,c,function(){return"function"==typeof this&&this[u]||f.call(this)})},function(t,n,r){var e=r(1),i=r(4),o=r(46),u=function(t,n,r,e){var i=String(o(t)),u="<"+n;return""!==r&&(u+=" "+r+'="'+String(e).replace(/"/g,"&quot;")+'"'),u+">"+i+"</"+n+">"};t.exports=function(t,n){var r={};r[t]=n(u),e(e.P+e.F*i(function(){var n=""[t]('"');return n!==n.toLowerCase()||n.split('"').length>3}),"String",r)}},function(t,n,r){var e=r(115),i=r(46);t.exports=function(t){return e(i(t))}},function(t,n,r){var e=r(116),i=r(66),o=r(30),u=r(50),c=r(24),f=r(167),a=Object.getOwnPropertyDescriptor;n.f=r(10)?a:function(t,n){if(t=o(t),n=u(n,!0),f)try{return a(t,n)}catch(t){}if(c(t,n))return i(!e.f.call(t,n),t[n])}},function(t,n,r){var e=r(24),i=r(17),o=r(145)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=i(t),e(t,o)?t[o]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n){t.exports={}},function(t,n){t.exports=!0},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,r){var e=r(14).f,i=r(8),o=r(15)("toStringTag");t.exports=function(t,n,r){t&&!i(t=r?t:t.prototype,o)&&e(t,o,{configurable:!0,value:n})}},function(t,n,r){var e=r(40)("keys"),i=r(23);t.exports=function(t){return e[t]||(e[t]=i(t))}},function(t,n,r){var e=r(5),i="__core-js_shared__",o=e[i]||(e[i]={});t.exports=function(t){return o[t]||(o[t]={})}},function(t,n){var r=Math.ceil,e=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?e:r)(t)}},function(t,n,r){var e=r(21);t.exports=function(t,n){if(!e(t))return t;var r,i;if(n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;if("function"==typeof(r=t.valueOf)&&!e(i=r.call(t)))return i;if(!n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;throw TypeError("Can't convert object to primitive value")}},function(t,n,r){var e=r(5),i=r(25),o=r(36),u=r(44),c=r(14).f;t.exports=function(t){var n=i.Symbol||(i.Symbol=o?{}:e.Symbol||{});"_"==t.charAt(0)||t in n||c(n,t,{value:u.f(t)})}},function(t,n,r){n.f=r(15)},function(t,n){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n,r){var e=r(4);t.exports=function(t,n){return!!t&&e(function(){n?t.call(null,function(){},1):t.call(null)})}},function(t,n,r){var e=r(53),i=r(115),o=r(17),u=r(16),c=r(203);t.exports=function(t,n){var r=1==t,f=2==t,a=3==t,s=4==t,l=6==t,h=5==t||l,v=n||c;return function(n,c,p){for(var d,y,g=o(n),b=i(g),m=e(c,p,3),x=u(b.length),w=0,S=r?v(n,x):f?v(n,0):void 0;x>w;w++)if((h||w in b)&&(d=b[w],y=m(d,w,g),t))if(r)S[w]=y;else if(y)switch(t){case 3:return!0;case 5:return d;case 6:return w;case 2:S.push(d)}else if(s)return!1;return l?-1:a||s?s:S}}},function(t,n,r){var e=r(1),i=r(52),o=r(4);t.exports=function(t,n){var r=(i.Object||{})[t]||Object[t],u={};u[t]=n(r),e(e.S+e.F*o(function(){r(1)}),"Object",u)}},function(t,n,r){var e=r(6);t.exports=function(t,n){if(!e(t))return t;var r,i;if(n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;if("function"==typeof(r=t.valueOf)&&!e(i=r.call(t)))return i;if(!n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;throw TypeError("Can't convert object to primitive value")}},function(t,n,r){var e=r(5),i=r(25),o=r(91),u=r(13),c="prototype",f=function(t,n,r){var a,s,l,h=t&f.F,v=t&f.G,p=t&f.S,d=t&f.P,y=t&f.B,g=t&f.W,b=v?i:i[n]||(i[n]={}),m=b[c],x=v?e:p?e[n]:(e[n]||{})[c];v&&(r=n);for(a in r)(s=!h&&x&&void 0!==x[a])&&a in b||(l=s?x[a]:r[a],b[a]=v&&"function"!=typeof x[a]?r[a]:y&&s?o(l,e):g&&x[a]==l?function(t){var n=function(n,r,e){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,r)}return new t(n,r,e)}return t.apply(this,arguments)};return n[c]=t[c],n}(l):d&&"function"==typeof l?o(Function.call,l):l,d&&((b.virtual||(b.virtual={}))[a]=l,t&f.R&&m&&!m[a]&&u(m,a,l)))};f.F=1,f.G=2,f.S=4,f.P=8,f.B=16,f.W=32,f.U=64,f.R=128,t.exports=f},function(t,n){var r=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=r)},function(t,n,r){var e=r(26);t.exports=function(t,n,r){if(e(t),void 0===n)return t;switch(r){case 1:return function(r){return t.call(n,r)};case 2:return function(r,e){return t.call(n,r,e)};case 3:return function(r,e,i){return t.call(n,r,e,i)}}return function(){return t.apply(n,arguments)}}},function(t,n,r){var e=r(183),i=r(1),o=r(126)("metadata"),u=o.store||(o.store=new(r(186))),c=function(t,n,r){var i=u.get(t);if(!i){if(!r)return;u.set(t,i=new e)}var o=i.get(n);if(!o){if(!r)return;i.set(n,o=new e)}return o},f=function(t,n,r){var e=c(n,r,!1);return void 0!==e&&e.has(t)},a=function(t,n,r){var e=c(n,r,!1);return void 0===e?void 0:e.get(t)},s=function(t,n,r,e){c(r,e,!0).set(t,n)},l=function(t,n){var r=c(t,n,!1),e=[];return r&&r.forEach(function(t,n){e.push(n)}),e},h=function(t){return void 0===t||"symbol"==typeof t?t:String(t)},v=function(t){i(i.S,"Reflect",t)};t.exports={store:u,map:c,has:f,get:a,set:s,keys:l,key:h,exp:v}},function(t,n,r){"use strict";if(r(10)){var e=r(69),i=r(3),o=r(4),u=r(1),c=r(127),f=r(152),a=r(53),s=r(68),l=r(66),h=r(27),v=r(73),p=r(67),d=r(16),y=r(75),g=r(50),b=r(24),m=r(180),x=r(114),w=r(6),S=r(17),_=r(137),O=r(70),E=r(32),P=r(71).f,j=r(154),F=r(76),M=r(7),A=r(48),N=r(117),T=r(146),I=r(155),k=r(80),L=r(123),R=r(74),C=r(130),D=r(160),U=r(11),W=r(31),G=U.f,B=W.f,V=i.RangeError,z=i.TypeError,q=i.Uint8Array,K="ArrayBuffer",J="Shared"+K,Y="BYTES_PER_ELEMENT",H="prototype",$=Array[H],X=f.ArrayBuffer,Q=f.DataView,Z=A(0),tt=A(2),nt=A(3),rt=A(4),et=A(5),it=A(6),ot=N(!0),ut=N(!1),ct=I.values,ft=I.keys,at=I.entries,st=$.lastIndexOf,lt=$.reduce,ht=$.reduceRight,vt=$.join,pt=$.sort,dt=$.slice,yt=$.toString,gt=$.toLocaleString,bt=M("iterator"),mt=M("toStringTag"),xt=F("typed_constructor"),wt=F("def_constructor"),St=c.CONSTR,_t=c.TYPED,Ot=c.VIEW,Et="Wrong length!",Pt=A(1,function(t,n){return Tt(T(t,t[wt]),n)}),jt=o(function(){return 1===new q(new Uint16Array([1]).buffer)[0]}),Ft=!!q&&!!q[H].set&&o(function(){new q(1).set({})}),Mt=function(t,n){if(void 0===t)throw z(Et);var r=+t,e=d(t);if(n&&!m(r,e))throw V(Et);return e},At=function(t,n){var r=p(t);if(r<0||r%n)throw V("Wrong offset!");return r},Nt=function(t){if(w(t)&&_t in t)return t;throw z(t+" is not a typed array!")},Tt=function(t,n){if(!(w(t)&&xt in t))throw z("It is not a typed array constructor!");return new t(n)},It=function(t,n){return kt(T(t,t[wt]),n)},kt=function(t,n){for(var r=0,e=n.length,i=Tt(t,e);e>r;)i[r]=n[r++];return i},Lt=function(t,n,r){G(t,n,{get:function(){return this._d[r]}})},Rt=function(t){var n,r,e,i,o,u,c=S(t),f=arguments.length,s=f>1?arguments[1]:void 0,l=void 0!==s,h=j(c);if(void 0!=h&&!_(h)){for(u=h.call(c),e=[],n=0;!(o=u.next()).done;n++)e.push(o.value);c=e}for(l&&f>2&&(s=a(s,arguments[2],2)),n=0,r=d(c.length),i=Tt(this,r);r>n;n++)i[n]=l?s(c[n],n):c[n];return i},Ct=function(){for(var t=0,n=arguments.length,r=Tt(this,n);n>t;)r[t]=arguments[t++];return r},Dt=!!q&&o(function(){gt.call(new q(1))}),Ut=function(){return gt.apply(Dt?dt.call(Nt(this)):Nt(this),arguments)},Wt={copyWithin:function(t,n){return D.call(Nt(this),t,n,arguments.length>2?arguments[2]:void 0)},every:function(t){return rt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},fill:function(t){return C.apply(Nt(this),arguments)},filter:function(t){return It(this,tt(Nt(this),t,arguments.length>1?arguments[1]:void 0))},find:function(t){return et(Nt(this),t,arguments.length>1?arguments[1]:void 0)},findIndex:function(t){return it(Nt(this),t,arguments.length>1?arguments[1]:void 0)},forEach:function(t){Z(Nt(this),t,arguments.length>1?arguments[1]:void 0)},indexOf:function(t){return ut(Nt(this),t,arguments.length>1?arguments[1]:void 0)},includes:function(t){return ot(Nt(this),t,arguments.length>1?arguments[1]:void 0)},join:function(t){return vt.apply(Nt(this),arguments)},lastIndexOf:function(t){return st.apply(Nt(this),arguments)},map:function(t){return Pt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},reduce:function(t){return lt.apply(Nt(this),arguments)},reduceRight:function(t){return ht.apply(Nt(this),arguments)},reverse:function(){for(var t,n=this,r=Nt(n).length,e=Math.floor(r/2),i=0;i<e;)t=n[i],n[i++]=n[--r],n[r]=t;return n},some:function(t){return nt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},sort:function(t){return pt.call(Nt(this),t)},subarray:function(t,n){var r=Nt(this),e=r.length,i=y(t,e);return new(T(r,r[wt]))(r.buffer,r.byteOffset+i*r.BYTES_PER_ELEMENT,d((void 0===n?e:y(n,e))-i))}},Gt=function(t,n){return It(this,dt.call(Nt(this),t,n))},Bt=function(t){Nt(this);var n=At(arguments[1],1),r=this.length,e=S(t),i=d(e.length),o=0;if(i+n>r)throw V(Et);for(;o<i;)this[n+o]=e[o++]},Vt={entries:function(){return at.call(Nt(this))},keys:function(){return ft.call(Nt(this))},values:function(){return ct.call(Nt(this))}},zt=function(t,n){return w(t)&&t[_t]&&"symbol"!=typeof n&&n in t&&String(+n)==String(n)},qt=function(t,n){return zt(t,n=g(n,!0))?l(2,t[n]):B(t,n)},Kt=function(t,n,r){return!(zt(t,n=g(n,!0))&&w(r)&&b(r,"value"))||b(r,"get")||b(r,"set")||r.configurable||b(r,"writable")&&!r.writable||b(r,"enumerable")&&!r.enumerable?G(t,n,r):(t[n]=r.value,t)};St||(W.f=qt,U.f=Kt),u(u.S+u.F*!St,"Object",{getOwnPropertyDescriptor:qt,defineProperty:Kt}),o(function(){yt.call({})})&&(yt=gt=function(){return vt.call(this)});var Jt=v({},Wt);v(Jt,Vt),h(Jt,bt,Vt.values),v(Jt,{slice:Gt,set:Bt,constructor:function(){},toString:yt,toLocaleString:Ut}),Lt(Jt,"buffer","b"),Lt(Jt,"byteOffset","o"),Lt(Jt,"byteLength","l"),Lt(Jt,"length","e"),G(Jt,mt,{get:function(){return this[_t]}}),t.exports=function(t,n,r,f){f=!!f;var a=t+(f?"Clamped":"")+"Array",l="Uint8Array"!=a,v="get"+t,p="set"+t,y=i[a],g=y||{},b=y&&E(y),m=!y||!c.ABV,S={},_=y&&y[H],j=function(t,r){var e=t._d;return e.v[v](r*n+e.o,jt)},F=function(t,r,e){var i=t._d;f&&(e=(e=Math.round(e))<0?0:e>255?255:255&e),i.v[p](r*n+i.o,e,jt)},M=function(t,n){G(t,n,{get:function(){return j(this,n)},set:function(t){return F(this,n,t)},enumerable:!0})};m?(y=r(function(t,r,e,i){s(t,y,a,"_d");var o,u,c,f,l=0,v=0;if(w(r)){if(!(r instanceof X||(f=x(r))==K||f==J))return _t in r?kt(y,r):Rt.call(y,r);o=r,v=At(e,n);var p=r.byteLength;if(void 0===i){if(p%n)throw V(Et);if((u=p-v)<0)throw V(Et)}else if((u=d(i)*n)+v>p)throw V(Et);c=u/n}else c=Mt(r,!0),u=c*n,o=new X(u);for(h(t,"_d",{b:o,o:v,l:u,e:c,v:new Q(o)});l<c;)M(t,l++)}),_=y[H]=O(Jt),h(_,"constructor",y)):L(function(t){new y(null),new y(t)},!0)||(y=r(function(t,r,e,i){s(t,y,a);var o;return w(r)?r instanceof X||(o=x(r))==K||o==J?void 0!==i?new g(r,At(e,n),i):void 0!==e?new g(r,At(e,n)):new g(r):_t in r?kt(y,r):Rt.call(y,r):new g(Mt(r,l))}),Z(b!==Function.prototype?P(g).concat(P(b)):P(g),function(t){t in y||h(y,t,g[t])}),y[H]=_,e||(_.constructor=y));var A=_[bt],N=!!A&&("values"==A.name||void 0==A.name),T=Vt.values;h(y,xt,!0),h(_,_t,a),h(_,Ot,!0),h(_,wt,y),(f?new y(1)[mt]==a:mt in _)||G(_,mt,{get:function(){return a}}),S[a]=y,u(u.G+u.W+u.F*(y!=g),S),u(u.S,a,{BYTES_PER_ELEMENT:n,from:Rt,of:Ct}),Y in _||h(_,Y,n),u(u.P,a,Wt),R(a),u(u.P+u.F*Ft,a,{set:Bt}),u(u.P+u.F*!N,a,Vt),u(u.P+u.F*(_.toString!=yt),a,{toString:yt}),u(u.P+u.F*o(function(){new y(1).slice()}),a,{slice:Gt}),u(u.P+u.F*(o(function(){return[1,2].toLocaleString()!=new y([1,2]).toLocaleString()})||!o(function(){_.toLocaleString.call([1,2])})),a,{toLocaleString:Ut}),k[a]=N?A:T,e||N||h(_,bt,T)}}else t.exports=function(){}},function(t,n){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,n,r){var e=r(21),i=r(5).document,o=e(i)&&e(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,n,r){t.exports=!r(12)&&!r(18)(function(){return 7!=Object.defineProperty(r(57)("div"),"a",{get:function(){return 7}}).a})},function(t,n,r){"use strict";var e=r(36),i=r(51),o=r(64),u=r(13),c=r(8),f=r(35),a=r(96),s=r(38),l=r(103),h=r(15)("iterator"),v=!([].keys&&"next"in[].keys()),p="keys",d="values",y=function(){return this};t.exports=function(t,n,r,g,b,m,x){a(r,n,g);var w,S,_,O=function(t){if(!v&&t in F)return F[t];switch(t){case p:case d:return function(){return new r(this,t)}}return function(){return new r(this,t)}},E=n+" Iterator",P=b==d,j=!1,F=t.prototype,M=F[h]||F["@@iterator"]||b&&F[b],A=M||O(b),N=b?P?O("entries"):A:void 0,T="Array"==n?F.entries||M:M;if(T&&(_=l(T.call(new t)))!==Object.prototype&&(s(_,E,!0),e||c(_,h)||u(_,h,y)),P&&M&&M.name!==d&&(j=!0,A=function(){return M.call(this)}),e&&!x||!v&&!j&&F[h]||u(F,h,A),f[n]=A,f[E]=y,b)if(w={values:P?A:O(d),keys:m?A:O(p),entries:N},x)for(S in w)S in F||o(F,S,w[S]);else i(i.P+i.F*(v||j),n,w);return w}},function(t,n,r){var e=r(20),i=r(100),o=r(34),u=r(39)("IE_PROTO"),c=function(){},f="prototype",a=function(){var t,n=r(57)("iframe"),e=o.length;for(n.style.display="none",r(93).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write("<script>document.F=Object<\/script>"),t.close(),a=t.F;e--;)delete a[f][o[e]];return a()};t.exports=Object.create||function(t,n){var r;return null!==t?(c[f]=e(t),r=new c,c[f]=null,r[u]=t):r=a(),void 0===n?r:i(r,n)}},function(t,n,r){var e=r(63),i=r(34).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return e(t,i)}},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,r){var e=r(8),i=r(9),o=r(90)(!1),u=r(39)("IE_PROTO");t.exports=function(t,n){var r,c=i(t),f=0,a=[];for(r in c)r!=u&&e(c,r)&&a.push(r);for(;n.length>f;)e(c,r=n[f++])&&(~o(a,r)||a.push(r));return a}},function(t,n,r){t.exports=r(13)},function(t,n,r){var e=r(76)("meta"),i=r(6),o=r(24),u=r(11).f,c=0,f=Object.isExtensible||function(){return!0},a=!r(4)(function(){return f(Object.preventExtensions({}))}),s=function(t){u(t,e,{value:{i:"O"+ ++c,w:{}}})},l=function(t,n){if(!i(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!o(t,e)){if(!f(t))return"F";if(!n)return"E";s(t)}return t[e].i},h=function(t,n){if(!o(t,e)){if(!f(t))return!0;if(!n)return!1;s(t)}return t[e].w},v=function(t){return a&&p.NEED&&f(t)&&!o(t,e)&&s(t),t},p=t.exports={KEY:e,NEED:!1,fastKey:l,getWeak:h,onFreeze:v}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var r=Math.ceil,e=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?e:r)(t)}},function(t,n){t.exports=function(t,n,r,e){if(!(t instanceof n)||void 0!==e&&e in t)throw TypeError(r+": incorrect invocation!");return t}},function(t,n){t.exports=!1},function(t,n,r){var e=r(2),i=r(173),o=r(133),u=r(145)("IE_PROTO"),c=function(){},f="prototype",a=function(){var t,n=r(132)("iframe"),e=o.length;for(n.style.display="none",r(135).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write("<script>document.F=Object<\/script>"),t.close(),a=t.F;e--;)delete a[f][o[e]];return a()};t.exports=Object.create||function(t,n){var r;return null!==t?(c[f]=e(t),r=new c,c[f]=null,r[u]=t):r=a(),void 0===n?r:i(r,n)}},function(t,n,r){var e=r(175),i=r(133).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return e(t,i)}},function(t,n,r){var e=r(175),i=r(133);t.exports=Object.keys||function(t){return e(t,i)}},function(t,n,r){var e=r(28);t.exports=function(t,n,r){for(var i in n)e(t,i,n[i],r);return t}},function(t,n,r){"use strict";var e=r(3),i=r(11),o=r(10),u=r(7)("species");t.exports=function(t){var n=e[t];o&&n&&!n[u]&&i.f(n,u,{configurable:!0,get:function(){return this}})}},function(t,n,r){var e=r(67),i=Math.max,o=Math.min;t.exports=function(t,n){return t=e(t),t<0?i(t+n,0):o(t,n)}},function(t,n){var r=0,e=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+e).toString(36))}},function(t,n,r){var e=r(33);t.exports=function(t){return Object(e(t))}},function(t,n,r){var e=r(7)("unscopables"),i=Array.prototype;void 0==i[e]&&r(27)(i,e,{}),t.exports=function(t){i[e][t]=!0}},function(t,n,r){var e=r(53),i=r(169),o=r(137),u=r(2),c=r(16),f=r(154),a={},s={},n=t.exports=function(t,n,r,l,h){var v,p,d,y,g=h?function(){return t}:f(t),b=e(r,l,n?2:1),m=0;if("function"!=typeof g)throw TypeError(t+" is not iterable!");if(o(g)){for(v=c(t.length);v>m;m++)if((y=n?b(u(p=t[m])[0],p[1]):b(t[m]))===a||y===s)return y}else for(d=g.call(t);!(p=d.next()).done;)if((y=i(d,b,p.value,n))===a||y===s)return y};n.BREAK=a,n.RETURN=s},function(t,n){t.exports={}},function(t,n,r){var e=r(11).f,i=r(24),o=r(7)("toStringTag");t.exports=function(t,n,r){t&&!i(t=r?t:t.prototype,o)&&e(t,o,{configurable:!0,value:n})}},function(t,n,r){var e=r(1),i=r(46),o=r(4),u=r(150),c="["+u+"]",f="â€‹Â…",a=RegExp("^"+c+c+"*"),s=RegExp(c+c+"*$"),l=function(t,n,r){var i={},c=o(function(){return!!u[t]()||f[t]()!=f}),a=i[t]=c?n(h):u[t];r&&(i[r]=a),e(e.P+e.F*c,"String",i)},h=l.trim=function(t,n){return t=String(i(t)),1&n&&(t=t.replace(a,"")),2&n&&(t=t.replace(s,"")),t};t.exports=l},function(t,n,r){t.exports={default:r(86),__esModule:!0}},function(t,n,r){t.exports={default:r(87),__esModule:!0}},function(t,n,r){"use strict";function e(t){return t&&t.__esModule?t:{default:t}}n.__esModule=!0;var i=r(84),o=e(i),u=r(83),c=e(u),f="function"==typeof c.default&&"symbol"==typeof o.default?function(t){return typeof t}:function(t){return t&&"function"==typeof c.default&&t.constructor===c.default&&t!==c.default.prototype?"symbol":typeof t};n.default="function"==typeof c.default&&"symbol"===f(o.default)?function(t){return void 0===t?"undefined":f(t)}:function(t){return t&&"function"==typeof c.default&&t.constructor===c.default&&t!==c.default.prototype?"symbol":void 0===t?"undefined":f(t)}},function(t,n,r){r(110),r(108),r(111),r(112),t.exports=r(25).Symbol},function(t,n,r){r(109),r(113),t.exports=r(44).f("iterator")},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n){t.exports=function(){}},function(t,n,r){var e=r(9),i=r(106),o=r(105);t.exports=function(t){return function(n,r,u){var c,f=e(n),a=i(f.length),s=o(u,a);if(t&&r!=r){for(;a>s;)if((c=f[s++])!=c)return!0}else for(;a>s;s++)if((t||s in f)&&f[s]===r)return t||s||0;return!t&&-1}}},function(t,n,r){var e=r(88);t.exports=function(t,n,r){if(e(t),void 0===n)return t;switch(r){case 1:return function(r){return t.call(n,r)};case 2:return function(r,e){return t.call(n,r,e)};case 3:return function(r,e,i){return t.call(n,r,e,i)}}return function(){return t.apply(n,arguments)}}},function(t,n,r){var e=r(19),i=r(62),o=r(37);t.exports=function(t){var n=e(t),r=i.f;if(r)for(var u,c=r(t),f=o.f,a=0;c.length>a;)f.call(t,u=c[a++])&&n.push(u);return n}},function(t,n,r){t.exports=r(5).document&&document.documentElement},function(t,n,r){var e=r(56);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==e(t)?t.split(""):Object(t)}},function(t,n,r){var e=r(56);t.exports=Array.isArray||function(t){return"Array"==e(t)}},function(t,n,r){"use strict";var e=r(60),i=r(22),o=r(38),u={};r(13)(u,r(15)("iterator"),function(){return this}),t.exports=function(t,n,r){t.prototype=e(u,{next:i(1,r)}),o(t,n+" Iterator")}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,r){var e=r(19),i=r(9);t.exports=function(t,n){for(var r,o=i(t),u=e(o),c=u.length,f=0;c>f;)if(o[r=u[f++]]===n)return r}},function(t,n,r){var e=r(23)("meta"),i=r(21),o=r(8),u=r(14).f,c=0,f=Object.isExtensible||function(){return!0},a=!r(18)(function(){return f(Object.preventExtensions({}))}),s=function(t){u(t,e,{value:{i:"O"+ ++c,w:{}}})},l=function(t,n){if(!i(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!o(t,e)){if(!f(t))return"F";if(!n)return"E";s(t)}return t[e].i},h=function(t,n){if(!o(t,e)){if(!f(t))return!0;if(!n)return!1;s(t)}return t[e].w},v=function(t){return a&&p.NEED&&f(t)&&!o(t,e)&&s(t),t},p=t.exports={KEY:e,NEED:!1,fastKey:l,getWeak:h,onFreeze:v}},function(t,n,r){var e=r(14),i=r(20),o=r(19);t.exports=r(12)?Object.defineProperties:function(t,n){i(t);for(var r,u=o(n),c=u.length,f=0;c>f;)e.f(t,r=u[f++],n[r]);return t}},function(t,n,r){var e=r(37),i=r(22),o=r(9),u=r(42),c=r(8),f=r(58),a=Object.getOwnPropertyDescriptor;n.f=r(12)?a:function(t,n){if(t=o(t),n=u(n,!0),f)try{return a(t,n)}catch(t){}if(c(t,n))return i(!e.f.call(t,n),t[n])}},function(t,n,r){var e=r(9),i=r(61).f,o={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],c=function(t){try{return i(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==o.call(t)?c(t):i(e(t))}},function(t,n,r){var e=r(8),i=r(77),o=r(39)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=i(t),e(t,o)?t[o]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,r){var e=r(41),i=r(33);t.exports=function(t){return function(n,r){var o,u,c=String(i(n)),f=e(r),a=c.length;return f<0||f>=a?t?"":void 0:(o=c.charCodeAt(f),o<55296||o>56319||f+1===a||(u=c.charCodeAt(f+1))<56320||u>57343?t?c.charAt(f):o:t?c.slice(f,f+2):u-56320+(o-55296<<10)+65536)}}},function(t,n,r){var e=r(41),i=Math.max,o=Math.min;t.exports=function(t,n){return t=e(t),t<0?i(t+n,0):o(t,n)}},function(t,n,r){var e=r(41),i=Math.min;t.exports=function(t){return t>0?i(e(t),9007199254740991):0}},function(t,n,r){"use strict";var e=r(89),i=r(97),o=r(35),u=r(9);t.exports=r(59)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,i(1)):"keys"==n?i(0,r):"values"==n?i(0,t[r]):i(0,[r,t[r]])},"values"),o.Arguments=o.Array,e("keys"),e("values"),e("entries")},function(t,n){},function(t,n,r){"use strict";var e=r(104)(!0);r(59)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,r=this._i;return r>=n.length?{value:void 0,done:!0}:(t=e(n,r),this._i+=t.length,{value:t,done:!1})})},function(t,n,r){"use strict";var e=r(5),i=r(8),o=r(12),u=r(51),c=r(64),f=r(99).KEY,a=r(18),s=r(40),l=r(38),h=r(23),v=r(15),p=r(44),d=r(43),y=r(98),g=r(92),b=r(95),m=r(20),x=r(9),w=r(42),S=r(22),_=r(60),O=r(102),E=r(101),P=r(14),j=r(19),F=E.f,M=P.f,A=O.f,N=e.Symbol,T=e.JSON,I=T&&T.stringify,k="prototype",L=v("_hidden"),R=v("toPrimitive"),C={}.propertyIsEnumerable,D=s("symbol-registry"),U=s("symbols"),W=s("op-symbols"),G=Object[k],B="function"==typeof N,V=e.QObject,z=!V||!V[k]||!V[k].findChild,q=o&&a(function(){return 7!=_(M({},"a",{get:function(){return M(this,"a",{value:7}).a}})).a})?function(t,n,r){var e=F(G,n);e&&delete G[n],M(t,n,r),e&&t!==G&&M(G,n,e)}:M,K=function(t){var n=U[t]=_(N[k]);return n._k=t,n},J=B&&"symbol"==typeof N.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof N},Y=function(t,n,r){return t===G&&Y(W,n,r),m(t),n=w(n,!0),m(r),i(U,n)?(r.enumerable?(i(t,L)&&t[L][n]&&(t[L][n]=!1),r=_(r,{enumerable:S(0,!1)})):(i(t,L)||M(t,L,S(1,{})),t[L][n]=!0),q(t,n,r)):M(t,n,r)},H=function(t,n){m(t);for(var r,e=g(n=x(n)),i=0,o=e.length;o>i;)Y(t,r=e[i++],n[r]);return t},$=function(t,n){return void 0===n?_(t):H(_(t),n)},X=function(t){var n=C.call(this,t=w(t,!0));return!(this===G&&i(U,t)&&!i(W,t))&&(!(n||!i(this,t)||!i(U,t)||i(this,L)&&this[L][t])||n)},Q=function(t,n){if(t=x(t),n=w(n,!0),t!==G||!i(U,n)||i(W,n)){var r=F(t,n);return!r||!i(U,n)||i(t,L)&&t[L][n]||(r.enumerable=!0),r}},Z=function(t){for(var n,r=A(x(t)),e=[],o=0;r.length>o;)i(U,n=r[o++])||n==L||n==f||e.push(n);return e},tt=function(t){for(var n,r=t===G,e=A(r?W:x(t)),o=[],u=0;e.length>u;)!i(U,n=e[u++])||r&&!i(G,n)||o.push(U[n]);return o};B||(N=function(){if(this instanceof N)throw TypeError("Symbol is not a constructor!");var t=h(arguments.length>0?arguments[0]:void 0),n=function(r){this===G&&n.call(W,r),i(this,L)&&i(this[L],t)&&(this[L][t]=!1),q(this,t,S(1,r))};return o&&z&&q(G,t,{configurable:!0,set:n}),K(t)},c(N[k],"toString",function(){return this._k}),E.f=Q,P.f=Y,r(61).f=O.f=Z,r(37).f=X,r(62).f=tt,o&&!r(36)&&c(G,"propertyIsEnumerable",X,!0),p.f=function(t){return K(v(t))}),u(u.G+u.W+u.F*!B,{Symbol:N});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),rt=0;nt.length>rt;)v(nt[rt++]);for(var nt=j(v.store),rt=0;nt.length>rt;)d(nt[rt++]);u(u.S+u.F*!B,"Symbol",{for:function(t){return i(D,t+="")?D[t]:D[t]=N(t)},keyFor:function(t){if(J(t))return y(D,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){z=!0},useSimple:function(){z=!1}}),u(u.S+u.F*!B,"Object",{create:$,defineProperty:Y,defineProperties:H,getOwnPropertyDescriptor:Q,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),T&&u(u.S+u.F*(!B||a(function(){var t=N();return"[null]"!=I([t])||"{}"!=I({a:t})||"{}"!=I(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!J(t)){for(var n,r,e=[t],i=1;arguments.length>i;)e.push(arguments[i++]);return n=e[1],"function"==typeof n&&(r=n),!r&&b(n)||(n=function(t,n){if(r&&(n=r.call(this,t,n)),!J(n))return n}),e[1]=n,I.apply(T,e)}}}),N[k][R]||r(13)(N[k],R,N[k].valueOf),l(N,"Symbol"),l(Math,"Math",!0),l(e.JSON,"JSON",!0)},function(t,n,r){r(43)("asyncIterator")},function(t,n,r){r(43)("observable")},function(t,n,r){r(107);for(var e=r(5),i=r(13),o=r(35),u=r(15)("toStringTag"),c=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],f=0;f<5;f++){var a=c[f],s=e[a],l=s&&s.prototype;l&&!l[u]&&i(l,u,a),o[a]=o.Array}},function(t,n,r){var e=r(45),i=r(7)("toStringTag"),o="Arguments"==e(function(){return arguments}()),u=function(t,n){try{return t[n]}catch(t){}};t.exports=function(t){var n,r,c;return void 0===t?"Undefined":null===t?"Null":"string"==typeof(r=u(n=Object(t),i))?r:o?e(n):"Object"==(c=e(n))&&"function"==typeof n.callee?"Arguments":c}},function(t,n,r){var e=r(45);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==e(t)?t.split(""):Object(t)}},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,r){var e=r(30),i=r(16),o=r(75);t.exports=function(t){return function(n,r,u){var c,f=e(n),a=i(f.length),s=o(u,a);if(t&&r!=r){for(;a>s;)if((c=f[s++])!=c)return!0}else for(;a>s;s++)if((t||s in f)&&f[s]===r)return t||s||0;return!t&&-1}}},function(t,n,r){"use strict";var e=r(3),i=r(1),o=r(28),u=r(73),c=r(65),f=r(79),a=r(68),s=r(6),l=r(4),h=r(123),v=r(81),p=r(136);t.exports=function(t,n,r,d,y,g){var b=e[t],m=b,x=y?"set":"add",w=m&&m.prototype,S={},_=function(t){var n=w[t];o(w,t,"delete"==t?function(t){return!(g&&!s(t))&&n.call(this,0===t?0:t)}:"has"==t?function(t){return!(g&&!s(t))&&n.call(this,0===t?0:t)}:"get"==t?function(t){return g&&!s(t)?void 0:n.call(this,0===t?0:t)}:"add"==t?function(t){return n.call(this,0===t?0:t),this}:function(t,r){return n.call(this,0===t?0:t,r),this})};if("function"==typeof m&&(g||w.forEach&&!l(function(){(new m).entries().next()}))){var O=new m,E=O[x](g?{}:-0,1)!=O,P=l(function(){O.has(1)}),j=h(function(t){new m(t)}),F=!g&&l(function(){for(var t=new m,n=5;n--;)t[x](n,n);return!t.has(-0)});j||(m=n(function(n,r){a(n,m,t);var e=p(new b,n,m);return void 0!=r&&f(r,y,e[x],e),e}),m.prototype=w,w.constructor=m),(P||F)&&(_("delete"),_("has"),y&&_("get")),(F||E)&&_(x),g&&w.clear&&delete w.clear}else m=d.getConstructor(n,t,y,x),u(m.prototype,r),c.NEED=!0;return v(m,t),S[t]=m,i(i.G+i.W+i.F*(m!=b),S),g||d.setStrong(m,t,y),m}},function(t,n,r){"use strict";var e=r(27),i=r(28),o=r(4),u=r(46),c=r(7);t.exports=function(t,n,r){var f=c(t),a=r(u,f,""[t]),s=a[0],l=a[1];o(function(){var n={};return n[f]=function(){return 7},7!=""[t](n)})&&(i(String.prototype,t,s),e(RegExp.prototype,f,2==n?function(t,n){return l.call(t,this,n)}:function(t){return l.call(t,this)}))}
},function(t,n,r){"use strict";var e=r(2);t.exports=function(){var t=e(this),n="";return t.global&&(n+="g"),t.ignoreCase&&(n+="i"),t.multiline&&(n+="m"),t.unicode&&(n+="u"),t.sticky&&(n+="y"),n}},function(t,n){t.exports=function(t,n,r){var e=void 0===r;switch(n.length){case 0:return e?t():t.call(r);case 1:return e?t(n[0]):t.call(r,n[0]);case 2:return e?t(n[0],n[1]):t.call(r,n[0],n[1]);case 3:return e?t(n[0],n[1],n[2]):t.call(r,n[0],n[1],n[2]);case 4:return e?t(n[0],n[1],n[2],n[3]):t.call(r,n[0],n[1],n[2],n[3])}return t.apply(r,n)}},function(t,n,r){var e=r(6),i=r(45),o=r(7)("match");t.exports=function(t){var n;return e(t)&&(void 0!==(n=t[o])?!!n:"RegExp"==i(t))}},function(t,n,r){var e=r(7)("iterator"),i=!1;try{var o=[7][e]();o.return=function(){i=!0},Array.from(o,function(){throw 2})}catch(t){}t.exports=function(t,n){if(!n&&!i)return!1;var r=!1;try{var o=[7],u=o[e]();u.next=function(){return{done:r=!0}},o[e]=function(){return u},t(o)}catch(t){}return r}},function(t,n,r){t.exports=r(69)||!r(4)(function(){var t=Math.random();__defineSetter__.call(null,t,function(){}),delete r(3)[t]})},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,r){var e=r(3),i="__core-js_shared__",o=e[i]||(e[i]={});t.exports=function(t){return o[t]||(o[t]={})}},function(t,n,r){for(var e,i=r(3),o=r(27),u=r(76),c=u("typed_array"),f=u("view"),a=!(!i.ArrayBuffer||!i.DataView),s=a,l=0,h="Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array".split(",");l<9;)(e=i[h[l++]])?(o(e.prototype,c,!0),o(e.prototype,f,!0)):s=!1;t.exports={ABV:a,CONSTR:s,TYPED:c,VIEW:f}},function(t,n){"use strict";var r={versions:function(){var t=window.navigator.userAgent;return{trident:t.indexOf("Trident")>-1,presto:t.indexOf("Presto")>-1,webKit:t.indexOf("AppleWebKit")>-1,gecko:t.indexOf("Gecko")>-1&&-1==t.indexOf("KHTML"),mobile:!!t.match(/AppleWebKit.*Mobile.*/),ios:!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:t.indexOf("Android")>-1||t.indexOf("Linux")>-1,iPhone:t.indexOf("iPhone")>-1||t.indexOf("Mac")>-1,iPad:t.indexOf("iPad")>-1,webApp:-1==t.indexOf("Safari"),weixin:-1==t.indexOf("MicroMessenger")}}()};t.exports=r},function(t,n,r){"use strict";var e=r(85),i=function(t){return t&&t.__esModule?t:{default:t}}(e),o=function(){function t(t,n,e){return n||e?String.fromCharCode(n||e):r[t]||t}function n(t){return e[t]}var r={"&quot;":'"',"&lt;":"<","&gt;":">","&amp;":"&","&nbsp;":" "},e={};for(var u in r)e[r[u]]=u;return r["&apos;"]="'",e["'"]="&#39;",{encode:function(t){return t?(""+t).replace(/['<> "&]/g,n).replace(/\r?\n/g,"<br/>").replace(/\s/g,"&nbsp;"):""},decode:function(n){return n?(""+n).replace(/<br\s*\/?>/gi,"\n").replace(/&quot;|&lt;|&gt;|&amp;|&nbsp;|&apos;|&#(\d+);|&#(\d+)/g,t).replace(/\u00a0/g," "):""},encodeBase16:function(t){if(!t)return t;t+="";for(var n=[],r=0,e=t.length;e>r;r++)n.push(t.charCodeAt(r).toString(16).toUpperCase());return n.join("")},encodeBase16forJSON:function(t){if(!t)return t;t=t.replace(/[\u4E00-\u9FBF]/gi,function(t){return escape(t).replace("%u","\\u")});for(var n=[],r=0,e=t.length;e>r;r++)n.push(t.charCodeAt(r).toString(16).toUpperCase());return n.join("")},decodeBase16:function(t){if(!t)return t;t+="";for(var n=[],r=0,e=t.length;e>r;r+=2)n.push(String.fromCharCode("0x"+t.slice(r,r+2)));return n.join("")},encodeObject:function(t){if(t instanceof Array)for(var n=0,r=t.length;r>n;n++)t[n]=o.encodeObject(t[n]);else if("object"==(void 0===t?"undefined":(0,i.default)(t)))for(var e in t)t[e]=o.encodeObject(t[e]);else if("string"==typeof t)return o.encode(t);return t},loadScript:function(t){var n=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(n),n.setAttribute("src",t)},addLoadEvent:function(t){var n=window.onload;"function"!=typeof window.onload?window.onload=t:window.onload=function(){n(),t()}}}}();t.exports=o},function(t,n,r){"use strict";var e=r(17),i=r(75),o=r(16);t.exports=function(t){for(var n=e(this),r=o(n.length),u=arguments.length,c=i(u>1?arguments[1]:void 0,r),f=u>2?arguments[2]:void 0,a=void 0===f?r:i(f,r);a>c;)n[c++]=t;return n}},function(t,n,r){"use strict";var e=r(11),i=r(66);t.exports=function(t,n,r){n in t?e.f(t,n,i(0,r)):t[n]=r}},function(t,n,r){var e=r(6),i=r(3).document,o=e(i)&&e(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n,r){var e=r(7)("match");t.exports=function(t){var n=/./;try{"/./"[t](n)}catch(r){try{return n[e]=!1,!"/./"[t](n)}catch(t){}}return!0}},function(t,n,r){t.exports=r(3).document&&document.documentElement},function(t,n,r){var e=r(6),i=r(144).set;t.exports=function(t,n,r){var o,u=n.constructor;return u!==r&&"function"==typeof u&&(o=u.prototype)!==r.prototype&&e(o)&&i&&i(t,o),t}},function(t,n,r){var e=r(80),i=r(7)("iterator"),o=Array.prototype;t.exports=function(t){return void 0!==t&&(e.Array===t||o[i]===t)}},function(t,n,r){var e=r(45);t.exports=Array.isArray||function(t){return"Array"==e(t)}},function(t,n,r){"use strict";var e=r(70),i=r(66),o=r(81),u={};r(27)(u,r(7)("iterator"),function(){return this}),t.exports=function(t,n,r){t.prototype=e(u,{next:i(1,r)}),o(t,n+" Iterator")}},function(t,n,r){"use strict";var e=r(69),i=r(1),o=r(28),u=r(27),c=r(24),f=r(80),a=r(139),s=r(81),l=r(32),h=r(7)("iterator"),v=!([].keys&&"next"in[].keys()),p="keys",d="values",y=function(){return this};t.exports=function(t,n,r,g,b,m,x){a(r,n,g);var w,S,_,O=function(t){if(!v&&t in F)return F[t];switch(t){case p:case d:return function(){return new r(this,t)}}return function(){return new r(this,t)}},E=n+" Iterator",P=b==d,j=!1,F=t.prototype,M=F[h]||F["@@iterator"]||b&&F[b],A=M||O(b),N=b?P?O("entries"):A:void 0,T="Array"==n?F.entries||M:M;if(T&&(_=l(T.call(new t)))!==Object.prototype&&(s(_,E,!0),e||c(_,h)||u(_,h,y)),P&&M&&M.name!==d&&(j=!0,A=function(){return M.call(this)}),e&&!x||!v&&!j&&F[h]||u(F,h,A),f[n]=A,f[E]=y,b)if(w={values:P?A:O(d),keys:m?A:O(p),entries:N},x)for(S in w)S in F||o(F,S,w[S]);else i(i.P+i.F*(v||j),n,w);return w}},function(t,n){var r=Math.expm1;t.exports=!r||r(10)>22025.465794806718||r(10)<22025.465794806718||-2e-17!=r(-2e-17)?function(t){return 0==(t=+t)?t:t>-1e-6&&t<1e-6?t+t*t/2:Math.exp(t)-1}:r},function(t,n){t.exports=Math.sign||function(t){return 0==(t=+t)||t!=t?t:t<0?-1:1}},function(t,n,r){var e=r(3),i=r(151).set,o=e.MutationObserver||e.WebKitMutationObserver,u=e.process,c=e.Promise,f="process"==r(45)(u);t.exports=function(){var t,n,r,a=function(){var e,i;for(f&&(e=u.domain)&&e.exit();t;){i=t.fn,t=t.next;try{i()}catch(e){throw t?r():n=void 0,e}}n=void 0,e&&e.enter()};if(f)r=function(){u.nextTick(a)};else if(o){var s=!0,l=document.createTextNode("");new o(a).observe(l,{characterData:!0}),r=function(){l.data=s=!s}}else if(c&&c.resolve){var h=c.resolve();r=function(){h.then(a)}}else r=function(){i.call(e,a)};return function(e){var i={fn:e,next:void 0};n&&(n.next=i),t||(t=i,r()),n=i}}},function(t,n,r){var e=r(6),i=r(2),o=function(t,n){if(i(t),!e(n)&&null!==n)throw TypeError(n+": can't set as prototype!")};t.exports={set:Object.setPrototypeOf||("__proto__"in{}?function(t,n,e){try{e=r(53)(Function.call,r(31).f(Object.prototype,"__proto__").set,2),e(t,[]),n=!(t instanceof Array)}catch(t){n=!0}return function(t,r){return o(t,r),n?t.__proto__=r:e(t,r),t}}({},!1):void 0),check:o}},function(t,n,r){var e=r(126)("keys"),i=r(76);t.exports=function(t){return e[t]||(e[t]=i(t))}},function(t,n,r){var e=r(2),i=r(26),o=r(7)("species");t.exports=function(t,n){var r,u=e(t).constructor;return void 0===u||void 0==(r=e(u)[o])?n:i(r)}},function(t,n,r){var e=r(67),i=r(46);t.exports=function(t){return function(n,r){var o,u,c=String(i(n)),f=e(r),a=c.length;return f<0||f>=a?t?"":void 0:(o=c.charCodeAt(f),o<55296||o>56319||f+1===a||(u=c.charCodeAt(f+1))<56320||u>57343?t?c.charAt(f):o:t?c.slice(f,f+2):u-56320+(o-55296<<10)+65536)}}},function(t,n,r){var e=r(122),i=r(46);t.exports=function(t,n,r){if(e(n))throw TypeError("String#"+r+" doesn't accept regex!");return String(i(t))}},function(t,n,r){"use strict";var e=r(67),i=r(46);t.exports=function(t){var n=String(i(this)),r="",o=e(t);if(o<0||o==1/0)throw RangeError("Count can't be negative");for(;o>0;(o>>>=1)&&(n+=n))1&o&&(r+=n);return r}},function(t,n){t.exports="\t\n\v\f\r Â áš€á â€€â€â€‚â€ƒâ€„â€…â€†â€‡â€ˆâ€‰â€Šâ€¯âŸã€€\u2028\u2029\ufeff"},function(t,n,r){var e,i,o,u=r(53),c=r(121),f=r(135),a=r(132),s=r(3),l=s.process,h=s.setImmediate,v=s.clearImmediate,p=s.MessageChannel,d=0,y={},g="onreadystatechange",b=function(){var t=+this;if(y.hasOwnProperty(t)){var n=y[t];delete y[t],n()}},m=function(t){b.call(t.data)};h&&v||(h=function(t){for(var n=[],r=1;arguments.length>r;)n.push(arguments[r++]);return y[++d]=function(){c("function"==typeof t?t:Function(t),n)},e(d),d},v=function(t){delete y[t]},"process"==r(45)(l)?e=function(t){l.nextTick(u(b,t,1))}:p?(i=new p,o=i.port2,i.port1.onmessage=m,e=u(o.postMessage,o,1)):s.addEventListener&&"function"==typeof postMessage&&!s.importScripts?(e=function(t){s.postMessage(t+"","*")},s.addEventListener("message",m,!1)):e=g in a("script")?function(t){f.appendChild(a("script"))[g]=function(){f.removeChild(this),b.call(t)}}:function(t){setTimeout(u(b,t,1),0)}),t.exports={set:h,clear:v}},function(t,n,r){"use strict";var e=r(3),i=r(10),o=r(69),u=r(127),c=r(27),f=r(73),a=r(4),s=r(68),l=r(67),h=r(16),v=r(71).f,p=r(11).f,d=r(130),y=r(81),g="ArrayBuffer",b="DataView",m="prototype",x="Wrong length!",w="Wrong index!",S=e[g],_=e[b],O=e.Math,E=e.RangeError,P=e.Infinity,j=S,F=O.abs,M=O.pow,A=O.floor,N=O.log,T=O.LN2,I="buffer",k="byteLength",L="byteOffset",R=i?"_b":I,C=i?"_l":k,D=i?"_o":L,U=function(t,n,r){var e,i,o,u=Array(r),c=8*r-n-1,f=(1<<c)-1,a=f>>1,s=23===n?M(2,-24)-M(2,-77):0,l=0,h=t<0||0===t&&1/t<0?1:0;for(t=F(t),t!=t||t===P?(i=t!=t?1:0,e=f):(e=A(N(t)/T),t*(o=M(2,-e))<1&&(e--,o*=2),t+=e+a>=1?s/o:s*M(2,1-a),t*o>=2&&(e++,o/=2),e+a>=f?(i=0,e=f):e+a>=1?(i=(t*o-1)*M(2,n),e+=a):(i=t*M(2,a-1)*M(2,n),e=0));n>=8;u[l++]=255&i,i/=256,n-=8);for(e=e<<n|i,c+=n;c>0;u[l++]=255&e,e/=256,c-=8);return u[--l]|=128*h,u},W=function(t,n,r){var e,i=8*r-n-1,o=(1<<i)-1,u=o>>1,c=i-7,f=r-1,a=t[f--],s=127&a;for(a>>=7;c>0;s=256*s+t[f],f--,c-=8);for(e=s&(1<<-c)-1,s>>=-c,c+=n;c>0;e=256*e+t[f],f--,c-=8);if(0===s)s=1-u;else{if(s===o)return e?NaN:a?-P:P;e+=M(2,n),s-=u}return(a?-1:1)*e*M(2,s-n)},G=function(t){return t[3]<<24|t[2]<<16|t[1]<<8|t[0]},B=function(t){return[255&t]},V=function(t){return[255&t,t>>8&255]},z=function(t){return[255&t,t>>8&255,t>>16&255,t>>24&255]},q=function(t){return U(t,52,8)},K=function(t){return U(t,23,4)},J=function(t,n,r){p(t[m],n,{get:function(){return this[r]}})},Y=function(t,n,r,e){var i=+r,o=l(i);if(i!=o||o<0||o+n>t[C])throw E(w);var u=t[R]._b,c=o+t[D],f=u.slice(c,c+n);return e?f:f.reverse()},H=function(t,n,r,e,i,o){var u=+r,c=l(u);if(u!=c||c<0||c+n>t[C])throw E(w);for(var f=t[R]._b,a=c+t[D],s=e(+i),h=0;h<n;h++)f[a+h]=s[o?h:n-h-1]},$=function(t,n){s(t,S,g);var r=+n,e=h(r);if(r!=e)throw E(x);return e};if(u.ABV){if(!a(function(){new S})||!a(function(){new S(.5)})){S=function(t){return new j($(this,t))};for(var X,Q=S[m]=j[m],Z=v(j),tt=0;Z.length>tt;)(X=Z[tt++])in S||c(S,X,j[X]);o||(Q.constructor=S)}var nt=new _(new S(2)),rt=_[m].setInt8;nt.setInt8(0,2147483648),nt.setInt8(1,2147483649),!nt.getInt8(0)&&nt.getInt8(1)||f(_[m],{setInt8:function(t,n){rt.call(this,t,n<<24>>24)},setUint8:function(t,n){rt.call(this,t,n<<24>>24)}},!0)}else S=function(t){var n=$(this,t);this._b=d.call(Array(n),0),this[C]=n},_=function(t,n,r){s(this,_,b),s(t,S,b);var e=t[C],i=l(n);if(i<0||i>e)throw E("Wrong offset!");if(r=void 0===r?e-i:h(r),i+r>e)throw E(x);this[R]=t,this[D]=i,this[C]=r},i&&(J(S,k,"_l"),J(_,I,"_b"),J(_,k,"_l"),J(_,L,"_o")),f(_[m],{getInt8:function(t){return Y(this,1,t)[0]<<24>>24},getUint8:function(t){return Y(this,1,t)[0]},getInt16:function(t){var n=Y(this,2,t,arguments[1]);return(n[1]<<8|n[0])<<16>>16},getUint16:function(t){var n=Y(this,2,t,arguments[1]);return n[1]<<8|n[0]},getInt32:function(t){return G(Y(this,4,t,arguments[1]))},getUint32:function(t){return G(Y(this,4,t,arguments[1]))>>>0},getFloat32:function(t){return W(Y(this,4,t,arguments[1]),23,4)},getFloat64:function(t){return W(Y(this,8,t,arguments[1]),52,8)},setInt8:function(t,n){H(this,1,t,B,n)},setUint8:function(t,n){H(this,1,t,B,n)},setInt16:function(t,n){H(this,2,t,V,n,arguments[2])},setUint16:function(t,n){H(this,2,t,V,n,arguments[2])},setInt32:function(t,n){H(this,4,t,z,n,arguments[2])},setUint32:function(t,n){H(this,4,t,z,n,arguments[2])},setFloat32:function(t,n){H(this,4,t,K,n,arguments[2])},setFloat64:function(t,n){H(this,8,t,q,n,arguments[2])}});y(S,g),y(_,b),c(_[m],u.VIEW,!0),n[g]=S,n[b]=_},function(t,n,r){var e=r(3),i=r(52),o=r(69),u=r(182),c=r(11).f;t.exports=function(t){var n=i.Symbol||(i.Symbol=o?{}:e.Symbol||{});"_"==t.charAt(0)||t in n||c(n,t,{value:u.f(t)})}},function(t,n,r){var e=r(114),i=r(7)("iterator"),o=r(80);t.exports=r(52).getIteratorMethod=function(t){if(void 0!=t)return t[i]||t["@@iterator"]||o[e(t)]}},function(t,n,r){"use strict";var e=r(78),i=r(170),o=r(80),u=r(30);t.exports=r(140)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,i(1)):"keys"==n?i(0,r):"values"==n?i(0,t[r]):i(0,[r,t[r]])},"values"),o.Arguments=o.Array,e("keys"),e("values"),e("entries")},function(t,n){function r(t,n){t.classList?t.classList.add(n):t.className+=" "+n}t.exports=r},function(t,n){function r(t,n){if(t.classList)t.classList.remove(n);else{var r=new RegExp("(^|\\b)"+n.split(" ").join("|")+"(\\b|$)","gi");t.className=t.className.replace(r," ")}}t.exports=r},function(t,n){function r(){throw new Error("setTimeout has not been defined")}function e(){throw new Error("clearTimeout has not been defined")}function i(t){if(s===setTimeout)return setTimeout(t,0);if((s===r||!s)&&setTimeout)return s=setTimeout,setTimeout(t,0);try{return s(t,0)}catch(n){try{return s.call(null,t,0)}catch(n){return s.call(this,t,0)}}}function o(t){if(l===clearTimeout)return clearTimeout(t);if((l===e||!l)&&clearTimeout)return l=clearTimeout,clearTimeout(t);try{return l(t)}catch(n){try{return l.call(null,t)}catch(n){return l.call(this,t)}}}function u(){d&&v&&(d=!1,v.length?p=v.concat(p):y=-1,p.length&&c())}function c(){if(!d){var t=i(u);d=!0;for(var n=p.length;n;){for(v=p,p=[];++y<n;)v&&v[y].run();y=-1,n=p.length}v=null,d=!1,o(t)}}function f(t,n){this.fun=t,this.array=n}function a(){}var s,l,h=t.exports={};!function(){try{s="function"==typeof setTimeout?setTimeout:r}catch(t){s=r}try{l="function"==typeof clearTimeout?clearTimeout:e}catch(t){l=e}}();var v,p=[],d=!1,y=-1;h.nextTick=function(t){var n=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)n[r-1]=arguments[r];p.push(new f(t,n)),1!==p.length||d||i(c)},f.prototype.run=function(){this.fun.apply(null,this.array)},h.title="browser",h.browser=!0,h.env={},h.argv=[],h.version="",h.versions={},h.on=a,h.addListener=a,h.once=a,h.off=a,h.removeListener=a,h.removeAllListeners=a,h.emit=a,h.prependListener=a,h.prependOnceListener=a,h.listeners=function(t){return[]},h.binding=function(t){throw new Error("process.binding is not supported")},h.cwd=function(){return"/"},h.chdir=function(t){throw new Error("process.chdir is not supported")},h.umask=function(){return 0}},function(t,n,r){var e=r(45);t.exports=function(t,n){if("number"!=typeof t&&"Number"!=e(t))throw TypeError(n);return+t}},function(t,n,r){"use strict";var e=r(17),i=r(75),o=r(16);t.exports=[].copyWithin||function(t,n){var r=e(this),u=o(r.length),c=i(t,u),f=i(n,u),a=arguments.length>2?arguments[2]:void 0,s=Math.min((void 0===a?u:i(a,u))-f,u-c),l=1;for(f<c&&c<f+s&&(l=-1,f+=s-1,c+=s-1);s-- >0;)f in r?r[c]=r[f]:delete r[c],c+=l,f+=l;return r}},function(t,n,r){var e=r(79);t.exports=function(t,n){var r=[];return e(t,!1,r.push,r,n),r}},function(t,n,r){var e=r(26),i=r(17),o=r(115),u=r(16);t.exports=function(t,n,r,c,f){e(n);var a=i(t),s=o(a),l=u(a.length),h=f?l-1:0,v=f?-1:1;if(r<2)for(;;){if(h in s){c=s[h],h+=v;break}if(h+=v,f?h<0:l<=h)throw TypeError("Reduce of empty array with no initial value")}for(;f?h>=0:l>h;h+=v)h in s&&(c=n(c,s[h],h,a));return c}},function(t,n,r){"use strict";var e=r(26),i=r(6),o=r(121),u=[].slice,c={},f=function(t,n,r){if(!(n in c)){for(var e=[],i=0;i<n;i++)e[i]="a["+i+"]";c[n]=Function("F,a","return new F("+e.join(",")+")")}return c[n](t,r)};t.exports=Function.bind||function(t){var n=e(this),r=u.call(arguments,1),c=function(){var e=r.concat(u.call(arguments));return this instanceof c?f(n,e.length,e):o(n,e,t)};return i(n.prototype)&&(c.prototype=n.prototype),c}},function(t,n,r){"use strict";var e=r(11).f,i=r(70),o=r(73),u=r(53),c=r(68),f=r(46),a=r(79),s=r(140),l=r(170),h=r(74),v=r(10),p=r(65).fastKey,d=v?"_s":"size",y=function(t,n){var r,e=p(n);if("F"!==e)return t._i[e];for(r=t._f;r;r=r.n)if(r.k==n)return r};t.exports={getConstructor:function(t,n,r,s){var l=t(function(t,e){c(t,l,n,"_i"),t._i=i(null),t._f=void 0,t._l=void 0,t[d]=0,void 0!=e&&a(e,r,t[s],t)});return o(l.prototype,{clear:function(){for(var t=this,n=t._i,r=t._f;r;r=r.n)r.r=!0,r.p&&(r.p=r.p.n=void 0),delete n[r.i];t._f=t._l=void 0,t[d]=0},delete:function(t){var n=this,r=y(n,t);if(r){var e=r.n,i=r.p;delete n._i[r.i],r.r=!0,i&&(i.n=e),e&&(e.p=i),n._f==r&&(n._f=e),n._l==r&&(n._l=i),n[d]--}return!!r},forEach:function(t){c(this,l,"forEach");for(var n,r=u(t,arguments.length>1?arguments[1]:void 0,3);n=n?n.n:this._f;)for(r(n.v,n.k,this);n&&n.r;)n=n.p},has:function(t){return!!y(this,t)}}),v&&e(l.prototype,"size",{get:function(){return f(this[d])}}),l},def:function(t,n,r){var e,i,o=y(t,n);return o?o.v=r:(t._l=o={i:i=p(n,!0),k:n,v:r,p:e=t._l,n:void 0,r:!1},t._f||(t._f=o),e&&(e.n=o),t[d]++,"F"!==i&&(t._i[i]=o)),t},getEntry:y,setStrong:function(t,n,r){s(t,n,function(t,n){this._t=t,this._k=n,this._l=void 0},function(){for(var t=this,n=t._k,r=t._l;r&&r.r;)r=r.p;return t._t&&(t._l=r=r?r.n:t._t._f)?"keys"==n?l(0,r.k):"values"==n?l(0,r.v):l(0,[r.k,r.v]):(t._t=void 0,l(1))},r?"entries":"values",!r,!0),h(n)}}},function(t,n,r){var e=r(114),i=r(161);t.exports=function(t){return function(){if(e(this)!=t)throw TypeError(t+"#toJSON isn't generic");return i(this)}}},function(t,n,r){"use strict";var e=r(73),i=r(65).getWeak,o=r(2),u=r(6),c=r(68),f=r(79),a=r(48),s=r(24),l=a(5),h=a(6),v=0,p=function(t){return t._l||(t._l=new d)},d=function(){this.a=[]},y=function(t,n){return l(t.a,function(t){return t[0]===n})};d.prototype={get:function(t){var n=y(this,t);if(n)return n[1]},has:function(t){return!!y(this,t)},set:function(t,n){var r=y(this,t);r?r[1]=n:this.a.push([t,n])},delete:function(t){var n=h(this.a,function(n){return n[0]===t});return~n&&this.a.splice(n,1),!!~n}},t.exports={getConstructor:function(t,n,r,o){var a=t(function(t,e){c(t,a,n,"_i"),t._i=v++,t._l=void 0,void 0!=e&&f(e,r,t[o],t)});return e(a.prototype,{delete:function(t){if(!u(t))return!1;var n=i(t);return!0===n?p(this).delete(t):n&&s(n,this._i)&&delete n[this._i]},has:function(t){if(!u(t))return!1;var n=i(t);return!0===n?p(this).has(t):n&&s(n,this._i)}}),a},def:function(t,n,r){var e=i(o(n),!0);return!0===e?p(t).set(n,r):e[t._i]=r,t},ufstore:p}},function(t,n,r){t.exports=!r(10)&&!r(4)(function(){return 7!=Object.defineProperty(r(132)("div"),"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(6),i=Math.floor;t.exports=function(t){return!e(t)&&isFinite(t)&&i(t)===t}},function(t,n,r){var e=r(2);t.exports=function(t,n,r,i){try{return i?n(e(r)[0],r[1]):n(r)}catch(n){var o=t.return;throw void 0!==o&&e(o.call(t)),n}}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n){t.exports=Math.log1p||function(t){return(t=+t)>-1e-8&&t<1e-8?t-t*t/2:Math.log(1+t)}},function(t,n,r){"use strict";var e=r(72),i=r(125),o=r(116),u=r(17),c=r(115),f=Object.assign;t.exports=!f||r(4)(function(){var t={},n={},r=Symbol(),e="abcdefghijklmnopqrst";return t[r]=7,e.split("").forEach(function(t){n[t]=t}),7!=f({},t)[r]||Object.keys(f({},n)).join("")!=e})?function(t,n){for(var r=u(t),f=arguments.length,a=1,s=i.f,l=o.f;f>a;)for(var h,v=c(arguments[a++]),p=s?e(v).concat(s(v)):e(v),d=p.length,y=0;d>y;)l.call(v,h=p[y++])&&(r[h]=v[h]);return r}:f},function(t,n,r){var e=r(11),i=r(2),o=r(72);t.exports=r(10)?Object.defineProperties:function(t,n){i(t);for(var r,u=o(n),c=u.length,f=0;c>f;)e.f(t,r=u[f++],n[r]);return t}},function(t,n,r){var e=r(30),i=r(71).f,o={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],c=function(t){try{return i(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==o.call(t)?c(t):i(e(t))}},function(t,n,r){var e=r(24),i=r(30),o=r(117)(!1),u=r(145)("IE_PROTO");t.exports=function(t,n){var r,c=i(t),f=0,a=[];for(r in c)r!=u&&e(c,r)&&a.push(r);for(;n.length>f;)e(c,r=n[f++])&&(~o(a,r)||a.push(r));return a}},function(t,n,r){var e=r(72),i=r(30),o=r(116).f;t.exports=function(t){return function(n){for(var r,u=i(n),c=e(u),f=c.length,a=0,s=[];f>a;)o.call(u,r=c[a++])&&s.push(t?[r,u[r]]:u[r]);return s}}},function(t,n,r){var e=r(71),i=r(125),o=r(2),u=r(3).Reflect;t.exports=u&&u.ownKeys||function(t){var n=e.f(o(t)),r=i.f;return r?n.concat(r(t)):n}},function(t,n,r){var e=r(3).parseFloat,i=r(82).trim;t.exports=1/e(r(150)+"-0")!=-1/0?function(t){var n=i(String(t),3),r=e(n);return 0===r&&"-"==n.charAt(0)?-0:r}:e},function(t,n,r){var e=r(3).parseInt,i=r(82).trim,o=r(150),u=/^[\-+]?0[xX]/;t.exports=8!==e(o+"08")||22!==e(o+"0x16")?function(t,n){var r=i(String(t),3);return e(r,n>>>0||(u.test(r)?16:10))}:e},function(t,n){t.exports=Object.is||function(t,n){return t===n?0!==t||1/t==1/n:t!=t&&n!=n}},function(t,n,r){var e=r(16),i=r(149),o=r(46);t.exports=function(t,n,r,u){var c=String(o(t)),f=c.length,a=void 0===r?" ":String(r),s=e(n);if(s<=f||""==a)return c;var l=s-f,h=i.call(a,Math.ceil(l/a.length));return h.length>l&&(h=h.slice(0,l)),u?h+c:c+h}},function(t,n,r){n.f=r(7)},function(t,n,r){"use strict";var e=r(164);t.exports=r(118)("Map",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{get:function(t){var n=e.getEntry(this,t);return n&&n.v},set:function(t,n){return e.def(this,0===t?0:t,n)}},e,!0)},function(t,n,r){r(10)&&"g"!=/./g.flags&&r(11).f(RegExp.prototype,"flags",{configurable:!0,get:r(120)})},function(t,n,r){"use strict";var e=r(164);t.exports=r(118)("Set",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{add:function(t){return e.def(this,t=0===t?0:t,t)}},e)},function(t,n,r){"use strict";var e,i=r(48)(0),o=r(28),u=r(65),c=r(172),f=r(166),a=r(6),s=u.getWeak,l=Object.isExtensible,h=f.ufstore,v={},p=function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},d={get:function(t){if(a(t)){var n=s(t);return!0===n?h(this).get(t):n?n[this._i]:void 0}},set:function(t,n){return f.def(this,t,n)}},y=t.exports=r(118)("WeakMap",p,d,f,!0,!0);7!=(new y).set((Object.freeze||Object)(v),7).get(v)&&(e=f.getConstructor(p),c(e.prototype,d),u.NEED=!0,i(["delete","has","get","set"],function(t){var n=y.prototype,r=n[t];o(n,t,function(n,i){if(a(n)&&!l(n)){this._f||(this._f=new e);var o=this._f[t](n,i);return"set"==t?this:o}return r.call(this,n,i)})}))},,,,function(t,n){"use strict";function r(){var t=document.querySelector("#page-nav");if(t&&!document.querySelector("#page-nav .extend.prev")&&(t.innerHTML='<a class="extend prev disabled" rel="prev">&laquo; Prev</a>'+t.innerHTML),t&&!document.querySelector("#page-nav .extend.next")&&(t.innerHTML=t.innerHTML+'<a class="extend next disabled" rel="next">Next &raquo;</a>'),yiliaConfig&&yiliaConfig.open_in_new){document.querySelectorAll(".article-entry a:not(.article-more-a)").forEach(function(t){var n=t.getAttribute("target");n&&""!==n||t.setAttribute("target","_blank")})}if(yiliaConfig&&yiliaConfig.toc_hide_index){document.querySelectorAll(".toc-number").forEach(function(t){t.style.display="none"})}var n=document.querySelector("#js-aboutme");n&&0!==n.length&&(n.innerHTML=n.innerText)}t.exports={init:r}},function(t,n,r){"use strict";function e(t){return t&&t.__esModule?t:{default:t}}function i(t,n){var r=/\/|index.html/g;return t.replace(r,"")===n.replace(r,"")}function o(){for(var t=document.querySelectorAll(".js-header-menu li a"),n=window.location.pathname,r=0,e=t.length;r<e;r++){var o=t[r];i(n,o.getAttribute("href"))&&(0,h.default)(o,"active")}}function u(t){for(var n=t.offsetLeft,r=t.offsetParent;null!==r;)n+=r.offsetLeft,r=r.offsetParent;return n}function c(t){for(var n=t.offsetTop,r=t.offsetParent;null!==r;)n+=r.offsetTop,r=r.offsetParent;return n}function f(t,n,r,e,i){var o=u(t),f=c(t)-n;if(f-r<=i){var a=t.$newDom;a||(a=t.cloneNode(!0),(0,d.default)(t,a),t.$newDom=a,a.style.position="fixed",a.style.top=(r||f)+"px",a.style.left=o+"px",a.style.zIndex=e||2,a.style.width="100%",a.style.color="#fff"),a.style.visibility="visible",t.style.visibility="hidden"}else{t.style.visibility="visible";var s=t.$newDom;s&&(s.style.visibility="hidden")}}function a(){var t=document.querySelector(".js-overlay"),n=document.querySelector(".js-header-menu");f(t,document.body.scrollTop,-63,2,0),f(n,document.body.scrollTop,1,3,0)}function s(){document.querySelector("#container").addEventListener("scroll",function(t){a()}),window.addEventListener("scroll",function(t){a()}),a()}var l=r(156),h=e(l),v=r(157),p=(e(v),r(382)),d=e(p),y=r(128),g=e(y),b=r(190),m=e(b),x=r(129);(function(){g.default.versions.mobile&&window.screen.width<800&&(o(),s())})(),(0,x.addLoadEvent)(function(){m.default.init()}),t.exports={}},,,,function(t,n,r){(function(t){"use strict";function n(t,n,r){t[n]||Object[e](t,n,{writable:!0,configurable:!0,value:r})}if(r(381),r(391),r(198),t._babelPolyfill)throw new Error("only one instance of babel-polyfill is allowed");t._babelPolyfill=!0;var e="defineProperty";n(String.prototype,"padLeft","".padStart),n(String.prototype,"padRight","".padEnd),"pop,reverse,shift,keys,values,entries,indexOf,every,some,forEach,map,filter,find,findIndex,includes,join,slice,concat,push,splice,unshift,sort,lastIndexOf,reduce,reduceRight,copyWithin,fill".split(",").forEach(function(t){[][t]&&n(Array,t,Function.call.bind([][t]))})}).call(n,function(){return this}())},,,function(t,n,r){r(210),t.exports=r(52).RegExp.escape},,,,function(t,n,r){var e=r(6),i=r(138),o=r(7)("species");t.exports=function(t){var n;return i(t)&&(n=t.constructor,"function"!=typeof n||n!==Array&&!i(n.prototype)||(n=void 0),e(n)&&null===(n=n[o])&&(n=void 0)),void 0===n?Array:n}},function(t,n,r){var e=r(202);t.exports=function(t,n){return new(e(t))(n)}},function(t,n,r){"use strict";var e=r(2),i=r(50),o="number";t.exports=function(t){if("string"!==t&&t!==o&&"default"!==t)throw TypeError("Incorrect hint");return i(e(this),t!=o)}},function(t,n,r){var e=r(72),i=r(125),o=r(116);t.exports=function(t){var n=e(t),r=i.f;if(r)for(var u,c=r(t),f=o.f,a=0;c.length>a;)f.call(t,u=c[a++])&&n.push(u);return n}},function(t,n,r){var e=r(72),i=r(30);t.exports=function(t,n){for(var r,o=i(t),u=e(o),c=u.length,f=0;c>f;)if(o[r=u[f++]]===n)return r}},function(t,n,r){"use strict";var e=r(208),i=r(121),o=r(26);t.exports=function(){for(var t=o(this),n=arguments.length,r=Array(n),u=0,c=e._,f=!1;n>u;)(r[u]=arguments[u++])===c&&(f=!0);return function(){var e,o=this,u=arguments.length,a=0,s=0;if(!f&&!u)return i(t,r,o);if(e=r.slice(),f)for(;n>a;a++)e[a]===c&&(e[a]=arguments[s++]);for(;u>s;)e.push(arguments[s++]);return i(t,e,o)}}},function(t,n,r){t.exports=r(3)},function(t,n){t.exports=function(t,n){var r=n===Object(n)?function(t){return n[t]}:n;return function(n){return String(n).replace(t,r)}}},function(t,n,r){var e=r(1),i=r(209)(/[\\^$*+?.()|[\]{}]/g,"\\$&");e(e.S,"RegExp",{escape:function(t){return i(t)}})},function(t,n,r){var e=r(1);e(e.P,"Array",{copyWithin:r(160)}),r(78)("copyWithin")},function(t,n,r){"use strict";var e=r(1),i=r(48)(4);e(e.P+e.F*!r(47)([].every,!0),"Array",{every:function(t){return i(this,t,arguments[1])}})},function(t,n,r){var e=r(1);e(e.P,"Array",{fill:r(130)}),r(78)("fill")},function(t,n,r){"use strict";var e=r(1),i=r(48)(2);e(e.P+e.F*!r(47)([].filter,!0),"Array",{filter:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(6),o="findIndex",u=!0;o in[]&&Array(1)[o](function(){u=!1}),e(e.P+e.F*u,"Array",{findIndex:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)(o)},function(t,n,r){"use strict";var e=r(1),i=r(48)(5),o="find",u=!0;o in[]&&Array(1)[o](function(){u=!1}),e(e.P+e.F*u,"Array",{find:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)(o)},function(t,n,r){"use strict";var e=r(1),i=r(48)(0),o=r(47)([].forEach,!0);e(e.P+e.F*!o,"Array",{forEach:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(53),i=r(1),o=r(17),u=r(169),c=r(137),f=r(16),a=r(131),s=r(154);i(i.S+i.F*!r(123)(function(t){Array.from(t)}),"Array",{from:function(t){var n,r,i,l,h=o(t),v="function"==typeof this?this:Array,p=arguments.length,d=p>1?arguments[1]:void 0,y=void 0!==d,g=0,b=s(h);if(y&&(d=e(d,p>2?arguments[2]:void 0,2)),void 0==b||v==Array&&c(b))for(n=f(h.length),r=new v(n);n>g;g++)a(r,g,y?d(h[g],g):h[g]);else for(l=b.call(h),r=new v;!(i=l.next()).done;g++)a(r,g,y?u(l,d,[i.value,g],!0):i.value);return r.length=g,r}})},function(t,n,r){"use strict";var e=r(1),i=r(117)(!1),o=[].indexOf,u=!!o&&1/[1].indexOf(1,-0)<0;e(e.P+e.F*(u||!r(47)(o)),"Array",{indexOf:function(t){return u?o.apply(this,arguments)||0:i(this,t,arguments[1])}})},function(t,n,r){var e=r(1);e(e.S,"Array",{isArray:r(138)})},function(t,n,r){"use strict";var e=r(1),i=r(30),o=[].join;e(e.P+e.F*(r(115)!=Object||!r(47)(o)),"Array",{join:function(t){return o.call(i(this),void 0===t?",":t)}})},function(t,n,r){"use strict";var e=r(1),i=r(30),o=r(67),u=r(16),c=[].lastIndexOf,f=!!c&&1/[1].lastIndexOf(1,-0)<0;e(e.P+e.F*(f||!r(47)(c)),"Array",{lastIndexOf:function(t){if(f)return c.apply(this,arguments)||0;var n=i(this),r=u(n.length),e=r-1;for(arguments.length>1&&(e=Math.min(e,o(arguments[1]))),e<0&&(e=r+e);e>=0;e--)if(e in n&&n[e]===t)return e||0;return-1}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(1);e(e.P+e.F*!r(47)([].map,!0),"Array",{map:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(131);e(e.S+e.F*r(4)(function(){function t(){}return!(Array.of.call(t)instanceof t)}),"Array",{of:function(){for(var t=0,n=arguments.length,r=new("function"==typeof this?this:Array)(n);n>t;)i(r,t,arguments[t++]);return r.length=n,r}})},function(t,n,r){"use strict";var e=r(1),i=r(162);e(e.P+e.F*!r(47)([].reduceRight,!0),"Array",{reduceRight:function(t){return i(this,t,arguments.length,arguments[1],!0)}})},function(t,n,r){"use strict";var e=r(1),i=r(162);e(e.P+e.F*!r(47)([].reduce,!0),"Array",{reduce:function(t){return i(this,t,arguments.length,arguments[1],!1)}})},function(t,n,r){"use strict";var e=r(1),i=r(135),o=r(45),u=r(75),c=r(16),f=[].slice;e(e.P+e.F*r(4)(function(){i&&f.call(i)}),"Array",{slice:function(t,n){var r=c(this.length),e=o(this);if(n=void 0===n?r:n,"Array"==e)return f.call(this,t,n);for(var i=u(t,r),a=u(n,r),s=c(a-i),l=Array(s),h=0;h<s;h++)l[h]="String"==e?this.charAt(i+h):this[i+h];return l}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(3);e(e.P+e.F*!r(47)([].some,!0),"Array",{some:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(26),o=r(17),u=r(4),c=[].sort,f=[1,2,3];e(e.P+e.F*(u(function(){f.sort(void 0)})||!u(function(){f.sort(null)})||!r(47)(c)),"Array",{sort:function(t){return void 0===t?c.call(o(this)):c.call(o(this),i(t))}})},function(t,n,r){r(74)("Array")},function(t,n,r){var e=r(1);e(e.S,"Date",{now:function(){return(new Date).getTime()}})},function(t,n,r){"use strict";var e=r(1),i=r(4),o=Date.prototype.getTime,u=function(t){return t>9?t:"0"+t};e(e.P+e.F*(i(function(){return"0385-07-25T07:06:39.999Z"!=new Date(-5e13-1).toISOString()})||!i(function(){new Date(NaN).toISOString()})),"Date",{toISOString:function(){
if(!isFinite(o.call(this)))throw RangeError("Invalid time value");var t=this,n=t.getUTCFullYear(),r=t.getUTCMilliseconds(),e=n<0?"-":n>9999?"+":"";return e+("00000"+Math.abs(n)).slice(e?-6:-4)+"-"+u(t.getUTCMonth()+1)+"-"+u(t.getUTCDate())+"T"+u(t.getUTCHours())+":"+u(t.getUTCMinutes())+":"+u(t.getUTCSeconds())+"."+(r>99?r:"0"+u(r))+"Z"}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50);e(e.P+e.F*r(4)(function(){return null!==new Date(NaN).toJSON()||1!==Date.prototype.toJSON.call({toISOString:function(){return 1}})}),"Date",{toJSON:function(t){var n=i(this),r=o(n);return"number"!=typeof r||isFinite(r)?n.toISOString():null}})},function(t,n,r){var e=r(7)("toPrimitive"),i=Date.prototype;e in i||r(27)(i,e,r(204))},function(t,n,r){var e=Date.prototype,i="Invalid Date",o="toString",u=e[o],c=e.getTime;new Date(NaN)+""!=i&&r(28)(e,o,function(){var t=c.call(this);return t===t?u.call(this):i})},function(t,n,r){var e=r(1);e(e.P,"Function",{bind:r(163)})},function(t,n,r){"use strict";var e=r(6),i=r(32),o=r(7)("hasInstance"),u=Function.prototype;o in u||r(11).f(u,o,{value:function(t){if("function"!=typeof this||!e(t))return!1;if(!e(this.prototype))return t instanceof this;for(;t=i(t);)if(this.prototype===t)return!0;return!1}})},function(t,n,r){var e=r(11).f,i=r(66),o=r(24),u=Function.prototype,c="name",f=Object.isExtensible||function(){return!0};c in u||r(10)&&e(u,c,{configurable:!0,get:function(){try{var t=this,n=(""+t).match(/^\s*function ([^ (]*)/)[1];return o(t,c)||!f(t)||e(t,c,i(5,n)),n}catch(t){return""}}})},function(t,n,r){var e=r(1),i=r(171),o=Math.sqrt,u=Math.acosh;e(e.S+e.F*!(u&&710==Math.floor(u(Number.MAX_VALUE))&&u(1/0)==1/0),"Math",{acosh:function(t){return(t=+t)<1?NaN:t>94906265.62425156?Math.log(t)+Math.LN2:i(t-1+o(t-1)*o(t+1))}})},function(t,n,r){function e(t){return isFinite(t=+t)&&0!=t?t<0?-e(-t):Math.log(t+Math.sqrt(t*t+1)):t}var i=r(1),o=Math.asinh;i(i.S+i.F*!(o&&1/o(0)>0),"Math",{asinh:e})},function(t,n,r){var e=r(1),i=Math.atanh;e(e.S+e.F*!(i&&1/i(-0)<0),"Math",{atanh:function(t){return 0==(t=+t)?t:Math.log((1+t)/(1-t))/2}})},function(t,n,r){var e=r(1),i=r(142);e(e.S,"Math",{cbrt:function(t){return i(t=+t)*Math.pow(Math.abs(t),1/3)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{clz32:function(t){return(t>>>=0)?31-Math.floor(Math.log(t+.5)*Math.LOG2E):32}})},function(t,n,r){var e=r(1),i=Math.exp;e(e.S,"Math",{cosh:function(t){return(i(t=+t)+i(-t))/2}})},function(t,n,r){var e=r(1),i=r(141);e(e.S+e.F*(i!=Math.expm1),"Math",{expm1:i})},function(t,n,r){var e=r(1),i=r(142),o=Math.pow,u=o(2,-52),c=o(2,-23),f=o(2,127)*(2-c),a=o(2,-126),s=function(t){return t+1/u-1/u};e(e.S,"Math",{fround:function(t){var n,r,e=Math.abs(t),o=i(t);return e<a?o*s(e/a/c)*a*c:(n=(1+c/u)*e,r=n-(n-e),r>f||r!=r?o*(1/0):o*r)}})},function(t,n,r){var e=r(1),i=Math.abs;e(e.S,"Math",{hypot:function(t,n){for(var r,e,o=0,u=0,c=arguments.length,f=0;u<c;)r=i(arguments[u++]),f<r?(e=f/r,o=o*e*e+1,f=r):r>0?(e=r/f,o+=e*e):o+=r;return f===1/0?1/0:f*Math.sqrt(o)}})},function(t,n,r){var e=r(1),i=Math.imul;e(e.S+e.F*r(4)(function(){return-5!=i(4294967295,5)||2!=i.length}),"Math",{imul:function(t,n){var r=65535,e=+t,i=+n,o=r&e,u=r&i;return 0|o*u+((r&e>>>16)*u+o*(r&i>>>16)<<16>>>0)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{log10:function(t){return Math.log(t)/Math.LN10}})},function(t,n,r){var e=r(1);e(e.S,"Math",{log1p:r(171)})},function(t,n,r){var e=r(1);e(e.S,"Math",{log2:function(t){return Math.log(t)/Math.LN2}})},function(t,n,r){var e=r(1);e(e.S,"Math",{sign:r(142)})},function(t,n,r){var e=r(1),i=r(141),o=Math.exp;e(e.S+e.F*r(4)(function(){return-2e-17!=!Math.sinh(-2e-17)}),"Math",{sinh:function(t){return Math.abs(t=+t)<1?(i(t)-i(-t))/2:(o(t-1)-o(-t-1))*(Math.E/2)}})},function(t,n,r){var e=r(1),i=r(141),o=Math.exp;e(e.S,"Math",{tanh:function(t){var n=i(t=+t),r=i(-t);return n==1/0?1:r==1/0?-1:(n-r)/(o(t)+o(-t))}})},function(t,n,r){var e=r(1);e(e.S,"Math",{trunc:function(t){return(t>0?Math.floor:Math.ceil)(t)}})},function(t,n,r){"use strict";var e=r(3),i=r(24),o=r(45),u=r(136),c=r(50),f=r(4),a=r(71).f,s=r(31).f,l=r(11).f,h=r(82).trim,v="Number",p=e[v],d=p,y=p.prototype,g=o(r(70)(y))==v,b="trim"in String.prototype,m=function(t){var n=c(t,!1);if("string"==typeof n&&n.length>2){n=b?n.trim():h(n,3);var r,e,i,o=n.charCodeAt(0);if(43===o||45===o){if(88===(r=n.charCodeAt(2))||120===r)return NaN}else if(48===o){switch(n.charCodeAt(1)){case 66:case 98:e=2,i=49;break;case 79:case 111:e=8,i=55;break;default:return+n}for(var u,f=n.slice(2),a=0,s=f.length;a<s;a++)if((u=f.charCodeAt(a))<48||u>i)return NaN;return parseInt(f,e)}}return+n};if(!p(" 0o1")||!p("0b1")||p("+0x1")){p=function(t){var n=arguments.length<1?0:t,r=this;return r instanceof p&&(g?f(function(){y.valueOf.call(r)}):o(r)!=v)?u(new d(m(n)),r,p):m(n)};for(var x,w=r(10)?a(d):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","),S=0;w.length>S;S++)i(d,x=w[S])&&!i(p,x)&&l(p,x,s(d,x));p.prototype=y,y.constructor=p,r(28)(e,v,p)}},function(t,n,r){var e=r(1);e(e.S,"Number",{EPSILON:Math.pow(2,-52)})},function(t,n,r){var e=r(1),i=r(3).isFinite;e(e.S,"Number",{isFinite:function(t){return"number"==typeof t&&i(t)}})},function(t,n,r){var e=r(1);e(e.S,"Number",{isInteger:r(168)})},function(t,n,r){var e=r(1);e(e.S,"Number",{isNaN:function(t){return t!=t}})},function(t,n,r){var e=r(1),i=r(168),o=Math.abs;e(e.S,"Number",{isSafeInteger:function(t){return i(t)&&o(t)<=9007199254740991}})},function(t,n,r){var e=r(1);e(e.S,"Number",{MAX_SAFE_INTEGER:9007199254740991})},function(t,n,r){var e=r(1);e(e.S,"Number",{MIN_SAFE_INTEGER:-9007199254740991})},function(t,n,r){var e=r(1),i=r(178);e(e.S+e.F*(Number.parseFloat!=i),"Number",{parseFloat:i})},function(t,n,r){var e=r(1),i=r(179);e(e.S+e.F*(Number.parseInt!=i),"Number",{parseInt:i})},function(t,n,r){"use strict";var e=r(1),i=r(67),o=r(159),u=r(149),c=1..toFixed,f=Math.floor,a=[0,0,0,0,0,0],s="Number.toFixed: incorrect invocation!",l="0",h=function(t,n){for(var r=-1,e=n;++r<6;)e+=t*a[r],a[r]=e%1e7,e=f(e/1e7)},v=function(t){for(var n=6,r=0;--n>=0;)r+=a[n],a[n]=f(r/t),r=r%t*1e7},p=function(){for(var t=6,n="";--t>=0;)if(""!==n||0===t||0!==a[t]){var r=String(a[t]);n=""===n?r:n+u.call(l,7-r.length)+r}return n},d=function(t,n,r){return 0===n?r:n%2==1?d(t,n-1,r*t):d(t*t,n/2,r)},y=function(t){for(var n=0,r=t;r>=4096;)n+=12,r/=4096;for(;r>=2;)n+=1,r/=2;return n};e(e.P+e.F*(!!c&&("0.000"!==8e-5.toFixed(3)||"1"!==.9.toFixed(0)||"1.25"!==1.255.toFixed(2)||"1000000000000000128"!==(0xde0b6b3a7640080).toFixed(0))||!r(4)(function(){c.call({})})),"Number",{toFixed:function(t){var n,r,e,c,f=o(this,s),a=i(t),g="",b=l;if(a<0||a>20)throw RangeError(s);if(f!=f)return"NaN";if(f<=-1e21||f>=1e21)return String(f);if(f<0&&(g="-",f=-f),f>1e-21)if(n=y(f*d(2,69,1))-69,r=n<0?f*d(2,-n,1):f/d(2,n,1),r*=4503599627370496,(n=52-n)>0){for(h(0,r),e=a;e>=7;)h(1e7,0),e-=7;for(h(d(10,e,1),0),e=n-1;e>=23;)v(1<<23),e-=23;v(1<<e),h(1,1),v(2),b=p()}else h(0,r),h(1<<-n,0),b=p()+u.call(l,a);return a>0?(c=b.length,b=g+(c<=a?"0."+u.call(l,a-c)+b:b.slice(0,c-a)+"."+b.slice(c-a))):b=g+b,b}})},function(t,n,r){"use strict";var e=r(1),i=r(4),o=r(159),u=1..toPrecision;e(e.P+e.F*(i(function(){return"1"!==u.call(1,void 0)})||!i(function(){u.call({})})),"Number",{toPrecision:function(t){var n=o(this,"Number#toPrecision: incorrect invocation!");return void 0===t?u.call(n):u.call(n,t)}})},function(t,n,r){var e=r(1);e(e.S+e.F,"Object",{assign:r(172)})},function(t,n,r){var e=r(1);e(e.S,"Object",{create:r(70)})},function(t,n,r){var e=r(1);e(e.S+e.F*!r(10),"Object",{defineProperties:r(173)})},function(t,n,r){var e=r(1);e(e.S+e.F*!r(10),"Object",{defineProperty:r(11).f})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("freeze",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(30),i=r(31).f;r(49)("getOwnPropertyDescriptor",function(){return function(t,n){return i(e(t),n)}})},function(t,n,r){r(49)("getOwnPropertyNames",function(){return r(174).f})},function(t,n,r){var e=r(17),i=r(32);r(49)("getPrototypeOf",function(){return function(t){return i(e(t))}})},function(t,n,r){var e=r(6);r(49)("isExtensible",function(t){return function(n){return!!e(n)&&(!t||t(n))}})},function(t,n,r){var e=r(6);r(49)("isFrozen",function(t){return function(n){return!e(n)||!!t&&t(n)}})},function(t,n,r){var e=r(6);r(49)("isSealed",function(t){return function(n){return!e(n)||!!t&&t(n)}})},function(t,n,r){var e=r(1);e(e.S,"Object",{is:r(180)})},function(t,n,r){var e=r(17),i=r(72);r(49)("keys",function(){return function(t){return i(e(t))}})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("preventExtensions",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("seal",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(1);e(e.S,"Object",{setPrototypeOf:r(144).set})},function(t,n,r){"use strict";var e=r(114),i={};i[r(7)("toStringTag")]="z",i+""!="[object z]"&&r(28)(Object.prototype,"toString",function(){return"[object "+e(this)+"]"},!0)},function(t,n,r){var e=r(1),i=r(178);e(e.G+e.F*(parseFloat!=i),{parseFloat:i})},function(t,n,r){var e=r(1),i=r(179);e(e.G+e.F*(parseInt!=i),{parseInt:i})},function(t,n,r){"use strict";var e,i,o,u=r(69),c=r(3),f=r(53),a=r(114),s=r(1),l=r(6),h=r(26),v=r(68),p=r(79),d=r(146),y=r(151).set,g=r(143)(),b="Promise",m=c.TypeError,x=c.process,w=c[b],x=c.process,S="process"==a(x),_=function(){},O=!!function(){try{var t=w.resolve(1),n=(t.constructor={})[r(7)("species")]=function(t){t(_,_)};return(S||"function"==typeof PromiseRejectionEvent)&&t.then(_)instanceof n}catch(t){}}(),E=function(t,n){return t===n||t===w&&n===o},P=function(t){var n;return!(!l(t)||"function"!=typeof(n=t.then))&&n},j=function(t){return E(w,t)?new F(t):new i(t)},F=i=function(t){var n,r;this.promise=new t(function(t,e){if(void 0!==n||void 0!==r)throw m("Bad Promise constructor");n=t,r=e}),this.resolve=h(n),this.reject=h(r)},M=function(t){try{t()}catch(t){return{error:t}}},A=function(t,n){if(!t._n){t._n=!0;var r=t._c;g(function(){for(var e=t._v,i=1==t._s,o=0;r.length>o;)!function(n){var r,o,u=i?n.ok:n.fail,c=n.resolve,f=n.reject,a=n.domain;try{u?(i||(2==t._h&&I(t),t._h=1),!0===u?r=e:(a&&a.enter(),r=u(e),a&&a.exit()),r===n.promise?f(m("Promise-chain cycle")):(o=P(r))?o.call(r,c,f):c(r)):f(e)}catch(t){f(t)}}(r[o++]);t._c=[],t._n=!1,n&&!t._h&&N(t)})}},N=function(t){y.call(c,function(){var n,r,e,i=t._v;if(T(t)&&(n=M(function(){S?x.emit("unhandledRejection",i,t):(r=c.onunhandledrejection)?r({promise:t,reason:i}):(e=c.console)&&e.error&&e.error("Unhandled promise rejection",i)}),t._h=S||T(t)?2:1),t._a=void 0,n)throw n.error})},T=function(t){if(1==t._h)return!1;for(var n,r=t._a||t._c,e=0;r.length>e;)if(n=r[e++],n.fail||!T(n.promise))return!1;return!0},I=function(t){y.call(c,function(){var n;S?x.emit("rejectionHandled",t):(n=c.onrejectionhandled)&&n({promise:t,reason:t._v})})},k=function(t){var n=this;n._d||(n._d=!0,n=n._w||n,n._v=t,n._s=2,n._a||(n._a=n._c.slice()),A(n,!0))},L=function(t){var n,r=this;if(!r._d){r._d=!0,r=r._w||r;try{if(r===t)throw m("Promise can't be resolved itself");(n=P(t))?g(function(){var e={_w:r,_d:!1};try{n.call(t,f(L,e,1),f(k,e,1))}catch(t){k.call(e,t)}}):(r._v=t,r._s=1,A(r,!1))}catch(t){k.call({_w:r,_d:!1},t)}}};O||(w=function(t){v(this,w,b,"_h"),h(t),e.call(this);try{t(f(L,this,1),f(k,this,1))}catch(t){k.call(this,t)}},e=function(t){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1},e.prototype=r(73)(w.prototype,{then:function(t,n){var r=j(d(this,w));return r.ok="function"!=typeof t||t,r.fail="function"==typeof n&&n,r.domain=S?x.domain:void 0,this._c.push(r),this._a&&this._a.push(r),this._s&&A(this,!1),r.promise},catch:function(t){return this.then(void 0,t)}}),F=function(){var t=new e;this.promise=t,this.resolve=f(L,t,1),this.reject=f(k,t,1)}),s(s.G+s.W+s.F*!O,{Promise:w}),r(81)(w,b),r(74)(b),o=r(52)[b],s(s.S+s.F*!O,b,{reject:function(t){var n=j(this);return(0,n.reject)(t),n.promise}}),s(s.S+s.F*(u||!O),b,{resolve:function(t){if(t instanceof w&&E(t.constructor,this))return t;var n=j(this);return(0,n.resolve)(t),n.promise}}),s(s.S+s.F*!(O&&r(123)(function(t){w.all(t).catch(_)})),b,{all:function(t){var n=this,r=j(n),e=r.resolve,i=r.reject,o=M(function(){var r=[],o=0,u=1;p(t,!1,function(t){var c=o++,f=!1;r.push(void 0),u++,n.resolve(t).then(function(t){f||(f=!0,r[c]=t,--u||e(r))},i)}),--u||e(r)});return o&&i(o.error),r.promise},race:function(t){var n=this,r=j(n),e=r.reject,i=M(function(){p(t,!1,function(t){n.resolve(t).then(r.resolve,e)})});return i&&e(i.error),r.promise}})},function(t,n,r){var e=r(1),i=r(26),o=r(2),u=(r(3).Reflect||{}).apply,c=Function.apply;e(e.S+e.F*!r(4)(function(){u(function(){})}),"Reflect",{apply:function(t,n,r){var e=i(t),f=o(r);return u?u(e,n,f):c.call(e,n,f)}})},function(t,n,r){var e=r(1),i=r(70),o=r(26),u=r(2),c=r(6),f=r(4),a=r(163),s=(r(3).Reflect||{}).construct,l=f(function(){function t(){}return!(s(function(){},[],t)instanceof t)}),h=!f(function(){s(function(){})});e(e.S+e.F*(l||h),"Reflect",{construct:function(t,n){o(t),u(n);var r=arguments.length<3?t:o(arguments[2]);if(h&&!l)return s(t,n,r);if(t==r){switch(n.length){case 0:return new t;case 1:return new t(n[0]);case 2:return new t(n[0],n[1]);case 3:return new t(n[0],n[1],n[2]);case 4:return new t(n[0],n[1],n[2],n[3])}var e=[null];return e.push.apply(e,n),new(a.apply(t,e))}var f=r.prototype,v=i(c(f)?f:Object.prototype),p=Function.apply.call(t,v,n);return c(p)?p:v}})},function(t,n,r){var e=r(11),i=r(1),o=r(2),u=r(50);i(i.S+i.F*r(4)(function(){Reflect.defineProperty(e.f({},1,{value:1}),1,{value:2})}),"Reflect",{defineProperty:function(t,n,r){o(t),n=u(n,!0),o(r);try{return e.f(t,n,r),!0}catch(t){return!1}}})},function(t,n,r){var e=r(1),i=r(31).f,o=r(2);e(e.S,"Reflect",{deleteProperty:function(t,n){var r=i(o(t),n);return!(r&&!r.configurable)&&delete t[n]}})},function(t,n,r){"use strict";var e=r(1),i=r(2),o=function(t){this._t=i(t),this._i=0;var n,r=this._k=[];for(n in t)r.push(n)};r(139)(o,"Object",function(){var t,n=this,r=n._k;do{if(n._i>=r.length)return{value:void 0,done:!0}}while(!((t=r[n._i++])in n._t));return{value:t,done:!1}}),e(e.S,"Reflect",{enumerate:function(t){return new o(t)}})},function(t,n,r){var e=r(31),i=r(1),o=r(2);i(i.S,"Reflect",{getOwnPropertyDescriptor:function(t,n){return e.f(o(t),n)}})},function(t,n,r){var e=r(1),i=r(32),o=r(2);e(e.S,"Reflect",{getPrototypeOf:function(t){return i(o(t))}})},function(t,n,r){function e(t,n){var r,c,s=arguments.length<3?t:arguments[2];return a(t)===s?t[n]:(r=i.f(t,n))?u(r,"value")?r.value:void 0!==r.get?r.get.call(s):void 0:f(c=o(t))?e(c,n,s):void 0}var i=r(31),o=r(32),u=r(24),c=r(1),f=r(6),a=r(2);c(c.S,"Reflect",{get:e})},function(t,n,r){var e=r(1);e(e.S,"Reflect",{has:function(t,n){return n in t}})},function(t,n,r){var e=r(1),i=r(2),o=Object.isExtensible;e(e.S,"Reflect",{isExtensible:function(t){return i(t),!o||o(t)}})},function(t,n,r){var e=r(1);e(e.S,"Reflect",{ownKeys:r(177)})},function(t,n,r){var e=r(1),i=r(2),o=Object.preventExtensions;e(e.S,"Reflect",{preventExtensions:function(t){i(t);try{return o&&o(t),!0}catch(t){return!1}}})},function(t,n,r){var e=r(1),i=r(144);i&&e(e.S,"Reflect",{setPrototypeOf:function(t,n){i.check(t,n);try{return i.set(t,n),!0}catch(t){return!1}}})},function(t,n,r){function e(t,n,r){var f,h,v=arguments.length<4?t:arguments[3],p=o.f(s(t),n);if(!p){if(l(h=u(t)))return e(h,n,r,v);p=a(0)}return c(p,"value")?!(!1===p.writable||!l(v)||(f=o.f(v,n)||a(0),f.value=r,i.f(v,n,f),0)):void 0!==p.set&&(p.set.call(v,r),!0)}var i=r(11),o=r(31),u=r(32),c=r(24),f=r(1),a=r(66),s=r(2),l=r(6);f(f.S,"Reflect",{set:e})},function(t,n,r){var e=r(3),i=r(136),o=r(11).f,u=r(71).f,c=r(122),f=r(120),a=e.RegExp,s=a,l=a.prototype,h=/a/g,v=/a/g,p=new a(h)!==h;if(r(10)&&(!p||r(4)(function(){return v[r(7)("match")]=!1,a(h)!=h||a(v)==v||"/a/i"!=a(h,"i")}))){a=function(t,n){var r=this instanceof a,e=c(t),o=void 0===n;return!r&&e&&t.constructor===a&&o?t:i(p?new s(e&&!o?t.source:t,n):s((e=t instanceof a)?t.source:t,e&&o?f.call(t):n),r?this:l,a)};for(var d=u(s),y=0;d.length>y;)!function(t){t in a||o(a,t,{configurable:!0,get:function(){return s[t]},set:function(n){s[t]=n}})}(d[y++]);l.constructor=a,a.prototype=l,r(28)(e,"RegExp",a)}r(74)("RegExp")},function(t,n,r){r(119)("match",1,function(t,n,r){return[function(r){"use strict";var e=t(this),i=void 0==r?void 0:r[n];return void 0!==i?i.call(r,e):new RegExp(r)[n](String(e))},r]})},function(t,n,r){r(119)("replace",2,function(t,n,r){return[function(e,i){"use strict";var o=t(this),u=void 0==e?void 0:e[n];return void 0!==u?u.call(e,o,i):r.call(String(o),e,i)},r]})},function(t,n,r){r(119)("search",1,function(t,n,r){return[function(r){"use strict";var e=t(this),i=void 0==r?void 0:r[n];return void 0!==i?i.call(r,e):new RegExp(r)[n](String(e))},r]})},function(t,n,r){r(119)("split",2,function(t,n,e){"use strict";var i=r(122),o=e,u=[].push,c="split",f="length",a="lastIndex";if("c"=="abbc"[c](/(b)*/)[1]||4!="test"[c](/(?:)/,-1)[f]||2!="ab"[c](/(?:ab)*/)[f]||4!="."[c](/(.?)(.?)/)[f]||"."[c](/()()/)[f]>1||""[c](/.?/)[f]){var s=void 0===/()??/.exec("")[1];e=function(t,n){var r=String(this);if(void 0===t&&0===n)return[];if(!i(t))return o.call(r,t,n);var e,c,l,h,v,p=[],d=(t.ignoreCase?"i":"")+(t.multiline?"m":"")+(t.unicode?"u":"")+(t.sticky?"y":""),y=0,g=void 0===n?4294967295:n>>>0,b=new RegExp(t.source,d+"g");for(s||(e=new RegExp("^"+b.source+"$(?!\\s)",d));(c=b.exec(r))&&!((l=c.index+c[0][f])>y&&(p.push(r.slice(y,c.index)),!s&&c[f]>1&&c[0].replace(e,function(){for(v=1;v<arguments[f]-2;v++)void 0===arguments[v]&&(c[v]=void 0)}),c[f]>1&&c.index<r[f]&&u.apply(p,c.slice(1)),h=c[0][f],y=l,p[f]>=g));)b[a]===c.index&&b[a]++;return y===r[f]?!h&&b.test("")||p.push(""):p.push(r.slice(y)),p[f]>g?p.slice(0,g):p}}else"0"[c](void 0,0)[f]&&(e=function(t,n){return void 0===t&&0===n?[]:o.call(this,t,n)});return[function(r,i){var o=t(this),u=void 0==r?void 0:r[n];return void 0!==u?u.call(r,o,i):e.call(String(o),r,i)},e]})},function(t,n,r){"use strict";r(184);var e=r(2),i=r(120),o=r(10),u="toString",c=/./[u],f=function(t){r(28)(RegExp.prototype,u,t,!0)};r(4)(function(){return"/a/b"!=c.call({source:"a",flags:"b"})})?f(function(){var t=e(this);return"/".concat(t.source,"/","flags"in t?t.flags:!o&&t instanceof RegExp?i.call(t):void 0)}):c.name!=u&&f(function(){return c.call(this)})},function(t,n,r){"use strict";r(29)("anchor",function(t){return function(n){return t(this,"a","name",n)}})},function(t,n,r){"use strict";r(29)("big",function(t){return function(){return t(this,"big","","")}})},function(t,n,r){"use strict";r(29)("blink",function(t){return function(){return t(this,"blink","","")}})},function(t,n,r){"use strict";r(29)("bold",function(t){return function(){return t(this,"b","","")}})},function(t,n,r){"use strict";var e=r(1),i=r(147)(!1);e(e.P,"String",{codePointAt:function(t){return i(this,t)}})},function(t,n,r){"use strict";var e=r(1),i=r(16),o=r(148),u="endsWith",c=""[u];e(e.P+e.F*r(134)(u),"String",{endsWith:function(t){var n=o(this,t,u),r=arguments.length>1?arguments[1]:void 0,e=i(n.length),f=void 0===r?e:Math.min(i(r),e),a=String(t);return c?c.call(n,a,f):n.slice(f-a.length,f)===a}})},function(t,n,r){"use strict";r(29)("fixed",function(t){return function(){return t(this,"tt","","")}})},function(t,n,r){"use strict";r(29)("fontcolor",function(t){return function(n){return t(this,"font","color",n)}})},function(t,n,r){"use strict";r(29)("fontsize",function(t){return function(n){return t(this,"font","size",n)}})},function(t,n,r){var e=r(1),i=r(75),o=String.fromCharCode,u=String.fromCodePoint;e(e.S+e.F*(!!u&&1!=u.length),"String",{fromCodePoint:function(t){for(var n,r=[],e=arguments.length,u=0;e>u;){if(n=+arguments[u++],i(n,1114111)!==n)throw RangeError(n+" is not a valid code point");r.push(n<65536?o(n):o(55296+((n-=65536)>>10),n%1024+56320))}return r.join("")}})},function(t,n,r){"use strict";var e=r(1),i=r(148),o="includes";e(e.P+e.F*r(134)(o),"String",{includes:function(t){return!!~i(this,t,o).indexOf(t,arguments.length>1?arguments[1]:void 0)}})},function(t,n,r){"use strict";r(29)("italics",function(t){return function(){return t(this,"i","","")}})},function(t,n,r){"use strict";var e=r(147)(!0);r(140)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,r=this._i;return r>=n.length?{value:void 0,done:!0}:(t=e(n,r),this._i+=t.length,{value:t,done:!1})})},function(t,n,r){"use strict";r(29)("link",function(t){return function(n){return t(this,"a","href",n)}})},function(t,n,r){var e=r(1),i=r(30),o=r(16);e(e.S,"String",{raw:function(t){for(var n=i(t.raw),r=o(n.length),e=arguments.length,u=[],c=0;r>c;)u.push(String(n[c++])),c<e&&u.push(String(arguments[c]));return u.join("")}})},function(t,n,r){var e=r(1);e(e.P,"String",{repeat:r(149)})},function(t,n,r){"use strict";r(29)("small",function(t){return function(){return t(this,"small","","")}})},function(t,n,r){"use strict";var e=r(1),i=r(16),o=r(148),u="startsWith",c=""[u];e(e.P+e.F*r(134)(u),"String",{startsWith:function(t){var n=o(this,t,u),r=i(Math.min(arguments.length>1?arguments[1]:void 0,n.length)),e=String(t);return c?c.call(n,e,r):n.slice(r,r+e.length)===e}})},function(t,n,r){"use strict";r(29)("strike",function(t){return function(){return t(this,"strike","","")}})},function(t,n,r){"use strict";r(29)("sub",function(t){return function(){return t(this,"sub","","")}})},function(t,n,r){"use strict";r(29)("sup",function(t){return function(){return t(this,"sup","","")}})},function(t,n,r){"use strict";r(82)("trim",function(t){return function(){return t(this,3)}})},function(t,n,r){"use strict";var e=r(3),i=r(24),o=r(10),u=r(1),c=r(28),f=r(65).KEY,a=r(4),s=r(126),l=r(81),h=r(76),v=r(7),p=r(182),d=r(153),y=r(206),g=r(205),b=r(138),m=r(2),x=r(30),w=r(50),S=r(66),_=r(70),O=r(174),E=r(31),P=r(11),j=r(72),F=E.f,M=P.f,A=O.f,N=e.Symbol,T=e.JSON,I=T&&T.stringify,k="prototype",L=v("_hidden"),R=v("toPrimitive"),C={}.propertyIsEnumerable,D=s("symbol-registry"),U=s("symbols"),W=s("op-symbols"),G=Object[k],B="function"==typeof N,V=e.QObject,z=!V||!V[k]||!V[k].findChild,q=o&&a(function(){return 7!=_(M({},"a",{get:function(){return M(this,"a",{value:7}).a}})).a})?function(t,n,r){var e=F(G,n);e&&delete G[n],M(t,n,r),e&&t!==G&&M(G,n,e)}:M,K=function(t){var n=U[t]=_(N[k]);return n._k=t,n},J=B&&"symbol"==typeof N.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof N},Y=function(t,n,r){return t===G&&Y(W,n,r),m(t),n=w(n,!0),m(r),i(U,n)?(r.enumerable?(i(t,L)&&t[L][n]&&(t[L][n]=!1),r=_(r,{enumerable:S(0,!1)})):(i(t,L)||M(t,L,S(1,{})),t[L][n]=!0),q(t,n,r)):M(t,n,r)},H=function(t,n){m(t);for(var r,e=g(n=x(n)),i=0,o=e.length;o>i;)Y(t,r=e[i++],n[r]);return t},$=function(t,n){return void 0===n?_(t):H(_(t),n)},X=function(t){var n=C.call(this,t=w(t,!0));return!(this===G&&i(U,t)&&!i(W,t))&&(!(n||!i(this,t)||!i(U,t)||i(this,L)&&this[L][t])||n)},Q=function(t,n){if(t=x(t),n=w(n,!0),t!==G||!i(U,n)||i(W,n)){var r=F(t,n);return!r||!i(U,n)||i(t,L)&&t[L][n]||(r.enumerable=!0),r}},Z=function(t){for(var n,r=A(x(t)),e=[],o=0;r.length>o;)i(U,n=r[o++])||n==L||n==f||e.push(n);return e},tt=function(t){for(var n,r=t===G,e=A(r?W:x(t)),o=[],u=0;e.length>u;)!i(U,n=e[u++])||r&&!i(G,n)||o.push(U[n]);return o};B||(N=function(){if(this instanceof N)throw TypeError("Symbol is not a constructor!");var t=h(arguments.length>0?arguments[0]:void 0),n=function(r){this===G&&n.call(W,r),i(this,L)&&i(this[L],t)&&(this[L][t]=!1),q(this,t,S(1,r))};return o&&z&&q(G,t,{configurable:!0,set:n}),K(t)},c(N[k],"toString",function(){return this._k}),E.f=Q,P.f=Y,r(71).f=O.f=Z,r(116).f=X,r(125).f=tt,o&&!r(69)&&c(G,"propertyIsEnumerable",X,!0),p.f=function(t){return K(v(t))}),u(u.G+u.W+u.F*!B,{Symbol:N});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),rt=0;nt.length>rt;)v(nt[rt++]);for(var nt=j(v.store),rt=0;nt.length>rt;)d(nt[rt++]);u(u.S+u.F*!B,"Symbol",{for:function(t){return i(D,t+="")?D[t]:D[t]=N(t)},keyFor:function(t){if(J(t))return y(D,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){z=!0},useSimple:function(){z=!1}}),u(u.S+u.F*!B,"Object",{create:$,defineProperty:Y,defineProperties:H,getOwnPropertyDescriptor:Q,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),T&&u(u.S+u.F*(!B||a(function(){var t=N();return"[null]"!=I([t])||"{}"!=I({a:t})||"{}"!=I(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!J(t)){for(var n,r,e=[t],i=1;arguments.length>i;)e.push(arguments[i++]);return n=e[1],"function"==typeof n&&(r=n),!r&&b(n)||(n=function(t,n){if(r&&(n=r.call(this,t,n)),!J(n))return n}),e[1]=n,I.apply(T,e)}}}),N[k][R]||r(27)(N[k],R,N[k].valueOf),l(N,"Symbol"),l(Math,"Math",!0),l(e.JSON,"JSON",!0)},function(t,n,r){"use strict";var e=r(1),i=r(127),o=r(152),u=r(2),c=r(75),f=r(16),a=r(6),s=r(3).ArrayBuffer,l=r(146),h=o.ArrayBuffer,v=o.DataView,p=i.ABV&&s.isView,d=h.prototype.slice,y=i.VIEW,g="ArrayBuffer";e(e.G+e.W+e.F*(s!==h),{ArrayBuffer:h}),e(e.S+e.F*!i.CONSTR,g,{isView:function(t){return p&&p(t)||a(t)&&y in t}}),e(e.P+e.U+e.F*r(4)(function(){return!new h(2).slice(1,void 0).byteLength}),g,{slice:function(t,n){if(void 0!==d&&void 0===n)return d.call(u(this),t);for(var r=u(this).byteLength,e=c(t,r),i=c(void 0===n?r:n,r),o=new(l(this,h))(f(i-e)),a=new v(this),s=new v(o),p=0;e<i;)s.setUint8(p++,a.getUint8(e++));return o}}),r(74)(g)},function(t,n,r){var e=r(1);e(e.G+e.W+e.F*!r(127).ABV,{DataView:r(152).DataView})},function(t,n,r){r(55)("Float32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Float64",8,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int16",2,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int8",1,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint16",2,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint8",1,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint8",1,function(t){return function(n,r,e){return t(this,n,r,e)}},!0)},function(t,n,r){"use strict";var e=r(166);r(118)("WeakSet",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{add:function(t){return e.def(this,t,!0)}},e,!1,!0)},function(t,n,r){"use strict";var e=r(1),i=r(117)(!0);e(e.P,"Array",{includes:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)("includes")},function(t,n,r){var e=r(1),i=r(143)(),o=r(3).process,u="process"==r(45)(o);e(e.G,{asap:function(t){var n=u&&o.domain;i(n?n.bind(t):t)}})},function(t,n,r){var e=r(1),i=r(45);e(e.S,"Error",{isError:function(t){return"Error"===i(t)}})},function(t,n,r){var e=r(1);e(e.P+e.R,"Map",{toJSON:r(165)("Map")})},function(t,n,r){var e=r(1);e(e.S,"Math",{iaddh:function(t,n,r,e){var i=t>>>0,o=n>>>0,u=r>>>0;return o+(e>>>0)+((i&u|(i|u)&~(i+u>>>0))>>>31)|0}})},function(t,n,r){var e=r(1);e(e.S,"Math",{imulh:function(t,n){var r=65535,e=+t,i=+n,o=e&r,u=i&r,c=e>>16,f=i>>16,a=(c*u>>>0)+(o*u>>>16);return c*f+(a>>16)+((o*f>>>0)+(a&r)>>16)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{isubh:function(t,n,r,e){var i=t>>>0,o=n>>>0,u=r>>>0;return o-(e>>>0)-((~i&u|~(i^u)&i-u>>>0)>>>31)|0}})},function(t,n,r){var e=r(1);e(e.S,"Math",{umulh:function(t,n){var r=65535,e=+t,i=+n,o=e&r,u=i&r,c=e>>>16,f=i>>>16,a=(c*u>>>0)+(o*u>>>16);return c*f+(a>>>16)+((o*f>>>0)+(a&r)>>>16)}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(26),u=r(11);r(10)&&e(e.P+r(124),"Object",{__defineGetter__:function(t,n){u.f(i(this),t,{get:o(n),enumerable:!0,configurable:!0})}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(26),u=r(11);r(10)&&e(e.P+r(124),"Object",{__defineSetter__:function(t,n){u.f(i(this),t,{set:o(n),enumerable:!0,configurable:!0})}})},function(t,n,r){var e=r(1),i=r(176)(!0);e(e.S,"Object",{entries:function(t){return i(t)}})},function(t,n,r){var e=r(1),i=r(177),o=r(30),u=r(31),c=r(131);e(e.S,"Object",{getOwnPropertyDescriptors:function(t){for(var n,r=o(t),e=u.f,f=i(r),a={},s=0;f.length>s;)c(a,n=f[s++],e(r,n));return a}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50),u=r(32),c=r(31).f;r(10)&&e(e.P+r(124),"Object",{__lookupGetter__:function(t){var n,r=i(this),e=o(t,!0);do{if(n=c(r,e))return n.get}while(r=u(r))}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50),u=r(32),c=r(31).f;r(10)&&e(e.P+r(124),"Object",{__lookupSetter__:function(t){var n,r=i(this),e=o(t,!0);do{if(n=c(r,e))return n.set}while(r=u(r))}})},function(t,n,r){var e=r(1),i=r(176)(!1);e(e.S,"Object",{values:function(t){return i(t)}})},function(t,n,r){"use strict";var e=r(1),i=r(3),o=r(52),u=r(143)(),c=r(7)("observable"),f=r(26),a=r(2),s=r(68),l=r(73),h=r(27),v=r(79),p=v.RETURN,d=function(t){return null==t?void 0:f(t)},y=function(t){var n=t._c;n&&(t._c=void 0,n())},g=function(t){return void 0===t._o},b=function(t){g(t)||(t._o=void 0,y(t))},m=function(t,n){a(t),this._c=void 0,this._o=t,t=new x(this);try{var r=n(t),e=r;null!=r&&("function"==typeof r.unsubscribe?r=function(){e.unsubscribe()}:f(r),this._c=r)}catch(n){return void t.error(n)}g(this)&&y(this)};m.prototype=l({},{unsubscribe:function(){b(this)}});var x=function(t){this._s=t};x.prototype=l({},{next:function(t){var n=this._s;if(!g(n)){var r=n._o;try{var e=d(r.next);if(e)return e.call(r,t)}catch(t){try{b(n)}finally{throw t}}}},error:function(t){var n=this._s;if(g(n))throw t;var r=n._o;n._o=void 0;try{var e=d(r.error);if(!e)throw t;t=e.call(r,t)}catch(t){try{y(n)}finally{throw t}}return y(n),t},complete:function(t){var n=this._s;if(!g(n)){var r=n._o;n._o=void 0;try{var e=d(r.complete);t=e?e.call(r,t):void 0}catch(t){try{y(n)}finally{throw t}}return y(n),t}}});var w=function(t){s(this,w,"Observable","_f")._f=f(t)};l(w.prototype,{subscribe:function(t){return new m(t,this._f)},forEach:function(t){var n=this;return new(o.Promise||i.Promise)(function(r,e){f(t);var i=n.subscribe({next:function(n){try{return t(n)}catch(t){e(t),i.unsubscribe()}},error:e,complete:r})})}}),l(w,{from:function(t){var n="function"==typeof this?this:w,r=d(a(t)[c]);if(r){var e=a(r.call(t));return e.constructor===n?e:new n(function(t){return e.subscribe(t)})}return new n(function(n){var r=!1;return u(function(){if(!r){try{if(v(t,!1,function(t){if(n.next(t),r)return p})===p)return}catch(t){if(r)throw t;return void n.error(t)}n.complete()}}),function(){r=!0}})},of:function(){for(var t=0,n=arguments.length,r=Array(n);t<n;)r[t]=arguments[t++];return new("function"==typeof this?this:w)(function(t){var n=!1;return u(function(){if(!n){for(var e=0;e<r.length;++e)if(t.next(r[e]),n)return;t.complete()}}),function(){n=!0}})}}),h(w.prototype,c,function(){return this}),e(e.G,{Observable:w}),r(74)("Observable")},function(t,n,r){var e=r(54),i=r(2),o=e.key,u=e.set;e.exp({defineMetadata:function(t,n,r,e){u(t,n,i(r),o(e))}})},function(t,n,r){var e=r(54),i=r(2),o=e.key,u=e.map,c=e.store;e.exp({deleteMetadata:function(t,n){var r=arguments.length<3?void 0:o(arguments[2]),e=u(i(n),r,!1);if(void 0===e||!e.delete(t))return!1;if(e.size)return!0;var f=c.get(n);return f.delete(r),!!f.size||c.delete(n)}})},function(t,n,r){var e=r(185),i=r(161),o=r(54),u=r(2),c=r(32),f=o.keys,a=o.key,s=function(t,n){var r=f(t,n),o=c(t);if(null===o)return r;var u=s(o,n);return u.length?r.length?i(new e(r.concat(u))):u:r};o.exp({getMetadataKeys:function(t){return s(u(t),arguments.length<2?void 0:a(arguments[1]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(32),u=e.has,c=e.get,f=e.key,a=function(t,n,r){if(u(t,n,r))return c(t,n,r);var e=o(n);return null!==e?a(t,e,r):void 0};e.exp({getMetadata:function(t,n){return a(t,i(n),arguments.length<3?void 0:f(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.keys,u=e.key;e.exp({getOwnMetadataKeys:function(t){
return o(i(t),arguments.length<2?void 0:u(arguments[1]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.get,u=e.key;e.exp({getOwnMetadata:function(t,n){return o(t,i(n),arguments.length<3?void 0:u(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(32),u=e.has,c=e.key,f=function(t,n,r){if(u(t,n,r))return!0;var e=o(n);return null!==e&&f(t,e,r)};e.exp({hasMetadata:function(t,n){return f(t,i(n),arguments.length<3?void 0:c(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.has,u=e.key;e.exp({hasOwnMetadata:function(t,n){return o(t,i(n),arguments.length<3?void 0:u(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(26),u=e.key,c=e.set;e.exp({metadata:function(t,n){return function(r,e){c(t,n,(void 0!==e?i:o)(r),u(e))}}})},function(t,n,r){var e=r(1);e(e.P+e.R,"Set",{toJSON:r(165)("Set")})},function(t,n,r){"use strict";var e=r(1),i=r(147)(!0);e(e.P,"String",{at:function(t){return i(this,t)}})},function(t,n,r){"use strict";var e=r(1),i=r(46),o=r(16),u=r(122),c=r(120),f=RegExp.prototype,a=function(t,n){this._r=t,this._s=n};r(139)(a,"RegExp String",function(){var t=this._r.exec(this._s);return{value:t,done:null===t}}),e(e.P,"String",{matchAll:function(t){if(i(this),!u(t))throw TypeError(t+" is not a regexp!");var n=String(this),r="flags"in f?String(t.flags):c.call(t),e=new RegExp(t.source,~r.indexOf("g")?r:"g"+r);return e.lastIndex=o(t.lastIndex),new a(e,n)}})},function(t,n,r){"use strict";var e=r(1),i=r(181);e(e.P,"String",{padEnd:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0,!1)}})},function(t,n,r){"use strict";var e=r(1),i=r(181);e(e.P,"String",{padStart:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0,!0)}})},function(t,n,r){"use strict";r(82)("trimLeft",function(t){return function(){return t(this,1)}},"trimStart")},function(t,n,r){"use strict";r(82)("trimRight",function(t){return function(){return t(this,2)}},"trimEnd")},function(t,n,r){r(153)("asyncIterator")},function(t,n,r){r(153)("observable")},function(t,n,r){var e=r(1);e(e.S,"System",{global:r(3)})},function(t,n,r){for(var e=r(155),i=r(28),o=r(3),u=r(27),c=r(80),f=r(7),a=f("iterator"),s=f("toStringTag"),l=c.Array,h=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],v=0;v<5;v++){var p,d=h[v],y=o[d],g=y&&y.prototype;if(g){g[a]||u(g,a,l),g[s]||u(g,s,d),c[d]=l;for(p in e)g[p]||i(g,p,e[p],!0)}}},function(t,n,r){var e=r(1),i=r(151);e(e.G+e.B,{setImmediate:i.set,clearImmediate:i.clear})},function(t,n,r){var e=r(3),i=r(1),o=r(121),u=r(207),c=e.navigator,f=!!c&&/MSIE .\./.test(c.userAgent),a=function(t){return f?function(n,r){return t(o(u,[].slice.call(arguments,2),"function"==typeof n?n:Function(n)),r)}:t};i(i.G+i.B+i.F*f,{setTimeout:a(e.setTimeout),setInterval:a(e.setInterval)})},function(t,n,r){r(330),r(269),r(271),r(270),r(273),r(275),r(280),r(274),r(272),r(282),r(281),r(277),r(278),r(276),r(268),r(279),r(283),r(284),r(236),r(238),r(237),r(286),r(285),r(256),r(266),r(267),r(257),r(258),r(259),r(260),r(261),r(262),r(263),r(264),r(265),r(239),r(240),r(241),r(242),r(243),r(244),r(245),r(246),r(247),r(248),r(249),r(250),r(251),r(252),r(253),r(254),r(255),r(317),r(322),r(329),r(320),r(312),r(313),r(318),r(323),r(325),r(308),r(309),r(310),r(311),r(314),r(315),r(316),r(319),r(321),r(324),r(326),r(327),r(328),r(231),r(233),r(232),r(235),r(234),r(220),r(218),r(224),r(221),r(227),r(229),r(217),r(223),r(214),r(228),r(212),r(226),r(225),r(219),r(222),r(211),r(213),r(216),r(215),r(230),r(155),r(302),r(307),r(184),r(303),r(304),r(305),r(306),r(287),r(183),r(185),r(186),r(342),r(331),r(332),r(337),r(340),r(341),r(335),r(338),r(336),r(339),r(333),r(334),r(288),r(289),r(290),r(291),r(292),r(295),r(293),r(294),r(296),r(297),r(298),r(299),r(301),r(300),r(343),r(369),r(372),r(371),r(373),r(374),r(370),r(375),r(376),r(354),r(357),r(353),r(351),r(352),r(355),r(356),r(346),r(368),r(377),r(345),r(347),r(349),r(348),r(350),r(359),r(360),r(362),r(361),r(364),r(363),r(365),r(366),r(367),r(344),r(358),r(380),r(379),r(378),t.exports=r(52)},function(t,n){function r(t,n){if("string"==typeof n)return t.insertAdjacentHTML("afterend",n);var r=t.nextSibling;return r?t.parentNode.insertBefore(n,r):t.parentNode.appendChild(n)}t.exports=r},,,,,,,,,function(t,n,r){(function(n,r){!function(n){"use strict";function e(t,n,r,e){var i=n&&n.prototype instanceof o?n:o,u=Object.create(i.prototype),c=new p(e||[]);return u._invoke=s(t,r,c),u}function i(t,n,r){try{return{type:"normal",arg:t.call(n,r)}}catch(t){return{type:"throw",arg:t}}}function o(){}function u(){}function c(){}function f(t){["next","throw","return"].forEach(function(n){t[n]=function(t){return this._invoke(n,t)}})}function a(t){function n(r,e,o,u){var c=i(t[r],t,e);if("throw"!==c.type){var f=c.arg,a=f.value;return a&&"object"==typeof a&&m.call(a,"__await")?Promise.resolve(a.__await).then(function(t){n("next",t,o,u)},function(t){n("throw",t,o,u)}):Promise.resolve(a).then(function(t){f.value=t,o(f)},u)}u(c.arg)}function e(t,r){function e(){return new Promise(function(e,i){n(t,r,e,i)})}return o=o?o.then(e,e):e()}"object"==typeof r&&r.domain&&(n=r.domain.bind(n));var o;this._invoke=e}function s(t,n,r){var e=P;return function(o,u){if(e===F)throw new Error("Generator is already running");if(e===M){if("throw"===o)throw u;return y()}for(r.method=o,r.arg=u;;){var c=r.delegate;if(c){var f=l(c,r);if(f){if(f===A)continue;return f}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(e===P)throw e=M,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);e=F;var a=i(t,n,r);if("normal"===a.type){if(e=r.done?M:j,a.arg===A)continue;return{value:a.arg,done:r.done}}"throw"===a.type&&(e=M,r.method="throw",r.arg=a.arg)}}}function l(t,n){var r=t.iterator[n.method];if(r===g){if(n.delegate=null,"throw"===n.method){if(t.iterator.return&&(n.method="return",n.arg=g,l(t,n),"throw"===n.method))return A;n.method="throw",n.arg=new TypeError("The iterator does not provide a 'throw' method")}return A}var e=i(r,t.iterator,n.arg);if("throw"===e.type)return n.method="throw",n.arg=e.arg,n.delegate=null,A;var o=e.arg;return o?o.done?(n[t.resultName]=o.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=g),n.delegate=null,A):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,A)}function h(t){var n={tryLoc:t[0]};1 in t&&(n.catchLoc=t[1]),2 in t&&(n.finallyLoc=t[2],n.afterLoc=t[3]),this.tryEntries.push(n)}function v(t){var n=t.completion||{};n.type="normal",delete n.arg,t.completion=n}function p(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(h,this),this.reset(!0)}function d(t){if(t){var n=t[w];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,e=function n(){for(;++r<t.length;)if(m.call(t,r))return n.value=t[r],n.done=!1,n;return n.value=g,n.done=!0,n};return e.next=e}}return{next:y}}function y(){return{value:g,done:!0}}var g,b=Object.prototype,m=b.hasOwnProperty,x="function"==typeof Symbol?Symbol:{},w=x.iterator||"@@iterator",S=x.asyncIterator||"@@asyncIterator",_=x.toStringTag||"@@toStringTag",O="object"==typeof t,E=n.regeneratorRuntime;if(E)return void(O&&(t.exports=E));E=n.regeneratorRuntime=O?t.exports:{},E.wrap=e;var P="suspendedStart",j="suspendedYield",F="executing",M="completed",A={},N={};N[w]=function(){return this};var T=Object.getPrototypeOf,I=T&&T(T(d([])));I&&I!==b&&m.call(I,w)&&(N=I);var k=c.prototype=o.prototype=Object.create(N);u.prototype=k.constructor=c,c.constructor=u,c[_]=u.displayName="GeneratorFunction",E.isGeneratorFunction=function(t){var n="function"==typeof t&&t.constructor;return!!n&&(n===u||"GeneratorFunction"===(n.displayName||n.name))},E.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,c):(t.__proto__=c,_ in t||(t[_]="GeneratorFunction")),t.prototype=Object.create(k),t},E.awrap=function(t){return{__await:t}},f(a.prototype),a.prototype[S]=function(){return this},E.AsyncIterator=a,E.async=function(t,n,r,i){var o=new a(e(t,n,r,i));return E.isGeneratorFunction(n)?o:o.next().then(function(t){return t.done?t.value:o.next()})},f(k),k[_]="Generator",k.toString=function(){return"[object Generator]"},E.keys=function(t){var n=[];for(var r in t)n.push(r);return n.reverse(),function r(){for(;n.length;){var e=n.pop();if(e in t)return r.value=e,r.done=!1,r}return r.done=!0,r}},E.values=d,p.prototype={constructor:p,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=g,this.done=!1,this.delegate=null,this.method="next",this.arg=g,this.tryEntries.forEach(v),!t)for(var n in this)"t"===n.charAt(0)&&m.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=g)},stop:function(){this.done=!0;var t=this.tryEntries[0],n=t.completion;if("throw"===n.type)throw n.arg;return this.rval},dispatchException:function(t){function n(n,e){return o.type="throw",o.arg=t,r.next=n,e&&(r.method="next",r.arg=g),!!e}if(this.done)throw t;for(var r=this,e=this.tryEntries.length-1;e>=0;--e){var i=this.tryEntries[e],o=i.completion;if("root"===i.tryLoc)return n("end");if(i.tryLoc<=this.prev){var u=m.call(i,"catchLoc"),c=m.call(i,"finallyLoc");if(u&&c){if(this.prev<i.catchLoc)return n(i.catchLoc,!0);if(this.prev<i.finallyLoc)return n(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return n(i.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return n(i.finallyLoc)}}}},abrupt:function(t,n){for(var r=this.tryEntries.length-1;r>=0;--r){var e=this.tryEntries[r];if(e.tryLoc<=this.prev&&m.call(e,"finallyLoc")&&this.prev<e.finallyLoc){var i=e;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=n&&n<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=t,o.arg=n,i?(this.method="next",this.next=i.finallyLoc,A):this.complete(o)},complete:function(t,n){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&n&&(this.next=n),A},finish:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),v(r),A}},catch:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc===t){var e=r.completion;if("throw"===e.type){var i=e.arg;v(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:d(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=g),A}}}("object"==typeof n?n:"object"==typeof window?window:"object"==typeof self?self:this)}).call(n,function(){return this}(),r(158))}])</script><script src="/./main.0cf68a.js"></script><script>!function(){!function(e){var t=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(t),t.setAttribute("src",e)}("/slider.e37972.js")}()</script>


    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-nav header-menu">
    
    
      
      
      
    
      
      
      
    
      
      
      
    
    

    <ul style="width: 70%">
    
    
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">æ‰€æœ‰æ–‡ç« </a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'friends')"><a href="javascript:void(0)" q-class="active:friends">å‹é“¾</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'aboutme')"><a href="javascript:void(0)" q-class="active:aboutme">å…³äºæˆ‘</a></li>
      
        
    </ul>
  </div>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find somethingâ€¦">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">netfilter</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">iptables</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">WLAN</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">iw</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">mac80211_hwsim</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">bridge</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            ç¼ºå¤±æ¨¡å—ã€‚<br/>1ã€è¯·ç¡®ä¿nodeç‰ˆæœ¬å¤§äº6.2<br/>2ã€åœ¨åšå®¢æ ¹ç›®å½•ï¼ˆæ³¨æ„ä¸æ˜¯yiliaæ ¹ç›®å½•ï¼‰æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š<br/> npm i hexo-generator-json-content --save<br/><br/>
            3ã€åœ¨æ ¹ç›®å½•_config.ymlé‡Œæ·»åŠ é…ç½®ï¼š
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: false
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    
    	<section class="tools-section tools-section-friends" q-show="friends">
  		
        <ul class="search-ul">
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>å‹æƒ…é“¾æ¥1</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>å‹æƒ…é“¾æ¥2</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>å‹æƒ…é“¾æ¥3</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>å‹æƒ…é“¾æ¥4</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>å‹æƒ…é“¾æ¥5</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>å‹æƒ…é“¾æ¥6</a>
            </li>
          
        </ul>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me" q-show="aboutme">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">å¾ˆæƒ­æ„§&lt;br&gt;&lt;br&gt;åªåšäº†ä¸€ç‚¹å¾®å°çš„å·¥ä½œ&lt;br&gt;è°¢è°¢å¤§å®¶</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>